/*!
 * OpenUI5
 * (c) Copyright 2025 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["sap/base/util/restricted/_omit","sap/base/util/restricted/_pick","sap/base/util/ObjectPath","sap/ui/fl/apply/_internal/controlVariants/Utils","sap/ui/fl/apply/_internal/flexObjects/States","sap/ui/fl/apply/_internal/flexState/changes/DependencyHandler","sap/ui/fl/apply/_internal/flexState/DataSelector","sap/ui/fl/apply/_internal/flexState/FlexState","sap/ui/fl/changeHandler/condenser/Classification","sap/ui/fl/initial/_internal/Storage","sap/ui/fl/LayerUtils"],function(e,t,n,a,r,c,i,s,f,o,u){"use strict";const l={ctrl_variant_change:{getCondenserInfo(e){return{classification:f.LastOneWins,uniqueKey:e.getVariantId()+e.getChangeType()}}},ctrl_variant_management_change:{getCondenserInfo(e,t){return{classification:f.LastOneWins,uniqueKey:t.modifier.getControlIdBySelector(e.getSelector(),t.appComponent)}}}};var g={};const v={};const d={};function h(e,t,r){var c=s.getComponentData(e);var i=n.get(["technicalParameters",a.VARIANT_TECHNICAL_PARAMETER],c)||[];var f=r.filter(e=>e.visible).map(e=>e.key);if(i.length===1){i=i[0].split(",")}var o=f.find(e=>i.includes(e));if(o){return o}return t.slice().reverse().map(e=>e.getContent().defaultVariant).find(e=>f.includes(e))}function p(e,t,n){var a=(v[t]||{})[n];return{defaultVariant:n,currentVariant:a,variants:[],variantManagementChanges:e.filter(function(e){return e.getSelector().id===n})}}function m(e,t){return e.find(e=>e.getId()===t)}function V(e,t){const n=[];let a=t;let r;do{r=m(e,a.getVariantReference());if(r){n.push(r);a=r}}while(r);return n.map(e=>e.getId())}function C(e,t){const n=V(e.variants,t);return{instance:t,variantChanges:e.variantChanges.filter(function(e){return e.getVariantId()===t.getId()}),controlChanges:e.changes.filter(function(e){var a=e.isA("sap.ui.fl.apply._internal.flexObjects.UIChange");if(!a){return false}var r=e.getVariantReference()===t.getId();var c=n.indexOf(e.getVariantReference())>-1;var i=u.compareAgainstCurrentLayer(e.getLayer(),t.getLayer())===-1;return r||c&&i}),key:t.getId(),title:t.getName(),layer:t.getLayer(),favorite:t.getFavorite(),executeOnSelect:t.getExecuteOnSelection(),visible:t.getVisible(),author:t.getAuthor(),contexts:t.getContexts(),isStandardVariant:t.getStandardVariant()}}function y(e,t){switch(t.getChangeType()){case"setTitle":e.title=t.getText("title");break;case"setFavorite":e.favorite=t.getContent().favorite;break;case"setExecuteOnSelect":e.executeOnSelect=t.getContent().executeOnSelect;break;case"setVisible":e.visible=t.getContent().visible;break;case"setContexts":e.contexts=t.getContent().contexts;break;default:throw Error("Unknown ctrl_variant_change type")}}function b(e,t){var n=t.getContent().defaultVariant;e.variants.forEach(t=>{if(t.key===n&&t.visible){e.defaultVariant=n}})}function R(e){const t={variants:[],variantManagementChanges:[],changes:[],variantChanges:[]};e.forEach(e=>{switch(e.getFileType()){case"ctrl_variant":t.variants.push(e);break;case"ctrl_variant_management_change":t.variantManagementChanges.push(e);break;case"change":t.changes.push(e);break;case"ctrl_variant_change":t.variantChanges.push(e);break;default:break}});return t}function O(e){const t=R(e);const a=e[0]?.getFlexObjectMetadata().reference;const r={};t.variants.forEach(e=>{var n=e.getVariantManagementReference();r[n]||=p(t.variantManagementChanges,a,n);r[n].variants.push(C(t,e))});t.variantChanges.forEach(e=>{const t=x(r,e);if(t){y(t,e,a,r)}});t.variantManagementChanges.forEach(e=>{const t=r[e.getSelector().id];if(t){b(t,e)}});Object.keys(r).forEach(e=>{const c=r[e];if(!c.currentVariant||!c.variants.some(e=>e.key===c.currentVariant)){const r=h(a,t.variantManagementChanges,c.variants)||e;c.currentVariant=r;n.set([a,e],r,v)}c.variants.sort((e,t)=>{if(e.isStandardVariant){return-1}if(t.isStandardVariant){return 1}return e.title.toLowerCase()<t.title.toLowerCase()?-1:1});var i=c.variants.find(e=>e.key===c.currentVariant).controlChanges;c.modified=i.some(e=>!e.isPersisted()&&!e.getSavedToVariant());c.variants.some(e=>{if(!e.favorite&&e.key===c.defaultVariant){e.favorite=true;return true}return false})});return r}function x(e,t){var n;Object.values(e).some(function(e){return e.variants.some(function(e){if(t.getVariantId()===e.key){n=e;return true}return false})});return n}var S=new i({id:"variantManagementMap",parentDataSelector:s.getFlexObjectsDataSelector(),executeFunction:O,checkInvalidation(e,t){if(t.type==="switchVariant"){return true}const n=["addFlexObject","updateFlexObject","removeFlexObject"];const a=n.includes(t.type);const r=["ctrl_variant","ctrl_variant_change","ctrl_variant_management_change"];const c=r.includes(t.updatedObject?.getFileType?.());const i=t.updatedObject?.getVariantReference?.();return a&&(c||i)}});var _=new i({id:"variantManagements",parameterKey:"variantManagementReference",parentDataSelector:S,executeFunction(e,t){return e[t.variantManagementReference]}});var j=new i({id:"variants",parameterKey:"variantReference",parentDataSelector:_,executeFunction(e,t){return e.variants.find(e=>e.instance.getId()===t.variantReference)}});const F=new i({id:"vmDependentDependencyMap",parentDataSelector:S,executeFunction(e,t){let n=[];Object.entries(e).forEach(([e,a])=>{n=n.concat(g.getControlChangesForVariant({vmReference:e,vReference:a.currentVariant,reference:t.reference}))});const a=c.createEmptyDependencyMap();const r=s.getComponentIdForReference(t.reference);n.forEach(e=>{c.addChangeAndUpdateDependencies(e,r,a)});return a},checkInvalidation(e,t){if(t.type==="switchVariant"){return true}const n=["addFlexObject","removeFlexObject"].includes(t.type);const a=t.updatedObject.getFileType()==="change";const r=Object.values(v[e.reference]||{});return a&&n&&r.includes(t.updatedObject.getVariantReference())}});var k=new i({id:"variantDependentFlexObjects",parentDataSelector:s.getFlexObjectsDataSelector(),executeFunction(e){return e.filter(function(e){const t=e.getVariantReference?.();const n=["ctrl_variant","ctrl_variant_change","ctrl_variant_management_change"].indexOf(e.getFileType())>-1;return n||t})}});g.getDependencyMap=function(e){return F.get({reference:e})};g.getVariantDependentFlexObjects=function(e){return k.get({reference:e})};g.getChangeInformationProvider=function(e){return l[e.getFileType()]};g.resetCurrentVariantReference=function(e){delete v[e];S.checkUpdate({reference:e})};g.getVariantManagementMap=function(){return S};g.addRuntimeSteadyObject=function(e,t,n){s.addRuntimeSteadyObject(e,t,n)};g.clearRuntimeSteadyObjects=function(e,t){s.clearRuntimeSteadyObjects(e,t)};g.addRuntimeOnlyFlexObjects=function(e,t){t.forEach(t=>s.getRuntimeOnlyData(e).flexObjects.push(t));s.getFlexObjectsDataSelector().clearCachedResult({reference:e})};g.loadVariant=async function(e){const t=await o.loadFlVariant({variantReference:e.variantReference,reference:e.reference});s.updateWithDataProvided({reference:e.reference,newData:t})};g.getControlChangesForVariant=function(e){const t=g.getVariant(e);if(t){return t.controlChanges.filter(function(t){const n=t.getState()!==r.LifecycleState.PERSISTED;const a=t.getVariantReference()!==e.vReference;return(e.includeDirtyChanges!==false||!n)&&(e.includeReferencedChanges!==false||!a)})}return[]};g.getVariantChangesForVariant=function(e){var t=g.getVariant(e);return t&&t.variantChanges||{}};g.getVariant=function(e){var t=e.vReference||_.get({variantManagementReference:e.vmReference,reference:e.reference}).defaultVariant;return j.get({variantManagementReference:e.vmReference,variantReference:t,reference:e.reference})};g.getCurrentVariantReference=function(e){var t=_.get({variantManagementReference:e.vmReference,reference:e.reference});return t.currentVariant};g.getAllCurrentVariants=function(e){const t=S.get({reference:e});return Object.entries(t).map(t=>{const n=g.getVariant({vmReference:t[0],vReference:t[1].currentVariant,reference:e}).instance;return n})};g.getVariantManagementReferences=function(e){var t=S.get({reference:e});return Object.keys(t)};g.getAllVariants=function(e){var t=S.get({reference:e});return Object.keys(t).reduce(function(e,n){return e.concat(t[n].variants)},[])};g.getVariantManagementChanges=function(e){const t=S.get({reference:e.reference});const n=Object.values(t).map(e=>e.variantManagementChanges).flat();if(!e.vReference){return n}return n.filter(t=>e.vReference===t.getContent().defaultVariant)};g.getInitialUIChanges=function(e){const t=S.get({reference:e.reference});e.includeDirtyChanges=!!e.includeDirtyChanges;return Object.keys(t).reduce(function(n,a){if(e.vmReference&&e.vmReference===a||!e.vmReference){const r={...e,vmReference:a,vReference:t[a].currentVariant};return n.concat(g.getControlChangesForVariant(r))}return n},[])};g.getAllCurrentFlexObjects=function(e){const t=S.get({reference:e.reference});return Object.keys(t).reduce(function(n,a){if(e.vmReference&&e.vmReference===a||!e.vmReference){const r={...e,vmReference:a,vReference:t[a].currentVariant};const c=g.getVariant(r);return n.concat(c.variantChanges).concat(c.controlChanges).concat(t[a].variantManagementChanges).concat(t[a].variants.map(e=>e.instance))}return n},[])};g.filterHiddenFlexObjects=function(e,t){const n=S.get({reference:t});const a=[];Object.values(n).forEach(e=>{e.variants.forEach(e=>{if(e.visible===false){a.push(e.key)}})});return e.filter(e=>{const t={ctrl_variant:()=>e.getVariantId(),ctrl_variant_change:()=>e.getVariantId(),change:()=>e.getVariantReference()}[e.getFileType()]?.();return!a.includes(t)})};g.setCurrentVariant=function(e){n.set([e.reference,e.vmReference],e.newVReference,v);S.checkUpdate({reference:e.reference},[{type:"switchVariant"}])};g.setVariantSwitchPromise=function(e,t){d[e]=t};g.getVariantSwitchPromise=function(e){return d[e]};return g});
//# sourceMappingURL=VariantManagementState.js.map