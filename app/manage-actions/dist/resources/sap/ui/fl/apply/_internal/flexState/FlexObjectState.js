/*!
 * OpenUI5
 * (c) Copyright 2025 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["sap/base/util/merge","sap/base/util/restricted/_omit","sap/ui/core/util/reflection/JsControlTreeModifier","sap/ui/core/Element","sap/ui/fl/apply/_internal/changes/Utils","sap/ui/fl/apply/_internal/flexObjects/States","sap/ui/fl/apply/_internal/flexState/changes/DependencyHandler","sap/ui/fl/apply/_internal/flexState/changes/UIChangesState","sap/ui/fl/apply/_internal/flexState/controlVariants/VariantManagementState","sap/ui/fl/apply/_internal/flexState/DataSelector","sap/ui/fl/apply/_internal/flexState/FlexState","sap/ui/fl/apply/_internal/flexState/ManifestUtils","sap/ui/fl/Utils"],function(e,n,t,c,s,a,o,i,r,l,p,g,d){"use strict";const f={};const u=new l({id:"allDirtyFlexObjects",parentDataSelector:p.getFlexObjectsDataSelector(),executeFunction(e){return e.filter(e=>e.getState()!==a.LifecycleState.PERSISTED)}});function h(e,n){const t=f.getCompleteDependencyMap(n).mDependencies;return t[e.getId()]&&{...t[e.getId()]}}function y(e,n,c,s,a){const o=[];const i=f.getLiveDependencyMap(a);const r={...e};e.controlsDependencies.forEach(e=>{if(!t.bySelector(e,c)){const n=t.getControlIdBySelector(e,c);o.push(e);i.mControlsWithDependencies[n]||=[];if(!i.mControlsWithDependencies[n].includes(s.getId())){i.mControlsWithDependencies[n].push(s.getId())}}});r.dependencies=n;r.controlsDependencies=o;if(n.length||o.length){i.mDependencies[s.getId()]=r}return r}function D(e,n){const c=e.getDependentControlSelectorList();c.push(e.getSelector());return!c.some(e=>!t.bySelector(e,n))}function C(e,n,t,c,s){let a=D(e,c);if(!a){return[]}s.push(e);const o=e.getId();const i=n[o]&&n[o].dependencies||[];for(let e=0,r=i.length;e<r;e++){const r=d.getChangeFromChangesMap(t,i[e]);a=C(r,n,t,c,s);if(a.length===0){s=[];break}delete n[o]}return s}f.getAllApplicableUIChanges=function(e){const n=i.getVariantIndependentUIChanges(e);return n.concat(r.getInitialUIChanges({reference:e}))};f.getCompleteDependencyMap=function(n){const t=i.getVMIndependentCompleteDependencyMap(n);const c=r.getDependencyMap(n);const s=e({},t);e(s.mDependencies,c.mDependencies);e(s.mDependentChangesOnMe,c.mDependentChangesOnMe);s.aChanges=s.aChanges.concat(c.aChanges);["mChanges","mControlsWithDependencies"].forEach(e=>{Object.entries(c[e]).forEach(([n,t])=>{if(Object.keys(s[e]).includes(n)){s[e][n]=s[e][n].concat(t)}else{s[e][n]=t}})});return s};f.getLiveDependencyMap=function(e){return p.getRuntimeOnlyData(e).liveDependencyMap||o.createEmptyDependencyMap()};f.getOpenDependentChangesForControl=function(e,n){const c=g.getFlexReferenceForControl(n);return o.getOpenDependentChangesForControl(f.getLiveDependencyMap(c),t.getControlIdBySelector(e,n),n)};f.copyDependenciesFromCompleteDependencyMap=function(e,n){const c=g.getFlexReferenceForControl(n);let a=h(e,c);if(a){const o=f.getLiveDependencyMap(c);const i=[];a.dependencies.forEach(function(c){if(s.checkIfDependencyIsStillValid(n,t,o,c)){o.mDependentChangesOnMe[c]||=[];o.mDependentChangesOnMe[c].push(e.getId());i.push(c)}});a=y(a,i,n,e,c)}};f.waitForFlexObjectsToBeApplied=async function(e){const n=d.getAppComponentForSelector(e[0].selector);if(!n){return}const t=g.getFlexReferenceForControl(n);await r.getVariantSwitchPromise(t);await Promise.all(e.map(e=>{const s=e.selector.id&&c.getElementById(e.selector.id)||e.selector;e.changeTypes||=[];const a=f.getLiveDependencyMap(t);let o=[];const i={...a.mDependencies};const{mChanges:r}=a;const l=r[s.getId()]||[];const p=l.filter(n=>!n.isCurrentProcessFinished()&&(e.changeTypes.length===0||e.changeTypes.includes(n.getChangeType())));const g=[];p.forEach(e=>{const t=C(e,i,a.mChanges,n,[]);t.forEach(e=>{if(g.indexOf(e)===-1){g.push(e)}})});g.forEach(e=>{o=o.concat(e.addChangeProcessingPromises())});return Promise.all(o)}))};function m(e){const n=[];const t=p.getCompVariantsMap(e);for(const e in t){const c=t[e];for(const e in c.byId){n.push(c.byId[e])}}return n}function S(e){return!(e.getState()===a.LifecycleState.DELETED&&e._sPreviousState===a.LifecycleState.NEW)}f.getDirtyFlexObjects=function(e){const n=m(e);return u.get({reference:e}).concat(n.filter(e=>e.getState()!==a.LifecycleState.PERSISTED)).filter(e=>S(e))};return f});
//# sourceMappingURL=FlexObjectState.js.map