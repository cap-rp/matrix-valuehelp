/*!
 * OpenUI5
 * (c) Copyright 2025 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["sap/base/Log","sap/ui/core/Component","sap/ui/core/Lib","sap/ui/fl/apply/_internal/changes/descriptor/ApplyStrategyFactory","sap/ui/fl/apply/_internal/changes/descriptor/InlineApplier","sap/ui/fl/apply/_internal/changes/Applier","sap/ui/fl/apply/_internal/flexState/FlexState","sap/ui/fl/apply/_internal/flexState/ManifestUtils","sap/ui/fl/apply/api/ControlVariantApplyAPI","sap/ui/fl/initial/_internal/changeHandlers/ChangeHandlerRegistration","sap/ui/fl/variants/VariantModel","sap/ui/fl/FlexControllerFactory","sap/ui/fl/Layer","sap/ui/fl/Utils","sap/ui/model/json/JSONModel","sap/ui/model/odata/ODataUtils","sap/ui/performance/Measurement"],function(e,t,n,o,a,i,r,s,l,c,p,g,d,f,u,m,h){"use strict";var C={};C._componentInstantiationPromises=new WeakMap;var y={};function v(t){if(f.getUshellContainer()){return Promise.resolve()}var o=window.sessionStorage.getItem(`sap.ui.rta.restart.${d.CUSTOMER}`);if(o){var a=s.getFlexReferenceForControl(t);if(o!==a&&o!=="true"){e.error(`an application component was started which does not match the component for which the restart was triggered:\n\t\t\t\t\tTriggering component: ${o}\n\t\t\t\t\tStarted component: ${a}`);return Promise.resolve()}return new Promise(function(e,o){Promise.all([n.load({name:"sap.ui.rta"}),t.rootControlLoaded()]).then(function(){sap.ui.require(["sap/ui/rta/api/startKeyUserAdaptation"],function(n){n({rootControl:t});e()})}).catch(function(e){o(e)})})}return Promise.resolve()}function M(e){const t=s.getFlexReferenceForControl(e);const n=r.getStorageResponse(t);if(n.messagebundle&&!e.getModel("i18nFlexVendor")&&n.changes?.changes?.some(e=>e.layer===d.VENDOR)){e.setModel(new u(n.messagebundle),"i18nFlexVendor")}}async function w(e){var t=g.createForControl(e);const n=s.getFlexReferenceForControl(e);var o;var a=i.applyAllChangesForControl.bind(i,e,n);a._bIsSapUiFlFlexControllerApplyChangesOnControl=true;e.addPropagationListener(a);o=C._createVariantModel(t,e);await o.initialize();h.end("flexProcessing");e.setModel(o,l.getVariantModelName());await v(e)}function F(e,t){if(f.isApplicationComponent(e)){var n=e.getId();var o=r.initialize({componentId:n,asyncHints:t.asyncHints}).then(w.bind(this,e)).then(M.bind(this,e)).then(function(){if(y[n]){y[n].forEach(function(t){var n=e.getModel(l.getVariantModelName());t.setModel(n,l.getVariantModelName())});delete y[n]}});C._componentInstantiationPromises.set(e,o);return o}else if(f.isEmbeddedComponent(e)){var a=f.getAppComponentForControl(e);if(C._componentInstantiationPromises.has(a)){return C._componentInstantiationPromises.get(a).then(function(){var t=a.getModel(l.getVariantModelName());e.setModel(t,l.getVariantModelName())})}y[a.getId()]=y[a.getId()]||[];y[a.getId()].push(e);return Promise.resolve()}return Promise.resolve()}function P(e,t){if(!f.isApplication(t)||!e.id){return Promise.resolve()}r.initialize({componentData:e.componentData||e.settings&&e.settings.componentData,asyncHints:e.asyncHints,manifest:t,componentId:e.id});return a.applyChanges(t,o.getRuntimeStrategy())}C._createVariantModel=function(e,t){return new p({},{flexController:e,appComponent:t})};C.instanceCreatedHook=function(...e){return F(...e)};C.componentLoadedHook=function(...e){return P(...e)};async function A(n){const o=n.owner&&t.get(n.owner.id);const a=n.owner?.id||n.factoryConfig.id||n.factoryConfig.settings?.id;const i=o?.getComponentData()||n.factoryConfig.componentData||n.factoryConfig.settings?.componentData;const l=s.getFlexReference({manifest:o?.getManifest()||n.manifest,componentData:i});try{await r.initialize({componentData:i,asyncHints:n.owner?.config.asyncHints||n.factoryConfig.asyncHints,componentId:a,reference:l,partialFlexState:true});const e=m.removeOriginSegmentParameters(n.model.getServiceUrl());const t=r.getAnnotationChanges(l).filter(t=>t.getServiceUrl()===e);const o=[];for(const e of t){const t=await c.getAnnotationChangeHandler({changeType:e.getChangeType()});o.push(await t.applyChange(e));e._appliedOnModel=true}return o}catch(t){e.error("Annotation changes could not be applied.",t);return[]}}C.modelCreatedHook=function(e){e.model.setAnnotationChangePromise(A(e))};return C});
//# sourceMappingURL=ComponentLifecycleHooks.js.map