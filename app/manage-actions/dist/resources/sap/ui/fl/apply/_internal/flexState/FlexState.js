/*!
 * OpenUI5
 * (c) Copyright 2025 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["sap/base/util/restricted/_omit","sap/base/util/Deferred","sap/base/util/each","sap/base/util/merge","sap/base/util/ObjectPath","sap/base/Log","sap/ui/core/Component","sap/ui/fl/apply/_internal/flexObjects/FlexObjectFactory","sap/ui/fl/apply/_internal/flexObjects/States","sap/ui/fl/apply/_internal/flexState/compVariants/prepareCompVariantsMap","sap/ui/fl/apply/_internal/flexState/DataSelector","sap/ui/fl/apply/_internal/flexState/InitialPrepareFunctions","sap/ui/fl/apply/_internal/flexState/Loader","sap/ui/fl/apply/_internal/flexState/ManifestUtils","sap/ui/fl/initial/_internal/FlexInfoSession","sap/ui/fl/initial/_internal/StorageUtils","sap/ui/fl/LayerUtils"],function(e,t,n,r,a,i,c,s,o,f,l,p,u,d,m,g,x){"use strict";const h="sap.ui.fl.apply._internal.flexObjects.AppDescriptorChange";const b="sap.ui.fl.apply._internal.flexObjects.AnnotationChange";var v={};var O={};var j={};var R={appDescriptorChanges:{pathInResponse:[]},annotationChanges:{pathInResponse:[]},changes:{initialPreparationFunctionName:"uiChanges",pathInResponse:["changes"]},variants:{initialPreparationFunctionName:"variants",pathInResponse:["variants","variantChanges","variantDependentControlChanges","variantManagementChanges"]},compVariants:{prepareFunction:f,pathInResponse:["comp.variants","comp.standardVariants","comp.defaultVariants","comp.changes"]}};var y={compVariants:{},flexObjects:{}};function I(e,t){var n={comp(){return Object.values(t).reduce(function(e,t){return e.concat(t)},[])},variants(){return t.map(function(e){var n=e.variantReference===e.variantManagementReference||t.some(function(t){return t.variantManagementReference===e.variantManagementReference&&t.fileName===e.variantReference});if(!n){return{...e,variantReference:e.variantManagementReference}}return e})}}[e];if(n){return n()}return Array.isArray(t)?t:[]}function F(e){var t=c.getComponentById(e.componentId);e.componentData||=t&&t.getComponentData()||{};e.manifest||=e.rawManifest||t&&t.getManifestObject()||{};e.reference||=d.getFlexReference(e);const n=m.getByReference(e.reference);e.version||=n.version;e.adaptationId||=n.displayedAdaptationId;e.allContextsProvided||=n.allContextsProvided}function S(e){var t=[];n(e.changes,function(e,n){I(e,n).forEach(function(e){t.push(s.createFromFileContent(e,null,true))})});return t}function C(e,t){var n=R[e].initialPreparationFunctionName;var r=p[n];if(r){return r(t)}return undefined}function D(e,t,n){t.reference=n;var r=C(e,t);if(r){z(n,r)}}var P=new l({id:"flexObjects",parameterKey:"reference",executeFunction(e,t){if(!O[t.reference]){return[]}var n=O[t.reference].runtimePersistence;return n.flexObjects.concat(n.runtimeOnlyData.flexObjects||[],y.flexObjects[t.reference][O[t.reference].componentId]||[])}});const w=new l({id:"appDescriptorChanges",parentDataSelector:P,executeFunction(e){return e.filter(e=>e.isA(h))},checkInvalidation(e,t){const n=["addFlexObject","removeFlexObject"].includes(t.type);return n&&t.updatedObject?.isA(h)}});const _=new l({id:"annotationChanges",parentDataSelector:P,executeFunction(e){return e.filter(e=>e.isA(b))},checkInvalidation(e,t){const n=["addFlexObject","removeFlexObject"].includes(t.type);return n&&t.updatedObject?.isA(b)}});function V(e,t){if(!O[e]){q(e)}if(!O[e].preparedMaps[t]){var n={unfilteredStorageResponse:O[e].unfilteredStorageResponse,storageResponse:O[e].storageResponse,componentId:O[e].componentId,componentData:O[e].componentData,reference:e,runtimePersistence:O[e].runtimePersistence};O[e].preparedMaps[t]=v.callPrepareFunction(t,n);D(t,n,e)}return O[e].preparedMaps[t]}function z(e,t){O[e]=r(O[e],t);P.checkUpdate({reference:e})}function E(e,t){const n=e.storageResponse;var a={flexObjects:S(n),runtimeOnlyData:{flexObjects:[]}};if(!e.componentId){return a}Object.keys(R).forEach(function(i){var c=C(i,{storageResponse:n,externalData:t,flexObjects:a.flexObjects,componentId:e.componentId});if(c){a=r(a,c)}});return a}function k(e,t,r){const a=r.flexObjects.slice();const c=a.length;const f=[];let l;n(t.changes,function(e,t){I(e,t).forEach(function(e){f.push(e)})});O[e].runtimePersistence={...r,flexObjects:f.map(function(e){let t;const n=a.find(function(n,r){t=r;return n.getId()===e.fileName});if(n){a.splice(t,1);if(n.getState()!==o.LifecycleState.PERSISTED){n.setResponse(e);l=true}return n}if(e.fileType==="ctrl_variant_change"&&e.fileName.endsWith("flVariant_contextFiltering_setVisible")){return s.createFromFileContent(e,null,true)}const r="Error updating runtime persistence: storage returned unknown flex objects";i.error(r);throw new Error(r)})};if(c!==O[e].runtimePersistence.flexObjects.length){l=true}return l}function M(e){var t=e.reference;var n=false;if(!O[t].componentData&&e.componentId){var r=c.getComponentById(e.componentId);O[t].componentData=r?r.getComponentData():e.componentData;n=true}if(!O[t].storageResponse){O[t].storageResponse=L(t,O[t].unfilteredStorageResponse);delete O[t].runtimePersistence;n=true}if(!a.get(["flexObjects",t,e.componentId],y)){a.set(["flexObjects",t,e.componentId],[],y)}if(!O[t].runtimePersistence){O[t].runtimePersistence=E(O[t],y.flexObjects[t][e.componentId]||[]);n=true}if(n){P.checkUpdate({reference:t})}}function L(e,t){const i=r({},t);i.changes={...g.getEmptyFlexDataResponse(),...i.changes};const c=i.changes;const s=m.getByReference(e);if(x.isLayerFilteringRequired(e)){n(R,function(e,t){t.pathInResponse.forEach(function(e){const t=a.get(e,c).filter(function(e){return!e.layer||!x.isOverLayer(e.layer,s.maxLayer)});a.set(e,t,c)})})}O[e].maxLayer=s.maxLayer;return i}async function N(e){const t=await u.loadFlexData(e);if(!e.partialFlexState){t.authors=await u.loadVariantsAuthors(e.reference)}U(e.reference,t);return t}function A(e,t){O[t.reference]=r({},{unfilteredStorageResponse:e,preparedMaps:{},componentId:t.componentId,componentData:t.componentData,partialFlexState:t.partialFlexState,version:t.version,allContextsProvided:t.allContextsProvided});Object.freeze(O[t.reference].storageResponse);Object.freeze(O[t.reference].unfilteredStorageResponse)}function U(e,t){var n=t&&t.changes||{};var r=m.getByReference(e);if(n.info!==undefined){r={...r,...n.info}}m.setByReference(r,e)}function B(e){var t=O[e.reference];if(t.partialFlexState===true&&e.partialFlexState!==true){t.partialFlexState=false;e.partialFlexData=r({},t.unfilteredStorageResponse.changes);e.reInitialize=true}}function T(e){var t=O[e.reference].componentId;if(!e.reInitialize&&t!==e.componentId){e.reInitialize=true}}function K(e){var t=O[e.reference].version;if(!e.reInitialize&&t!==e.version){e.reInitialize=true}const n=O[e.reference].allContextsProvided;if(!e.reInitialize&&n!==e.allContextsProvided){e.reInitialize=true}}function W(e){if(O[e]?.maxLayer!==m.getByReference(e).maxLayer){v.rebuildFilteredResponse(e)}}function q(e){O[e]={unfilteredStorageResponse:{changes:g.getEmptyFlexDataResponse()},storageResponse:{changes:g.getEmptyFlexDataResponse()},preparedMaps:{},emptyState:true,reInitialize:true,componentId:""};const n=new t;j[e]=n;n.resolve();M({reference:e})}v.getRuntimeOnlyData=function(e){if(!O[e]){q(e)}return O[e].runtimePersistence.runtimeOnlyData};v.initialize=async function(e){const n=r({},e);F(n);const a=n.reference;const i=j[a];const c=new t;j[a]=c;if(i){await i.promise;B(n);T(n);K(n);if(n.reInitialize){const e=await N(n);A(e,n)}else{W(e.reference)}}else{const e=await N(n);A(e,n)}M(n);c.resolve()};v.waitForInitialization=function(e){const t=j[e]?.promise;if(!t){i.error("FlexState.waitForInitialization was called before FlexState.initialize");return Promise.resolve()}return t};v.isInitialized=function(e){var t=e.reference?e.reference:d.getFlexReferenceForControl(e.control);return!!O[t]};v.updateWithDataProvided=function(e){if(!O[e.reference]){q(e.reference)}const t=O[e.reference];Object.entries(e.newData).forEach(([e,n])=>{t.unfilteredStorageResponse.changes[e].push(...n)});t.storageResponse=L(e.reference,t.unfilteredStorageResponse);t.runtimePersistence.flexObjects=[...t.runtimePersistence.flexObjects,...S(L(e.reference,{changes:e.newData}))];P.checkUpdate({reference:e.reference})};v.update=async function(e){F(e);const n=e.reference;const r=O[n].runtimePersistence;const a=j[n].promise;const i=new t;j[n]=i;await a;const c=await N(e);A(c,e);O[n].storageResponse=L(n,O[n].unfilteredStorageResponse);const s=k(n,O[n].storageResponse,r);if(s){P.checkUpdate({reference:n})}i.resolve()};function G(e){switch(e.fileType){case"change":if(e.selector&&e.selector.persistencyKey){return["comp","changes"]}if(e.variantReference){return"variantDependentControlChanges"}return"changes";case"ctrl_variant":return"variants";case"ctrl_variant_change":return"variantChanges";case"ctrl_variant_management_change":return"variantManagementChanges";case"variant":return["comp","variants"];case"annotation_change":return"annotationChanges";default:return""}}v.updateStorageResponse=function(e,t){const n=[];t.forEach(t=>{if(t.type==="ui2"){O[e].unfilteredStorageResponse.changes.ui2personalization=t.newData}else{const r=G(t.flexObject);const i=t.flexObject.fileName;const c=a.get(r,O[e].unfilteredStorageResponse.changes);const s=a.get(r,O[e].storageResponse.changes);const f=O[e].runtimePersistence.flexObjects.findIndex(e=>e.getId()===i);const l=O[e].runtimePersistence.flexObjects[f];switch(t.type){case"add":c.push(t.flexObject);s.push(t.flexObject);if(f<0){throw new Error("Flex response includes unknown flex object")}break;case"delete":s.splice(s.findIndex(e=>e.fileName===i),1);c.splice(c.findIndex(e=>e.fileName===i),1);if(f>=0){O[e].runtimePersistence.flexObjects.splice(f,1);n.push({type:"removeFlexObject",updatedObject:l})}break;case"update":s.splice(s.findIndex(e=>e.fileName===i),1,t.flexObject);c.splice(c.findIndex(e=>e.fileName===i),1,t.flexObject);if(l&&l.getState()!==o.LifecycleState.PERSISTED){l.setResponse(t.flexObject);n.push({type:"updateFlexObject",updatedObject:l})}break;default:}}});if(n.length>0){P.checkUpdate({reference:e},n)}};v.clearState=function(e){if(e){delete O[e];delete j[e];P.clearCachedResult({reference:e})}else{O={};j={};P.clearCachedResult()}};v.setInitialNonFlCompVariantData=function(e,t,n,r,a){y.compVariants[e]||={};y.compVariants[e][t]={};y.compVariants[e][t].standardVariant=n;y.compVariants[e][t].variants=r;y.compVariants[e][t].controlId=a};v.getInitialNonFlCompVariantData=function(e){return y.compVariants[e]};v.resetInitialNonFlCompVariantData=function(e){delete y.compVariants[e]};v.addRuntimeSteadyObject=function(e,t,n){n.setState(o.LifecycleState.PERSISTED);y.flexObjects[e]||={};y.flexObjects[e][t]||=[];y.flexObjects[e][t].push(n);P.checkUpdate({reference:e},[{type:"addFlexObject",updatedObject:n}])};v.clearRuntimeSteadyObjects=function(e,t){if(y.flexObjects[e]){delete y.flexObjects[e][t];P.clearCachedResult({reference:e})}};v.rebuildFilteredResponse=function(e){if(O[e]){O[e].preparedMaps={};O[e].storageResponse=L(e,O[e].unfilteredStorageResponse);O[e].runtimePersistence=E(O[e],y.flexObjects[e][O[e].componentId]||[]);P.checkUpdate({reference:e})}};v.addDirtyFlexObjects=function(e,t){if(!O[e]){q(e)}const n=m.getByReference(e).adaptationLayer;const r=t.filter(e=>!n||!x.isOverLayer(e.getLayer(),n)).filter(t=>!O[e].runtimePersistence.flexObjects.some(e=>e.getId()===t.getId()));if(r.length>0){O[e].runtimePersistence.flexObjects=O[e].runtimePersistence.flexObjects.concat(r);P.checkUpdate({reference:e},r.map(function(e){return{type:"addFlexObject",updatedObject:e}}))}return r};v.removeDirtyFlexObjects=function(e,t){const n=[];if(O[e]&&t.length>0){const r=O[e].runtimePersistence.flexObjects;t.forEach(function(e){const t=r.indexOf(e);if(t>=0){n.push(e);r.splice(t,1)}});if(n.length>0){P.checkUpdate({reference:e},t.map(function(e){return{type:"removeFlexObject",updatedObject:e}}))}}return n};v.getComponentIdForReference=function(e){return O[e]?.componentId};v.getFlexObjectsDataSelector=function(){return P};v.getAppDescriptorChanges=function(e){return w.get({reference:e})};v.getAnnotationChanges=function(e){return _.get({reference:e})};v.getUI2Personalization=function(e){return r({},O[e].unfilteredStorageResponse.changes.ui2personalization)};v.getCompVariantsMap=function(e){return V(e,"compVariants")};v.callPrepareFunction=function(e,t){return R[e].prepareFunction(t)};v.getStorageResponse=function(e){if(j[e]){return j[e].promise.then(function(){return O[e].unfilteredStorageResponse})}return Promise.resolve()};v.getComponentData=function(e){return O[e]&&O[e].componentData};v.setAllContextsProvided=function(e,t){if(O[e]&&O[e].allContextsProvided===undefined){O[e].allContextsProvided=t}};return v});
//# sourceMappingURL=FlexState.js.map