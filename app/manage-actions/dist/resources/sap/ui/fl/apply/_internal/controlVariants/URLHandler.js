/*!
 * OpenUI5
 * (c) Copyright 2025 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["sap/ui/core/Component","sap/base/Log","sap/base/util/deepEqual","sap/base/util/merge","sap/base/util/ObjectPath","sap/base/util/isEmptyObject","sap/ui/base/ManagedObjectObserver","sap/ui/thirdparty/hasher","sap/ui/fl/apply/_internal/controlVariants/Utils"],function(e,a,t,r,n,o,i,s,l){"use strict";var c={};var m={};function d(e,a){var t=[];return e.reduce(function(e,r){var n=a.getVariantManagementReference(r).variantManagementReference;if(n){if(t.includes(n)){e.updateRequired=true;return e}t.push(n)}if(n&&a.oData[n].currentVariant!==r){e.updateRequired=true;if(a.oData[n].currentVariant!==a.oData[n].defaultVariant){e.parameters.push(a.oData[n].currentVariant)}}else{e.parameters.push(r)}return e},{updateRequired:false,parameters:[]})}function p(e,a){const t=e.getUShellService("URLParsing")?.parseShellHash(a||s.getHash());var r=n.get(["params",l.VARIANT_TECHNICAL_PARAMETER],t);if(Array.isArray(r)&&r.length===1){r=r[0].split(",")}if(r){var o=d(r,e);if(o.updateRequired){m.update({updateURL:!e._bDesignTimeMode,parameters:o.parameters,updateHashEntry:true,model:e})}}}function u(e,t){try{const a=e.getUShellService("URLParsing");if(a){p(e,t)}}catch(e){a.error(e.message)}const r=e.getUShellService("ShellNavigationInternal");return r?.NavigationFilterStatus.Continue}function f(e){const a=e.getUShellService("ShellNavigationInternal");if(!c[e.sFlexReference]){c[e.sFlexReference]=u.bind(null,e);if(a){a.registerNavigationFilter(c[e.sFlexReference])}}}function A(e){const a=e.getUShellService("ShellNavigationInternal");if(a){a.unregisterNavigationFilter(c[e.sFlexReference]);delete c[e.sFlexReference]}}function R(e){const r=e.model;const n=r.getUShellService("URLParsing");const o=r.getUShellService("Navigation");const i=n?.parseShellHash(s.getHash());if(i?.params){const c={...i.params};const m=r.oAppComponent?.getComponentData?.()?.technicalParameters;if(!m){a.warning("Component instance not provided, so technical parameters in component data and browser history remain unchanged")}if(e.parameters.length===0){delete i.params[l.VARIANT_TECHNICAL_PARAMETER];if(m){delete m[l.VARIANT_TECHNICAL_PARAMETER]}}else{i.params[l.VARIANT_TECHNICAL_PARAMETER]=[e.parameters.toString()];if(m){m[l.VARIANT_TECHNICAL_PARAMETER]=[e.parameters.toString()]}}if(e.silent){s.changed.active=false;s.replaceHash(n.constructShellHash(i));s.changed.active=true}else if(!t(c,i.params)){o.navigate({target:{semanticObject:i.semanticObject,action:i.action,context:i.contextRaw},params:i.params,appSpecificRoute:i.appSpecificRoute,writeHistory:false})}}}function h(e){var a={index:-1};var t=e.model;var n=t.getUShellService("URLParsing");var i=n?.parseShellHash(s.getHash()).params;if(i){a.parameters=[];if(t._bDesignTimeMode){i[l.VARIANT_TECHNICAL_PARAMETER]=m.getStoredHashParams(e)}if(Array.isArray(i[l.VARIANT_TECHNICAL_PARAMETER])){if(i[l.VARIANT_TECHNICAL_PARAMETER].length>1){i[l.VARIANT_TECHNICAL_PARAMETER]=i[l.VARIANT_TECHNICAL_PARAMETER].map(decodeURIComponent)}else if(i[l.VARIANT_TECHNICAL_PARAMETER].length===1){const e=i[l.VARIANT_TECHNICAL_PARAMETER][0];const a=e&&decodeURIComponent(e);i[l.VARIANT_TECHNICAL_PARAMETER]=a?a.split(","):[]}i[l.VARIANT_TECHNICAL_PARAMETER].some(function(r,n){if(!o(t.getVariant(r,e.vmReference))){a.index=n;return true}return false})}}return r(a,i&&i[l.VARIANT_TECHNICAL_PARAMETER]&&{parameters:i[l.VARIANT_TECHNICAL_PARAMETER]})}function v(e){var a=e.getUShellService("URLParsing");var t=a?.parseShellHash(s.getHash());return t?.params&&t.params[l.VARIANT_TECHNICAL_PARAMETER]}m.variantTechnicalParameterName="sap-ui-fl-control-variant-id";m.initialize=function(e){var a=e.model;m.attachHandlers(e);a._oHashData={hashParams:[],controlPropertyObservers:[],variantControlIds:[]};p(a)};m.updateVariantInURL=function(e){var a=m.removeURLParameterForVariantManagement(e);if(!a.parameters){return}var t=a.parameters||[];var r=a.index;var n=e.newVReference===e.model.oData[e.vmReference].defaultVariant;if(!n){if(r===-1){t=t.concat([e.newVReference])}else{t=t.slice(0,r).concat([e.newVReference],t.slice(r))}}if(!n||r>-1){m.update({parameters:t,updateURL:!e.model._bDesignTimeMode,updateHashEntry:true,model:e.model})}};m.removeURLParameterForVariantManagement=function(e){var a=h(e);if(a.index>-1){a.parameters.splice(a.index,1)}return a};m.attachHandlers=function(a){function t(){return a.model._oVariantSwitchPromise.then(function(){a.model._oHashData.controlPropertyObservers.forEach(function(e){e.destroy()});A(a.model);a.model.destroy();a.model.oComponentDestroyObserver.unobserve(a.model.oAppComponent,{destroy:true});a.model.oComponentDestroyObserver.destroy()})}f(a.model);if(!a.model.oComponentDestroyObserver&&a.model.oAppComponent instanceof e){a.model.oComponentDestroyObserver=new i(t.bind(null));a.model.oComponentDestroyObserver.observe(a.model.oAppComponent,{destroy:true})}};m.registerControl=function(e){if(e.updateURL){e.model._oHashData.variantControlIds.push(e.vmReference)}};m.update=function(e){if(!Array.isArray(e.parameters)){a.info("Variant URL parameters could not be updated since invalid parameters were received");return}if(e.updateURL){R(e)}if(e.updateHashEntry){e.model._oHashData.hashParams=e.parameters}};m.getStoredHashParams=function(e){return Array.prototype.slice.call(e.model._oHashData.hashParams)};m.handleModelContextChange=function(e){var a="modelContextChange";function t(a,t){var r=t.model.getVariantManagementReferenceForControl(a.getSource());var n=t.model._oHashData.variantControlIds;var o=n.indexOf(r);if(o>-1){n.slice(o).forEach(function(a){if(h({vmReference:a,model:e.model}).index===-1){t.model.switchToDefaultForVariantManagement(a)}})}}var r=new i(function(r){if(r.current===true&&r.old===false){r.object.attachEvent(a,{model:e.model},t)}else if(r.current===false&&r.old===true){r.object.detachEvent(a,t)}});r.observe(e.vmControl,{properties:["resetOnContextChange"]});e.model._oHashData.controlPropertyObservers.push(r);if(e.vmControl.getResetOnContextChange()!==false){e.vmControl.attachEvent(a,{model:e.model},t)}};m.clearAllVariantURLParameters=function(e){if(v(e.model)){m.update({updateURL:true,parameters:[],updateHashEntry:false,model:e.model})}};return m});
//# sourceMappingURL=URLHandler.js.map