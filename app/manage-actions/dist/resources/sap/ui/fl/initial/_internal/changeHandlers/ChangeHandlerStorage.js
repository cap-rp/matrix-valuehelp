/*!
* OpenUI5
 * (c) Copyright 2025 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
*/
sap.ui.define(["sap/base/util/each","sap/base/util/ObjectPath","sap/base/Log","sap/ui/fl/Layer","sap/ui/fl/registry/Settings","sap/ui/fl/requireAsync"],function(e,n,r,t,a,o){"use strict";const i={};let l={};let s={};let c={};let u={};const f="defaultForAll";function g(e){if(!e.changeHandler){r.error("sap.ui.fl.registry.ChangeRegistryStorage: changeHandler required");return false}return true}async function h(e){if(typeof e.changeHandler==="string"){const n=await o(e.changeHandler.replace(/\./g,"/"));e.changeHandler=n}return e.changeHandler}function d(e,n){let r={};if(!n||!n.changeHandler){r.changeHandler=n}else{r=n}if(r.changeHandler==="default"){r.changeHandler=c.defaultChangeHandlers[e]}else if(Object.keys(c.developerChangeHandlers||{}).includes(e)){throw Error(`You can't use a custom change handler for the following Developer Mode change type: ${e}. Please use 'default' instead.`)}return r}function y(n){s={};e(n,function(e,n){const r={controlType:"defaultActiveForAll",changeHandler:n,layers:a.getDeveloperModeLayerPermissions(),changeType:e};s[e]=r})}function p(n,r,t){t=d(r,t);const o={...a.getDefaultLayerPermissions()};if(t.layers){e(t.layers,function(e,n){if(o[e]===undefined){throw Error(`The Layer '${e}' is not supported. Please only use supported layers`)}o[e]=n})}const i={controlType:n,changeHandler:t.changeHandler,layers:o,changeType:r};return g(i)?i:undefined}function C(e,n,r){const t=p(e,n,r);if(t){l[e]||={};l[e][n]=t}}function H(n,t){let a=Promise.resolve(t);const i="ChangeHandlerStorage.registerChangeHandlersForControl.skip_next_then";if(typeof t==="string"){a=o(`${t}.flexibility`).catch(function(e){r.error(`Flexibility change handler registration failed.\nControlType: ${n}\n${e.message}`);return Promise.resolve(i)})}return a.then(function(r){if(r!==i){e(r,function(e,r){C(n,e,r)})}}).catch(function(e){r.error(e.message)})}function m(e,n,r){const a=l[e]&&l[e][n]||s[n];if(!a){throw Error("No Change handler registered for the Control and Change type")}r=r===t.PUBLIC?t.USER:r;if(!a.layers[r]){throw Error(`Change type ${n} not enabled for layer ${r}`)}return a}function P(e,n,t,a){const i=a.getChangeHandlerModulePath(t);if(typeof i!=="string"){return Promise.resolve(undefined)}return o(i).then(function(r){const t=r[e];if(t){return p(n,e,t)}}).catch(function(e){r.error(`Flexibility registration for control ${a.getId(t)} failed to load module ${i}\n${e.message}`)})}i.getChangeHandler=function(e,n,r,t,a){return P(e,n,r,t).then(function(r){const t=r||m(n,e,a);return h(t)}).then(function(e){if(typeof e.completeChangeContent!=="function"||typeof e.applyChange!=="function"||typeof e.revertChange!=="function"){throw new Error("The ChangeHandler is either not available or does not have all required functions")}return e})};i.registerPredefinedChangeHandlers=function(e,n){c.defaultChangeHandlers=e;c.developerChangeHandlers=n;y(n)};i.registerChangeHandlersForLibrary=function(n){const r=[];e(n,function(e,n){r.push(H(e,n))});return Promise.all(r)};i.clearAll=function(){l={};s={};c={};u={}};i.registerChangeHandlersForControl=function(e,n){return H(e,n)};i.registerAnnotationChangeHandler=function(e){const n=e.isDefaultChangeHandler?f:e.changeType;u[n]={changeHandler:e.changeHandler}};i.getAnnotationChangeHandler=function(e){const n=u[e.changeType]||u[f];if(!n){throw Error("No Annotation Change handler registered for the Change type and Model type")}return h(n)};return i});
//# sourceMappingURL=ChangeHandlerStorage.js.map