/*!
 * OpenUI5
 * (c) Copyright 2025 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["sap/base/util/restricted/_omit","sap/base/util/restricted/_pick","sap/ui/core/Element","sap/ui/fl/Layer","sap/ui/fl/Utils","sap/ui/fl/apply/_internal/flexObjects/CompVariant","sap/ui/fl/apply/_internal/flexObjects/CompVariantRevertData","sap/ui/fl/apply/_internal/flexObjects/FlexObjectFactory","sap/ui/fl/apply/_internal/flexObjects/RevertData","sap/ui/fl/apply/_internal/flexObjects/States","sap/ui/fl/apply/_internal/flexObjects/UpdatableChange","sap/ui/fl/apply/_internal/flexState/compVariants/CompVariantMerger","sap/ui/fl/apply/_internal/flexState/compVariants/CompVariantManagementState","sap/ui/fl/apply/_internal/flexState/FlexState","sap/ui/fl/initial/api/Version","sap/ui/fl/registry/Settings","sap/ui/fl/write/_internal/Storage","sap/ui/fl/write/_internal/Versions"],function(e,t,n,a,r,i,o,s,c,p,f,u,l,d,g,v,y,C){"use strict";function S(e,t){var n=h("/draftFilenames",t);if(n){return e.getState()===p.LifecycleState.NEW||n.includes(e.getId())}return true}function h(e,t){var t={reference:t.reference,layer:t.layer};if(C.hasVersionsModel(t)){return C.getVersionsModel(t).getProperty(e)}return undefined}function m(e,t){var n=e.getFlexObjectMetadata?e.getFlexObjectMetadata().changeType:e.getChangeType();if(!["defaultVariant","updateVariant"].includes(n)){return false}var a=e.getLayer()===t.layer;var r=e.getFlexObjectMetadata().packageName;var i=!r||r==="$TMP";return a&&i&&S(e,t)}function V(e,t){if(t.isVariant&&t.isVariant()){return e.variants}var n=t.getChangeType();switch(n){case"defaultVariant":return e.defaultVariants;case"standardVariant":return e.standardVariants;default:return e.changes}}function x(e,t){for(var n=0;n<e.length;n++){if(e[n].fileName===t.fileName){e.splice(n,1,t);break}}}function O(e,t,n,a){return y.update({flexObject:e.convertToFileContent(),layer:e.getLayer(),transport:e.getRequest(),parentVersion:n}).then(function(t){if(t&&t.response){e.setResponse(t.response);if(n){C.onAllChangesSaved({reference:t.response.reference,layer:t.response.layer,draftFilenames:t.response.fileName})}}else{e.setState(p.LifecycleState.PERSISTED)}}).then(function(){var n=V(t.changes.comp,e);var r=e.convertToFileContent();d.getFlexObjectsDataSelector().checkUpdate({reference:a});x(n,r);return r})}function I(e,t){for(var n=e.length-1;n>=0;n--){var a=e[n].fileName||e[n].getId()&&e[n].getId();if((a||e[n].getId())===t){e.splice(n,1);break}}}function D(e,t){delete t.byId[e.getId()];if(e.getChangeType()==="standardVariant"){t.standardVariantChange=undefined}else{I(V(t,e),e.getId())}}function b(e,t,n,a,r){var i=e.convertToFileContent();return y.remove({flexObject:i,layer:e.getLayer(),transport:e.getRequest(),parentVersion:a}).then(function(){D(e,t)}).then(C.updateModelFromBackend.bind(this,{reference:i.reference,layer:i.layer})).then(function(){I(V(n.changes.comp,e),i.fileName);d.getFlexObjectsDataSelector().checkUpdate({reference:r});return i})}function T(e){var t={};if(typeof e.texts==="object"){Object.keys(e.texts).forEach(function(n){t[n]={value:e.texts[n],type:"XFLD"}})}return t}function E(e){return e&&[p.LifecycleState.NEW,p.LifecycleState.UPDATED,p.LifecycleState.DELETED].includes(e.getState())}function U(e){return e.variants.concat(e.changes).concat(e.defaultVariants).concat(e.standardVariantChange)}function F(e){if(e.layer){return e.layer}if(e.isUserDependent){return a.USER}var t=new URLSearchParams(window.location.search).get("sap-ui-layer")||"";t=t.toUpperCase();if(t){return t}if(!e.fileType==="variant"){return a.CUSTOMER}var n=v.getInstanceOrUndef().isPublicLayerAvailable();return n?a.PUBLIC:a.CUSTOMER}function L(e){var t=d.getCompVariantsMap(e.reference)._getOrCreate(e.persistencyKey);return t.byId[e.id]}function R(e){if(e instanceof i){e.removeAllRevertData()}}function N(e,t){e.storeExecuteOnSelection(t.executeOnSelection);e.storeFavorite(t.favorite);e.storeContexts(t.contexts);e.storeName(t.name);e.storeContent(t.content||e.getContent());return e}function A(e,t){e.setExecuteOnSelection(t.executeOnSelection);e.setFavorite(t.favorite);e.setContexts(t.contexts);e.setName(t.name);e.setContent(t.content||e.getContent());return e}function M(e){if(e&&e.getRevertData().length){let t;e.getRevertData().reverse().some(e=>{t=e.getContent();return t.previousAction===w.updateActionType.SAVE});N(e,{name:t.previousName,content:t.previousContent,favorite:t.previousFavorite,executeOnSelection:t.previousExecuteOnSelection,contexts:t.previousContexts});e.setState(t.previousState)}}function j(e){if(e.layer===a.VENDOR){e.support={user:"SAP"}}else if(v.getInstanceOrUndef()&&v.getInstanceOrUndef().getUserId()){e.support={user:v.getInstanceOrUndef().getUserId()}}}function _(e){const t=d.getCompVariantsMap(e);const a=[];if(t){Object.values(t).forEach(function(e){const t=e.controlId&&n.getElementById(e.controlId);if(t){a.push(t)}})}return a}var w={};w.checkSVMControlsForDirty=function(e){return _(e).some(e=>e.getModified())};w.setDefault=function(e){var t={defaultVariantName:e.defaultVariantId};e.layer||=new URLSearchParams(window.location.search).get("sap-ui-layer")||a.USER;let n=l.getDefaultChanges(e).slice(-1)[0];if(!n||!m(n,e)){var i=d.getCompVariantsMap(e.reference)._getOrCreate(e.persistencyKey);var o="defaultVariant";var p={fileName:r.createDefaultFileName(o),fileType:"change",changeType:o,layer:e.layer,content:t,namespace:r.createNamespace(e,"changes"),reference:e.reference,selector:{persistencyKey:e.persistencyKey},support:e.support||{}};p.adaptationId=e.changeSpecificData?.adaptationId;p.support.generator||=`CompVariantState.${o}`;n=s.createFromFileContent(p,f);i.byId[n.getId()]=n;n.addRevertInfo(new c({type:w.operationType.NewChange}));d.addDirtyFlexObjects(e.reference,[n])}else{n.addRevertInfo(new c({type:w.operationType.ContentUpdate,content:{previousState:n.getState(),previousContent:n.getContent()}}));n.setContent(t)}return n};w.revertSetDefaultVariantId=function(e){const t=l.getDefaultChanges(e);const n=t?.slice(-1)[0];const a=n.popLatestRevertInfo();if(a.getType()===w.operationType.ContentUpdate){n.setContent(a.getContent().previousContent);n.setState(a.getContent().previousState)}else{n.setState(p.LifecycleState.DELETED);t.pop()}};w.addVariant=function(t){if(!t){return undefined}const n=t.changeSpecificData;n.layer=F(n);n.changeType=n.type;n.texts=T(n);j(n);const r={...n,...e(t,"changeSpecificData")};const i=s.createCompVariant(r);const o=d.getCompVariantsMap(t.reference);const c=o._getOrCreate(t.persistencyKey);c.variants.push(i);c.byId[i.getId()]=i;d.addDirtyFlexObjects(t.reference,[i]);if(n.layer!==a.USER&&n.layer!==a.PUBLIC){t.id=t.control.getCurrentVariantId();M(L(t))}return i};w.updateVariant=function(e){function n(t,n){var a=t.getLayer()===n;var r=t.getFlexObjectMetadata().packageName;var i=!r||r==="$TMP";var o=t.getChanges().some(function(e){return e.getLayer()===n});return t.getPersisted()&&a&&i&&!o&&S(t,e)}function r(t){return t.getChanges().reverse().find(function(t){return t.getChangeType()==="updateVariant"&&m(t,e)})}function i(e,t,n,a){var r={type:n,change:a,content:{previousState:t.getState(),previousContent:t.getContent(),previousFavorite:t.getFavorite(),previousVisible:t.getVisible(),previousExecuteOnSelection:t.getExecuteOnSelection(),previousContexts:t.getContexts(),previousName:t.getName(),previousAction:e.action}};t.addRevertData(new o(r))}function c(e,t){i(e,t,w.operationType.ContentUpdate);if(e.executeOnSelection!==undefined){t.storeExecuteOnSelection(e.executeOnSelection)}if(e.layer===a.PUBLIC){t.storeFavorite(false)}else if(e.favorite!==undefined){t.storeFavorite(e.favorite)}if(e.visible!==undefined){t.storeVisible(e.visible)}if(e.contexts){t.storeContexts(e.contexts)}if(e.name){t.storeName(e.name)}if(e.transportId){t.setRequest(e.transportId)}t.storeContent(e.content||t.getContent())}function p(e,n,a){const r=a.getRevertData()||[];const o={...a.getContent()};const s={previousContent:{...o},previousState:a.getState(),change:t(e,["favorite","visible","executeOnSelection","contexts","content","name"])};r.push(s);a.setRevertData(r);if(e.executeOnSelection!==undefined){o.executeOnSelection=e.executeOnSelection}if(e.favorite!==undefined){o.favorite=e.favorite}if(e.visible!==undefined){o.visible=e.visible}if(e.contexts){o.contexts=e.contexts}if(e.content){o.variantContent=e.content}if(e.adaptationId){a.setAdaptationId(e.adaptationId)}if(e.name){a.setText("variantName",e.name)}a.setContent(o);if(e.transportId){a.setRequest(e.transportId)}i(e,n,w.operationType.UpdateVariantViaChangeUpdate,a);u.applyChangeOnVariant(n,a)}function f(e,t){function n(t){var n=d.getCompVariantsMap(e.reference);var a=t.getSelector().persistencyKey;n[a].changes.push(t);n[a].byId[t.getId()]=t;d.addDirtyFlexObjects(e.reference,[t])}var a={};["favorite","visible","executeOnSelection","contexts"].forEach(function(t){if(e[t]!==undefined){a[t]=e[t]}});if(e.content!==undefined){a.variantContent=e.content}var r=s.createUIChange({changeType:"updateVariant",layer:g,fileType:"change",reference:e.reference,packageName:e.packageName,content:a,selector:{persistencyKey:e.persistencyKey,variantId:t.getVariantId()}});const o=e.adaptationId||e?.changeSpecificData?.adaptationId;if(o){r.setAdaptationId(o)}if(e.name){r.setText("variantName",e.name,"XFLD",true)}if(e.transportId){r.setRequest(e.transportId)}n(r);i(e,t,w.operationType.NewChange,r);u.applyChangeOnVariant(t,r)}var l=L(e);var g=F(e);e.layer||=g;if(e.forceCreate){f(e,l)}else if(n(l,g)){c(e,l)}else{var v=r(l);if(v){p(e,l,v)}else{f(e,l)}}return l};w.discardVariantContent=function(e){var t=L(e);var n=t.getRevertData();if(n.length!==0){var a=n.slice().reverse().some(function(t){e.layer=t.getChange()?.getLayer();if(t.getContent().previousAction===w.updateActionType.SAVE){e.content=t.getContent().previousContent;e.action=w.updateActionType.DISCARD;return true}});if(!a){e.content=n[0].getContent().previousContent;e.action=w.updateActionType.DISCARD}w.updateVariant(e)}return t};w.updateActionType={UPDATE:"update",SAVE:"save",DISCARD:"discard",UPDATE_METADATA:"update_metadata"};w.operationType={StateUpdate:"StateUpdate",ContentUpdate:"ContentUpdate",NewChange:"NewChange",UpdateVariantViaChange:"UpdateVariantViaChange",UpdateVariantViaChangeUpdate:"UpdateVariantViaChangeUpdate"};w.removeVariant=function(e){var t=L(e);var n=t.getState();if(!e.revert){var a=new o({type:w.operationType.StateUpdate,content:{previousState:n}});t.addRevertData(a)}t.markForDeletion();return t};w.revert=function(e){function n(t){var n=t.getSelector().persistencyKey;var a=d.getCompVariantsMap(e.reference);delete a[n].byId[t.getId()];a[n].changes=a[n].changes.filter(function(e){return e!==t});d.removeDirtyFlexObjects(e.reference,[t])}var a=L(e);var r=a.getRevertData().pop();a.removeRevertData(r);var i=r.getContent();var o;switch(r.getType()){case w.operationType.ContentUpdate:N(a,{name:i.previousName,content:i.previousContent,favorite:i.previousFavorite,executeOnSelection:i.previousExecuteOnSelection,contexts:i.previousContexts,...t(e,["reference","persistencyKey","id"])});break;case w.operationType.NewChange:o=r.getChange();a.removeChange(o);n(o);A(a,{name:i.previousName,content:i.previousContent,favorite:i.previousFavorite,executeOnSelection:i.previousExecuteOnSelection,contexts:i.previousContexts,...t(e,["reference","persistencyKey","id"])});break;case w.operationType.UpdateVariantViaChangeUpdate:o=r.getChange();A(a,{...{name:i.previousName,content:i.previousContent,favorite:i.previousFavorite,executeOnSelection:i.previousExecuteOnSelection,contexts:i.previousContexts},...t(e,["reference","persistencyKey","id"])});var s=o.getRevertData().pop();o.setContent(s.previousContent);o.setState(s.previousState);break;case w.operationType.StateUpdate:default:break}a.setState(i.previousState);return a};w.overrideStandardVariant=function(e){var t=d.getCompVariantsMap(e.reference)[e.persistencyKey];var n=t.byId[t.standardVariant.getVariantId()];n.setExecuteOnSelection(!!e.executeOnSelection);var a=n.getChanges();n.removeAllChanges();a.forEach(function(e){u.applyChangeOnVariant(n,e)})};w.persist=async function(e){function t(t,n,r){if(t.getLayer()===a.PUBLIC){t.setFavorite(false)}return y.write({flexObjects:[t.convertToFileContent()],layer:t.getLayer(),transport:t.getRequest(),isLegacyVariant:t.isVariant&&t.isVariant(),parentVersion:r}).then(function(e){if(e&&e.response&&e.response[0]){t.setResponse(e.response[0]);if(r){C.onAllChangesSaved({reference:e.response[0].reference,layer:e.response[0].layer,draftFilenames:[e.response[0].fileName]})}}else{t.setState(p.LifecycleState.PERSISTED)}}).then(function(){const a=t.convertToFileContent();V(n.changes.comp,t).push(a);d.getFlexObjectsDataSelector().checkUpdate({reference:e.reference});return a})}function n(n,a,r,i){switch(n.getState()){case p.LifecycleState.NEW:R(n);return t(n,r,i);case p.LifecycleState.UPDATED:R(n);return O(n,r,i,e.reference);case p.LifecycleState.DELETED:if(n._sPreviousState!==p.LifecycleState.NEW){R(n);return b(n,a,r,i,e.reference)}return Promise.resolve();default:return undefined}}const r=e.reference;const i=e.persistencyKey;const o=d.getCompVariantsMap(r);const s=o._getOrCreate(i);const c=l.getDefaultChanges({reference:e.reference,persistencyKey:e.persistencyKey});const f=[...U(s),...c];const u=await d.getStorageResponse(r);const v=f.filter(E);const S=v.map(function(e,t){if(t===0){const t=h("/persistedVersion",{layer:e.getLayer(),reference:e.getFlexObjectMetadata().reference});return n(e,s,u,t).then(function(){const e=v.map(function(e,a){if(a!==0){const a=t?g.Number.Draft:undefined;return n(e,s,u,a)}return undefined});return Promise.all(e)})}return undefined});return Promise.all(S)};w.persistAll=async function(t){const n=e(d.getCompVariantsMap(t),"_getOrCreate","_initialize");const a=[];const r=_(t);for(const e of Object.keys(n)){const n=await w.persist({reference:t,persistencyKey:e});a.push(n)}r.forEach(e=>{e.setModified(false)});return a};w.hasDirtyChanges=function(e){var t=d.getCompVariantsMap(e);var n=[];for(var a in t){var r=t[a];for(var i in r.byId){n.push(r.byId[i])}}return n.some(function(e){return e.getLayer()&&e.getState()!==p.LifecycleState.PERSISTED&&e.getVariantId?.()!=="*standard*"&&e.getState()!==p.LifecycleState.DELETED})};w.filterHiddenFlexObjects=function(t,n){const a=e(d.getCompVariantsMap(n),"_getOrCreate","_initialize");const r=[];for(const e in a){a[e].variants.forEach(e=>r.push(e.getId()))}return t.filter(e=>{if(e.getFileType()==="change"){if(e.getChangeType()==="updateVariant"){return r.includes(e.getSelector().variantId)}if(e.getChangeType()==="defaultVariant"){return!e.getContent().defaultVariantName||r.includes(e.getContent().defaultVariantName)}}return true})};return w});
//# sourceMappingURL=CompVariantState.js.map