/*!
 * OpenUI5
 * (c) Copyright 2025 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["sap/ui/fl/initial/api/Version","sap/ui/fl/initial/_internal/FlexInfoSession","sap/ui/fl/registry/Settings","sap/ui/fl/write/_internal/Storage","sap/ui/model/json/JSONModel","sap/ui/model/BindingMode"],function(e,r,t,i,n,s){"use strict";var a={};var o=9;var l=o+1;function d(r){var t=v(r);t.setDefaultBindingMode(s.OneWay);t.setSizeLimit(o);t.setDirtyChanges=function(e){t.setProperty("/dirtyChanges",e);t.updateDraftVersion();t.updateBindings(true)};t.updateDraftVersion=function(){var r=t.getProperty("/versions");var i=t.getProperty("/versioningEnabled");var n=t.getProperty("/dirtyChanges");var s=t.getProperty("/backendDraft");var a=i&&(n||s);t.setProperty("/draftAvailable",a);if(n){t.setProperty("/displayedVersion",e.Number.Draft)}if(!u(r)&&a){r.splice(0,0,{version:e.Number.Draft,type:e.Type.Draft,filenames:[],isPublished:false})}if(u(r)&&!a){r.shift();t.setProperty("/displayedVersion",t.getProperty("/persistedVersion"))}var o=t.getProperty("/displayedVersion")!==t.getProperty("/activeVersion");t.setProperty("/activateEnabled",o)};return t}function f(r,t){if(t!==e.Number.Original&&t!==e.Number.Draft){return r.some(function(e){return e.version===t&&e.isPublished===false})}return false}function v(t){var i;var s=e.Number.Original;var a=t.versions;var o=t.versionsModel;var l=u(a);var d=[];if(a.length>0){i=a[0].version}else{i=e.Number.Original}a.forEach(function(r){if(r.version===e.Number.Draft){r.type=e.Type.Draft;r.isPublished=false;d=r.filenames}else if(s===e.Number.Original){r.type=e.Type.Active;s=r.version}else{r.type=e.Type.Inactive}});if(o){o.setProperty("/publishVersionEnabled",f(a,i));o.setProperty("/versioningEnabled",t.versioningEnabled);o.setProperty("/versions",a);o.setProperty("/backendDraft",l);o.setProperty("/dirtyChanges",false);o.setProperty("/draftAvailable",l);o.setProperty("/activateEnabled",l);o.setProperty("/activeVersion",s);o.setProperty("/persistedVersion",i);o.setProperty("/displayedVersion",i);o.setProperty("/draftFilenames",d);o.updateBindings(true)}else{var v=r.getByReference(t.reference);return new n({publishVersionEnabled:f(a,v.version||i),versioningEnabled:t.versioningEnabled,versions:a,backendDraft:l,dirtyChanges:false,draftAvailable:l,activateEnabled:l,activeVersion:s,persistedVersion:v.version||i,displayedVersion:v.version||i,draftFilenames:d})}return o}function u(r){return r.some(function(r){return r.version===e.Number.Draft})}function p(e,r){e.setProperty("/backendDraft",false);e.setProperty("/dirtyChanges",false);e.setProperty("/draftAvailable",false);e.setProperty("/activateEnabled",false);e.setProperty("/displayedVersion",r);e.setProperty("/persistedVersion",r);e.updateBindings(true)}var y={};y.initialize=function(e){var r=e.reference;var n=e.layer;e.limit=l;return t.getInstance().then(function(t){var s=t.isVersioningEnabled(n);if(a&&a[r]&&a[r][n]){return a[r][n]}var o=s?i.versions.load(e):Promise.resolve([]);return o.then(function(r){e.versioningEnabled=s;e.versions=r;return d(e)}).then(function(e){a[r]||={};a[r][n]||={};a[r][n]=e;return a[r][n]})})};y.getVersionsModel=function(e){var r=e.reference;var t=e.layer;if(!y.hasVersionsModel(e)){throw Error(`Versions Model for reference '${r}' and layer '${t}' were not initialized.`)}return a[r][t]};y.hasVersionsModel=function(e){var r=e.reference;var t=e.layer;return!!(a[r]&&a[r][t])};y.clearInstances=function(){a={}};y.updateModelFromBackend=function(e){if(y.hasVersionsModel(e)&&y.getVersionsModel(e).getProperty("/versioningEnabled")){e.limit=l;return i.versions.load(e).then(function(r){var t=y.getVersionsModel(e);e.versioningEnabled=t.getProperty("/versioningEnabled");e.versions=r;e.versionsModel=t;return v(e)})}return undefined};y.onAllChangesSaved=function(r){var t=y.getVersionsModel(r);var i=t.getProperty("/versioningEnabled");var n=t.getProperty("/dirtyChanges");var s=t.getProperty("/draftFilenames");t.setProperty("/draftFilenames",s.concat(r.draftFilenames));t.setProperty("/dirtyChanges",true);t.setProperty("/backendDraft",i&&n||!!r.contextBasedAdaptation);t.updateDraftVersion();t.setProperty("/persistedVersion",e.Number.Draft);t.updateBindings(true)};y.activate=function(r){var t=y.getVersionsModel(r);var n=t.getProperty("/versions");var s=u(n);var a=t.getProperty("/activeVersion");if(r.displayedVersion===a){return Promise.reject("Version is already active")}r.version=r.displayedVersion;return i.versions.activate(r).then(function(r){n.forEach(function(r){r.type=e.Type.Inactive});r.type=e.Type.Active;r.isPublished=false;if(s){n.shift()}n.splice(0,0,r);t.setProperty("/activeVersion",r.version);t.setProperty("/publishVersionEnabled",true);t.setProperty("/draftFilenames",[]);p(t,r.version)})};y.discardDraft=function(e){var r=y.getVersionsModel(e);var t=r.getProperty("/backendDraft");var n=t?i.versions.discardDraft(e):Promise.resolve();return n.then(function(){var i=r.getProperty("/versions");i.shift();let n=r.getProperty("/activeVersion");if(e.discardDraftAndKeepActiveVersion){n=r.getProperty("/displayedVersion")}p(r,n);return{backendChangesDiscarded:t}})};y.publish=function(e){var r=y.getVersionsModel({reference:e.reference,layer:e.layer});return i.versions.publish(e).then(function(t){if(t!=="Error"&&t!=="Cancel"){r.setProperty("/publishVersionEnabled",false);var i=r.getProperty("/versions");var n=false;i.forEach(function(r){if(r.isPublished){return}if(r.version===e.version){n=true}if(n&&!r.isPublished){r.isPublished=true}})}return t})};return y});
//# sourceMappingURL=Versions.js.map