/*!
 * OpenUI5
 * (c) Copyright 2025 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["sap/base/util/restricted/_omit","sap/ui/core/util/reflection/JsControlTreeModifier","sap/ui/fl/apply/_internal/changes/Reverter","sap/ui/fl/apply/_internal/flexObjects/FlexObjectFactory","sap/ui/fl/apply/_internal/flexObjects/States","sap/ui/fl/apply/_internal/flexState/changes/DependencyHandler","sap/ui/fl/apply/_internal/flexState/changes/UIChangesState","sap/ui/fl/apply/_internal/flexState/compVariants/CompVariantMerger","sap/ui/fl/apply/_internal/flexState/controlVariants/VariantManagementState","sap/ui/fl/apply/_internal/flexState/FlexObjectState","sap/ui/fl/apply/_internal/flexState/FlexState","sap/ui/fl/apply/_internal/flexState/ManifestUtils","sap/ui/fl/write/_internal/flexState/compVariants/CompVariantState","sap/ui/fl/write/_internal/Storage","sap/ui/fl/write/_internal/Versions","sap/ui/fl/LayerUtils","sap/ui/fl/requireAsync","sap/ui/fl/Utils"],function(e,t,n,r,a,c,i,l,s,o,f,p,u,g,y,d,F,x){"use strict";const h={};function C(e){const t=[];const n=f.getCompVariantsMap(e.reference);for(const e in n){const r=n[e];for(const e in r.byId){t.push(r.byId[e])}}return d.filterChangeOrChangeDefinitionsByCurrentLayer(t,e.currentLayer)}function O(e){const t=f.getCompVariantsMap(e.reference);const n=f.getInitialNonFlCompVariantData(e.reference);if(n){Object.keys(n).forEach(function(e){t._initialize(e,n[e].variants,n[e].controlId);l.merge(e,t[e],n[e].standardVariant)})}}function b(e){var t=p.getFlexReferenceForControl(e.selector);return u.persistAll(t)}function j(e,t){if(t.isValidForDependencyMap()){c.removeChangeFromMap(o.getLiveDependencyMap(e),t.getId());c.removeChangeFromDependencies(o.getLiveDependencyMap(e),t.getId())}}async function S(e,t){const n=await F("sap/ui/fl/FlexControllerFactory");var r=n.createForSelector(e.selector);return r.saveAll(t,e.skipUpdateCache,e.draft,e.layer,e.removeOtherLayerChanges,e.condenseAnyLayer)}function m(e){return typeof e.isA==="function"&&e.isA("sap.ui.fl.apply._internal.flexObjects.FlexObject")?e:r.createFromFileContent(e)}h.filterHiddenFlexObjects=function(e,t){const n=s.filterHiddenFlexObjects(e,t);return u.filterHiddenFlexObjects(n,t)};h.getFlexObjects=async function(e){e.reference=p.getFlexReferenceForControl(e.selector);if(e.invalidateCache){await f.update(e);O(e)}let t=i.getVariantIndependentUIChanges(e.reference);if(!e.includeCtrlVariants){t=t.concat(s.getInitialUIChanges({reference:e.reference,includeDirtyChanges:true}))}else if(!e.onlyCurrentVariants){t=t.concat(s.getVariantDependentFlexObjects(e.reference))}else{t=t.concat(s.getAllCurrentFlexObjects({reference:e.reference}))}if(e.includeManifestChanges){t=t.concat(f.getAppDescriptorChanges(e.reference))}if(e.includeAnnotationChanges){t=t.concat(f.getAnnotationChanges(e.reference))}if(e.currentLayer){t=t.filter(t=>t.getLayer()===e.currentLayer)}return t.concat(C(e))};h.hasDirtyFlexObjects=function(e){var t=p.getFlexReferenceForSelector(e.selector);return o.getDirtyFlexObjects(t).length>0||u.hasDirtyChanges(t)};h.addDirtyFlexObjects=function(e,t){return f.addDirtyFlexObjects(e,t.map(m))};h.removeDirtyFlexObjects=function(e){const n=[].concat(e.layers||[]);const r=o.getDirtyFlexObjects(e.reference);const a=r.filter(r=>{let a=true;if(n.length&&!n.includes(r.getLayer())){return false}if(e.generator&&r.getSupportInformation().generator!==e.generator){return false}if(e.control){const n=t.getControlIdBySelector(r.getSelector(),e.component);a=e.control.getId()===n}if(e.changeTypes){a&&=e.changeTypes.includes(r.getChangeType())}return a});return f.removeDirtyFlexObjects(e.reference,a)};h.saveFlexObjects=async function(t){var n=x.getAppComponentForSelector(t.selector);t.reference=p.getFlexReferenceForControl(t.selector);await b(t);await S(t,n);if(t.version!==undefined&&y.hasVersionsModel(t)){var r=y.getVersionsModel(t);t.version=r.getProperty("/displayedVersion")}if(t.layer){t.currentLayer=t.layer}t.componentId=n.getId();t.invalidateCache=true;return h.getFlexObjects(e(t,"skipUpdateCache"))};h.deleteFlexObjects=function(e){const t=o.getDirtyFlexObjects(e.reference);const n=[];const r=[];e.flexObjects.forEach(function(c){if(t.indexOf(c)>-1&&c.getState()===a.LifecycleState.NEW){r.push(c)}else{c.markForDeletion();n.push(c)}j(e.reference,c)});f.removeDirtyFlexObjects(e.reference,r);const c=h.addDirtyFlexObjects(e.reference,n);if(!r.length&&!c.length){const t=f.getFlexObjectsDataSelector();t.checkUpdate({reference:e.reference})}};h.restoreDeletedFlexObjects=function(e){const t=e.flexObjects.filter(e=>e.getState()===a.LifecycleState.DELETED||e.getState()===a.LifecycleState.NEW);t.forEach(e=>{e.restorePreviousState()});const n=t.filter(e=>e.getState()!==a.LifecycleState.PERSISTED);h.addDirtyFlexObjects(e.reference,n)};h.resetFlexObjects=async function(e){const r=p.getFlexReferenceForControl(e.appComponent);const a=await h.getFlexObjects({selector:e.appComponent,currentLayer:e.layer,includeCtrlVariants:true});const c={reference:r,layer:e.layer,changes:a};if(e.generator){c.generator=e.generator}if(e.selectorIds){c.selectorIds=e.selectorIds}if(e.changeTypes){c.changeTypes=e.changeTypes}const i=await g.reset(c);if(e.selectorIds||e.changeTypes||e.generator){const c=[];if(i?.response?.length>0){i.response.forEach(function(e){c.push(e.fileName)})}const l=a.filter(function(e){return c.indexOf(e.getId())!==-1});f.updateStorageResponse(r,l.map(e=>({flexObject:e.convertToFileContent(),type:"delete"})));if(l.length){await n.revertMultipleChanges([...l].reverse(),{appComponent:e.appComponent,modifier:t,reference:r})}}};return h});
//# sourceMappingURL=FlexObjectManager.js.map