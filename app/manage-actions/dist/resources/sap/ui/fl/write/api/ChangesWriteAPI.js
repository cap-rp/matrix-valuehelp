/*!
 * OpenUI5
 * (c) Copyright 2025 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["sap/base/util/restricted/_omit","sap/base/Log","sap/ui/core/util/reflection/JsControlTreeModifier","sap/ui/core/Component","sap/ui/core/Element","sap/ui/core/Lib","sap/ui/fl/apply/_internal/appVariant/DescriptorChangeTypes","sap/ui/fl/apply/_internal/changes/Applier","sap/ui/fl/apply/_internal/changes/Reverter","sap/ui/fl/apply/_internal/changes/Utils","sap/ui/fl/apply/_internal/flexObjects/FlexObjectFactory","sap/ui/fl/apply/_internal/flexObjects/States","sap/ui/fl/apply/_internal/flexState/FlexObjectState","sap/ui/fl/apply/_internal/flexState/ManifestUtils","sap/ui/fl/descriptorRelated/api/DescriptorChangeFactory","sap/ui/fl/initial/_internal/changeHandlers/ChangeHandlerStorage","sap/ui/fl/write/_internal/appVariant/AppVariantInlineChangeFactory","sap/ui/fl/write/_internal/controlVariants/ControlVariantWriteUtils","sap/ui/fl/write/_internal/flexState/FlexObjectManager","sap/ui/fl/write/api/ContextBasedAdaptationsAPI","sap/ui/fl/write/api/VersionsAPI","sap/ui/fl/Utils"],function(e,t,n,a,r,o,i,c,p,l,s,g,f,h,u,d,C,m,y,S,D,v){"use strict";var F={};function T(e){let n;if(e.changeSpecificData.layer){n=e.changeSpecificData.layer;delete e.changeSpecificData.layer}const a={changeType:e.changeSpecificData.changeType,content:e.changeSpecificData.content};if(e.changeSpecificData.texts){a.texts=e.changeSpecificData.texts}if(e.changeSpecificData.support){a.support={compositeCommand:e.changeSpecificData.support.compositeCommand||""}}if(e.changeSpecificData.adaptationId){a.adaptationId=e.changeSpecificData.adaptationId}return C.createDescriptorInlineChange(a).then(t=>(new u).createNew(e.changeSpecificData.reference,t,n,undefined,e.generator)).catch(e=>{t.error("the change could not be created.",e.message);throw e})}async function x(e){const t=await d.getAnnotationChangeHandler({changeType:e.changeSpecificData.changeType});const a=s.createAnnotationChange(e.changeSpecificData);t.completeChangeContent(a,e.changeSpecificData,{modifier:n,appComponent:e.appComponent});return a}function w(e){const a=s.createUIChange(e.changeSpecificData);return d.getChangeHandler(a.getChangeType(),e.controlType,e.selector,n,a.getLayer()).then(r=>{const o={...e.changeSpecificData};if(o.content){Object.keys(o.content).forEach(e=>{if(!o[e]){o[e]=o.content[e]}else{t.warning(`The property '${e}' is defined both in the change specific data and its content.`)}})}return r.completeChangeContent(a,o,{modifier:n,appComponent:e.appComponent,view:v.getViewForControl(e.selector)})}).then(()=>{a.setState(g.LifecycleState.NEW);return a})}F.create=function(e){const{changeSpecificData:t,selector:r}=e;if(t.changeType==="codeExt"){return s.createControllerExtensionChange(t)}e.appComponent=v.getAppComponentForSelector(r.view||r);if(r?.appId||h.getFlexReferenceForControl(e.appComponent)){t.reference=r?.appId||h.getFlexReferenceForControl(e.appComponent)}const o={layer:t.layer,control:e.appComponent,reference:t.reference};if(S.hasAdaptationsModel(o)){t.adaptationId=S.getDisplayedAdaptationId(o)}if(i.getChangeTypes().includes(t.changeType)){return T(e)}if(e.changeSpecificData.changeType==="deactivateChanges"){return s.createFlexObject(e.changeSpecificData)}if(e.annotationChange){return x(e)}if(r instanceof a){return Promise.resolve(s.createUIChange(t))}if(r.name&&r.view){t.selector={name:r.name,viewSelector:n.getSelector(r.view.getId(),e.appComponent)};return w(e)}const c=r.id||r.getId();t.selector||={};Object.assign(t.selector,n.getSelector(c,e.appComponent));e.controlType=r.controlType||v.getControlType(r);return w(e)};F.apply=function(t){if(!(t.element instanceof r)){return Promise.reject("Please provide an Element")}t.appComponent=v.getAppComponentForSelector(t.element);t.modifier||=n;return c.applyChangeOnControl(t.change,t.element,e(t,["element","change"])).then(function(e){var a=f.getOpenDependentChangesForControl(n.getControlIdBySelector(t.change.getSelector(),t.appComponent),t.appComponent);if(a.length>0){return F.revert({change:t.change,element:t.element}).then(function(){var e=o.getResourceBundleFor("sap.ui.fl");var n=a.map(function(e){return e.getId()}).join(", ");throw Error(e.getText("MSG_DEPENDENT_CHANGE_ERROR",[t.change.getId(),n]))})}return e})};F.revert=function(e){var t=v.getAppComponentForSelector(e.element||{});var a=[];var r={modifier:n,appComponent:t};if(!Array.isArray(e.change)){return p.revertChangeOnControl(e.change,e.element,r)}var o=e.change.slice(0).reverse();return o.reduce(function(t,n){return t.then(function(){return p.revertChangeOnControl(n,e.element,r).then(function(e){a.unshift(e)})})},Promise.resolve()).then(function(){return a})};F.getChangeHandler=function(e){var t=e.controlType||e.modifier?.getControlType(e.element);return l.getChangeHandler({changeType:e.changeType,control:e.element,controlType:t,modifier:e.modifier,layer:e.layer,appDescriptorChange:e.appDescriptorChange,annotationChange:e.annotationChange})};F.deleteVariantsAndRelatedObjects=function(e){if(!e.variantManagementControl?.isA("sap.ui.fl.variants.VariantManagement")){throw new Error("Please provide a valid Variant Management control")}const t=e.variantManagementControl;const a=v.getAppComponentForControl(t);const r=n.getSelector(t,a).id;const o=h.getFlexReferenceForControl(a);const i=D.getDraftFilenames({control:t,layer:e.layer});const c=f.getDirtyFlexObjects(o).map(e=>e.getId());const p=e.variants.filter(e=>i.includes(e)||c.includes(e));return p.map(e=>m.deleteVariant(o,r,e)).flat()};F.restoreDeletedFlexObjects=function(e){y.restoreDeletedFlexObjects(e)};return F});
//# sourceMappingURL=ChangesWriteAPI.js.map