/*
 * ! OpenUI5
 * (c) Copyright 2025 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["sap/base/util/restricted/_difference","sap/base/util/merge","sap/base/util/ObjectPath","sap/ui/core/util/reflection/JsControlTreeModifier","sap/ui/core/Element","sap/ui/fl/apply/_internal/changes/Applier","sap/ui/fl/apply/_internal/changes/Reverter","sap/ui/fl/apply/_internal/flexObjects/FlexObjectFactory","sap/ui/fl/apply/_internal/flexObjects/States","sap/ui/fl/apply/_internal/flexState/controlVariants/VariantManagementState","sap/ui/fl/apply/_internal/flexState/FlexObjectState","sap/ui/fl/apply/api/ControlVariantApplyAPI","sap/ui/fl/write/_internal/controlVariants/ControlVariantWriteUtils","sap/ui/fl/write/_internal/flexState/changes/UIChangeManager","sap/ui/fl/write/_internal/flexState/FlexObjectManager","sap/ui/fl/write/api/ContextBasedAdaptationsAPI","sap/ui/fl/Layer","sap/ui/fl/Utils"],function(e,a,n,t,r,i,o,c,l,s,f,p,g,u,d,v,m,C){"use strict";var h={};function y(e){const a=C.getAppComponentForControl(e);return a.getModel(p.getVariantModelName())}async function R(e){var a=e.model._getDirtyChangesFromVariantChanges(e.changes);a=a.reverse();if(e.revert){await o.revertMultipleChanges(a,{appComponent:e.model.oAppComponent,modifier:t,reference:e.model.sFlexReference})}d.deleteFlexObjects({reference:e.model.sFlexReference,flexObjects:a})}function V(e,a){a._oVariantSwitchPromise=a._oVariantSwitchPromise.catch(function(){}).then(e);s.setVariantSwitchPromise(a.sFlexReference,a._oVariantSwitchPromise);return a._oVariantSwitchPromise}async function x(e,a,n,t,r){if(!r._bDesignTimeMode){const i=await e.saveSequenceOfDirtyChanges(a,t);if(i){const e=i.response.find(e=>e.fileType==="ctrl_variant");const a=r.oData[n].variants.find(a=>a.key===e.fileName);const t=a.instance.getSupportInformation();t.user=e.support.user;a.instance.setSupportInformation(t)}r.invalidateMap()}}function F(e,a,n){var t={layer:e,control:a,reference:n};var r=v.hasAdaptationsModel(t);return r&&v.getDisplayedAdaptationId(t)}h.handleSelectVariant=function(e,a){return V(async function(e,a){var t=a.model;var r=a.vmReference;var i=false;var o=n.get([r,"modified"],t.oData);var c=e.key;var l=e.key;if(n.get([r,"currentVariant"],t.oData)&&t.oData[r].currentVariant!==c){l=t.oData[r].currentVariant;i=true;await t.updateCurrentVariant({variantManagementReference:r,newVariantReference:c,appComponent:t.oAppComponent,internallyCalled:true})}if(o){var f=s.getControlChangesForVariant({reference:t.sFlexReference,vmReference:r,vReference:l});await R({changes:f,vmReference:r,vReference:l,revert:!i,model:t})}if(!i){t.callVariantSwitchListeners(r,t.oData[r].currentVariant)}}.bind(null,e.getParameters(),a),a.model)};h.handleManageEvent=async function(a,n,t){const r=n.variantManagementReference;if(!t.oFlexController||!t.getData()){return}const{changes:i,variantsToBeDeleted:o}=t._collectModelChanges(r,m.USER,a);if(!i.length&&!o.length){return}if(i.some(e=>e.visible===false&&e.variantReference===t.getCurrentVariantReference(r))){await t.updateCurrentVariant({variantManagementReference:r,newVariantReference:r})}i.forEach(function(e){e.appComponent=t.oAppComponent});const c=h.addVariantChanges(r,i);const f=o.map(e=>{const a=s.getVariant({reference:t.sFlexReference,vmReference:r,vReference:e});if(a.layer===m.USER){return g.deleteVariant(t.sFlexReference,r,e)}return[]}).flat();const p=[...e(c,f),...f.filter(e=>e.getState()!==l.LifecycleState.NEW)];const u=Object.values(m).reverse();for(const e of u){const a=p.filter(a=>a.getLayer()===e);if(a.length>0){await t.oChangePersistence.saveDirtyChanges(t.oAppComponent,false,a)}}};h.handleSaveEvent=async function(e,n,r){var i=C.getAppComponentForControl(e);var o=r.getLocalId(e.getId(),i);var l;await V(async function(e,n,i){var o=r.getCurrentVariantReference(e);var f=s.getControlChangesForVariant({reference:r.sFlexReference,vmReference:e,vReference:o});if(i.overwrite){l=r._getDirtyChangesFromVariantChanges(f);if(r.getVariant(o,e).layer===m.PUBLIC){l.forEach(e=>e.setLayer(m.PUBLIC))}const a=r.oFlexController.saveSequenceOfDirtyChanges(l,n);r.invalidateMap();return a}var p=i.layer||(i.public?m.PUBLIC:m.USER);var g=i.layer||m.USER;var u=i.newVariantReference||C.createDefaultFileName("flVariant");var d={variantManagementReference:e,appComponent:n,layer:p,title:i.name,contexts:i.contexts,sourceVariantReference:o,newVariantReference:u,generator:i.generator,additionalVariantChanges:[],adaptationId:F(g,n,r.sFlexReference),executeOnSelection:i.execute};var v={content:{},reference:r.sFlexReference,generator:d.generator,layer:g,adaptationId:d.adaptationId};if(i.def){var y=a({changeType:"setDefault",content:{defaultVariant:u},fileType:"ctrl_variant_management_change",selector:t.getSelector(e,d.appComponent)},v);d.additionalVariantChanges.push(c.createVariantManagementChange(y))}const V=await h.copyVariant(d);l=V;await R({changes:f,vmReference:e,vReference:o,model:r});return x(r.oFlexController,l,e,n,r)}.bind(r,o,i,n),r);return l};h.addAndApplyChangesOnVariant=function(e,a){const n=y(a);const o=u.addDirtyChanges(n.sFlexReference,e,n.oAppComponent);return o.reduce(async function(e,a){await e;const o=r.getElementById(t.getControlIdBySelector(a.getSelector(),n.oAppComponent));const c=await i.applyChangeOnControl(a,o,{modifier:t,appComponent:n.oAppComponent,view:C.getViewForControl(o)});if(!c.success){var l=c.error||new Error("The change could not be applied.");d.deleteFlexObjects({reference:n.sFlexReference,flexObjects:[a]});throw l}},Promise.resolve())};h.eraseDirtyChangesOnVariant=async function(e,a,n){const t=y(n);var r=s.getControlChangesForVariant({reference:t.sFlexReference,vmReference:e,vReference:a});var i=t._getDirtyChangesFromVariantChanges(r);await R({changes:r,vmReference:e,vReference:a,model:t,revert:true});return i};h.copyVariant=async function(e){const a=y(e.appComponent);var n=a._duplicateVariant(e);n.generator=e.generator;a.oData[e.variantManagementReference].variants.push({key:n.instance.getId(),rename:true,change:true,remove:true,sharing:e.layer===m.USER?a.sharing.PRIVATE:a.sharing.PUBLIC});var t=[];if(e.layer===m.PUBLIC){n.instance.setFavorite(false);var r={variantId:e.newVariantReference,changeType:"setFavorite",fileType:"ctrl_variant_change",generator:e.generator,layer:m.USER,reference:a.sFlexReference,content:{favorite:true}};t.push(c.createVariantChange(r))}t=d.addDirtyFlexObjects(a.sFlexReference,t.concat([n.instance].concat(n.controlChanges).concat(e.additionalVariantChanges)));await a.updateCurrentVariant({variantManagementReference:e.variantManagementReference,newVariantReference:n.instance.getId(),appComponent:e.appComponent,internallyCalled:true,scenario:"saveAs"});return t};h.removeVariant=async function(e){const a=y(e.appComponent);var n=f.getDirtyFlexObjects(a.sFlexReference).filter(function(a){return a.getVariantReference&&a.getVariantReference()===e.variant.getId()||a.getId()===e.variant.getId()});await a.updateCurrentVariant({variantManagementReference:e.variantManagementReference,newVariantReference:e.sourceVariantReference,appComponent:e.component});d.deleteFlexObjects({reference:a.sFlexReference,flexObjects:n})};h.addVariantChange=function(e,a){const n=y(a.appComponent);var t=h.createVariantChange(e,a);d.addDirtyFlexObjects(n.sFlexReference,[t]);return t};h.addVariantChanges=function(e,a){const n=y(a[0].appComponent);var t=a.map(function(a){return h.createVariantChange(e,a)});d.addDirtyFlexObjects(n.sFlexReference,t);return t};h.deleteVariantChange=function(e,a,n){const t=y(a.appComponent);t.setVariantProperties(e,a);d.deleteFlexObjects({reference:t.sFlexReference,flexObjects:[n]})};h.createVariantChange=function(e,a){const n=y(a.appComponent);var r=n.setVariantProperties(e,a);var i={changeType:a.changeType,layer:a.layer,generator:a.generator,reference:n.sFlexReference};if(a.adaptationId!==undefined){i.adaptationId=a.adaptationId}else{i.adaptationId=F(a.layer,a.appComponent,n.sFlexReference)}let o;if(a.changeType==="setDefault"){i.fileType="ctrl_variant_management_change";i.selector=t.getSelector(e,a.appComponent);o=c.createVariantManagementChange(i)}else{i.fileType="ctrl_variant_change";i.variantId=a.variantReference;o=c.createVariantChange(i)}o.setContent(r);if(a.changeType==="setTitle"){o.setText("title",a.title,"XFLD")}return o};h.manageVariants=function(e,a,n,t,r){const i=y(e);return new Promise(function(o){e.attachEventOnce("manage",{resolve:o,variantManagementReference:a,layer:n},i.fnManageClickRta,i);e.openManagementDialog(true,t,r)})};return h});
//# sourceMappingURL=VariantManager.js.map