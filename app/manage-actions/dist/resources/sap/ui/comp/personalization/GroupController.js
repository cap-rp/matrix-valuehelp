/*!
 * SAPUI5
 * (c) Copyright 2025 SAP SE. All rights reserved.
 */
sap.ui.define(["./BaseController","sap/m/library","sap/ui/comp/library","./Util","sap/m/P13nConditionPanel","sap/ui/core/Element"],function(e,t,o,r,n,a){"use strict";var p=t.P13nConditionOperation;var i=e.extend("sap.ui.comp.personalization.GroupController",{constructor:function(o,r){e.apply(this,arguments);this.setType(t.P13nPanelType.group);this.setItemType(t.P13nPanelType.group+"Items")},metadata:{events:{afterGroupModelDataChange:{}}}});i.prototype.setTable=function(t){e.prototype.setTable.apply(this,arguments);if(this.getTableType()===o.personalization.TableType.ResponsiveTable){t.detachEvent("_group",this._onGroup,this);t.attachEvent("_group",this._onGroup,this)}else if(t&&t.detachGroup&&t.attachGroup){t.detachGroup(this._onGroup,this);t.attachGroup(this._onGroup,this)}};i.prototype.getColumn2Json=function(e,t,r){if(this.getTableType()!==o.personalization.TableType.AnalyticalTable){return null}if(!e.getGrouped()){return null}return{columnKey:t,isGrouped:e.getGrouped(),operation:e.getSortOrder&&e.getSortOrder()!=="Descending"?p.GroupAscending:p.GroupDescending,showIfGrouped:e.getShowIfGrouped?e.getShowIfGrouped():false}};i.prototype.getAdditionalData2Json=function(e,t){if(this.getTableType()!==o.personalization.TableType.AnalyticalTable){return}if(!e.group.groupItems.length){return}t.getGroupedColumns().forEach(function(t,o){if(typeof t==="string"){t=a.getElementById(t)}var n=r.getIndexByKey("columnKey",r.getColumnKey(t),e.group.groupItems);if(n>-1&&o===n){return}var p=e.group.groupItems.splice(n,1);e.group.groupItems.splice(o,0,p)})};i.prototype.getColumn2JsonTransient=function(e,t,o,n){if(!r.isGroupable(e)){return null}return{columnKey:t,text:o,tooltip:n!==o?n:undefined}};i.prototype.handleIgnore=function(e,t){e.sort.sortItems.splice(t,1)};i.prototype.syncJson2Table=function(e){var t=this.getColumnMap();var r=this.getTable();var n;this.fireBeforePotentialTableChange();if(this.getTableType()===o.personalization.TableType.TreeTable){return}else if(this.getTableType()===o.personalization.TableType.AnalyticalTable){var a=true;for(var p in t){n=t[p];if(!n){return}if(n.getGrouped()){n.setGrouped(false,a);n.setShowIfGrouped(false)}}e.group.groupItems.forEach(function(e){n=t[e.columnKey];if(!n){return}n.setGrouped(true,a);n.setShowIfGrouped(e.showIfGrouped)})}else if(this.getTableType()===o.personalization.TableType.Table||this.getTableType()===o.personalization.TableType.AnalyticalTable||this.getTableType()===o.personalization.TableType.TreeTable){if(!r.getGroupBy){return}if(e.group.groupItems.length>0){e.group.groupItems.some(function(e){n=t[e.columnKey];if(n){r.setGroupBy&&r.setGroupBy(n);return true}})}else{r.setGroupBy&&r.setGroupBy(null)}}this.fireAfterPotentialTableChange()};i.prototype.getDataSuiteFormat2Json=function(e){var t=this.createControlDataStructure();if(!e.GroupBy||!e.GroupBy.length){return t}t.group.groupItems=e.GroupBy.map(function(e){return{columnKey:e,operation:p.GroupAscending,showIfGrouped:false}});return t};i.prototype.getDataSuiteFormatSnapshot=function(e){var t=this.getUnionData(this.getControlDataInitial(),this.getControlData());if(!t.group||!t.group.groupItems||!t.group.groupItems.length){return}e.GroupBy=t.group.groupItems.map(function(e){return e.columnKey})};i.prototype._onGroup=function(e){this.fireBeforePotentialTableChange();this._updateInternalModel(e.getParameter("groupedColumns"));this.fireAfterPotentialTableChange();this.fireAfterGroupModelDataChange()};i.prototype._setGroup=function(e,t){this.fireBeforePotentialTableChange();if(e){this._updateInternalModel([t])}else{this._updateInternalModel([])}this.fireAfterPotentialTableChange();this.fireAfterGroupModelDataChange()};i.prototype._updateInternalModel=function(e){this.getInternalModel().setProperty("/controlData/group/groupItems",[]);var t=this.getControlData();e.forEach(function(e){if(typeof e==="string"){e=a.getElementById(e)}var o=r.getColumnKey(e);var n=r.getIndexByKey("columnKey",o,t.group.groupItems);n=n>-1?n:t.group.groupItems.length;this.getInternalModel().setProperty("/controlData/group/groupItems/"+n+"/",{columnKey:o,showIfGrouped:e.getShowIfGrouped?e.getShowIfGrouped():false})},this);this.updateControlDataBaseFromJson(t)};i.prototype.retrieveAdaptationUI=function(e){if(!r.hasGroupableColumns(this.getColumnMap())){return null}return new Promise(function(e){sap.ui.require(["sap/m/p13n/GroupPanel"],function(t){var r=this.getAdaptationData();var n=this.getTableType()===o.personalization.TableType.AnalyticalTable;var a=new t({queryLimit:n?undefined:1,enableShowField:n});this.oPanel=a;a.setP13nData(r);a.attachChange(function(e){var t=t=e.getParameter("item");var o=a.getP13nData(true);var r=this.getControlDataReduce();r.group.groupItems=o.map(function(e){return{isGrouped:true,columnKey:e.name,operation:e.descending?"GroupDescending":"GroupAscending",showIfGrouped:t.name===e.name?t.showIfGrouped:e.showIfGrouped}});this.setControlDataReduce2Model(r);this.fireAfterPotentialModelChange({json:r})}.bind(this));e(a)}.bind(this))}.bind(this))};i.prototype._transformAdaptationData=function(t,o){var r=e.prototype._transformAdaptationData.apply(this,arguments);r.grouped=!!t;r.showIfGrouped=t?t.showIfGrouped:true;return r};i.prototype._sortAdaptationData=function(e){this._getP13nBuilder().sortP13nData({visible:"grouped",position:"position"},e)};i.prototype._getPresenceAttribute=function(){return"grouped"};i.prototype.getChangeType=function(e,t){if(!t||!t.group||!t.group.groupItems){return o.personalization.ChangeType.Unchanged}var r=JSON.stringify(e.group.groupItems)!==JSON.stringify(t.group.groupItems);return r?o.personalization.ChangeType.ModelChanged:o.personalization.ChangeType.Unchanged};i.prototype.getChangeData=function(e,t){if(!e||!e.group||!e.group.groupItems){return this.createControlDataStructure()}if(!t||!t.group||!t.group.groupItems){return{group:r.copy(e.group)}}if(JSON.stringify(e.group.groupItems)!==JSON.stringify(t.group.groupItems)){return{group:r.copy(e.group)}}return null};i.prototype.getUnionData=function(e,t){if(!t||!t.group||!t.group.groupItems){return{group:r.copy(e.group)}}return{group:r.copy(t.group)}};i.prototype.isGroupSelected=function(e,t){var o=-1;e.groupItems.some(function(e,r){if(e.columnKey===t){o=r;return true}});return o>-1};i.prototype.exit=function(){e.prototype.exit.apply(this,arguments);if(this.getTable()&&this.getTable().detachGroup&&(this.getTableType()===o.personalization.TableType.AnalyticalTable||this.getTableType()===o.personalization.TableType.Table||this.getTableType()===o.personalization.TableType.TreeTable)){this.getTable().detachGroup(this._onGroup,this)}};return i});
//# sourceMappingURL=GroupController.js.map