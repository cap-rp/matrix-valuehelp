/*!
 * SAPUI5
 * (c) Copyright 2025 SAP SE. All rights reserved.
 */
sap.ui.define(["sap/ui/core/Element","sap/ui/comp/library","sap/ui/comp/odata/ODataModelUtil","sap/ui/comp/odata/MetadataAnalyser","./SmartVariantManagementAdapter","./SmartVariantManagementBase","sap/base/Log","sap/base/util/merge","sap/ui/base/SyncPromise"],function(t,e,i,a,r,n,o,s,l){"use strict";var h=n.extend("sap.ui.comp.smartvariants.SmartVariantManagement",{metadata:{library:"sap.ui.comp",designtime:"sap/ui/comp/designtime/smartvariants/SmartVariantManagement.designtime",interfaces:["sap.ui.core.IShrinkable"],properties:{persistencyKey:{type:"string",group:"Misc",defaultValue:null},entitySet:{type:"string",group:"Misc",defaultValue:null}},aggregations:{personalizableControls:{type:"sap.ui.comp.smartvariants.PersonalizableInfo",multiple:true,singularName:"personalizableControl"}},events:{initialise:{},save:{parameters:{tile:{type:"boolean"},name:{type:"string"}}},afterSave:{}}},renderer:{apiVersion:2}});h.prototype.init=function(){n.prototype.init.apply(this);this._bIsInitialized=false;this._bIsVariantAdaptationEnabled=false;this._oStandardVariant=null;this._oControlPromise=null;this._oPersoControl=null;this._sAppStandardVariantKey=null;this._oSelectionVariantHandler={};this._oAppStdContent=null;this._aPersonalizableControls=[];this._oAdapter=null;this._bApplyingUIState=false;this._loadFlex()};h.prototype.setEntitySet=function(t){this.setProperty("entitySet",t,true);this._checkEntitySet(t);return this};h.prototype._checkEntitySet=function(t){if(!this._oMetadataPromise){this.attachModelContextChange(this._initializeMetadata,this);this._createMetadataPromise();this._initializeMetadata()}return this};h.prototype._createMetadataPromise=function(){this._oMetadataPromise=new Promise(t=>{this._fResolveMetadataPromise=t})};h.prototype._resolveMetadataPromise=function(){if(this._fResolveMetadataPromise){this._fResolveMetadataPromise()}};h.prototype._initializeMetadata=function(){if(!this.bIsInitialised){i.handleModelInit(this,this._onMetadataInitialised)}};h.prototype._onMetadataInitialised=function(){this._bMetaModelLoadAttached=false;if(!this.bIsInitialised){var t=new a(this.getModel());if(t){this._oAdapter=new r({selectionPresentationVariants:t.getSelectionPresentationVariantAnnotationList(this.getEntitySet())});this.detachModelContextChange(this._initializeMetadata,this);this.bIsInitialised=true;this._resolveMetadataPromise()}}};h.prototype.applySettings=function(t){if(!t||!t.hasOwnProperty("useFavorites")){this.setUseFavorites(true)}if(t&&Object.hasOwn(t,"entitySet")&&t.entitySet){this._checkEntitySet(t.entitySet)}n.prototype.applySettings.apply(this,arguments)};h.prototype._createControlWrapper=function(e){var i=null;var a=t.getElementById(e.getControl());if(a){let t,r;const n={promise:new l((e,i)=>{t=e;r=i}),reject:r,resolve:t};i={control:a,type:e.getType(),dataSource:e.getDataSource(),keyName:e.getKeyName(),loaded:n}}return i};h.prototype._getControlWrapper=function(t){var e=this._getAllPersonalizableControls();if(e&&e.length){for(var i=0;i<e.length;i++){if(e[i].control===t){return e[i]}}}return null};h.prototype.addPersonalizableControl=function(e){var i,a=e.getControl();var r=t.getElementById(a);if(!r){o.error("couldn't obtain the control with the id="+a);return this}this.addAggregation("personalizableControls",e,true);i=this._createControlWrapper(e);if(i){this._aPersonalizableControls.push(i)}if(this.isPageVariant()){return this}this.setPersControler(r);return this};h.prototype._loadFlex=function(){return this.oModel.loadFlex().catch(t=>{o.error(t)})};h.prototype.setPersControler=function(t){if(this.oModel.isFlexLoaded()&&this.oModel._isFlexSupported(t)){this._oPersoControl=t;this._handleGetChanges(t);return}if(!this._oPersoControl){this.oModel.isFlexSupported(t).then(e=>{if(e){this._oPersoControl=t;this._handleGetChanges(t)}})}};h.prototype.setPersistencyKey=function(t){this.setProperty("persistencyKey",t);this.setPersControler(this);return this};h.prototype.isPageVariant=function(){if(this.getPersistencyKey()){return true}return false};h.prototype._getAdapter=function(){return this._oAdapter};h.prototype._handleGetChanges=function(t){if(!t||!this.oModel.isFlexLoaded()){return}this._oControlPromise=new Promise((t,e)=>{Promise.all([this._getStandardVariantItemName(),this._oMetadataPromise]).then(i=>{if(this._bIsBeingDestroyed){return}const a=i[0];var r={control:this._oPersoControl,standardVariant:{id:this.STANDARDVARIANTKEY,name:a,executeOnSelection:this.bExecuteOnSelectForStandardViaXML}};if(this._getAdapter()){r.variants=this._getAdapter().getODataVariants()}else{if(this._getFilterBarAdapter()){r.variants=this._getFilterBarAdapter().variants}}this.oModel.loadVariants(r,t,e)})})};h.prototype._getFilterBarAdapter=function(){return this._oSelectionVariantHandler["#"]};h.prototype._getVariantById=function(t){if(this._mVariants&&this._mVariants[t]){return this._mVariants[t]}return null};h.prototype.getVariantContent=function(t,e){var i,a=this._getVariantContent(e);if(a&&this.isPageVariant()&&t){i=this._getControlPersKey(t);if(i){a=this._retrieveContent(a,i)}}return a};h.prototype._getContent=function(t){return t.getContent()};h.prototype._getVariantContent=function(t){var e=this._getVariantById(t);if(e){var i=this._getContent(e);if(i){if(t===this.STANDARDVARIANTKEY&&Object.keys(i).length<1){i=this.getStandardVariant()}return s({},i)}}return null};h.prototype._getAllPersonalizableControls=function(){return this._aPersonalizableControls};h.prototype.removeAllPersonalizableControls=function(){this.removeAllAggregation("personalizableControls");this._aPersonalizableControls=[]};h.prototype.removePersonalizableControl=function(t){var e=this.removeAggregation("personalizableControls",t);if(e){this._aPersonalizableControls.some((t,i)=>{if(t.control.getId()===e.getControl()){this._aPersonalizableControls.splice(i,1);return true}return false})}return e};h.prototype.removePersonalizableControlById=function(t){var e=this.getAggregation("personalizableControls");if(e){e.some((e,i)=>{if(e.getControl()===t.getId()){this.removePersonalizableControl(e);return true}return false})}};h.prototype._createVariantItem=function(t){try{const e={key:t.getVariantId(),title:t.getName(),sharing:t.isUserDependent()?"private":"public",remove:t.isDeleteEnabled(),favorite:t.getFavorite(),executeOnSelect:t.getExecuteOnSelection(),rename:t.isRenameEnabled(),visible:true,changeable:t.isEditEnabled(),author:t.getAuthor(),contexts:t.getContexts()};this._mVariants[t.getVariantId()]=t;this._insertVariantItem(t,e)}catch(t){o.error(t.message)}};h.prototype._createVariantEntries=function(t){if(t){if(t.defaultVariantId){this._setDefaultVariantKey(t.defaultVariantId,false)}if(t.standardVariant){this._createVariantItem(t.standardVariant);var e=this._getVariantContent(t.standardVariant.getVariantId());if(Object.keys(e).length>0){this._sAppStandardVariantKey=t.standardVariant.getVariantId();if(this._sAppStandardVariantKey!==this.STANDARDVARIANTKEY){this.setStandardVariantKey(this._sAppStandardVariantKey)}}}if(t.variants){t.variants.forEach(t=>{this._createVariantItem(t)})}this.resolveTitleBindings()}};h.prototype._addFavorites=function(t){t.forEach(t=>{if(t.key!==this.STANDARDVARIANTKEY){var e=this._getVariantById(t.key);if(e){this._flUpdateVariant(e,{favorite:t.visible});this._updateView(t.key,"favorite",t.visible)}}})};h.prototype._flUpdateVariant=function(t,e){return this.oModel.flUpdateVariant(t,e,this._oPersoControl)};h.prototype._flRemoveVariant=function(t){var e={control:this._oPersoControl,id:t.getVariantId(),layer:t.getLayer()};var i=this.oModel._flWriteRemoveVariant(e);if(i){delete this._mVariants[i.getVariantId()]}};h.prototype.flWriteOverrideStandardVariant=function(t){this.oModel.flWriteOverrideStandardVariant(t,this._oPersoControl)};h.prototype.getCurrentVariantId=function(){if(this._bDuringVariantCreation){return"SV1656651501366"}var t=this.getCurrentVariantKey();if(t===this.STANDARDVARIANTKEY){t=""}return t};h.prototype.clearVariantSelection=function(){this.setSelectionKey(this.getStandardVariantKey())};h.prototype.setCurrentVariantId=function(t,e){var i;if(this._oPersoControl){i=this._determineVariantId(t);this.setCurrentVariantKey(i);if(this._oStandardVariant){this.setModified(false);if(!e){this._triggerSelectVariant(i,"SET_VM_ID")}}}};h.prototype._determineVariantId=function(t){var e=t;if(!e||!this.getItemByKey(e)){e=this.getStandardVariantKey()}return e};h.prototype.initialise=function(t,e){var i,a;try{if(e&&t){i=this._getControlWrapper(e);if(!i){o.error("initialise on an unknown control.");return}if(i.bInitialized){o.error("initialise on "+e.getId()+" already executed");return}i.fInitCallback=t}else if(!this.isPageVariant()){i=this._getControlWrapper(this._oPersoControl)}const r=this.oModel.getPersistencyPromise();if(!r){this._errorHandling("'initialise' no '_oPersistencyPromise'  available",t,e);return}return r.then(()=>{if(!this._oControlPromise||!this._oPersoControl||!i){this._errorHandling("'initialise' no personalizable component available",t,e);return}Promise.all([this._oMetadataPromise,this._oControlPromise,...this.oModel.retrieveDataFromFlex()]).then(t=>{const[,e,a,r,n]=t;this._dataReceived(e,a,r,n,i)},i=>{a="'loadVariants' failed:";if(i&&i.message){a+=" "+i.messages}this._errorHandling(a,t,e)},i=>{if(i&&i.message){a=i.message}else{a="accessing either flexibility functionality or odata metadata."}this._errorHandling("'initialise' failed: "+a,t,e)})}).catch(i=>{if(i&&i.message){a=i.message}else{a="accessing the flexibility functionality."}this._errorHandling("'initialise' failed: "+a,t,e)})}catch(i){this._errorHandling("exception occurs during 'initialise' processing",t,e)}};h.prototype._errorHandling=function(t,e,i){var a={variantKeys:[]};this._setErrorValueState(this.oResourceBundle.getText("VARIANT_MANAGEMENT_READ_FAILED"),t);if(e&&i){e.call(i)}else{this.fireEvent("initialise",a)}if(i.variantsInitialized){i.variantsInitialized()}this.setInErrorState(true)};h.prototype.isVariantAdaptationEnabled=function(){return this._bIsVariantAdaptationEnabled};h.prototype._dataReceived=function(t,e,i,a,r){var n,o,s={variantKeys:[]};if(this._bIsBeingDestroyed){return}if(!this._bIsInitialized){this._bIsVariantAdaptationEnabled=a;this.setVariantCreationByUserAllowed(i);this.setShowShare(e);this._bIsInitialized=true;this._createVariantEntries(t);o=this._getDefaultVariantKey();if(!o||!this._getVariantById(o)&&o.substring(0,1)!=="#"){o=this.getStandardVariantKey()}n=this._getVariantById(o);if(n){this.setDefaultVariantKey(o);this.setSelectionKey(o)}if(this._sAppStandardVariantKey){this._oAppStdContent=this._getVariantContent(this._sAppStandardVariantKey)}}this._initialize(s,r)};h.prototype._initialize=function(t,e){var i,a=null,r=this.isPageVariant();var n,s=false;if(this._oAppStdContent){if(e.type==="table"||e.type==="chart"){if(r){this._applyControlVariant(e.control,this._oAppStdContent,"STANDARD",true)}else{this._applyVariant(e.control,this._oAppStdContent,"STANDARD",true)}}}if(e.fInitCallback){e.fInitCallback.call(e.control);delete e.fInitCallback;e.bInitialized=true}else{t.variantKeys=Object.keys(this._mVariants);this.fireEvent("initialise",t)}i=this.getCurrentVariantKey();if(i&&i!==this.getStandardVariantKey()){a=this._getVariantContent(i);n=this._getVariantById(i);if(n){s=n.getExecuteOnSelection()}}else if(this._oAppStdContent){a=this._oAppStdContent;if(e.type==="table"||e.type==="chart"){a=null}}if(this._sAppStandardVariantKey){this._updateStandardVariant(e,this._oAppStdContent)}else{this._setStandardVariant(e)}try{e.loaded.resolve();if(a){if(this._getAdapter()&&i.substring(0,1)==="#"&&Object.entries(a).length===0){this._applyUiState(i,"INIT",s)}else if(r){this._applyControlVariant(e.control,a,"INIT",true,s)}else{this._applyVariant(e.control,a,"INIT",true,s)}}if(this.bConsiderXml!==undefined){this._executeOnSelectForStandardVariantByXML(this.bConsiderXml)}if(e.control.variantsInitialized){e.control.variantsInitialized()}if(this.getCurrentVariantKey()===this.getStandardVariantKey()){if(this._getApplyAutomaticallyOnStandardVariant()&&e.control.search){e.control.search()}if(this.getExecuteOnSelectForStandardVariant()&&this._oAppStdContent){var l=this.getItemByKey(this.getCurrentVariantKey());if(l){l.setExecuteOnSelect(true)}}}if(!this.getEnabled()){this.setEnabled(true)}}catch(t){o.error("'_initialize' throws an exception:"+t.message)}};h.prototype._updateVariant=function(t){return l.resolve(this._fetchContentAsync()).then(e=>{if(t.key!==this.getStandardVariantKey()){var i=this._getVariantById(t.key);if(i){if(e){var a=this.getItemByKey(t.key);var r={content:e};if(i.getPackage()){r.transportId=i.getPackage()}if(i.getRequest()){r.packageName=i.getRequest()}if(a){r.executeOnSelection=a.getExecuteOnSelect()}this._flUpdateVariant(i,r);if(t.def===true){this._setDefaultVariantKey(t.key)}}this._afterSave(t,false)}}}).catch(t=>{o.error("'_updateVariant' throws an exception:"+t.message)}).unwrap()};h.prototype._createChangeHeader=function(){if(this.isPageVariant()){return{type:"page",dataService:"n/a"}}var t=this._getAllPersonalizableControls();if(t&&t.length>0){return{type:t[0].type,dataService:t[0].dataSource}}};h.prototype._newVariant=function(t){this._bDuringVariantCreation=true;return l.resolve(this._fetchContentAsync()).then(e=>{var i=this._createChangeHeader();var a={type:i.type,ODataService:i.dataSource,texts:{variantName:t.name},content:e,isVariant:true,isUserDependent:!t.public,executeOnSelection:t.execute};var r=this.oModel._flWriteAddVariant({control:this._oPersoControl,changeSpecificData:a});if(r){var n=r.getVariantId();this._mVariants[n]=r;const e=this._flUpdateVariant(r,{favorite:true});if(e){this._mVariants[e.getVariantId()]=e}this._createVariantItem(r);this.setSelectionKey(n);this._bDuringVariantCreation=false;if(t.def===true){this._setDefaultVariantKey(n);this.setDefaultVariantKey(n)}this._afterSave(t,true)}}).catch(t=>{this._bDuringVariantCreation=false;o.error("'_newVariant' throws an exception:"+t.message)}).unwrap()};h.prototype._fetchContent=function(){var t,e,i,a={};var r=this._getAllPersonalizableControls();for(var n=0;n<r.length;n++){t=r[n];if(t&&t.control&&t.control.fetchVariant){i=t.control.fetchVariant();if(i){i=s({},i);if(this.isPageVariant()){e=this._getControlPersKey(t);if(e){a=this._assignContent(a,i,e)}else{o.error("no persistancy key retrieved")}}else{a=i;break}}}}return a};h.prototype._fetchContentAsync=function(){var t,e,i,a={},r=[],n=[];var l=this._getAllPersonalizableControls();for(var h=0;h<l.length;h++){t=l[h];if(t&&t.control&&t.control.fetchVariant){i=t.control.fetchVariant();if(i){if(i&&i instanceof Promise){this.setEnabled(false);r.push(i);n.push(t);continue}i=s({},i);if(this.isPageVariant()){e=this._getControlPersKey(t);if(e){a=this._assignContent(a,i,e)}else{o.error("no persistancy key retrieved")}}else{a=i;break}}}}if(r.length>0){var d=null;var p=new Promise((t,e)=>{d=t});Promise.all(r).then(t=>{for(var r=0;r<t.length;r++){i=s({},t[r]);if(this.isPageVariant()){e=this._getControlPersKey(n[r]);if(e){a=this._assignContent(a,i,e)}else{o.error("no persistancy key retrieved")}}else{a=i;break}}d(a)});return p}else{return a}};h.prototype._getControlInfoPersKey=function(t){var e=null;if(t.keyName==="id"){e=t.control.getId()}else{e=t.control.getProperty(t.keyName)}return e};h.prototype._getControlPersKey=function(t){var e=t;if(!t.keyName){e=this._getControlWrapper(t)}return this._getControlInfoPersKey(e)};h.prototype._appendLifecycleInformation=function(t,e){var i;if(t){i=t.getRequest();if(i===null||i===undefined){i=""}}return i};h.prototype._renameVariant=function(t){if(t.key!==this.getStandardVariantKey()){if(t){var e=this._getVariantById(t.key);if(e){var i={name:t.name};var a=this._appendLifecycleInformation(e,t.key);if(a!=undefined){i.transportId=a}this._flUpdateVariant(e,i);this._reorderList(t.key,t.name)}}}};h.prototype._deleteVariants=function(t){var e;var i=this._getDefaultVariantKey();var a=this.getCurrentVariantKey();if(t&&t.length){for(var r=0;r<t.length;r++){var n=t[r];var o=this._getVariantById(n);if(o){e=this._appendLifecycleInformation(o,n);o.setRequest(e);this._flRemoveVariant(o);var s=this.getItemByKey(n);if(s){this._removeViewItem(s.getKey());this.removeVariantItem(s)}if(i&&i===n){this._setDefaultVariantKey("")}if(n===a){this.setModified(false);this.setCurrentVariantKey(this.STANDARDVARIANTKEY);this._selectVariant(this.STANDARDVARIANTKEY)}}}}};h.prototype._executeOnSelectForStandardVariantByXML=function(t){n.prototype._executeOnSelectForStandardVariantByXML.apply(this,arguments);this._reapplyExecuteOnSelectForStandardVariant(t)};h.prototype._reapplyExecuteOnSelectForStandardVariant=function(t){if(Object.keys(this._mVariants).length>0){this.bConsiderXml=undefined;this.flWriteOverrideStandardVariant(t);var e=this.getStandardVariantKey();var i=this._getVariantById(e);if(i){var a=this.getItemByKey(e);if(a){a.setExecuteOnSelect(i.getExecuteOnSelection());this._reapplyExecuteOnSelectForStandardVariantItem(i.getExecuteOnSelection())}}}else{this.bConsiderXml=t}};h.prototype.setExecuteOnStandard=function(t){this._reapplyExecuteOnSelectForStandardVariant(t)};h.prototype.getExecuteOnStandard=function(){var t=this.getStandardVariantKey();var e=this.getItemByKey(t);if(e){return e.getExecuteOnSelect()}return undefined};h.prototype._getApplyAutomaticallyOnStandardVariant=function(){var t=this.getExecuteOnSelectForStandardVariant();if(this._fRegisteredApplyAutomaticallyOnStandardVariant&&this.getDisplayTextForExecuteOnSelectionForStandardVariant()){try{t=this._fRegisteredApplyAutomaticallyOnStandardVariant()}catch(t){o.error("callback for determination of apply automatically on standard variant failed")}}return t};h.prototype._getDefaultVariantKey=function(){return this.oModel._getDefaultVariantId()};h.prototype._setDefaultVariantKey=function(t,e=true){return this.oModel._setDefaultVariantId(t,e?this._oPersoControl:undefined)};h.prototype._setExecuteOnSelections=function(t){if(t&&t.length){for(var e=0;e<t.length;e++){var i=this._getVariantById(t[e].key);if(i){var a=t[e].key;this._flUpdateVariant(i,{executeOnSelection:t[e].exe});this._updateView(a,"executeOnSelect",t[e].exe)}}}};h.prototype._save=function(t,e){if(this.oModel.isFlexLoaded()){try{this.oModel.save(this._oPersoControl).then(()=>{if(!e){if(t){this._updateUser()}this.fireEvent("afterSave")}}).catch(t=>{var e="'_save' failed:";if(t&&t.message){e+=" "+t.message}this._setErrorValueState(this.oResourceBundle.getText("VARIANT_MANAGEMENT_SAVE_FAILED"),e)})}catch(t){this._setErrorValueState(this.oResourceBundle.getText("VARIANT_MANAGEMENT_SAVE_FAILED"),"'_save' throws an exception")}}};h.prototype._updateUser=function(){var t=this.getInitialSelectionKey();var e,i=this._getVariantById(t);if(i){e=i.getAuthor();if(e){this._assignUser(t,e)}}};h.prototype.fireSave=function(t){var e={};if(t){if(t.hasOwnProperty("tile")){e.tile=t.tile}e.name=t.name;if(t.overwrite){if(t.key!==this.getStandardVariantKey()){this.fireEvent("save",e);if(t.key===this.STANDARDVARIANTKEY){this._newVariant(t)}else{this._updateVariant(t)}}}else{this.fireEvent("save",e);this._newVariant(t)}}};h.prototype._afterSave=function(t,e){this.setEnabled(true);this.setModified(false);this._save(e)};h.prototype.fireManage=function(t){var e,i=false;if(t){if(t.renamed){for(e=0;e<t.renamed.length;e++){this._renameVariant(t.renamed[e])}}if(t.deleted){this._deleteVariants(t.deleted)}if(t.exe){this._setExecuteOnSelections(t.exe)}if(t.def){var a=this._getDefaultVariantKey();if(a!==t.def){if(!(a===""&&t.def===this.STANDARDVARIANTKEY)){this._setDefaultVariantKey(t.def);this.setDefaultVariantKey(t.def);i=true}}}if(t.fav&&t.fav.length>0){this._addFavorites(t.fav)}this._checkUpdate();if(t.deleted&&t.deleted.length>0||t.renamed&&t.renamed.length>0||t.exe&&t.exe.length>0||i){this._save()}else if(t.fav&&t.fav.length>0){this._save(false,true)}this.fireEvent("manage",t)}};h.prototype.fireSelect=function(t,e){if(this._oPersoControl&&t&&t.key){this._triggerSelectVariant(t.key,e);this.fireEvent("select",t)}};h.prototype._selectVariant=function(t,e){this.setModified(false);this.fireSelect({key:t},e)};h.prototype._checkForSelectionHandler=function(t){var e=null,i=Object.keys(this._oSelectionVariantHandler);if(i.length>-1){i.some(i=>{if(t.indexOf(i)===0){e=this._oSelectionVariantHandler[i];return true}return false})}return e};h.prototype._triggerSelectVariant=function(t,e){var i,a,r=false;var n=this._checkForSelectionHandler(t);var o=this._getVariantById(t);if(o){i=o.getExecuteOnSelection();if(t===this.getStandardVariantKey()){i=this._getApplyAutomaticallyOnStandardVariant()}r=Object.entries(this._getContent(o)).length===0?false:true}if(r){a=this._getGeneralSelectVariantContent(t,e)}else if(this._getAdapter()&&t.substring(0,1)==="#"){this._applyUiState(t,"SPV_VARIANT",i);return}else if(n){a=this._getSpecialSelectVariantContent(t,e,n)}else{a=this._getGeneralSelectVariantContent(t,e)}if(a){if(this.isPageVariant()){this._applyVariants(a,e,i)}else{this._applyVariant(this._oPersoControl,a,e,false,i)}}};h.prototype._getSpecialSelectVariantContent=function(t,e,i){return i.callback.call(i.handler,t,e)};h.prototype._getGeneralSelectVariantContent=function(t,e){var i=this._getVariantContent(t);if(i){i=s({},i)}return i};h.prototype.currentVariantSetModified=function(t){if(!this._bApplyingUIState){n.prototype.currentVariantSetModified.apply(this,arguments)}};h.prototype._applyControlUiState=function(t,e,i){if(t&&e){t.loaded.promise.then(()=>{if(t.control.setUiStateAsVariant){t.control.setUiStateAsVariant(e,i)}})}};h.prototype._applyUiState=function(t,e,i){var a,r=this._getAdapter(),n=null,o=this._getAllPersonalizableControls();var s=null;if(r){n=r.getUiState(t);this._bApplyingUIState=true;for(a=0;a<o.length;a++){if(o[a]?.control&&o[a]?.loaded){this._applyControlUiState(o[a],n,e);if(o[a].control.search){s=o[a].control}}}this._bApplyingUIState=false;if(i&&s){s.search()}}};h.prototype._applyControlWrapperVariants=function(t,e,i,a){if(t){return t.loaded.promise.then(()=>{this._applyControlVariant(t.control,e,i,false,a)})}return Promise.resolve()};h.prototype._applyVariants=function(t,e,i){var a,r=this._getAllPersonalizableControls();const n=[];for(a=0;a<r.length;a++){if(r[a]?.control&&r[a]?.loaded){n.push(this._applyControlWrapperVariants(r[a],t,e,i))}}return n};h.prototype._setStandardVariant=function(t){var i=t.control;if(i){if(i.fireBeforeVariantSave){i.fireBeforeVariantSave(e.STANDARD_VARIANT_NAME)}return this._assignStandardVariantAsync(t)}};h.prototype._retrieveContent=function(t,e){var i=t;if(this.isPageVariant()&&t){i=t[e];if(!i&&e===this.getPersistencyKey()&&this._aPersonalizableControls&&this._aPersonalizableControls.length===1){i=t}}return i};h.prototype._assignContent=function(t,e,i){if(this.isPageVariant()){t[i]=e}else{t=e}return t};h.prototype._updateStandardVariant=function(t,e){if(t.control){var i=e;if(this.isPageVariant()){var a=this._getControlPersKey(t);if(a){i=this._retrieveContent(e,a)}}return this._assignStandardVariantForControl(t,i)}return e};h.prototype._assignStandardVariantAsync=function(t){var e=null;if(t.control){if(t.control.fetchVariant){e=t.control.fetchVariant()}if(e instanceof Promise){this.setEnabled(false)}return l.resolve(e).then(e=>this._assignStandardVariantForControl(t,e)).catch(t=>{o.error("'_assignStandardVariant' throws an exception: "+t.message)}).unwrap()}return null};h.prototype._assignStandardVariantForControl=function(t,e){var i=e;if(t){if(this.isPageVariant()){var a=this._getControlPersKey(t.control);if(a){if(!this._oStandardVariant){this._oStandardVariant={}}this._oStandardVariant=this._assignContent(this._oStandardVariant,i,a)}}else{this._oStandardVariant=i}}return this._oStandardVariant};h.prototype.getStandardVariant=function(t){var e,i,a=null;if(this._oStandardVariant){if(!t){a=this._oStandardVariant}else{if(this.isPageVariant()){i=this._getControlWrapper(t);if(i){e=this._getControlPersKey(t);if(e){a=this._retrieveContent(this._oStandardVariant,e)}}}else{if(t===this._oPersoControl){a=this._oStandardVariant}}}}return a};h.prototype._applyVariant=function(t,e,i,a,r){if(t&&t.applyVariant){if(r!=undefined){e.executeOnSelection=r}t.applyVariant(e,i,a)}};h.prototype._applyVariantByPersistencyKey=function(e,i,a){var r=null;this.getAggregation("personalizableControls",[]).some(i=>{var a=t.getElementById(i.getControl());if(a){var n=i.getKeyName();if(a.getProperty(n)===e){r=a}return r!=null}});if(r){var n=this._retrieveContent(i,e);this._applyVariant(r,n,a)}};h.prototype._applyControlVariant=function(t,e,i,a,r){var n,o;o=this._getControlPersKey(t);if(o){n=this._retrieveContent(e,o);if(n){this._applyVariant(t,n,i,a,r)}}};h.prototype.registerSelectionVariantHandler=function(t,e){this._oSelectionVariantHandler[e]=t};h.prototype.unregisterSelectionVariantHandler=function(t){var e=null;if(!this._oSelectionVariantHandler){return}if(typeof t==="string"){e=t}else{Object.keys(this._oSelectionVariantHandler).some(i=>{if(this._oSelectionVariantHandler[i].handler===t){e=i;return true}return false})}if(e){delete this._oSelectionVariantHandler[e]}};h.prototype._setErrorValueState=function(t,e){this.setInErrorState(true);if(e){o.error(e)}};h.prototype.exit=function(){n.prototype.exit.apply(this,arguments);this._aPersonalizableControls=null;this._oMetadataPromise=null;this._fResolveMetadataPromise=null;this._oControlPromise=null;this._oPersoControl=null;this._oAppStdContent=null;this._sAppStandardVariantKey=null;this._oSelectionVariantHandler=null;if(this._oAdapter){this._oAdapter.destroy();this._oAdapter=null}};return h});
//# sourceMappingURL=SmartVariantManagement.js.map