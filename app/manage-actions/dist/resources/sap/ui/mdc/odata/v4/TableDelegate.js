/*!
 * OpenUI5
 * (c) Copyright 2025 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["../../TableDelegate","../../table/V4AnalyticsPropertyHelper","sap/ui/mdc/enums/TableP13nMode","sap/ui/mdc/enums/TableType","sap/ui/mdc/enums/TableSelectionMode","sap/ui/mdc/odata/v4/TypeMap","sap/ui/mdc/util/loadModules","sap/m/plugins/PluginBase","sap/ui/core/Lib","sap/ui/core/format/ListFormat","sap/ui/core/message/MessageType"],(e,t,n,r,o,i,a,s,l,g,p)=>{"use strict";const u=Object.assign({},e);u.getTypeMap=function(e){return i};u.getPropertyHelperClass=function(){return t};u.updateBindingInfo=function(t,n){const r=t.getRowBinding()?.getAggregation();e.updateBindingInfo.apply(this,arguments);if("expandTo"in(r??{})){n.parameters.$$aggregation={expandTo:r.expandTo}}if(!E(t)){const e=b(t);if(e.length>0){const r=t.getPropertyHelper();n.parameters.$select=e.map(e=>r.getProperty(e).path)}}};u.getGroupSorter=function(t){const n=t._getGroupedProperties()[0];if(!n||!t._isOfType(r.ResponsiveTable)){return undefined}if(!P(t).includes(n.name)){return undefined}return e.getGroupSorter.apply(this,arguments)};u.getSorters=function(t){let n=e.getSorters.apply(this,arguments);if(E(t)){const e=t.getPropertyHelper();const r=P(t).map(t=>e.getProperty(t).path);n=n.filter(e=>r.includes(e.sPath))}return n};u.updateBinding=function(e,t,n,r){if(E(e)){h(e,t)}if(!n||n.getPath()!=t.path){this.rebind(e,t);return}const o=n.getRootBinding();let i=o&&!o.isSuspended();try{if(i){o.suspend()}n.setAggregation(t.parameters?.$$aggregation);n.changeParameters((()=>{const e={...t.parameters};delete e.$$aggregation;return e})());n.filter(t.filters,"Application");n.sort(t.sorter);if(r&&r.forceRefresh){n.refresh()}}catch(r){this.rebind(e,t);if(o==n){i=false}}finally{if(i&&o.isSuspended()){o.resume()}}};u.fetchExpandAndCollapseConfiguration=function(e){if(!e._isOfType(r.TreeTable)){return Promise.resolve({})}return Promise.resolve({expandAll:function(e){c(e,Number.MAX_SAFE_INTEGER)},collapseAll:function(e){c(e,1)},expandAllFromNode:function(e,t){t.expand(Number.MAX_SAFE_INTEGER)},collapseAllFromNode:function(e,t){t.collapse(true)},isNodeExpanded:function(e,t){return t.getProperty("@$ui5.node.isExpanded")}})};function c(e,t){const n=e.getRowBinding();if(!n){return}const r=n.getAggregation()?.expandTo===t;if(r){n.refresh()}else{n.setAggregation({...n.getAggregation(),...{expandTo:t}})}}u.getInResultPropertyKeys=function(e){return[]};u.getSupportedFeatures=function(t){const o=e.getSupportedFeatures.apply(this,arguments);if(t._isOfType(r.Table)){const e=o.p13nModes;if(!e.includes(n.Group)){e.push(n.Group)}if(!e.includes(n.Aggregate)){e.push(n.Aggregate)}}return{...o}};u.validateState=function(t,n,r){const o=e.validateState.apply(this,arguments);let i;if(r=="Sort"){i=f(t,n)}else if(r=="Group"){i=d(t,n)}else if(r=="Column"){i=y(t,n)}return R(o,i)};function f(e,t){if(E(e)&&_(e,t.items,t.sorters)){return{validation:p.Information,message:l.getResourceBundleFor("sap.ui.mdc").getText("table.PERSONALIZATION_DIALOG_SORT_RESTRICTION")}}return null}function d(e,t){const n=l.getResourceBundleFor("sap.ui.mdc");if(t.aggregations){const r=Object.keys(t.aggregations);const o=[];const i=g.getInstance();r.forEach(t=>{const n=e.getPropertyHelper().getProperty(t);if(n&&n.groupable){o.push(t)}});if(o.length>0){return{validation:p.Information,message:n.getText("table.PERSONALIZATION_DIALOG_GROUP_RESTRICTION_TOTALS",[i.format(o)])}}}else if(e._isOfType(r.ResponsiveTable)){if(_(e,t.items,t.groupLevels)){return{validation:p.Information,message:n.getText("table.PERSONALIZATION_DIALOG_GROUP_RESTRICTION_VISIBLE")}}}return null}function y(e,t){const n=l.getResourceBundleFor("sap.ui.mdc");const o=t.aggregations&&Object.keys(t.aggregations);let i;if(e._isOfType(r.ResponsiveTable)){if(_(e,t.items,t.groupLevels)){return{validation:p.Information,message:n.getText("table.PERSONALIZATION_DIALOG_GROUP_RESTRICTION_VISIBLE")}}}if(_(e,t.items,o)){i=n.getText("table.PERSONALIZATION_DIALOG_TOTAL_RESTRICTION")}if(E(e)&&_(e,t.items,t.sorters)){const e=n.getText("table.PERSONALIZATION_DIALOG_SORT_RESTRICTION");i=i?i+"\n"+e:e}if(i){return{validation:p.Information,message:i}}return null}u.preInit=function(){return Promise.resolve()};u.initializeContent=async function(t){await e.initializeContent.apply(this,arguments);if(t._isOfType(r.Table)){await m(t)}};async function m(e){const[t]=await a("sap/ui/table/plugins/V4Aggregation");e._oTable.addDependent(new t({enabled:{parts:[{path:"$sap.ui.mdc.Table>/p13nMode"},{path:"$sap.ui.mdc.Table>/groupConditions"},{path:"$sap.ui.mdc.Table>/aggregateConditions"}],formatter:function(t,n,r){return E(e)}},groupHeaderFormatter:function(t){const n=e._getGroupedProperties().map(e=>e.name);const r=n[t.getProperty("@$ui5.node.level")-1];return e.getControlDelegate().formatGroupHeader(e,t,r)}}))}u.initializeSelection=function(t){if(t._isOfType(r.Table,true)){return T(t)}else{return e.initializeSelection.apply(this,arguments)}};function T(e){const t={Single:"Single",SingleMaster:"Single",Multi:"MultiToggle"};return a("sap/ui/table/plugins/ODataV4Selection").then(n=>{const r=n[0];e._oTable.addDependent(new r({limit:"{$sap.ui.mdc.Table#type>/selectionLimit}",enableNotification:true,hideHeaderSelector:"{= !${$sap.ui.mdc.Table#type>/showHeaderSelector} }",selectionMode:{path:"$sap.ui.mdc.Table>/selectionMode",formatter:function(e){return t[e]}},enabled:{path:"$sap.ui.mdc.Table>/selectionMode",formatter:function(e){return e in t}},selectionChange:function(t){e._onSelectionChange({selectAll:t.getParameter("selectAll")})}}))})}u.setSelectedContexts=function(t,n){if(t._isOfType(r.Table,true)){const e=t.getSelectionMode();if(e===o.None||(e===o.Single||e===o.SingleMaster)&&n.length>1){throw Error("Unsupported operation: Cannot select the given number of contexts in the current selection mode")}t.clearSelection();for(const e of n){e.setSelected(true)}}else{e.setSelectedContexts.apply(this,arguments)}};u.getSelectedContexts=function(t){if(t._isOfType(r.Table,true)){return s.getPlugin(t._oTable,"sap.ui.table.plugins.ODataV4Selection")?.getSelectedContexts()??[]}return e.getSelectedContexts.apply(this,arguments)};function h(e,t){const n=x(e);const r=t.parameters.$search;if(n&&r){delete t.parameters.$search;n.search=r}t.parameters.$$aggregation=n;const o=Object.keys(n?.aggregate||{}).some(e=>n.aggregate[e].grandTotal);e.getModel("$sap.ui.mdc.Table").setProperty("/@custom/hasGrandTotal",o);const i=s.getPlugin(e._oTable,"sap.ui.table.plugins.V4Aggregation");i?.declareColumnsHavingTotals(S(e).map(e=>e.getInnerColumn()))}function P(e){return O(e,e.getColumns())}function b(e){return O(e,e.getControlDelegate().getInResultPropertyKeys(e))}function S(e){const t=Object.keys(e._getAggregatedProperties());const n=new Set;for(const r of e.getColumns()){const o=A(e,r).filter(e=>t.includes(e.key));const i=o.length>0;if(i){n.add(r);I(e,o).forEach(e=>{n.add(e)})}}return Array.from(n)}function O(e,t){const n=e.getPropertyHelper();const r=typeof t[0]==="object"?t.map(e=>e.getPropertyKey()):t;return Array.from(new Set(r.flatMap(e=>n.getProperty(e)?.getSimpleProperties().map(e=>e.key)||[])))}function A(e,t){const n=e.getPropertyHelper().getProperty(t.getPropertyKey());if(!n){return[]}else{return n.getSimpleProperties()}}function I(e,t){const n=[];t.forEach(e=>{if(e.unit){n.push(e.unit)}});return e.getColumns().filter(t=>A(e,t).some(e=>n.includes(e.key)))}function _(e,t,n){const r=[];if(t){t.forEach(t=>{e.getPropertyHelper().getProperty(t.name).getSimpleProperties().forEach(e=>{r.push(e.key)})})}const o=n?n.every(e=>r.find(t=>e.name?e.name===t:e===t)):true;return!o}function R(e,t){const n={Error:1,Warning:2,Information:3,None:4};if(!t||n[t.validation]-n[e.validation]>0){return e}else{return t}}function E(e){return e._isOfType(r.Table)&&(e._getGroupedProperties().length>0||e.isGroupingEnabled()||Object.keys(e._getAggregatedProperties()).length>0||e.isAggregationEnabled())}function x(e){const t=P(e);if(t.length===0){return undefined}const n={leafLevel:false,...e.getPayload()?.aggregationConfiguration};const r=e.getPropertyHelper();const o=e._getGroupedProperties().map(e=>e.name);const i=Object.keys(e._getAggregatedProperties());const a={group:{},groupLevels:[],aggregate:{},grandTotalAtBottomOnly:true,subtotalsAtBottomOnly:true};if(!n.leafLevel){C(a,e)}N(a,e);o.forEach(e=>{if(t.indexOf(e)<0){t.push(e)}});for(const n of t){const t=r.getProperty(n);if(t.extension.technicallyGroupable){v(a,e,t)}if(t.extension.technicallyAggregatable){G(a,e,t,{withTotals:i.includes(t.key)})}}o.forEach(e=>{const t=r.getProperty(e);if(t){a.groupLevels.push(t.path)}});if(!Object.keys(a.group).length&&!Object.keys(a.aggregate).length){return undefined}L(a);return a}function C(e,t){t.getPropertyHelper().getProperties().forEach(t=>{if(t.isKey){e.group[t.path]={}}})}function N(e,t){const n=t.getPropertyHelper();for(const r of b(t)){const t=n.getProperty(r);if(t.extension.technicallyGroupable){e.group[t.path]={}}else if(t.extension.technicallyAggregatable){e.aggregate[t.path]={}}}}function v(e,t,n){const r=t.getPropertyHelper();const o={};if(n.extension.additionalProperties.length===1){const o=r.getProperty(n.extension.additionalProperties[0]);if(o.text===n.key){v(e,t,o);return}}e.group[n.path]=o;const i=r.getProperty(n.text);if(i){o.additionally=[i.path]}const a=r.getProperty(n.unit);if(a){e.group[a.path]??={}}for(const t of n.extension.additionalProperties){const n=r.getProperty(t);e.group[n.path]??={}}}function G(e,t,n,r){const o=t.getPropertyHelper();const i={};e.aggregate[n.path]=i;if(r?.withTotals){i.grandTotal=true;i.subtotals=true}const a=o.getProperty(n.unit);if(a){i.unit=a.path}for(const t of n.extension.additionalProperties){const n=o.getProperty(t);e.group[n.path]??={}}}function L(e){$(e);M(e)}function $(e){for(const t in e.group){if(t in e.aggregate){if(e.aggregate[t].grandTotal||e.aggregate[t].subtotals){delete e.group[t]}else{delete e.aggregate[t]}}}}function M(e){const t=new Set;for(const n in e.group){e.group[n].additionally?.forEach(e=>t.add(e))}for(const n of t){if(n in e.group){delete e.group[n]}}}return u});
//# sourceMappingURL=TableDelegate.js.map