{"version":3,"file":"ValueHelpPreviewFactory.js","names":["ValueHelpPreviewFactory","_BaseFactory","EFB","token","_this","call","this","setControl","List","delete","onDelete","bind","mode","ListMode","Delete","showSeparators","ListSeparators","None","_inheritsLoose","_proto","prototype","setItems","items","tokenType","isDateTimeOffset","Utils","areItemsSame","list","getControl","destroyAggregation","ctr","forEach","item","index1","operator","selectedValues","title","isBetweenSelectedValues","mapOperatorForBetweenOperator","insertItem","selectedValue","index2","mapOperatorForValueHelp","mapOperator","indexPositions","addItem","StandardListItem","customData","CustomData","key","value","event","popover","getToken","getCustomDataValue","getParameter","setVisible","focus","normalizeString","str","regex","replace","invokeOkButtonHandler","easyFilterBarContainer","getEasyFilter","getItems","map","JSON","parse","stringify","deepClone","indicesToBeRemoved","listItem","getVisible","Infinity","getCustomData","find","data","getKey","getValue","push","sort","a","b","_ref","objIndex","valueIndex","splice","length","updateTokenArray","close","invokeShowAllButtonHandler","async","type","valueHelpPromise","Promise","resolve","reject","fireEvent","values","newSelectedValues","error","Error","Log","message","String","invokePopupCloseHandler","BaseFactory"],"sources":["./ValueHelpPreviewFactory.ts"],"sourcesContent":["import Log from \"sap/base/Log\";\nimport deepClone from \"sap/base/util/deepClone\";\nimport type { EnhanceWithUI5 } from \"sap/fe/base/ClassSupport\";\nimport { BaseFactory } from \"sap/fe/controls/easyFilter/innerControls/BaseFactory\";\nimport Utils from \"sap/fe/controls/easyFilter/utils\";\nimport List from \"sap/m/List\";\nimport type { ListBase$DeleteEvent } from \"sap/m/ListBase\";\nimport type Popover from \"sap/m/Popover\";\nimport StandardListItem from \"sap/m/StandardListItem\";\nimport { ListMode, ListSeparators } from \"sap/m/library\";\nimport CustomData from \"sap/ui/core/CustomData\";\nimport type EasyFilterBarContainer from \"../EasyFilterBarContainer\";\nimport type {\n\tBetweenSelectedValues,\n\tCodeListType,\n\tTokenDefinition,\n\tTokenSelectedValuesDefinition,\n\tTokenType,\n\tValueHelpBetweenSelectedValues,\n\tValueHelpSelectedValuesDefinition\n} from \"../EasyFilterBarContainer\";\nimport type EasyFilterToken from \"../Token\";\n\nclass ValueHelpPreviewFactory extends BaseFactory<List> {\n\tconstructor(EFB: EnhanceWithUI5<EasyFilterBarContainer>, token: EnhanceWithUI5<EasyFilterToken>) {\n\t\tsuper(EFB, token);\n\t\tthis.setControl(\n\t\t\tnew List({\n\t\t\t\tdelete: this.onDelete.bind(this),\n\t\t\t\tmode: ListMode.Delete,\n\t\t\t\tshowSeparators: ListSeparators.None\n\t\t\t})\n\t\t);\n\t}\n\n\tsetItems(\n\t\titems: ValueHelpSelectedValuesDefinition[] | TokenSelectedValuesDefinition[],\n\t\ttokenType: TokenType,\n\t\tisDateTimeOffset: boolean\n\t): void {\n\t\tif (Utils.areItemsSame(items, this.items as ValueHelpSelectedValuesDefinition[])) {\n\t\t\treturn;\n\t\t}\n\t\tthis.items = items;\n\t\tconst list = this.getControl();\n\t\tlist?.destroyAggregation(\"items\");\n\t\t//Make sure only top 5 values are shown\n\t\tlet ctr = 0;\n\t\titems.forEach((item, index1) => {\n\t\t\tconst { operator, selectedValues } = item;\n\t\t\tlet title = \"\";\n\t\t\t//Currently hardCoding the most number of values that can be shown is 5\n\t\t\t//ValueHelp will have non-fixed values, so its important to limit the number of values to be shown\n\t\t\tif (tokenType === \"ValueHelp\" && ctr < 5) {\n\t\t\t\tif (Utils.isBetweenSelectedValues(operator)) {\n\t\t\t\t\ttitle = Utils.mapOperatorForBetweenOperator(\n\t\t\t\t\t\toperator,\n\t\t\t\t\t\tselectedValues as ValueHelpBetweenSelectedValues,\n\t\t\t\t\t\ttokenType,\n\t\t\t\t\t\tisDateTimeOffset\n\t\t\t\t\t);\n\t\t\t\t\tthis.insertItem(list as List, title, [index1]);\n\t\t\t\t\t++ctr;\n\t\t\t\t} else {\n\t\t\t\t\tselectedValues.forEach((selectedValue, index2) => {\n\t\t\t\t\t\tif (ctr < 5) {\n\t\t\t\t\t\t\ttitle = Utils.mapOperatorForValueHelp(operator, selectedValue as CodeListType, tokenType, isDateTimeOffset);\n\t\t\t\t\t\t\tthis.insertItem(list as List, title, [index1, index2]);\n\t\t\t\t\t\t\t++ctr;\n\t\t\t\t\t\t}\n\t\t\t\t\t});\n\t\t\t\t}\n\t\t\t} else if (tokenType !== \"ValueHelp\") {\n\t\t\t\tif (Utils.isBetweenSelectedValues(operator)) {\n\t\t\t\t\ttitle = Utils.mapOperatorForBetweenOperator(\n\t\t\t\t\t\toperator,\n\t\t\t\t\t\tselectedValues as BetweenSelectedValues,\n\t\t\t\t\t\ttokenType,\n\t\t\t\t\t\tisDateTimeOffset\n\t\t\t\t\t);\n\t\t\t\t\t//In this case, we don't need t to store index2, because we know that LLM or VHD always gives you only 2 values in return\n\t\t\t\t\tthis.insertItem(list as List, title, [index1]);\n\t\t\t\t} else {\n\t\t\t\t\tselectedValues.forEach((selectedValue, index2) => {\n\t\t\t\t\t\ttitle = Utils.mapOperator(operator, selectedValue as string | boolean | number | Date, tokenType, isDateTimeOffset);\n\t\t\t\t\t\t//We need to store index2 to find out which item has been removed inside the array\n\t\t\t\t\t\tthis.insertItem(list as List, title, [index1, index2]);\n\t\t\t\t\t});\n\t\t\t\t}\n\t\t\t}\n\t\t});\n\t}\n\n\tinsertItem(list: List, title: string, indexPositions: number[]): void {\n\t\tlist?.addItem(\n\t\t\tnew StandardListItem({\n\t\t\t\ttitle,\n\t\t\t\tcustomData: new CustomData({\n\t\t\t\t\tkey: \"arrayIndex\",\n\t\t\t\t\tvalue: indexPositions\n\t\t\t\t})\n\t\t\t})\n\t\t);\n\t}\n\n\tonDelete(event: ListBase$DeleteEvent): void {\n\t\tconst popover = this.getToken()?.getCustomDataValue(\"popover\") as Popover;\n\t\tevent.getParameter(\"listItem\")?.setVisible(false);\n\t\tpopover.focus();\n\t}\n\n\tnormalizeString(str: string): string {\n\t\tconst regex = /^(>=|<=|!=|>|<)+/;\n\t\treturn str.replace(regex, \"\");\n\t}\n\n\tinvokeOkButtonHandler(): void {\n\t\tconst popover = this.getToken()?.getCustomDataValue(\"popover\") as Popover;\n\t\tconst token = this.getToken();\n\t\tconst easyFilterBarContainer = this.getEasyFilter() as EasyFilterBarContainer;\n\t\tconst items = token?.getItems()?.map((item) => ({\n\t\t\toperator: JSON.parse(JSON.stringify(item.operator)), // Deep copy of operator\n\t\t\tselectedValues: deepClone(item.selectedValues) // Deep copy of selectedValues, if its a complex object\n\t\t}));\n\t\tconst indicesToBeRemoved: number[][] = [];\n\t\tthis.getControl()\n\t\t\t?.getItems()\n\t\t\t.forEach((listItem) => {\n\t\t\t\t//If the item is hidden that means it should be removed completely\n\t\t\t\tif (!listItem.getVisible()) {\n\t\t\t\t\tconst [index1 = Infinity, index2 = Infinity] =\n\t\t\t\t\t\t(listItem\n\t\t\t\t\t\t\t?.getCustomData()\n\t\t\t\t\t\t\t?.find((data) => data?.getKey() === \"arrayIndex\")\n\t\t\t\t\t\t\t?.getValue() as number[]) ?? [];\n\t\t\t\t\tif (index1 === Infinity || !items) {\n\t\t\t\t\t\treturn;\n\t\t\t\t\t}\n\t\t\t\t\tindicesToBeRemoved.push([index1, index2]);\n\t\t\t\t}\n\t\t\t});\n\n\t\t/*\n\t\tWithout sorting in descending order:\n\n\t\tRemoving an object would shift all subsequent indices, potentially causing incorrect removals or skips.\n\t\tRemoving values from selectedValues could shift other values, resulting in missed or unintended removals.\n\t\tThis approach ensures that each removal operates on stable, correct indices.\n\n\t\tThis is the reason why we have added valueIndex to infinity\n\t\tInfinity is greater than any valid index, so sorting in descending order will naturally place entries with valueIndex = Infinity at the top for each objIndex.\n\t\tThis way, we can process the complete removal of an object before handling any individual selectedValues removals within that object, preventing unwanted shifts.\n\t\t */\n\t\tindicesToBeRemoved.sort((a, b) => b[0] - a[0] || b[1] - a[1]);\n\n\t\tindicesToBeRemoved.forEach(([objIndex, valueIndex]) => {\n\t\t\tif (items) {\n\t\t\t\t//If valueIndex is infinity, then it means it should be a between operator scenario, so remove the total object only\n\t\t\t\tif (valueIndex === Infinity) {\n\t\t\t\t\titems.splice(objIndex, 1);\n\t\t\t\t\treturn;\n\t\t\t\t}\n\t\t\t\titems[objIndex].selectedValues.splice(valueIndex, 1);\n\t\t\t\t// If the values array becomes empty, remove the whole object\n\t\t\t\tif (items[objIndex].selectedValues.length === 0) {\n\t\t\t\t\titems.splice(objIndex, 1);\n\t\t\t\t}\n\t\t\t}\n\t\t});\n\t\teasyFilterBarContainer.updateTokenArray(\n\t\t\t\"setSelectedValues\",\n\t\t\titems as TokenSelectedValuesDefinition[] | ValueHelpSelectedValuesDefinition[],\n\t\t\ttoken?.getKey() as string\n\t\t);\n\t\tpopover.close();\n\t}\n\n\tasync invokeShowAllButtonHandler(): Promise<void> {\n\t\tconst token = this.getToken();\n\t\tconst { type } = token?.getCustomDataValue(\"TokenInfo\") as TokenDefinition;\n\t\tconst key = token?.getKey() as string;\n\t\tconst valueHelpPromise = new Promise<TokenSelectedValuesDefinition[]>((resolve, reject) => {\n\t\t\tthis.getEasyFilter()?.fireEvent(\"showValueHelp\", {\n\t\t\t\tkey,\n\t\t\t\tvalues: token?.getItems()?.map((item: TokenSelectedValuesDefinition | ValueHelpSelectedValuesDefinition) => {\n\t\t\t\t\tif (type === \"ValueHelp\") {\n\t\t\t\t\t\treturn {\n\t\t\t\t\t\t\toperator: item.operator,\n\t\t\t\t\t\t\t//Making sure that only the id part is passed\n\t\t\t\t\t\t\tselectedValues: (item as ValueHelpSelectedValuesDefinition).selectedValues.map(\n\t\t\t\t\t\t\t\t(selectedValue) => selectedValue.value\n\t\t\t\t\t\t\t)\n\t\t\t\t\t\t};\n\t\t\t\t\t} else {\n\t\t\t\t\t\treturn item;\n\t\t\t\t\t}\n\t\t\t\t}),\n\t\t\t\tresolve,\n\t\t\t\treject\n\t\t\t});\n\t\t});\n\n\t\ttry {\n\t\t\tconst newSelectedValues = await valueHelpPromise;\n\t\t\tthis.getEasyFilter()?.updateTokenArray(\"setSelectedValues\", newSelectedValues, key);\n\t\t} catch (error) {\n\t\t\tif (error instanceof Error) {\n\t\t\t\tLog.error(\"Error while fetching new tokens\", error.message);\n\t\t\t} else {\n\t\t\t\tLog.error(\"Error while fetching new tokens\", String(error));\n\t\t\t}\n\t\t}\n\t}\n\n\tinvokePopupCloseHandler(): void {\n\t\t//Whatever has been deleted, make them appear again so that they can be visible as soon as you click the token again\n\t\tthis.getControl()\n\t\t\t?.getItems()\n\t\t\t.forEach((item) => item.setVisible(true));\n\t}\n}\n\nexport default ValueHelpPreviewFactory;\n"],"mappings":"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","ignoreList":[]}