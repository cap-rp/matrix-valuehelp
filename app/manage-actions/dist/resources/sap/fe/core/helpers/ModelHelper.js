/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)
 *      (c) Copyright 2009-2025 SAP SE. All rights reserved
 */
sap.ui.define(["sap/base/Log","sap/fe/base/BindingToolkit","sap/fe/core/controls/Any","sap/fe/core/converters/MetaModelConverter","sap/fe/core/helpers/MetaPath","sap/fe/core/helpers/TypeGuards","sap/ui/model/BindingMode","sap/ui/model/json/JSONModel","sap/ui/model/odata/type/Raw"],function(t,e,n,o,i,a,r,s,c){"use strict";var d=a.isPathAnnotationExpression;var l=a.isNavigationProperty;var g=a.isEntitySet;var f=o.getInvolvedDataModelObjects;var u=o.convertTypes;var p=e.compileExpression;const h={disableCollaborationDraft:false,isStickySessionSupported:function(t){const e=t.getObject("/");for(const n in e){if(e[n].$kind==="EntitySet"&&t.getObject(`/${n}@com.sap.vocabularies.Session.v1.StickySessionSupported`)){return true}}return false},isDraftSupported:function(t,e){const n=t.getMetaContext(e);const o=f(n);return this.isObjectPathDraftSupported(o)},isObjectPathDraftSupported:function(t){const e=t.targetEntitySet;const n=h.isDraftRoot(e);const o=h.isDraftNode(e);const i=l(t.targetObject)&&t.targetObject?.containsTarget&&(t.startingEntitySet?.annotations?.Common?.DraftRoot||t.startingEntitySet?.annotations?.Common?.DraftNode)?true:false;return n||o||!e&&i},isMetaPathDraftSupported:function(t){const e=t.getClosestEntitySet();const n=h.isDraftRoot(e);const o=h.isDraftNode(e);return n||o},isCollaborationDraftSupportedFromConverterContext(t){return t.getConvertedTypes().entitySets.some(t=>t.annotations?.Common?.DraftRoot?.ShareAction!==undefined)},isCollaborationDraftSupported:function(t,e){if(!h.disableCollaborationDraft){const n=e?.context?.getModel()||t;if(n.__$feIsCollaborationDraftEnabled!==undefined){return n.__$feIsCollaborationDraftEnabled}const o=n.getObject("/");for(const t in o){if(o[t].$kind==="EntitySet"&&n.getObject(`/${t}@com.sap.vocabularies.Common.v1.DraftRoot/ShareAction`)){n.__$feIsCollaborationDraftEnabled=true;return true}}n.__$feIsCollaborationDraftEnabled=false}return false},getDraftRootPath:function(t){const e=t.getModel().getMetaModel();const n=function(t,i){let a=arguments.length>2&&arguments[2]!==undefined?arguments[2]:true;const r=a?t:new RegExp(/.*(?=\/)/).exec(t)?.[0];if(r&&r!=="/"){const t=e.getMetaPath(r);const a=o.getInvolvedDataModelObjects(e.getContext(t));if(a.targetEntitySet?.annotations.Common?.DraftRoot){return r}return n(r,i,false)}return undefined};return n(t.getPath(),t.getModel())},getStickyRootPath:function(t){const e=t.getModel().getMetaModel();const n=function(t,i){let a=arguments.length>2&&arguments[2]!==undefined?arguments[2]:true;const r=a?t:new RegExp(/.*(?=\/)/).exec(t)?.[0];if(r&&r!=="/"){const t=e.getMetaPath(r);const a=o.getInvolvedDataModelObjects(e.getContext(t));if(a.startingEntitySet===a.targetEntitySet&&a.targetEntitySet?.annotations?.Session?.StickySessionSupported){return r}return n(r,i,false)}return undefined};return n(t.getPath(),t.getModel())},getTargetEntitySet:function(t){const e=t.getPath();if(t.getObject("$kind")==="EntitySet"||t.getObject("$kind")==="Action"||t.getObject("0/$kind")==="Action"){return e}const n=h.getEntitySetPath(e);return`/${t.getObject(n)}`},getEntitySetPath:function(t,e){let n="";if(!e){n=`/${t.split("/").filter(h.filterOutNavPropBinding).join("/$NavigationPropertyBinding/")}`}else{const o=t.split("/").filter(h.filterOutNavPropBinding);if(o.length>1){const t={growingPath:"/",pendingNavPropBinding:""};const i=o.reduce((t,n,o)=>{const i=!!o&&"/$NavigationPropertyBinding/"||"";let{growingPath:a,pendingNavPropBinding:r}=t;const s=a+i;const c=e.getObject(s);const d=r?`${r}/${n}`:n;if(c&&Object.keys(c).length>0&&c.hasOwnProperty(d)){a=s+d.replace("/","%2F");r=""}else{r+=r?`/${n}`:n}return{growingPath:a,pendingNavPropBinding:r}},t);n=i.growingPath}else{n=`/${o[0]}`}}return n},getActionParameterItemsModelPath:function(t){return t&&t.$Name?`{path: 'mvfview>/${t.$Name}'}`:undefined},filterOutNavPropBinding:function(t){return t!==""&&t!=="$NavigationPropertyBinding"},enhanceInternalJSONModel:function(t){const e=t.bindContext;t.bindContext=function(t,n,o,i){const a=e.apply(this,[t,n,o,i]);const r=a.getBoundContext;a.getBoundContext=function(){const t=r.apply(this);if(t){t.setProperty=function(t,e){if(this.getObject()===undefined){this.getModel().setProperty(this.getPath(),{})}const n=t.split("/");let o=this.getPath().replace(/\/$/,"");for(let t=0;t<n.length-1;t++){o=`${o}/${n[t]}`;if(this.getModel().getProperty(o)===undefined){this.getModel().setProperty(o,{})}}this.getModel().setProperty(t,e,this)}}return t};return a}},enhanceUiJSONModel:function(t,e){const n=t.setProperty;t.setProperty=function(o,i,a,r){if(o==="/isEditable"){t.setProperty("/editMode",i?e.EditMode.Editable:e.EditMode.Display,a,r)}return n.apply(this,[o,i,a,r])}},enhanceViewJSONModel:function(t){const e=t._getObject;t._getObject=function(t,n){if(t===undefined||t===""){t="/"}return e.apply(this,[t,n])}},isFilteringCaseSensitive:function(t,e){const n=e??t?.getObject("/@Org.OData.Capabilities.V1.FilterFunctions");if(!n){return true}return n.indexOf("tolower")===-1},getMetaPathForContext:function(t){const e=t.getModel(),n=e.getMetaModel(),o=t.getPath();return n&&o&&n.getMetaPath(o)},getRootEntitySetPath:function(t){let e="";const n=t?t.split("/"):[];if(n.length>1){e=n[1]}return e},getAbsoluteMetaPathForListBinding:function(t,e){const n=t.getModel().getMetaModel();let o;if(typeof e==="string"){if(e.startsWith("/")){o=n.getMetaPath(e)}else{const i=t.getBindingContext();const a=i.getPath();o=n.getMetaPath(`${a}/${e}`)}}else{const t=e;const i=t.getRootBinding();if(t===i){o=n.getMetaPath(t.getPath())}else{const e=i.getPath();const a=t.getPath();o=n.getMetaPath(`${e}/${a}`)}}return o},isDraftRoot:function(t){return this.getDraftRoot(t)!==undefined},isDraftNode:function(t){return this.getDraftNode(t)!==undefined},isSticky:function(t){return this.getStickySession(t)!==undefined},isUpdateHidden:function(t,e){if(g(t)){return t.annotations.UI?.UpdateHidden??e?.annotations.UI?.UpdateHidden}},getDraftRoot:function(t){return g(t)?t.annotations.Common?.DraftRoot:undefined},getDraftNode:function(t){return g(t)?t.annotations.Common?.DraftNode:undefined},getStickySession:function(t){return g(t)?t.annotations.Session?.StickySessionSupported:undefined},getDeleteHidden:function(t,e){if(g(t)){return t.annotations.UI?.DeleteHidden??e.annotations.UI?.DeleteHidden}},getAbsolutePathFromListBinding(t){const e=t.getModel().getMetaModel();let n;const o=t.getRootBinding();if(t===o){n=e.getMetaPath(t.getPath())}else{const i=o?.getPath();const a=t.getPath();n=e.getMetaPath(`${i}/${a}`)}return n},enhanceODataModel(e,a){e.virtualPropertyBindingRegistry=new Array;const c=e.setMessages;const l=new s({});l.setDefaultBindingMode(r.OneWay);const g=l.setProperty;const f=l.getProperty;l.getProperty=function(t,n){const[o,a]=t.split("@$ui5.fe.");if(n&&n.isTransient()!==true&&a==="@Common/ExternalID"){const t=n.getObject();if(t){const t=new i(u(e.getMetaModel()),e.getMetaModel().getMetaPath(n.getPath()),e.getMetaModel().getMetaPath(n.getPath()));const a=t.getMetaPathForPath(o)?.getTarget().annotations.Common?.ExternalID;if(d(a)){return n.getObject(a.path)}else{return n.getObject(o)}}else{return undefined}}else if(n&&a==="contextPath"){return n.getPath()}return f.apply(this,[t,n])};l.setProperty=function(n,o,a,r){let s=n;if(a){s=a.getPath(n)}const c=()=>{this.refresh()};const[l,f]=n.split("@$ui5.fe.");if(a&&f==="@Common/ExternalID"){a.setProperty(l,o);const n=new i(u(e.getMetaModel()),e.getMetaModel().getMetaPath(a.getPath()),e.getMetaModel().getMetaPath(a.getPath()));const r=n.getMetaPathForPath(l)?.getTarget().annotations.Common?.ExternalID;if(d(r)){const e=r.path;const o=[e.substring(0,e.lastIndexOf("/"))];const i=n.getMetaPathForPath(e)?.getTarget().annotations.Common?.Text;if(d(i)){const t=i.path;if(t.includes("/")){o.push(t)}}a.requestSideEffects(o).then(c).catch(e=>{t.error(e)})}}const p=s.split("/");let h="";for(let t=0;t<p.length-1;t++){if(t>0){h+="/"}h+=p[t];if(this.getObject(h)===undefined){this.setProperty(h,{})}}return g.apply(this,[n,o,a,r])};function y(t,e){for(const n in e){const o=e?.[n];const i=o?.isA?.("sap.ui.model.odata.v4.Context");if(typeof o==="object"&&!i){e[n]=y(t,e[n]);if(e[n]&&Object.keys(e[n]).length===0){delete e[n]}}for(const o of t){if(n.endsWith(o)){delete e[n]}}}return e}e._localAnnotationModel=l;e.getLocalAnnotationModel=function(){return this._localAnnotationModel};e.setMessages=function(t){const e=y(["@$ui5.fe.messageType","@$ui5.fe.messageText"],this._localAnnotationModel.getData());this._localAnnotationModel.setData(e);for(const e in t){this._localAnnotationModel.setProperty(`${e}@$ui5.fe.messageType`,t[e][0].getType());this._localAnnotationModel.setProperty(`${e}@$ui5.fe.messageText`,t[e][0].getMessage())}c.apply(this,[t])};const P=e.bindProperty.bind(e);e.bindProperty=function(i,r,s){const c=a.getEnvironmentCapabilities()?.getCapabilities().DisableInputAssistance;const d=h.setUpRecommendationLocalModelBinding(this,P,i,r,c);if(d){return d}if(i.endsWith("@$ui5.fe.@Common/ExternalID")&&r){const n=P(i,r);e.virtualPropertyBindingRegistry.push(n);const o=this._localAnnotationModel.bindProperty(i,r);n.attachChange(()=>{o.refresh()});n.requestValue().then(()=>{o.refresh();return}).catch(e=>{t.error(e)});return o}if(i.includes("@$ui5.fe.")){const t=this._localAnnotationModel.bindProperty(i,r);if(i.endsWith("@$ui5.fe.@Common/ExternalID")){return t}t.updateRequired=function(t){return t&&t===e};if(i.includes("@$ui5.fe.virtual.")){const e=o.getVirtualBindingExpression(i,o.convertTypes(this.getMetaModel()));const a=new n({any:p(e),bindBackProperty:i});const s=t.destroy.bind(t);t.destroy=()=>{a?.destroy();return s()};const c=t.setContext;if(c){t.setContext=e=>{a?.setBindingContext(e);return c.bind(t)(e)}}a.setModel(this);const d=a.getBindingInfo("any")?.binding;const l=d?.checkUpdate;if(l){a.getBindingInfo("any").binding.checkUpdate=()=>l.bind(d)(true)}a.setBindingContext(r)}return t}return P(i,r,s)};const m=e.destroy.bind(e);e.destroy=function(){for(const t of e.virtualPropertyBindingRegistry){t.destroy()}this._localAnnotationModel.destroy();return m.apply(this)}},fetchTextFromMetaModel(e,n,o){let i=e!==undefined?e:"";if(e?.startsWith("{metaModel>")){const a=e.substring(11,e.length-1);try{if(n){i=n.getEntityTypeAnnotation(a).annotation?.toString()??""}else{i=o?.getObject(a)}}catch(e){t.info(`Unable to retrieve text from meta model using path ${a}`)}}return i},getMessagesPath:function(t,e){const n=t.getMetaContext(e);const o=f(n);const i=o.targetEntityType.annotations.Common?.Messages;return d(i)?i.path:undefined},setUpRecommendationLocalModelBinding:function(e,n,o,i,a){if(o.includes("ui5.fe.recommendations")){const s=e.getLocalAnnotationModel().bindProperty(o,i);const d=t=>{const e=s.setContext;if(e){s.setContext=n=>{t?.setContext(n);return e.bind(t)(n)}}};if(i){const{recommendationComplexProperty:l,isRecommendedProperty:g}=h.validateRecommendationBindingPath(i,o);if(l&&g&&!a){const o=e.virtualPropertyBindingRegistry.some(t=>i.getPath()===t.getContext()?.getPath()&&l===t.getPath());if(!o){const o=n(l,i);o.setType(new c,"any");o.setBindingMode(r.OneWay);e.virtualPropertyBindingRegistry.push(o);o.attachChange(t=>{const e=t.getSource();const n=t.getSource().getContext();if(n){const t=e.getValue();h.setRecommendationsOnLocalAnnotationModel(t,n);s.refresh()}});o.requestValue().catch(e=>{t.error("Recommendations could not be resolved",e)});d(o)}}}s.updateRequired=function(t){return this.getContext()?t&&t===e:t&&this.getModel()===t};return s}},validateRecommendationBindingPath:function(t,e){const n=t.getModel().getMetaModel();const o=n.getMetaPath(t.getPath());const i=n.getMetaContext(o);const a=f(i).targetEntityType;const r=a?.annotations?.UI?.Recommendations?.path;const s=e.split("@$ui5.fe.recommendations")[0];const c=a.entityProperties.some(t=>{if(t.name===r){return t?.targetType?.properties.some(t=>s===t.name)}});return{recommendationComplexProperty:r,isRecommendedProperty:c}},setRecommendationsOnLocalAnnotationModel:function(t,e){if(t){for(const n in t){const o=t[n];const i=n;const a=e.getModel().getLocalAnnotationModel();const r=[];for(const t of o){if(t.RecommendedFieldIsSuggestion){const n=e.getPath(i+"@$ui5.fe.recommendations.placeholderValue");const o=e.getPath(i+"@$ui5.fe.recommendations.placeholderDescription");a.setProperty(n,t.RecommendedFieldValue,e,false);a.setProperty(o,t.RecommendedFieldDescription,e,false)}if(t.RecommendedFieldValue){r.push(t.RecommendedFieldValue)}}if(!o||!o.length){const t=e.getPath(i+"@$ui5.fe.recommendations.placeholderValue");const n=e.getPath(i+"@$ui5.fe.recommendations.placeholderDescription");a.setProperty(t,null,e,false);a.setProperty(n,"",e,false)}a.setProperty(e.getPath(i+"@$ui5.fe.recommendations.typeAheadValues"),r,e,false);a.setProperty(e.getPath("recommendationContext"),e)}}},getAlternateAndSecondaryKeys:(t,e)=>{const n=[];const o=t=>{t?.annotations?.Core?.AlternateKeys?.forEach(t=>{t.Key.forEach(t=>{n.push(t.Name.value)})})};const i=t=>{t?.annotations?.Common?.SecondaryKey?.forEach(t=>{if(!n.includes(t.value)){n.push(t.value)}})};o(e);if(!n.length){o(t)}i(t);return n}};return h},false);
//# sourceMappingURL=ModelHelper.js.map