/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)
 *      (c) Copyright 2009-2025 SAP SE. All rights reserved
 */
sap.ui.define(["sap/base/Log","sap/base/i18n/Localization","sap/fe/core/CommonUtils","sap/fe/core/TemplateModel","sap/fe/core/converters/ManifestSettings","sap/fe/core/converters/ManifestWrapper","sap/fe/core/definition/FEDefinition","sap/fe/core/helpers/LoaderUtils","sap/fe/core/helpers/ModelHelper","sap/fe/core/manifestMerger/ChangePageConfiguration","sap/ui/Device","sap/ui/VersionInfo","sap/ui/core/Core","sap/ui/core/mvc/View","sap/ui/core/service/Service","sap/ui/core/service/ServiceFactory","sap/ui/core/service/ServiceFactoryRegistry","sap/ui/model/json/JSONModel","../helpers/DynamicAnnotationPathHelper"],function(e,t,n,o,i,r,s,a,c,l,u,g,p,f,d,h,v,m,C){"use strict";var y=C.resolveDynamicExpression;var w=l.applyPageConfigurationChanges;var b=a.requireDependencies;var M=s.DefinitionContext;var V=i.TemplateType;function I(e,t){e.prototype=Object.create(t.prototype),e.prototype.constructor=e,P(e,t)}function P(e,t){return P=Object.setPrototypeOf?Object.setPrototypeOf.bind():function(e,t){return e.__proto__=t,e},P(e,t)}let S=function(i){function s(){return i.apply(this,arguments)||this}I(s,i);var a=s.prototype;a.init=function e(){const o=[];const i=this.getContext();const r=i.scopeObject;const s=n.getAppComponent(r);const a=s.getMetaModel();this.pageId=s.getLocalId(r.getId());const c=`${s.getMetadata().getComponentName()}::${this.pageId}`;const l=r.getEnhanceI18n()||[];let u;this.oFactory=i.factory;if(l){u=s.getMetadata().getComponentName();for(let e=0;e<l.length;e++){const t=s.getModel(l[e]);if(t&&t.isA("sap.ui.model.resource.ResourceModel")){l[e]=t}else{l[e]=`${u}.${l[e].replace(".properties","")}`}}}const f=`${s.getMetadata().getName()}_${c}_${t.getLanguageTag()}`;o.push(v.get("sap.fe.core.services.ResourceModelService").createInstance({scopeType:"component",scopeObject:r,settings:{bundles:["sap.fe.core.messagebundle","sap.fe.macros.messagebundle","sap.fe.templates.messagebundle"],enhanceI18n:l,modelName:"sap.fe.i18n"}}).then(e=>{this.oResourceModelService=e;return e.getResourceModel()}));o.push(v.get("sap.fe.core.services.CacheHandlerService").createInstance({settings:{metaModel:a,appComponent:s,component:r}}).then(async e=>{this.oCacheHandlerService=e;return e.validateCacheKey(f,r,s.getEnvironmentCapabilities())}));o.push(g.load().then(function(e){let t="";if(!e.libraries){t=p?.buildinfo?.buildtime??"<NOVALUE>"}else{e.libraries.forEach(function(e){t+=e.buildTimestamp})}return t}).catch(function(){return"<NOVALUE>"}));this.initPromise=Promise.all(o).then(async e=>{const t=e[0];const n=e[1];const[o,i]=await b(["sap/fe/core/converters/TemplateConverter","sap/fe/core/converters/MetaModelConverter"]);return this.createView(t,c,n,o,i)}).then(function(e){const t=v.get("sap.fe.core.services.CacheHandlerService").getInstance(a);t.invalidateIfNeeded(e,f,r,s.getEnvironmentCapabilities());return})};a.refreshView=async function t(n){const o=n.getRootControl();if(o){o.destroy()}else if(this.oView){this.oView.destroy()}return this.createView(this.resourceModel,this.stableId,"",this.TemplateConverter,this.MetaModelConverter).then(function(){n.getUIArea().invalidate();return}).catch(function(t){n.getUIArea().invalidate();e.error(t)})};a._getViewSettings=function e(t,n,o,i,r,s,a){let c=n.viewType||o.getViewType()||"XML";if(c!=="XML"){c=undefined}return{type:c,preprocessors:{xml:t,controls:{}},id:i.stableId,viewName:n.viewName||o.getViewName?.(),viewData:i,cache:{keys:[r],additionalData:{getAdditionalCacheData:()=>s.getData(),setAdditionalCacheData:e=>{s.setData(e)}}},models:{"sap.fe.i18n":a},height:"100%"}};a._createErrorPage=async function t(n,o,i,r,s){e.error(n.message,n);o.viewName=i;if(o.preprocessors){o.preprocessors.xml.models["error"]=new m(n)}return r.runAsOwner(async()=>f.create(o).then(e=>{this.oView=e;this.oView.setModel(new m(this.oView),"$view");r.setAggregation("rootControl",this.oView);r.getAppComponent().getRootControl().getController().getPlaceholder().hideRootPlaceholder();return s}))};a.createView=async function t(i,s,a,l,g){this.resourceModel=i;this.stableId=s;this.TemplateConverter=l;this.MetaModelConverter=g;const p=this.getContext();const d=p.settings;const h=d.converterType;const v=p.scopeObject;const C=n.getAppComponent(v);let w=C.getRoutingService().getTargetInformationFor(v)?.options?.settings?.fullContextPath??"";if(!w){w=v.getContextPath()??""}const b=C.getMetaModel();const I=C.getManifest();const P=new m(u).setDefaultBindingMode("OneWay");const S=new m(I);let D,O,N;try{const t=await C.getService("routingService");const n=t.getTargetInformationFor(v);const p=I["sap.app"]&&I["sap.app"].crossNavigation&&I["sap.app"].crossNavigation.outbounds||{};const T=v.getNavigation()||{};this._enhanceNavigationConfig(T,p);const E=g.convertTypes(b,C.getEnvironmentCapabilities().getCapabilities());const F=new M(E);F.addApplicationManifest(I);N={appComponent:C,navigation:T,viewLevel:n?.viewLevel,stableId:s,contentDensities:I["sap.ui5"]?.contentDensities,resourceModel:i,fullContextPath:w,isDesktop:u.system.desktop,isPhone:u.system.phone,converterType:V.FreeStylePage};if(v.getViewData){Object.assign(N,v.getViewData());N=x.setPageConfigurationChanges(I,N,C,this.pageId)}N.isShareButtonVisibleForMyInbox=x.getShareButtonVisibilityForMyInbox(C);const j=C.getShellServices();N.converterType=h;N.shellContentDensity=j.getContentDensity();const A=I["sap.fe"];N.sapFeManifestConfiguration=I["sap.fe"];N.retrieveTextFromValueList=A?.form?A?.form?.retrieveTextFromValueList:undefined;O=new m(N);if(N.controlConfiguration){for(const e in N.controlConfiguration){if(e.includes("[")){const t=y(e,b);N.controlConfiguration[t]=N.controlConfiguration[e]}}}D=new o(()=>{try{const t=C.getDiagnostics();const n=t.getIssues().length;const o=l.convertPage(h,b,N,new r(N,C),t,w,C.getEnvironmentCapabilities().getCapabilities(),v);const i=t.getIssues();const s=i.slice(n);if(s.length>0){e.warning("Some issues have been detected in your project, please check the UI5 support assistant rule for sap.fe.core")}return o}catch(t){e.error(t,t);return{}}},b);const _=w.split("/");const $=this._getFullPathToEntitySet(_,b);const R={bindingContexts:{entitySet:$?b.createBindingContext($):null,fullContextPath:w?b.createBindingContext(w):null,contextPath:w?b.createBindingContext(w):null,converterContext:D.createBindingContext("/",undefined,{noResolve:true}),viewData:N?O.createBindingContext("/"):null},models:{entitySet:b,fullContextPath:b,contextPath:b,"sap.fe.i18n":i,metaModel:b,device:P,manifest:S,converterContext:D,viewData:O},fullContextPath:w,getConvertedMetadata:()=>E,getDefinitionContext(){return F},getDefinitionForPage(){let e=w;if(e.endsWith("/")){e=e.substring(0,e.length-1)}return F.getPageFor(e)},appComponent:C,viewId:s},L=this._getViewSettings(R,d,v,N,a,D,i);v.setModel(D,"_pageModel");v.setPreprocessorContext(R);return v.runAsOwner(async()=>f.create(L).then(e=>{this.oView=e;const t=new m(this.oView);c.enhanceViewJSONModel(t);this.oView.setModel(t,"$view");this.oView.setModel(O,"viewData");v.setAggregation("rootControl",this.oView);return a}).catch(async e=>this._createErrorPage(e,L,d.errorViewName||"sap.fe.core.services.view.TemplatingErrorPage",v,a)).catch(t=>e.error(t.message,t)))}catch(t){e.error(t.message,t);throw new Error(`Error while creating view : ${t}`)}};a._enhanceNavigationConfig=function e(t,n){Object.keys(t).forEach(function(e){const o=t[e];let i;if(o.detail&&o.detail.outbound&&n[o.detail.outbound]){i=n[o.detail.outbound];o.detail.outboundDetail={semanticObject:i.semanticObject,action:i.action,parameters:i.parameters}}if(o.create&&o.create.outbound&&n[o.create.outbound]){i=n[o.create.outbound];o.create.outboundDetail={semanticObject:i.semanticObject,action:i.action,parameters:i.parameters}}})};a._getFullPathToEntitySet=function e(t,n){return t.reduce(function(e,t){if(t===""){return e}if(e===""){e=`/${t}`}else{const o=n.getObject(`${e}/$NavigationPropertyBinding/${t}`);if(o&&Object.keys(o).length>0){e+="/$NavigationPropertyBinding"}e+=`/${t}`}return e},"")};a.getView=function e(){return this.oView};a.getInterface=function e(){return this};a.exit=function e(){if(this.oResourceModelService){this.oResourceModelService.destroy()}if(this.oCacheHandlerService){this.oCacheHandlerService.destroy()}this.oFactory.removeGlobalInstance()};return s}(d);let x=function(e){function t(){var t;for(var n=arguments.length,o=new Array(n),i=0;i<n;i++){o[i]=arguments[i]}t=e.call(this,...o)||this;t._oInstanceRegistry={};return t}I(t,e);var n=t.prototype;n.createInstance=async function e(n){t.iCreatingViews++;const o=new S(Object.assign({factory:this},n));return o.initPromise.then(function(){t.iCreatingViews--;return o})};n.removeGlobalInstance=function e(){this._oInstanceRegistry={}};t.getShareButtonVisibilityForMyInbox=function e(t){const n=t.getComponentData();if(n!==undefined&&n.feEnvironment){return n.feEnvironment.getShareControlVisibility()}return undefined};t.getNumberOfViewsInCreationState=function e(){return t.iCreatingViews};t.setPageConfigurationChanges=function e(t,n,o,i){const r=t?.["sap.ui5"]?.routing?.targets??{};let s="";for(const e in r){if(r[e].id===i){s=e;break}}if(s===""){s=i}const a=t?.["sap.ui5"]?.routing?.targets?.[s]?.options?.settings||{};return w(a,n,o,i)};return t}(h);return x},false);
//# sourceMappingURL=TemplatedViewServiceFactory.js.map