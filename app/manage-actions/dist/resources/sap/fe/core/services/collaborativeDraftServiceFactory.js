/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)
 *      (c) Copyright 2009-2025 SAP SE. All rights reserved
 */
sap.ui.define(["sap/base/Log","sap/fe/core/CommonUtils","sap/fe/core/controllerextensions/collaboration/ActivityBase","sap/fe/core/controllerextensions/collaboration/CollaborationCommon","sap/fe/core/converters/MetaModelConverter","sap/fe/core/helpers/ModelHelper","sap/m/MessageBox","sap/ui/core/service/Service","sap/ui/core/service/ServiceFactory"],function(t,e,n,o,i,s,r,c,a){"use strict";var l={};var u=o.getActivityKeyFromPath;var d=o.CollaborationUtils;var g=o.Activity;var f=n.isCollaborationConnected;var p=n.initializeCollaboration;var h=n.endCollaboration;var C=n.broadcastCollaborationMessage;function y(t,e){t.prototype=Object.create(e.prototype),t.prototype.constructor=t,P(t,e)}function P(t,e){return P=Object.setPrototypeOf?Object.setPrototypeOf.bind():function(t,e){return t.__proto__=e,t},P(t,e)}const A="/collaboration/myActivities";const v="/collaboration/activeUsers";const m="/collaboration/activities";const M="/collaboration/asyncMsgQueue";const b="/collaboration/retainedMessages";const x="/collaboration/asyncMsgTimerId";const O="$auto.sync";const F=500;let D=function(n){function o(){return n.apply(this,arguments)||this}l.CollaborativeDraftService=o;y(o,n);var c=o.prototype;c.checkPathForLock=function t(e,n){const o=e.getProperty(A);if(!o){return false}else{return o.includes(n)}};c.setLock=function t(e,n){const o=e.getProperty(A)??[];if(!o.includes(n)){o.push(n)}e.setProperty(A,o)};c.removeLock=function t(e,n){const o=e.getProperty(A);if(!o||n===undefined){return false}const i=Array.isArray(n)?n:[n];const s=o.filter(t=>!i.includes(t));e.setProperty(A,s);return s.length!==o.length};c.getLockedProperties=function t(e){const n=e.getProperty(A);if(!n){return undefined}else{return n.join("|")}};c.updateLocksForContextPath=function t(e,n,o){if(!this.isConnected(e)){return}const i=e.getModel("internal");const s=i.getProperty(M);s.forEach(t=>{if(t.path.startsWith(n)){t.path=t.path.replace(n,o)}});const r=i.getProperty(A);if(r){const t=[];const s=[];r.forEach(e=>{if(e.startsWith(n)){const i=e.replace(n,o);t.push(i)}else{s.push(e)}});i.setProperty(A,s);if(t.length!==0){this.send(e,{action:g.Lock,content:t})}}};c.resetAsyncMessagesTimer=function t(e){let n=e.getProperty(x);if(n!==undefined){clearTimeout(n)}n=setTimeout(()=>{const t=e.getProperty(M);const n=[];const o=e.getProperty(b)??[];if(!t){return}t.forEach(t=>{if(o.includes(t.path)){n.push(t)}else{this.doSend(e,t.action,t.path)}});e.setProperty(M,n);e.setProperty(x,undefined);if(n.length){this.resetAsyncMessagesTimer(e)}},F);e.setProperty(x,n)};c.retainAsyncMessages=function t(e,n){const o=e.getModel("internal");const i=Array.isArray(n)?n:[n];const s=o.getProperty(b);i.forEach(t=>{if(!s.includes(t)){s.push(t)}})};c.releaseAsyncMessages=function t(e,n){const o=e.getModel("internal");const i=o.getProperty(b);const s=Array.isArray(n)?n:[n];o.setProperty(b,i.filter(t=>!s.includes(t)))};c.isConnected=function t(e){const n=e.getModel("internal");return f(n)};c.send=function t(e,n){if(this.isConnected(e)){const t=e.getModel("internal");if(n.action===g.Lock||n.action===g.Unlock){this.doSendAsync(t,n.action,n.content)}else{this.doSend(t,n.action,n.content,n.triggeredActionName,n.refreshListBinding,n.actionRequestedProperties)}}};c.doSend=function t(e,n,o,i,s,r){const c=(Array.isArray(o)?o.join("|"):o)??"";const a=r?.join("|");if(n===g.Lock){const t=(Array.isArray(o)?o[0]:o)??"";if(this.checkPathForLock(e,t)){return}else{this.setLock(e,t)}}else if(n===g.Unlock){const t=this.removeLock(e,o);if(!t){return}}C(n,c,e,i,s,a)};c.doSendAsync=function t(e,n,o){if(o===undefined){return}const i=e.getProperty(M);const s=Array.isArray(o)?o:[o];const r=i.filter(t=>!s.includes(t.path));s.forEach(t=>{r.push({path:t,action:n})});e.setProperty(M,r);this.resetAsyncMessagesTimer(e)};c.isCollaborationEnabled=function t(e){const n=e?.getBindingContext&&e.getBindingContext();return!!(n&&s.isCollaborationDraftSupported(n.getModel().getMetaModel()))};c.connect=async function t(n){const o=n.getModel("internal");const i=d.getMe(e.getAppComponent(n));if(!i){return}const s=n.getBindingContext();const r=await s.requestProperty("DraftAdministrativeData/DraftUUID");if(!r){return}const c=p(i,r,o,t=>{this.messageReceive(t,n)},n);if(c){o.setProperty(A,[]);o.setProperty(M,[]);o.setProperty(b,[])}};c.disconnect=function t(e){const n=e.getModel("internal");h(n)};c.userJoinDraft=function t(e,n,o,i,s){if(e.findIndex(t=>t.id===o.id)===-1){e.unshift(o);n.setProperty(v,e)}if(i.userAction===g.Join){C(g.JoinEcho,this.getLockedProperties(n),n)}if(i.userAction===g.JoinEcho){if(i.clientContent){i.userAction=g.Lock;this.messageReceive(i,s)}}};c.userLeaveDraft=function t(e,n,o){e=e.filter(t=>t.id!==o.id||t.me);n.setProperty(v,e);const i=n.getProperty(m)||{};const s=function(t){if(Array.isArray(t)){return t.filter(t=>t.id!==o.id)}else{for(const e in t){t[e]=s(t[e])}return t}};s(i);n.setProperty(m,i)};c.messageReceive=function t(e,n){const o=n.getModel("internal");const i=o.getProperty(v);let s;let r;const c=this.calculateMetaPath(n,e.clientContent);e.userAction=e.userAction||e.clientAction;const a={id:e.userID,name:e.userDescription,initials:d.formatInitials(e.userDescription),color:d.getUserColor(e.userID,i,[])};let l=a;switch(e.userAction){case g.Join:case g.JoinEcho:this.userJoinDraft(i,o,a,e,n);break;case g.Leave:this.userLeaveDraft(i,o,a);break;case g.Change:this.updateOnChange(n,e);break;case g.Create:this.updateOnCreate(n,e);break;case g.Delete:this.updateOnDelete(n,e);break;case g.Activate:this.draftClosedByOtherUser(n,e.clientContent,d.getText("C_COLLABORATIONDRAFT_ACTIVATE",a.name));break;case g.Discard:this.draftClosedByOtherUser(n,e.clientContent,d.getText("C_COLLABORATIONDRAFT_DISCARD",a.name));break;case g.Action:this.updateOnAction(n,e);break;case g.Lock:l=a;l.key=u(e.clientContent);let t="";const f=c.split("/");for(let e=1;e<f.length-1;e++){t+=`/${f[e]}`;if(!o.getProperty(m+t)){o.setProperty(m+t,{})}}s=o.getProperty(m+c);s=s?.slice?s.slice():[];s.push(l);o.setProperty(m+c,s);break;case g.Unlock:s=o.getProperty(m+c);r=u(e.clientContent);o.setProperty(m+c,s?.filter(t=>t.key!==r));break}};c.draftClosedByOtherUser=function e(n,o,i){this.disconnect(n);r.information(i,{onClose:async()=>{try{await n.getBindingContext().getBinding().resetChanges();this.navigate(o,n);return}catch(e){t.error("Pending Changes could not be reset - still navigating to active instance");this.navigate(o,n)}}})};c.updateOnChange=function t(e,n){const o=n.clientContent.split("|");const i=this.getCurrentPage(e);const s=i.getBindingContext();const r=o.map(async t=>this.applyUpdatesForChange(e,t));i.getController().editFlow.updateDocument(s,Promise.all(r))};c.applyUpdatesForChange=async function e(n,o){const s=n.getModel().getMetaModel();const r=s.getMetaContext(o);const c=i.getInvolvedDataModelObjects(r);const a=o.substring(0,o.lastIndexOf("/"));const l=this.findContextForUpdate(n,a);const u=a.substring(0,a.lastIndexOf("("));const g=u.substring(0,u.lastIndexOf("/"));const f=g?this.findContextForUpdate(n,g):undefined;if(!l&&!f){return}try{const t=[];const e=d.getAppComponent(n).getSideEffectsService();if(l){const n=s.getMetaPath(l.getPath());const i=s.getMetaPath(o).replace(n,"").slice(1);t.push(e.requestSideEffects([i],l,O))}const i=e.computeFieldGroupIds(c.targetEntityType.fullyQualifiedName,c.targetObject.fullyQualifiedName);if(i.length){const e=n.getController();const o=e._sideEffects.getSideEffectsMapForFieldGroups(i,l||f);Object.keys(o).forEach(n=>{const i=o[n];t.push(e._sideEffects.requestSideEffects(i.sideEffects,i.context,O,undefined,true))})}await Promise.all(t)}catch(e){t.error("Failed to update data after change:"+e);throw e}};c.updateOnDelete=function t(e,n){const o=this.getCurrentPage(e);const i=o.getBindingContext();const s=i.getPath();const c=n.clientContent.split("|");const a=c.find(t=>s.startsWith(t));if(a){r.information(d.getText("C_COLLABORATIONDRAFT_DELETE",n.userDescription),{onClose:()=>{const t=i.getModel().getKeepAliveContext(a);t.setKeepAlive(false);const n=this.applyUpdatesForCollection(e,c[0]);o.getController().editFlow.updateDocument(o.getBindingContext(),n);o.getController()._routing.navigateBackFromContext(t)}})}else{const t=this.applyUpdatesForCollection(e,c[0]);o.getController().editFlow.updateDocument(o.getBindingContext(),t)}};c.updateOnCreate=function t(e,n){const o=this.getCurrentPage(e);const i=n.clientContent.split("|");const s=this.applyUpdatesForCollection(e,i[0]);o.getController().editFlow.updateDocument(o.getBindingContext(),s)};c.applyUpdatesForCollection=async function e(n,o){const i=d.getAppComponent(n);const s=o.substring(0,o.lastIndexOf("/"));const r=this.findContextForUpdate(n,s);if(r){try{const t=[];const e=r.getModel().getMetaModel();const n=e.getMetaPath(o);const s=e.getMetaPath(r.getPath());const c=n.replace(`${s}/`,"");const a=i.getSideEffectsService();t.push(a.requestSideEffects([c],r,O));t.push(a.requestSideEffectsForNavigationProperty(c,r,O,true));await Promise.all(t)}catch(e){t.error("Failed to update data after collection update:"+e)}}};c.updateOnAction=function t(e,n){const o=this.getCurrentPage(e);const i=n.clientContent.split("|");const s=n.clientTriggeredActionName||"";const r=n.clientRequestedProperties?.split("|");const c=n.clientRefreshListBinding==="true";let a=[];if(c){a.push(this.applyUpdatesForCollection(e,i[0]))}else{a=i.map(async t=>this.requestUpdateForAction(e,t,s,r))}o.getController().editFlow.updateDocument(o.getBindingContext(),Promise.all(a))};c.requestUpdateForAction=async function t(e,n,o,s){const r=this.findContextForUpdate(e,n);if(!r){return}const c=d.getAppComponent(e);const a=c.getSideEffectsService();const l=a.getODataActionSideEffects(o,r);const u=[];if(l){if(l.pathExpressions?.length){u.push(a.requestSideEffects(l.pathExpressions,r,O))}}if(s&&s.length>0){const t=e.getModel().getMetaModel();const o=this.calculateMetaPath(e,n);const c=i.getInvolvedDataModelObjects(t.getContext(o));const l=c.targetEntityType.entityProperties.map(t=>t.name).filter(t=>s.includes(t));if(l.length>0){u.push(a.requestSideEffects(l,r,O))}}await Promise.all(u)};c.findContextForUpdate=function t(e,n){if(!n){return undefined}const o=[];while(!n.endsWith(")")){o.unshift(n);n=n.substring(0,n.lastIndexOf("/"))}o.unshift(n);const i=n.substring(0,n.lastIndexOf("("));let s;let r=this.getCurrentPage(e).getBindingContext();while(r&&!s){if(o.includes(r.getPath())){s=r}r=r.getBinding()?.getContext()}if(s){return s}const c=this.getCurrentPage(e).getBindingContext().getModel();const a=c.getAllBindings().find(t=>{const e=t.isRelative()?t.getResolvedPath():t.getPath();return t.isA("sap.ui.model.odata.v4.ODataListBinding")&&e===i});s=a?.getAllCurrentContexts().find(t=>o.includes(t.getPath()));return s};c.navigate=function t(e,n){const o=this.getCurrentPage(n);const i=n.getModel().bindContext(e).getBoundContext();if(o.getController().editFlow.getCreationMode()){o.getController()._routing.navigateBackFromContext(i)}else{o.getController().routing.navigate(i)}};c.getCurrentPage=function t(n){const o=d.getAppComponent(n);return e.getCurrentPageView(o)};c.calculateMetaPath=function t(e,n){let o="";if(n){const t=n.split("|")[0];o=e.getModel().getMetaModel().getMetaPath(t)}return o};c.init=function t(){this.initPromise=Promise.resolve(this)};return o}(c);l.CollaborativeDraftService=D;let k=function(t){function e(){return t.apply(this,arguments)||this}l=e;y(e,t);var n=e.prototype;n.createInstance=async function t(e){const n=new D(e);return n.initPromise};return e}(a);l=k;return l},false);
//# sourceMappingURL=collaborativeDraftServiceFactory.js.map