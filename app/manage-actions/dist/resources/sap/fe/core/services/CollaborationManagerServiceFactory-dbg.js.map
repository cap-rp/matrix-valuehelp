{"version":3,"names":["CollaborationManagerService","_Service","_this","_len","arguments","length","args","Array","_key","call","__implements__sap_insights_ICardProvider","registered","_exports","_inheritsLoose","_proto","prototype","init","initPromise","Promise","resolve","appComponent","getContext","scopeObject","getCardsChannel","default","cardHelper","__ui5_require_async","service","getServiceAsync","connect","providerId","onRetrieveAvailableCards","channel","isEnabled","id","consumers","sharedCards","registerProvider","updateConsumers","error","Log","debug","onConsumerConnected","shareAvailableCards","Object","keys","onConsumerDisconnected","onCardRequested","consumerId","cardId","card","find","callback","onViewUpdate","active","unregisterProvider","unregister","undefined","publishAvailableCards","addCardsToCollaborationManager","cards","parentAppId","entries","push","title","getDesignTimeCard","cardType","_this2","reject","Library","load","name","then","sap","ui","require","_len2","params","_key2","retrieveCard","generatedManifest","getObjectPageCardManifestForPreview","catch","publishCard","descriptorContent","Service","CollaborationManagerServiceFactory","_ServiceFactory","apply","_proto2","createInstance","oServiceContext","instance","getInstance","ServiceFactory","serviceClass"],"sourceRoot":".","sources":["CollaborationManagerServiceFactory.ts"],"sourcesContent":["import Log from \"sap/base/Log\";\nimport type RetrieveCard from \"sap/cards/ap/common/services/RetrieveCard\";\nimport type { RetrieveCardType } from \"sap/cards/ap/common/services/RetrieveCard\";\nimport type { CardManifest } from \"sap/insights/CardHelper\";\nimport type CardsChannel from \"sap/insights/CardsChannel\";\nimport type { ICardProvider, SharedCard } from \"sap/insights/CardsChannel\";\nimport Library from \"sap/ui/core/Lib\";\nimport Service from \"sap/ui/core/service/Service\";\nimport ServiceFactory from \"sap/ui/core/service/ServiceFactory\";\nimport type { ServiceContext } from \"types/metamodel_types\";\nimport type AppComponent from \"../AppComponent\";\n\ntype CollaborationManagerSettings = {};\n\nexport type WrappedCard = Pick<NonNullable<SharedCard>, \"card\" | \"title\" | \"callback\">;\n\nexport class CollaborationManagerService extends Service<CollaborationManagerSettings> implements ICardProvider {\n\tinitPromise!: Promise<CollaborationManagerService>;\n\n\t// eslint-disable-next-line camelcase\n\t__implements__sap_insights_ICardProvider = true;\n\n\tprivate channel!: CardsChannel;\n\n\tprivate id!: string;\n\n\tprivate consumers!: Record<string, boolean>;\n\n\tprivate onRetrieveAvailableCards?: () => Promise<void>;\n\n\tprivate sharedCards!: SharedCard[];\n\n\tprivate registered = false;\n\n\tprivate appComponent!: AppComponent;\n\n\tinit(): void {\n\t\tthis.initPromise = new Promise((resolve) => {\n\t\t\tthis.appComponent = this.getContext().scopeObject as AppComponent;\n\t\t\tresolve(this);\n\t\t});\n\t}\n\n\tprivate async getCardsChannel(): Promise<CardsChannel> {\n\t\tconst { default: cardHelper } = await import(\"sap/insights/CardHelper\");\n\t\tconst service = await cardHelper.getServiceAsync(\"UIService\");\n\t\treturn service.getCardsChannel();\n\t}\n\n\tpublic async connect(providerId: string, onRetrieveAvailableCards: () => Promise<void>): Promise<CollaborationManagerService> {\n\t\ttry {\n\t\t\tconst channel = await this.getCardsChannel();\n\t\t\tif (channel.isEnabled()) {\n\t\t\t\tthis.onRetrieveAvailableCards = onRetrieveAvailableCards;\n\t\t\t\tthis.channel = channel;\n\t\t\t\tthis.id = providerId;\n\t\t\t\tthis.consumers = {};\n\t\t\t\tthis.sharedCards = [];\n\t\t\t\tif (this.registered !== true) {\n\t\t\t\t\tawait this.registerProvider();\n\t\t\t\t}\n\t\t\t\tthis.updateConsumers();\n\t\t\t}\n\t\t} catch (error: unknown) {\n\t\t\tLog.debug(\"Collaboration Manager connection failed\", error as Error | string);\n\t\t}\n\t\treturn this;\n\t}\n\n\tpublic async onConsumerConnected(id: string): Promise<number> {\n\t\tif (!this.consumers[id]) {\n\t\t\tthis.consumers[id] = true;\n\t\t\tawait this.onRetrieveAvailableCards?.();\n\t\t\tthis.shareAvailableCards(id);\n\t\t}\n\t\treturn Promise.resolve(Object.keys(this.consumers).length);\n\t}\n\n\tpublic async onConsumerDisconnected(id: string): Promise<number> {\n\t\tif (this.consumers[id]) {\n\t\t\tdelete this.consumers[id];\n\t\t}\n\t\treturn Promise.resolve(Object.keys(this.consumers).length);\n\t}\n\n\tpublic onCardRequested(consumerId: string, cardId: string): SharedCard {\n\t\tconst card = this.sharedCards.find((card) => card?.id === cardId);\n\t\tcard?.callback?.(card.card);\n\t\treturn card;\n\t}\n\n\tpublic async onViewUpdate(active: boolean): Promise<void> {\n\t\t// register / unregister if the status of the home page changed\n\t\tif (this.registered !== active) {\n\t\t\tif (active) {\n\t\t\t\tawait this.registerProvider();\n\t\t\t\tthis.updateConsumers();\n\t\t\t} else {\n\t\t\t\tawait this.unregisterProvider();\n\t\t\t}\n\t\t} else if (this.registered) {\n\t\t\tthis.updateConsumers();\n\t\t}\n\t}\n\n\tprivate async registerProvider(): Promise<void> {\n\t\tif (this.channel) {\n\t\t\tawait this.channel.registerProvider(this.id, this);\n\t\t\tthis.registered = true;\n\t\t}\n\t}\n\n\tpublic async unregisterProvider(): Promise<void> {\n\t\tif (this.channel) {\n\t\t\tawait this.channel.unregister(this.id);\n\t\t\tthis.registered = false;\n\t\t\tthis.consumers = {};\n\t\t\tthis.sharedCards = [];\n\t\t\tthis.onRetrieveAvailableCards = undefined;\n\t\t}\n\t}\n\n\tprivate updateConsumers(): void {\n\t\tthis.shareAvailableCards();\n\t}\n\n\tpublic shareAvailableCards(consumerId = \"*\"): void {\n\t\tthis?.channel?.publishAvailableCards(this.id, this.sharedCards, consumerId);\n\t}\n\n\tpublic addCardsToCollaborationManager(cards: Record<string, WrappedCard>, parentAppId: string): void {\n\t\tthis.sharedCards = [];\n\t\tfor (const [id, card] of Object.entries(cards)) {\n\t\t\tthis.sharedCards.push({\n\t\t\t\tid: id,\n\t\t\t\ttitle: card.title,\n\t\t\t\tparentAppId: parentAppId,\n\t\t\t\tcallback: card.callback,\n\t\t\t\tcard: card.card\n\t\t\t});\n\t\t}\n\t}\n\n\tpublic async getDesignTimeCard(cardType: RetrieveCardType): Promise<Record<string, unknown> | undefined> {\n\t\treturn new Promise((resolve, reject) => {\n\t\t\tLibrary.load({ name: \"sap/cards/ap/common\" })\n\t\t\t\t.then((): void => {\n\t\t\t\t\tsap.ui.require([\"sap/cards/ap/common/services/RetrieveCard\"], async (...params: unknown[]) => {\n\t\t\t\t\t\tconst retrieveCard = params[0] as typeof RetrieveCard;\n\t\t\t\t\t\tlet generatedManifest;\n\t\t\t\t\t\tconst appComponent = this.appComponent;\n\t\t\t\t\t\ttry {\n\t\t\t\t\t\t\tgeneratedManifest = await retrieveCard.getObjectPageCardManifestForPreview(appComponent, {\n\t\t\t\t\t\t\t\tcardType: cardType\n\t\t\t\t\t\t\t});\n\t\t\t\t\t\t} catch (error) {\n\t\t\t\t\t\t\tLog.error(error as string);\n\t\t\t\t\t\t}\n\t\t\t\t\t\tresolve(generatedManifest);\n\t\t\t\t\t});\n\t\t\t\t\treturn;\n\t\t\t\t})\n\t\t\t\t.catch(function (error) {\n\t\t\t\t\tLog.error(error as string);\n\t\t\t\t\treject();\n\t\t\t\t});\n\t\t});\n\t}\n\n\tpublic publishCard(card: CardManifest): void {\n\t\tthis.channel.publishCard(this.id, { id: card[\"sap.app\"].id, descriptorContent: card }, \"*\");\n\t}\n}\n\nexport default class CollaborationManagerServiceFactory extends ServiceFactory<CollaborationManagerSettings> {\n\tstatic serviceClass = CollaborationManagerService;\n\n\tprivate instance!: CollaborationManagerService;\n\n\tasync createInstance(oServiceContext: ServiceContext<CollaborationManagerSettings>): Promise<CollaborationManagerService> {\n\t\tthis.instance = new CollaborationManagerService(oServiceContext);\n\t\treturn this.instance.initPromise;\n\t}\n\n\tgetInstance(): CollaborationManagerService {\n\t\treturn this.instance;\n\t}\n\n\tshareAvailableCards(): void {\n\t\tthis.instance.shareAvailableCards();\n\t}\n}\n"],"mappings":"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","ignoreList":[],"file":"CollaborationManagerServiceFactory-dbg.js"}