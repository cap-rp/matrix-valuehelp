{"version":3,"file":"sticky.js","names":["ProgrammingModel","FELibrary","getConvertedAction","context","operation","operationName","getActionName","metaModel","getModel","getMetaModel","actionPath","getMetaPath","getPath","boundAction","createBindingContext","convertTypes","resolvePath","target","model","sEntitySetPath","getObject","async","editDocumentInStickySession","appComponent","messageHandler","convertedAction","result","Operation","contexts","label","getResourceModel","getText","skipMessages","oDataProperties","disableSideEffects","ignoreETag","undefined","groupId","replaceWithRVC","getBinding","isA","deferredSubmit","bindingParameters","$$inheritExpandSelect","execute","status","Error","reason","newContext","value","returnedContext","sideEffects","getSideEffectsService","getODataActionSideEffects","triggerActions","length","requestSideEffectsForODataAction","activateDocument","metaPath","messagesPath","requestSideEffects","error","Log","discardDocument","discardActionAnnotation","discardAction","bindContext","then","processDataLossConfirmation","fnProcess","view","programmingModel","uiEditable","CommonUtils","getIsEditable","resourceBundle","Library","getResourceBundleFor","warningMsg","confirmButtonTxt","cancelButtonTxt","Sticky","MessageBox","warning","actions","emphasizedAction","onClose","actionText","info","sticky"],"sources":["./sticky.ts"],"sourcesContent":["import type { Action as EdmAction } from \"@sap-ux/vocabularies-types\";\nimport { CommonAnnotationTerms } from \"@sap-ux/vocabularies-types/vocabularies/Common\";\nimport Log from \"sap/base/Log\";\nimport type AppComponent from \"sap/fe/core/AppComponent\";\nimport type { FEView } from \"sap/fe/core/BaseController\";\nimport CommonUtils from \"sap/fe/core/CommonUtils\";\nimport { getResourceModel } from \"sap/fe/core/helpers/ResourceModelHelper\";\nimport FELibrary from \"sap/fe/core/library\";\nimport MessageBox from \"sap/m/MessageBox\";\nimport Library from \"sap/ui/core/Lib\";\nimport type Context from \"sap/ui/model/odata/v4/Context\";\nimport { convertTypes } from \"../../converters/MetaModelConverter\";\nimport type MessageHandler from \"../MessageHandler\";\nimport Operation from \"./operations/Operation\";\n\nconst ProgrammingModel = FELibrary.ProgrammingModel;\n\n/**\n * Gets the converted action for a given context and operation.\n * @param context  The context that should be bound to the operation\n * @param operation The operation name\n * @returns The converted action\n */\nfunction getConvertedAction(context: Context, operation: string): EdmAction | undefined {\n\tconst operationName = getActionName(context, operation);\n\tconst metaModel = context.getModel().getMetaModel(),\n\t\tactionPath = `${metaModel.getMetaPath(context.getPath())}/${operationName}`,\n\t\tboundAction = metaModel.createBindingContext(actionPath)!;\n\treturn convertTypes(metaModel).resolvePath<EdmAction | undefined>(boundAction.getPath()).target;\n}\n\n/**\n * Determines the action name for a draft operation.\n * @param context The context that should be bound to the operation\n * @param operation The operation name\n * @returns The name of the draft operation\n */\nfunction getActionName(context: Context, operation: string): string {\n\tconst model = context.getModel(),\n\t\tmetaModel = model.getMetaModel(),\n\t\tsEntitySetPath = metaModel.getMetaPath(context.getPath());\n\n\treturn metaModel.getObject(`${sEntitySetPath}@com.sap.vocabularies.Session.v1.StickySessionSupported/${operation}`);\n}\n\n/**\n * Opens a sticky session to edit a document.\n * @param context Context of the document to be edited\n * @param appComponent The AppComponent\n * @param messageHandler The message handler controller extension\n * @returns A Promise resolved when the sticky session is in edit mode\n */\nasync function editDocumentInStickySession(\n\tcontext: Context,\n\tappComponent: AppComponent,\n\tmessageHandler: MessageHandler\n): Promise<Context | undefined> {\n\tconst operation = \"EditAction\";\n\tconst convertedAction = getConvertedAction(context, operation);\n\tif (convertedAction) {\n\t\tconst result = await new Operation(appComponent, context.getModel(), convertedAction, {\n\t\t\tmessageHandler: messageHandler,\n\t\t\tcontexts: [context],\n\t\t\tlabel: getResourceModel(appComponent).getText(\"C_COMMON_OBJECT_PAGE_EDIT\"),\n\t\t\tskipMessages: true,\n\t\t\toDataProperties: {\n\t\t\t\tdisableSideEffects: true,\n\t\t\t\tignoreETag: context.getObject() === undefined, // If the context has not been loaded yet, we can ignore the ETag (as no previous ETag is available)\n\t\t\t\tgroupId: \"direct\",\n\t\t\t\treplaceWithRVC: context.getBinding().isA(\"sap.ui.model.odata.v4.ODataListBinding\"),\n\t\t\t\tdeferredSubmit: false\n\t\t\t},\n\t\t\tbindingParameters: { $$inheritExpandSelect: true }\n\t\t}).execute();\n\t\tif (result[0].status === \"rejected\") {\n\t\t\tthrow new Error(result[0].reason);\n\t\t} else {\n\t\t\tconst newContext = result[0].value.returnedContext;\n\t\t\tif (newContext) {\n\t\t\t\tconst sideEffects = appComponent\n\t\t\t\t\t.getSideEffectsService()\n\t\t\t\t\t.getODataActionSideEffects(getActionName(context, operation), newContext);\n\t\t\t\tif (sideEffects?.triggerActions && sideEffects.triggerActions.length) {\n\t\t\t\t\tawait appComponent.getSideEffectsService().requestSideEffectsForODataAction(sideEffects, newContext);\n\t\t\t\t}\n\t\t\t}\n\t\t\treturn newContext;\n\t\t}\n\t} else {\n\t\tthrow new Error(`Edit Action for Sticky Session not found for ${operation}`);\n\t}\n}\n/**\n * Activates a document and closes the sticky session.\n * @param context Context of the document to be activated\n * @param appComponent Context of the document to be activated\n * @param messageHandler The message handler controller extension\n * @returns A promise resolve when the sticky session is activated\n */\nasync function activateDocument(context: Context, appComponent: AppComponent, messageHandler: MessageHandler): Promise<Context> {\n\tconst operation = \"SaveAction\";\n\tconst model = context.getModel(),\n\t\tmetaModel = model.getMetaModel(),\n\t\tmetaPath = metaModel.getMetaPath(context.getPath());\n\n\tconst convertedAction = getConvertedAction(context, operation);\n\tif (convertedAction) {\n\t\tconst result = await new Operation(appComponent, context.getModel(), convertedAction, {\n\t\t\tmessageHandler: messageHandler,\n\t\t\tcontexts: [context],\n\t\t\tlabel: getResourceModel(appComponent).getText(\"C_OP_OBJECT_PAGE_SAVE\"),\n\t\t\tskipMessages: true,\n\t\t\toDataProperties: {\n\t\t\t\tdisableSideEffects: true,\n\t\t\t\tignoreETag: context.getObject() === undefined, // If the context has not been loaded yet, we can ignore the ETag (as no previous ETag is available)\n\t\t\t\tgroupId: \"direct\",\n\t\t\t\treplaceWithRVC: context.getBinding().isA(\"sap.ui.model.odata.v4.ODataListBinding\"),\n\t\t\t\tdeferredSubmit: false\n\t\t\t}\n\t\t}).execute();\n\n\t\tif (result[0].status === \"rejected\") {\n\t\t\tconst messagesPath = metaModel.getObject(`${metaPath}/@${CommonAnnotationTerms.Messages}/$Path`) as string | undefined;\n\n\t\t\tif (messagesPath) {\n\t\t\t\ttry {\n\t\t\t\t\tawait appComponent.getSideEffectsService().requestSideEffects([messagesPath], context);\n\t\t\t\t} catch (error: unknown) {\n\t\t\t\t\tLog.error(\"Error while requesting side effects\", error as string);\n\t\t\t\t}\n\t\t\t}\n\t\t\tthrow new Error(result[0].reason);\n\t\t} else if (result[0].value.returnedContext === undefined) {\n\t\t\tthrow new Error(`Save Action for Sticky Session doesn't return a context for ${metaPath}`);\n\t\t}\n\t\treturn result[0].value.returnedContext;\n\t} else {\n\t\tthrow new Error(`Save Action for Sticky Session not found for ${metaPath}`);\n\t}\n}\n/**\n * Discards a document and closes sticky session.\n * @param context Context of the document to be discarded\n * @returns A promise resolved when the document is dicarded\n */\nasync function discardDocument(context: Context): Promise<Context> {\n\tconst model = context.getModel(),\n\t\tmetaModel = model.getMetaModel(),\n\t\tmetaPath = metaModel.getMetaPath(context.getPath()),\n\t\tdiscardActionAnnotation = metaModel.getObject(`${metaPath}@com.sap.vocabularies.Session.v1.StickySessionSupported/DiscardAction`);\n\n\tif (!discardActionAnnotation) {\n\t\tthrow new Error(`Discard Action for Sticky Session not found for ${metaPath}`);\n\t}\n\n\tconst discardAction = model.bindContext(`/${discardActionAnnotation}(...)`);\n\treturn discardAction.execute(\"$single\").then(function () {\n\t\treturn context;\n\t});\n}\n\n/**\n * Process the Data loss confirmation.\n * @param fnProcess Function to execute after confirmation\n * @param view Current view\n * @param programmingModel Programming Model of the current page\n * @returns `void` i think\n */\nfunction processDataLossConfirmation(fnProcess: Function, view: FEView, programmingModel: string): void {\n\tconst uiEditable = CommonUtils.getIsEditable(view),\n\t\tresourceBundle = Library.getResourceBundleFor(\"sap.fe.templates\")!,\n\t\twarningMsg = resourceBundle.getText(\"T_COMMON_UTILS_NAVIGATION_AWAY_MSG\"),\n\t\tconfirmButtonTxt = resourceBundle.getText(\"T_COMMON_UTILS_NAVIGATION_AWAY_CONFIRM_BUTTON\"),\n\t\tcancelButtonTxt = resourceBundle.getText(\"T_COMMON_UTILS_NAVIGATION_AWAY_CANCEL_BUTTON\");\n\n\tif (programmingModel === ProgrammingModel.Sticky && uiEditable) {\n\t\treturn MessageBox.warning(warningMsg, {\n\t\t\tactions: [confirmButtonTxt, cancelButtonTxt],\n\t\t\temphasizedAction: confirmButtonTxt,\n\t\t\tonClose: function (actionText: string) {\n\t\t\t\tif (actionText === confirmButtonTxt) {\n\t\t\t\t\tLog.info(\"Navigation confirmed.\");\n\t\t\t\t\tfnProcess();\n\t\t\t\t} else {\n\t\t\t\t\tLog.info(\"Navigation rejected.\");\n\t\t\t\t}\n\t\t\t}\n\t\t});\n\t}\n\treturn fnProcess();\n}\n\n/**\n * Static functions for the sticky session programming model\n * @namespace\n * @experimental This module is only for experimental use! <br/><b>This is only a POC and maybe deleted</b>\n * @since 1.54.0\n */\nconst sticky = {\n\teditDocumentInStickySession: editDocumentInStickySession,\n\tactivateDocument: activateDocument,\n\tdiscardDocument: discardDocument,\n\tprocessDataLossConfirmation: processDataLossConfirmation\n};\n\nexport default sticky;\n"],"mappings":"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","ignoreList":[]}