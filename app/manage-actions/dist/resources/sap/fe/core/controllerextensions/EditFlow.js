/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)
 *      (c) Copyright 2009-2025 SAP SE. All rights reserved
 */
sap.ui.define(["sap/base/Log","sap/fe/base/ClassSupport","sap/fe/core/CommonUtils","sap/fe/core/controllerextensions/BaseControllerExtension","sap/fe/core/controllerextensions/BusyLocker","sap/fe/core/controllerextensions/Feedback","sap/fe/core/controllerextensions/collaboration/CollaborationCommon","sap/fe/core/controllerextensions/editFlow/TransactionHelper","sap/fe/core/controllerextensions/editFlow/draft","sap/fe/core/controllerextensions/editFlow/editFlowConstants","sap/fe/core/controllerextensions/editFlow/sticky","sap/fe/core/converters/MetaModelConverter","sap/fe/core/helpers/EditState","sap/fe/core/helpers/ModelHelper","sap/fe/core/helpers/ResourceModelHelper","sap/fe/core/helpers/SemanticKeyHelper","sap/fe/core/library","sap/m/Button","sap/m/Dialog","sap/m/MessageToast","sap/m/Text","sap/ui/core/Element","sap/ui/core/Lib","sap/ui/core/Messaging","sap/ui/core/message/Message","sap/ui/core/message/MessageType","sap/ui/core/mvc/OverrideExecution","sap/ui/model/Filter","sap/ui/model/Sorter","../ActionRuntime","../controls/Recommendations/ConfirmRecommendationDialog","../converters/ManifestSettings","../helpers/TypeGuards","./routing/NavigationReason"],function(e,t,n,i,o,s,a,r,c,l,d,g,f,h,u,p,y,m,C,w,M,D,b,P,v,E,A,S,x,I,k,R,_,T){"use strict";var O,F,B,H,V,N,j,L,U,G,$,q,K,W,z,J,Q,X,Y,Z,ee,te,ne,ie,oe,se,ae,re,ce,le,de,ge,fe,he,ue,pe,ye,me,Ce,we,Me,De,be,Pe,ve,Ee,Ae,Se;var xe=_.isFulfilled;var Ie=R.CreationMode;var ke=k.RecommendationDialogDecision;var Re=k.ConfirmRecommendationDialog;var _e=u.getResourceModel;var Te=g.getInvolvedDataModelObjects;var Oe=g.convertTypes;var Fe=a.shareObject;var Be=a.CollaborationUtils;var He=a.Activity;var Ve=s.triggerConfiguredSurvey;var Ne=s.TriggerType;var je=s.StandardActions;var Le=t.publicExtension;var Ue=t.methodOverride;var Ge=t.finalExtension;var $e=t.extensible;var qe=t.defineUI5Class;function Ke(e,t){e.prototype=Object.create(t.prototype),e.prototype.constructor=e,We(e,t)}function We(e,t){return We=Object.setPrototypeOf?Object.setPrototypeOf.bind():function(e,t){return e.__proto__=t,e},We(e,t)}function ze(e,t,n,i,o){var s={};return Object.keys(i).forEach(function(e){s[e]=i[e]}),s.enumerable=!!s.enumerable,s.configurable=!!s.configurable,("value"in s||s.initializer)&&(s.writable=!0),s=n.slice().reverse().reduce(function(n,i){return i(e,t,n)||n},s),o&&void 0!==s.initializer&&(s.value=s.initializer?s.initializer.call(o):void 0,s.initializer=void 0),void 0===s.initializer?(Object.defineProperty(e,t,s),null):s}const Je=y.ProgrammingModel,Qe=y.Constants,Xe=y.DraftStatus,Ye=y.EditMode,Ze=y.StartupMode;let et=(O=qe("sap.fe.core.controllerextensions.EditFlow"),F=Ue(),B=Le(),H=Ge(),V=Le(),N=Ge(),j=Le(),L=Ge(),U=Le(),G=$e(A.After),$=Le(),q=$e("AfterAsync"),K=Le(),W=$e("AfterAsync"),z=Le(),J=$e(A.After),Q=Le(),X=$e(A.After),Y=Le(),Z=$e("AfterAsync"),ee=Le(),te=$e(A.After),ne=Le(),ie=$e(A.After),oe=Le(),se=$e(A.After),ae=Le(),re=$e(A.After),ce=Le(),le=$e(A.After),de=Le(),ge=Ge(),fe=Le(),he=Ge(),ue=Le(),pe=Ge(),ye=Le(),me=Ge(),Ce=Le(),we=Ge(),Me=Le(),De=$e(A.After),be=Le(),Pe=$e(A.Instead),ve=Le(),Ee=Ge(),O(Ae=(Se=function(t){function i(){var i;for(var o=arguments.length,s=new Array(o),a=0;a<o;a++){s[a]=arguments[a]}i=t.call(this,...s)||this;i.syncTasks=Promise.resolve();i.handleSideEffects=async(t,o)=>{try{const e=i.getView().getBindingContext();const s=await o;await s.created();if(!n.hasTransientContext(t)&&e){i.getAppComponent().getSideEffectsService().requestSideEffectsForNavigationProperty(t.getPath(),e)}}catch(t){e.error("Error while creating the document",t)}};i.createCustomValidationMessages=(e,t)=>{const n=t.getCreationRow().data("customValidationFunction");const o=t.getBindingContext("internal")?.getProperty("creationRowCustomValidity");const s=[];let a;let r;const c=P.getMessageModel().getData().filter(e=>e.getCode()===n);P.removeMessages(c);e.forEach(e=>{if(e.messageTarget){a=D.getElementById(o[e.messageTarget].fieldId);r=`${a.getBindingContext()?.getPath()}/${a.getBindingPath("value")}`;if(!P.getMessageModel().getData().filter(e=>e.getTargets().some(e=>e===r)).length){P.addMessages(new v({message:e.messageText,processor:i.getView().getModel(),type:E.Error,code:n,technical:false,persistent:false,target:r}))}const t=P.getMessageModel().getData().filter(e=>e.getTargets().some(e=>e===r));t[0].addControlId(o[e.messageTarget].fieldId)}else{s.push({code:n,text:e.messageText,persistent:true,type:E.Error})}});if(s.length){i.getMessageHandler().showMessageDialog({customMessages:s})}};i.resolveCreationMode=(e,t,n)=>{if(e!==Ie.NewPage){return e}else{const e=t.getModel().getMetaModel();const o=i.getProgrammingModel(t);if(!t.isRelative()){const n=Te(e.getMetaContext(t.getPath()));const i=n.targetEntitySet,s=(o===Je.Draft?i?.annotations.Common?.DraftRoot:i?.annotations.Session?.StickySessionSupported)?.NewAction?.toString();if(s&&n.targetEntityType.actions[s].parameters.length>1){return Ie.Deferred}}const s=i.getTransactionHelper().getCreationParameters(t,n,i.getAppComponent());if(s.length){return Ie.Deferred}return Ie.Async}};return i}Ke(i,t);var s=i.prototype;s.onInit=function e(){this._hiddenDraft=this.getAppComponent().getEnvironmentCapabilities().getCapabilities().HiddenDraft};s.getInterface=function e(){return t.prototype.getInterface.call(this)};s.getAppComponent=function e(){return this.base.getAppComponent()};s.editDocument=async function t(n){const i=this.getTransactionHelper();const o=this._getRootViewController();const s=n.getModel();const a=this.getView().getViewData();const r=this.getProgrammingModel(n);const c="editGroup";const l=this.getMessageHandler().registerToHoldMessages();try{const e=await this.getRootContext(n);await this.base.editFlow.onBeforeEdit({context:e});let t=this._isFclEnabled()?o.getRightmostContext():n;if(t===undefined||r===Je.Draft&&this.getProgrammingModel(t)!==Je.Draft){t=n}const d=i.editDocument(e,this.base.getView(),this.getAppComponent(),this.getMessageHandler(),c);const g={rootSiblingPathPromise:d};this._setStickySessionInternalProperties(r,s);let f;const u=t!==e||a?.viewLevel>1;if(u){f=this._computeSiblingInformation(e,t,r,true,g,c)}n.getModel().submitBatch(c);let p=await f;const y=await d;let m=y;if(u&&m){if(p===undefined){p=await this._computeSiblingInformation(e,t,r,true,g,"$auto")}m=this._getNavigationTargetForEdit(n,y,p)}else{this._updatePathsInHistory([])}let C=false;if(y){if(r!==Je.Sticky&&h.isCollaborationDraftSupported(s.getMetaModel())){Fe(y);this.fetchCollaborativeDraftUsersPromise=y.requestSideEffects(["DraftAdministrativeData/DraftAdministrativeUser"],"$auto.Workers")}await this.base.editFlow.onAfterEdit({context:m});await this._handleNewContext(m,{editable:true,recreateContext:false,forceFocus:true});if(r===Je.Sticky){let e;if(this._isFclEnabled()){e=y?.getModel().getKeepAliveContext(y.getPath())}else{e=y}await this.handleStickyOn(e)}C=true;this.setEditMode(Ye.Editable,false);this.setDocumentModified(false)}this.getMessageHandler().showMessageDialog({unHoldKey:l,overrideUIDecision:C});return m}catch(t){this.getMessageHandler().showMessageDialog({unHoldKey:l});e.error("Error while editing the document",t);return Promise.reject(t)}};s.requestSideEffectsOnDelete=function e(t,i){if(!t||!i||n.hasTransientContext(t)){return}const o=this.getAppComponent().getSideEffectsService();o.requestSideEffectsForNavigationProperty(t.getPath(),i);const s=h.getMessagesPath(t.getModel().getMetaModel(),i.getPath());if(s&&this.getTransactionHelper().isListBindingHierarchical(t)){o.requestSideEffects([s],i)}};s.deleteMultipleDocuments=async function t(n,i){i.beforeDeleteCallBack=this.base.editFlow.onBeforeDelete;i.requestSideEffects=i.requestSideEffects!==false;const s=this.getGlobalUIModel();const a=this.getView().byId(i.controlId)??D.getElementById(i.controlId);let r=[];if(a?.isA("sap.ui.mdc.Table")){r=n.filter(e=>e.isInactive())}if(!a){throw new Error("parameter controlId missing or incorrect")}else{i.parentControl=a}const c=a.getBinding("items")||a.getRowBinding();i.bFindActiveContexts=true;o.lock(s);try{if(this.getProgrammingModel(i?.selectedContexts?.[0]??n[0])===Je.Sticky){this.setDocumentModified(true)}await this.deleteDocumentTransaction(n,i);let e;if(a.isA("sap.ui.mdc.Table")){a.clearSelection()}const t=this.getView().getBindingContext();if(c.isRoot()){e=this.getTransactionHelper().refreshListBinding(c,this.getAppComponent())}else if(i.requestSideEffects){this.requestSideEffectsOnDelete(c,t)}if(!this.getAppComponent()._isFclEnabled()){f.setEditStateDirty()}const o=this.base.recommendations.isRecommendationEnabled();if(o){this.base.recommendations.ignoreRecommendationForContexts(n)}await this.base.editFlow.onAfterDelete({contexts:n});if(a.isA("sap.ui.mdc.Table")){const e=a.getParent();if(e?.tableDefinition?.control?.creationMode===Ie.InlineCreationRows&&r.length>0){e.removeEmptyRowsMessages(r);await e.setUpEmptyRows(a,false)}}this._sendActivity(He.Delete,n);return await e}catch(t){if(c.isRoot()){await this.getTransactionHelper().refreshListBinding(c,this.getAppComponent())}else if(i.requestSideEffects){const e=this.getView().getBindingContext();this.requestSideEffectsOnDelete(c,e)}e.error("Error while deleting the document(s)",t)}finally{o.unlock(s)}};s.updateDocument=async function t(n,i){const o=this.getView().getBindingContext();const s=this.getProgrammingModel(n)===Je.Draft;this.getMessageHandler().removeTransitionMessages();const a=this.getMessageHandler().registerToHoldMessages();return this.syncTask(async()=>{if(o){this.setDocumentModified(true);if(!this._isFclEnabled()){f.setEditStateDirty()}if(s){this.setDraftStatus(Xe.Saving)}}try{await i;const e=this.getView().getBindingContext();if(!s||!e||e!==o){return}const t=e.getModel().getMetaModel();const n=t.getMetaContext(e.getPath()).getObject("@sapui.name");const a=p.getSemanticKeys(t,n);if(a?.length&&e.getProperty("IsActiveEntity")===false&&e.getProperty("HasActiveEntity")===true){const t=this._getSemanticMapping();const n=t?.semanticPath,i=p.getSemanticPath(e,true);if(n&&n!==i){await this._handleNewContext(e,{editable:true,recreateContext:false})}}this.setDraftStatus(Xe.Saved)}catch(t){e.error("Error while updating the document",t);if(s&&o){this.setDraftStatus(Xe.Clear)}}finally{await this.getMessageHandler().showMessages({unHoldKey:a})}})};s.getParentContextFromSelection=function e(t){if(t&&t.length>1){throw new Error(`Cannot create a new document in a TreeTable with ${t.length} parents`)}return t?.length===1?t[0]:undefined};s.createDocument=async function e(t,n){let i;let o;const s=function(e,t){const n=e.getView().getModel();if(!n){return undefined}return n.bindList(t)};if(typeof t==="object"&&t.isA&&t.isA("sap.fe.core.IRowBindingInterface")){i=t.getRowBinding();t=i}if(n.creationMode!==Ie.External){if(typeof t==="string"){const e=s(this,t);if(!e){return}else{i=e}delete n.createAtEnd}else if(typeof t==="object"&&t.isA&&t.isA("sap.ui.model.odata.v4.ODataListBinding")){i=t}else{throw new Error("Binding object or path expected")}if(this.getTransactionHelper().isListBindingHierarchical(i)){o=this.getParentContextFromSelection(n.selectedContexts)}}const a=this.resolveCreationMode(n.creationMode,i,n.data);this.getAppComponent().getRouterProxy().removeIAppStateKey();if((n.singleDraftForCreate!==undefined?n.singleDraftForCreate:this.getAppComponent().getManifest()["sap.fe"]?.app?.singleDraftForCreate)&&i===i.getRootBinding()&&i.getHeaderContext()!==null){const e=i.getModel()?.bindList(i.getPath(),i.getContext(),new x("DraftAdministrativeData/LastChangeDateTime",true),new S({filters:[new S({path:"IsActiveEntity",operator:"EQ",value1:false}),new S({path:"HasActiveEntity",operator:"EQ",value1:false})],and:true}));const s=await(e?.requestContexts(0,1));if(s.length>0){return this._handleNewContext(s[0],{editable:true,recreateContext:false}).then(()=>e?.destroy())}e?.destroy();return this._handleCreationMode(a,t,n,i,o)}return this._handleCreationMode(a,t,n,i,o)};s._handleCreationMode=async function e(t,n,i,o,s){this._updatePathsInHistory([]);switch(t){case Ie.External:return this.createExternalDocument(n,i.outbound);case Ie.Deferred:return this.createDeferredDocument(o,s,i.data);case Ie.CreationRow:return i.creationRow?this.createCreateRowDocument({creationRow:i.creationRow,skipSideEffects:i.skipSideEffects,createAtEnd:i.createAtEnd}):undefined;case Ie.Inline:return this.createDialogInlineDocument({creationMode:Ie.Inline,tableId:i.tableId,createAtEnd:i.createAtEnd,skipSideEffects:i.skipSideEffects,parentContext:s,data:i.data},o);case Ie.CreationDialog:if(o.isRelative()){return this.createDialogInlineDocument({creationMode:Ie.CreationDialog,tableId:i.tableId,createAtEnd:i.createAtEnd,skipSideEffects:i.skipSideEffects,parentContext:s,data:i.data,creationDialogFields:i.creationDialogFields},o)}else{return this.createDialogAndSaveDocument({tableId:i.tableId,createAtEnd:i.createAtEnd,skipSideEffects:i.skipSideEffects,parentContext:s,data:i.data,creationDialogFields:i.creationDialogFields},o)}case Ie.Sync:case Ie.Async:return this.createSyncAsyncDocument({creationMode:t,data:i.data,bFromDeferred:i.bFromDeferred,skipSideEffects:i.skipSideEffects,createAction:i.createAction,parentContext:s},o);default:throw new Error(`Unhandled creationMode ${t}`)}};s.postDocumentCreation=async function e(t,n){const i=this.getProgrammingModel(n);const o=n.getModel();const s=await t;const a=s[0];this._setStickySessionInternalProperties(i,o);await this.base.editFlow.onAfterCreate({context:a});this.setEditMode(Ye.Editable);if(!n.isRelative()){if(i===Je.Sticky){const e=o.getMetaModel().getMetaContext(n.getPath());const t=Te(e).startingEntitySet;const i=t?.annotations.Session?.StickySessionSupported?.NewAction;this.getInternalModel().setProperty("/lastInvokedAction",i)}else if(this.getTransactionHelper().isListBindingHierarchical(n)||this.getTransactionHelper().isListBindingAnalytical(n)){this.forceDraftSaveOrDiscard(true)}}if(a){this.setDocumentModifiedOnCreate(n);if(!this._isFclEnabled()){f.setEditStateDirty()}this._sendActivity(He.Create,a);if(h.isCollaborationDraftSupported(o.getMetaModel())&&this.isDraftRoot(a)&&!this.base.collaborativeDraft.isConnected()){this.getInternalModel().setProperty("/executeShareActionForCollaboration",true)}}};s.createCreateRowDocument=async function t(n){let i;const s=this.getAppComponent();const a=n.creationRow;const r=n.creationRow.getParent();let c=Promise.resolve();if(!r){return}const l=r.getModel()?.getMetaModel();const d=r.getRowBinding();if(this.getTransactionHelper().isListBindingHierarchical(d)){throw new Error(`Unhandled creationMode "CreationRow" with a TreeTable`)}const g=a.getBindingContext();const f=this.getCreationRowValidationFunction(r);if(a.data("disableAddRowButtonForEmptyData")==="true"){r.getBindingContext("internal")?.setProperty("creationRowFieldValidity",{})}const h=await this.syncTask(f);if(h.length>0){this.createCustomValidationMessages(h,r);e.error("Custom Validation failed");return}const u=Te(l.getMetaContext(g.getPath())).targetEntityType;const p=g.getObject();await this._checkForValidationErrors();d.attachEventOnce("change",async()=>{await i;r.scrollToIndex(n.createAtEnd?r.getRowBinding().getLength():0)});this.handleCreateEvents(d);try{i=this.getTransactionHelper().createDocument(d,{data:Object.assign({},...Object.keys(p).filter(e=>u.navigationProperties.findIndex(t=>t.name===e)===-1).map(e=>({[e]:p[e]}))),keepTransientContextOnFailed:false,busyMode:"Local",busyId:r?.getParent()?.getTableDefinition()?.annotation.id,parentControl:this.getView(),beforeCreateCallBack:this.base.editFlow.onBeforeCreate,skipParameterDialog:s.getStartupMode()===Ze.AutoCreate,createAtEnd:n.createAtEnd,creationMode:Ie.CreationRow},s,this._getResourceModel(),this.getMessageHandler(),false);if(!n.skipSideEffects){this.handleSideEffects(d,i)}await i;const t=g.getBinding();const o=t.create();a.setBindingContext(o);o.created()?.catch(()=>{e.trace("transient fast creation context deleted")});c=g.delete("$direct");return await this.postDocumentCreation(Promise.all([i,c]),d)}catch(t){if(o.isLocked(this.base.getView().getModel("ui"))){o.unlock(this.base.getView().getModel("ui"))}e.error("CreationRow navigation error: ",t)}};s.createDialogInlineDocument=async function e(t,n){let i;if(t.tableId){i=this.getView().byId(t.tableId)}if(i?.isA("sap.ui.mdc.Table")){i.getRowBinding().attachEventOnce("createCompleted",async()=>{const e=await o;const t=e.getIndex();const s=n.getAggregation();const a=s?.createInPlace??false;if(t!==undefined&&t>=0){i?.focusRow(t,true)}else if(a){w.show(this._getResourceModel().getText("C_NEW_ELEMENT_NOT_DISPLAYED"))}if(this.getTransactionHelper().isListBindingHierarchical(n)&&!a){const t=e.getParent();const n=t?.getIndex();if(n!==undefined&&n>=0){i?.scrollToIndex(n)}}})}else{i=undefined}this.handleCreateEvents(n);const o=this.getTransactionHelper().createDocument(n,{keepTransientContextOnFailed:false,busyMode:"Local",busyId:i?.getParent()?.getTableDefinition()?.annotation.id,parentControl:this.getView(),beforeCreateCallBack:this.base.editFlow.onBeforeCreate,skipParameterDialog:this.getAppComponent().getStartupMode()===Ze.AutoCreate,createAtEnd:t.createAtEnd,creationMode:t.creationMode,parentContext:t.parentContext,data:t.data,creationDialogFields:t.creationDialogFields},this.getAppComponent(),this._getResourceModel(),this.getMessageHandler(),false);if(!t.skipSideEffects){this.handleSideEffects(n,o)}return this.postDocumentCreation(Promise.all([o,this.syncTask(o)]),n)};s.createDialogAndSaveDocument=async function t(n,i){let o;if(n.tableId){o=this.getView().byId(n.tableId);if(o?.isA("sap.ui.mdc.Table")!==true){o=undefined}}let s;const a=async t=>{try{await this.base.editFlow.onAfterCreate({context:t})}catch(t){e.error("Error after creation: "+t)}await this.base.editFlow.onBeforeSave({context:t});s=await this.getTransactionHelper().saveDocument(t,this.getAppComponent(),this._getResourceModel(),false,[],this.getMessageHandler(),true,true);try{await this.base.editFlow.onAfterSave({context:s})}catch(t){e.error("Error after save: "+t)}if(this.getTransactionHelper().isListBindingHierarchical(i)){const e=o?.getParent();if(e){const t=n.parentContext?.getIndex();e.refresh();if(t!==undefined&&t>=0){o?.scrollToIndex(t)}}}else{const e=s.getIndex();if(e!==undefined&&e>=0){o?.scrollToIndex(e)}}};const r=this.getTransactionHelper().createDocument(i,{keepTransientContextOnFailed:false,busyMode:"Local",busyId:o?.getParent()?.getTableDefinition()?.annotation.id,parentControl:this.getView(),beforeCreateCallBack:this.base.editFlow.onBeforeCreate,afterCreateCallBack:a,skipParameterDialog:this.getAppComponent().getStartupMode()===Ze.AutoCreate,createAtEnd:n.createAtEnd,creationMode:Ie.CreationDialog,parentContext:n.parentContext,data:n.data,creationDialogFields:n.creationDialogFields},this.getAppComponent(),this._getResourceModel(),this.getMessageHandler(),false);await Promise.all([r,this.syncTask(r)]);if(s&&n.skipSideEffects!==true){this.getAppComponent().getSideEffectsService().requestSideEffectsForNavigationProperty(i.getPath(),s)}};s.createDeferredDocument=async function e(t,n,i){const s=this.getGlobalUIModel();o.lock(s);await this.getInternalRouting().navigateForwardToContext(t,{createOnNavigateParameters:{mode:"Deferred",parentContext:n,listBinding:t,data:i},editable:true,forceFocus:true});o.unlock(s)};s.createSyncAsyncDocument=async function e(t,n){let i;const s=this.getGlobalUIModel();const a=this.getInternalRouting();o.lock(s);const r=this.getTransactionHelper().createDocument(n,{...t,...{parentControl:this.getView(),beforeCreateCallBack:this.base.editFlow.onBeforeCreate,skipParameterDialog:this.getAppComponent().getStartupMode()===Ze.AutoCreate}},this.getAppComponent(),this._getResourceModel(),this.getMessageHandler(),false).then(e=>{if(this._isFclEnabled()&&e&&e.getBinding()!==n){n.refresh()}return e});if(t.bFromDeferred!==true&&!t.skipSideEffects){this.handleSideEffects(n,r)}if(t.creationMode===Ie.Async){i=a.navigateForwardToContext(n,{createOnNavigateParameters:{mode:"Async",createContextPromise:r},editable:true,forceFocus:true})}else{i=r.then(async e=>{if(!e){const e=b.getResourceBundleFor("sap.fe.core");return a.navigateToMessagePage(e.getText("C_COMMON_SAPFE_DATA_RECEIVED_ERROR"),{title:e.getText("C_COMMON_SAPFE_ERROR"),description:e.getText("C_EDITFLOW_SAPFE_CREATION_FAILED_DESCRIPTION")})}else{const i={editable:true,forceFocus:true,transient:this.getProgrammingModel(n)==Je.Sticky||t.createAction?true:undefined};return t.bFromDeferred?a.navigateToContext(e,i):a.navigateForwardToContext(e,i)}})}try{await this.postDocumentCreation(Promise.all([r,i]),n)}catch(e){if([Qe.CancelActionDialog,Qe.ActionExecutionFailed,Qe.CreationFailed,Qe.OnBeforeCreateFailed].includes(e instanceof Error?e.message:e)){this.getInternalRouting().navigateBackFromTransientState()}throw e}finally{o.unlock(s)}};s.createExternalDocument=async function e(t,n){if(n){if(typeof t!=="string"&&this.getTransactionHelper().isListBindingHierarchical(t)){throw new Error(`Unhandled creationMode "External" with a TreeTable`)}await this.syncTask();const e=this.getView().getController();const i=h.getAbsoluteMetaPathForListBinding(this.base.getView(),t);e._intentBasedNavigation.onChevronPressNavigateOutBound(e,n,undefined,i)}};s.validateDocument=async function e(t,n){return this.getTransactionHelper().validateDocument(t,n,this.getView())};s.getCreationRowValidationFunction=function e(t){const n=t?.getCreationRow();if(n&&t){return async()=>{const e=n.getBindingContext().getObject();delete e["@$ui5.context.isTransient"];return this.validateDocument(t.getBindingContext(),{data:e,customValidationFunction:t.getCreationRow().data("customValidationFunction")})}}return async()=>Promise.resolve([])};s.createMultipleDocuments=async function t(i,s,a,r,c){let l=arguments.length>5&&arguments[5]!==undefined?arguments[5]:false;let d=arguments.length>6?arguments[6]:undefined;const g=this.getTransactionHelper();const f=this.getGlobalUIModel();const h=i;d=d!==false;if(!l){o.lock(f)}try{await this.syncTask();const e=h.getModel().getMetaModel();let t;if(h.getContext()){t=e.getMetaPath(`${h.getContext().getPath()}/${h.getPath()}`)}else{t=e.getMetaPath(h.getPath())}this.handleCreateEvents(h);const i=s.map(async n=>{const i={data:{},parentControl:this.getView()};i.keepTransientContextOnFailed=false;i.creationMode=Ie.CreationRow;i.createAtEnd=a;i.inactive=l;i.beforeCreateCallBack=c;for(const o in n){const s=e.getObject(`${t}/${o}`);if(s&&s.$kind!=="NavigationProperty"&&!o.includes("/")&&n[o]){i.data[o]=n[o]}}return g.createDocument(h,i,this.getAppComponent(),this._getResourceModel(),this.getMessageHandler(),r)});const o=await Promise.all(i);if(!l){this.setDocumentModifiedOnCreate(h)}const f=o.filter(e=>!e.isInactive());await Promise.all(f.map(async e=>e.created()));const u=this.getView().getBindingContext();if(d&&!n.hasTransientContext(h)){this.getAppComponent().getSideEffectsService().requestSideEffectsForNavigationProperty(h.getPath(),u)}if(this.base.collaborativeDraft.isConnected()&&f.length>0){this._sendActivity(He.Create,f)}return o}catch(t){e.error("Error while creating multiple documents.");throw t}finally{if(!l){o.unlock(f)}}};s.onBeforeCreate=async function e(t){return Promise.resolve()};s.onBeforeEdit=async function e(t){return Promise.resolve()};s.onBeforeSave=async function e(t){return Promise.resolve()};s.onBeforeDiscard=async function e(t){return Promise.resolve()};s.onBeforeDelete=async function e(t){return Promise.resolve()};s.onBeforeExecuteAction=async function e(t){return Promise.resolve()};s.onAfterSave=async function e(t){return Promise.resolve()};s.onAfterCreate=async function e(t){return Promise.resolve()};s.onAfterEdit=async function e(t){return Promise.resolve()};s.onAfterDiscard=async function e(t){return Promise.resolve()};s.onAfterDelete=async function e(t){return Promise.resolve()};s.saveDocument=async function t(n,i){if(!this.getGlobalUIModel().getProperty("/isEditable")&&this.base.inlineEditFlow?.isInlineEditPossible()&&this.getGlobalUIModel().getProperty("/isInlineEditActive")){this.base.inlineEditFlow.inlineEditSave();return}i=i||{};const o=i.bExecuteSideEffectsOnError||undefined;const s=this.getTransactionHelper();const a=i.bindings;const r=this.getMessageHandler().registerToHoldMessages();try{await this.syncTask();this.getMessageHandler().removeTransitionMessages();if(i.mergePatchDraft!==true){await this._submitOpenChanges(n)}await this._checkForValidationErrors();const e=await this.checkRecommendationOption();const t=await this.getRootContext(n);await this.base.editFlow.onBeforeSave({context:t});const c=this.getProgrammingModel(n);const l=this._getRootViewController();let d;if((c===Je.Sticky||n.getProperty("HasActiveEntity"))&&l.isFclEnabled()||this._hiddenDraft){d=await this._computeSiblingInformation(t,this._hiddenDraft?n:l.getRightmostContext(),c,true)}await this.base._sideEffects.handlePageChangeContext(n);if(n.getModel().hasPendingChanges("$auto")&&i.mergePatchDraft){n.getModel().submitBatch("$auto")}const g=await s.saveDocument(t,this.getAppComponent(),this._getResourceModel(),o,a,this.getMessageHandler(),this.getCreationMode());this._removeStickySessionInternalProperties(c);this._sendActivity(He.Activate,g);this.base.collaborativeDraft.disconnect();this._triggerConfiguredSurvey(je.save,Ne.standardAction);this.setDocumentModified(false);this.setEditMode(Ye.Display,false);this.getMessageHandler().showMessageDialog({unHoldKey:r});await this.base.editFlow.onAfterSave({context:g});this.base.recommendations.storeDataForTelemetry(e);if(g!==n){let e=g;d=d??this._createSiblingInfo(n,g);if(c===Je.Draft){const e=p.getSemanticPath(n,true);const t=p.getSemanticPath(g,true);if(e&&t&&e!==t){d.pathMapping.push({oldPath:e,newPath:t})}}this._updatePathsInHistory(d.pathMapping);if(l.isFclEnabled()||this._hiddenDraft?.stayOnCurrentPageAfterSave){if(d.targetContext.getPath()!==g.getPath()){e=d.targetContext}}if(i.skipBindingToView!==true){await this._handleNewContext(e,{editable:false,recreateContext:false,forceFocus:true})}}}catch(t){await this.getMessageHandler().showMessageDialog({unHoldKey:r});if(!(t&&t.canceled)){e.error("Error while saving the document",t)}throw t}};s.toggleDraftActive=async function e(t){const n=t.getObject();let i;const o=t&&this.getProgrammingModel(t)===Je.Draft;if(!o||!(!n.IsActiveEntity&&n.HasActiveEntity||n.IsActiveEntity&&n.HasDraftEntity)){return}if(!n.IsActiveEntity&&n.HasActiveEntity){i=false}else{i=true}try{const e=this._getRootViewController();const n=e.isFclEnabled()?e.getRightmostContext():t;let o=await this._computeSiblingInformation(t,n,Je.Draft,false);if(!o&&t!==n){o=await this._computeSiblingInformation(t,t,Je.Draft,false)}if(o){if(e.isFclEnabled()){const e=this._getSemanticMapping();if(e?.technicalPath===t.getPath()){const t=o.pathMapping[o.pathMapping.length-1].newPath;o.pathMapping.push({oldPath:e.semanticPath,newPath:t})}}this._updatePathsInHistory(o.pathMapping);await this._handleNewContext(o.targetContext,{editable:i,recreateContext:true,forceFocus:true})}else{throw new Error("Error in EditFlow.toggleDraftActive - Cannot find sibling")}}catch(e){throw new Error(`Error in EditFlow.toggleDraftActive:${e}`)}};s.cancelDocument=async function t(n,i){const o=this.getTransactionHelper();let s;let a=false;const r={skipDiscardPopover:i.skipDiscardPopover===true,cancelButton:i.control||i.cancelButton,beforeCancelCallBack:this.base.editFlow.onBeforeDiscard};try{await this.syncTask();const e=this.getProgrammingModel(n);const t=await this.getRootContext(n);if((e===Je.Sticky||n.getProperty("HasActiveEntity"))&&this._isFclEnabled()||this._hiddenDraft){const i=this._getRootViewController();s=await this._computeSiblingInformation(t,this._hiddenDraft?n:i.getRightmostContext(),e,true)}const c=await o.cancelDocument(t,r,this.getAppComponent(),this._getResourceModel(),this.getMessageHandler(),this._hiddenDraft?this.getCreationMode()&&!t.getProperty("HasActiveEntity"):this.getCreationMode(),this.isDocumentModified()||e===Je.Sticky);this._getRootViewController().getInstancedViews().forEach(e=>{const t=e.getBindingContext();if(t?.isKeepAlive()===true){t.setKeepAlive(false)}});this._removeStickySessionInternalProperties(e);this.setEditMode(Ye.Display,false);this.setDocumentModified(false);this.setDraftStatus(Xe.Clear);await this.base.editFlow.onAfterDiscard({context:c});f.setEditStateDirty();if(!c){this._sendActivity(He.Discard,n);this.base.collaborativeDraft.disconnect();if(!i.skipBackNavigation){await this.getInternalRouting().navigateBackFromContext(t);a=true}}else{const t=c;this._sendActivity(He.Discard,t);this.base.collaborativeDraft.disconnect();let o=t;s=s??this._createSiblingInfo(n,t);this._updatePathsInHistory(s.pathMapping);if((this._isFclEnabled()||this._hiddenDraft?.stayOnCurrentPageAfterCancel)&&s.targetContext.getPath()!==t.getPath()){o=s.targetContext}if(e===Je.Draft){await this._fetchSemanticKeyValues(t);if(!i.skipBindingToView){await this._handleNewContext(o,{editable:false,recreateContext:true,forceFocus:true})}else{return t}}else{await this._handleNewContext(o,{editable:false,recreateContext:true,forceFocus:true})}}if(e===Je.Draft&&!this._hiddenDraft){this.showDocumentDiscardMessage(a)}}catch(t){e.error("Error while discarding the document",t)}};s.getRootContext=async function e(t,i){const o=this.getView().getViewData();const s=this.getProgrammingModel(t);if(o?.viewLevel>1){if(s===Je.Draft||s===Je.Sticky){return await n.createRootContext(s,this.getView(),this.getAppComponent(),i)}}return t};s.isRootContextNew=async function e(t){const n=await this.getRootContext(t,{$select:"HasActiveEntity,IsActiveEntity"});return!n.getObject("HasActiveEntity")&&!n.getObject("IsActiveEntity")};s.showDocumentDiscardMessage=function e(t){const n=this._getResourceModel();const i=n.getText("C_TRANSACTION_HELPER_DISCARD_DRAFT_TOAST");if(t==true){const e=this.getAppComponent();e.getRoutingService().attachAfterRouteMatched({},this.showMessageWhenNoContext,this)}else{w.show(i)}};s.showMessageWhenNoContext=function e(){const t=this._getResourceModel();const n=t.getText("C_TRANSACTION_HELPER_DISCARD_DRAFT_TOAST");const i=this.getAppComponent();w.show(n,{closeOnBrowserNavigation:false});i.getRoutingService().detachAfterRouteMatched(this.showMessageWhenNoContext,this)};s.isDraftRoot=function e(t){const n=t.getModel().getMetaModel();const i=n.getMetaContext(t.getPath());return h.isDraftRoot(Te(i).targetEntitySet)};s.deleteDocument=async function t(n,i){const o=this.getAppComponent();const s={...i,bFindActiveContexts:false,beforeDeleteCallBack:this.base.editFlow.onBeforeDelete},a=this.getMessageHandler().registerToHoldMessages();try{if(this._isFclEnabled()&&this.isDraftRoot(n)&&n.getIndex()===undefined&&n.getProperty("IsActiveEntity")===true&&n.getProperty("HasDraftEntity")===true){s.beforeDeleteCallBack=async t=>{await this.base.editFlow.onBeforeDelete(t);try{const e=n.getModel();const t=e.bindContext(`${n.getPath()}/SiblingEntity`).getBoundContext();const i=await t.requestCanonicalPath();const o=e.getKeepAliveContext(i);o.replaceWith(n)}catch(t){e.error("Error while replacing the draft instance in the LR ODLB",t)}}}if(this.getProgrammingModel(n)===Je.Sticky){this.setDocumentModified(true)}await this.deleteDocumentTransaction(n,s);if(!this._isFclEnabled()){f.setEditStateDirty()}else{const e=n.getBinding();if(e.isA("sap.ui.model.odata.v4.ODataListBinding")){if(e.isRoot()){await this.getTransactionHelper().refreshListBinding(e,o)}else if(s.requestSideEffects!==false){this.requestSideEffectsOnDelete(e,e.getContext())}}}this._sendActivity(He.Delete,n);await(o?.getShellServices().setBackNavigation());const t=this.base.recommendations.isRecommendationEnabled();if(t){this.base.recommendations.ignoreRecommendationForContexts([n])}await this.base.editFlow.onAfterDelete({contexts:[n]});if(!this._isFclEnabled()){if(o?.getStartupMode()===Ze.Deeplink){o.getRouterProxy().exitFromApp()}else{this.getInternalRouting().navigateBackFromContext(n)}}}catch(t){e.error("Error while deleting the document",t)}finally{this.getMessageHandler().showMessages({unHoldKey:a})}};s.applyDocument=async function e(t){const n=this.getGlobalUIModel();const i=this.getMessageHandler().registerToHoldMessages();try{await this.syncTask();if(t.getModel().hasPendingChanges("$auto")){o.lock(n);await this._submitOpenChanges(t)}const e=await this.showConfirmRecommendationsDialog(false);if(e===ke.Continue){return}await this._checkForValidationErrors();await this.getMessageHandler().showMessageDialog({unHoldKey:i});await this.getInternalRouting().navigateBackFromContext(t,{callExtension:true})}finally{if(o.isLocked(n)){o.unlock(n)}}};s.invokeAction=async function t(n,i,o){const s=this.getTransactionHelper();let a;let r;let c;const l=this.base.getView();if(i?.isA&&i?.isA("sap.ui.model.odata.v4.Context")||Array.isArray(i)||o!==undefined){const e=i;i=o||{};if(e){i.contexts=e}else{i.model=this.base.getView().getModel()}}const d={...i,view:this.base.getView()}||{view:this.base.getView()};d.isNavigable=d.requiresNavigation||d.isNavigable;const g=Oe(this.getView().getModel()?.getMetaModel());if(n.includes(""+g.entityContainer.name)){d.isBound=false}else{d.isBound=true}if(!d.entitySetName&&d.contexts&&d.model){d.entitySetName=d.model.getMetaModel().getMetaContext((Array.isArray(d.contexts)?d.contexts[0]:d.contexts).getPath()).getObject("@sapui.name")}let h;if(d.controlId){h=this.getView().byId(d.controlId);if(h){d.internalModelContext=h.getBindingContext("internal")}}else{d.internalModelContext=l.getBindingContext("internal")}d.ignoreETag=d.internalModelContext?.getProperty("/sessionOn");if(n&&n.includes("(")){a=n.split("(");n=a[0];r=a[a.length-1].replaceAll(")","")}if(d.bStaticAction&&h){if(h.isA("sap.ui.mdc.Table")){const e=h.getParent();d.contexts=e.getRowBinding().getHeaderContext()}if(r&&h.getBindingContext()&&h.isA&&h.isA("sap.ui.mdc.Table")){d.contexts=this._getActionOverloadContextFromMetadataPath(h.getBindingContext(),h.getRowBinding(),r)}if(d.enableAutoScroll){c=this.createActionPromise(n,h.getId())}}try{await this.syncTask();await this.base.editFlow.onBeforeExecuteAction({contexts:d.contexts});const t=await s.callAction(n,d,this.getAppComponent(),this.getMessageHandler());const o=t.filter(xe);if(t.length!==o.length){throw t}let a;if(d.contexts&&Array.isArray(d.contexts)&&d.isBound===true){a=await this._refreshListIfRequired(this.getActionResponseDataAndKeys(n,o),d.contexts[0])}if(this.base.collaborativeDraft.isConnected()){this._sendActivity(He.Action,d.contexts,n,a,Object.keys(o[0].value.boundContext.getObject()))}this._triggerConfiguredSurvey(n,Ne.action);if(c){c.fResolver(o)}if(d.contexts){if(this.base.getView().getViewData().converterType!=="ListReport"){f.setEditStateDirty()}this.getInternalModel().setProperty("/lastInvokedAction",n)}if(d.isNavigable){if(o.length===1){const t=this._getBoundContext(l,d)?o[0].value.boundContext:o[0].value.returnedContext??o[0].value.boundContext;const n=l.getModel().getMetaModel();const i=n.getMetaPath(t.getPath());const s=(e,t)=>e.filter(e=>{if(t){return t.includes(e)}return true});const a=Array.isArray(d.contexts)?s(d.contexts,d.applicableContexts)[0]:d.contexts;const r=a&&n.getMetaPath(a.getPath());if(i!=undefined&&i===r){if(a?.getPath()!==t.getPath()){this.getInternalRouting().navigateForwardToContext(t,{checkNoHashChange:true});if(this.getProgrammingModel(t)===Je.Draft&&(t.getProperty("IsActiveEntity")===false||this._isFclEnabled())){t.getBinding().destroy()}}else{e.info("Navigation to the same context is not allowed")}}}}this.base.editFlow.onAfterActionExecution(n);if(!Array.isArray(i?.contexts)&&o.length===1){return o[0].value.returnedContext??o[0].value.boundContext}return o.map(e=>({...e,...{value:e.value.returnedContext??e.value.boundContext}}))}catch(e){if(c){c.fRejector()}if(e===Qe.CancelActionDialog){throw new Error("Dialog cancelled")}throw e}};s.onAfterActionExecution=async function e(t){};s.customMassEditSave=async function e(t){return Promise.resolve(false)};s.securedExecution=async function e(t,n){const i=n?.busy?.set??true,s=n?.busy?.check??true,a=n?.updatesDocument??false,r=this.getGlobalUIModel(),c=this.getView().getBindingContext(),l=c&&this.getProgrammingModel(c)===Je.Draft,d=this.getMessageHandler().registerToHoldMessages();if(s&&o.isLocked(r)){return Promise.reject("Application already busy therefore execution rejected")}if(i){o.lock(r)}if(a&&l){this.setDraftStatus(Xe.Saving)}this.getMessageHandler().removeTransitionMessages();return this.syncTask(t).then(()=>{if(a){this.setDocumentModified(true);if(!this._isFclEnabled()){f.setEditStateDirty()}if(l){this.setDraftStatus(Xe.Saved)}}return}).catch(e=>{if(a&&l){this.setDraftStatus(Xe.Clear)}throw e}).finally(()=>{if(i){o.unlock(r)}this.getMessageHandler().showMessageDialog({unHoldKey:d})})};s.handlePatchSent=function e(t){const n=this.getView()?.getBindingContext("internal");const i=this.getView()?.getBindingContext("ui");const o=this.base.collaborativeDraft.isConnected()||n.getProperty("/sessionOn");if(o){t.getSource().getModel().setIgnoreETag(true)}if(i?.getProperty("isEditable")===false){this.base.inlineEditFlow.handleInlineEditPatchSent(t)}else if(!n?.getProperty("skipPatchHandlers")){const e=t.getSource();const n=new Promise((n,i)=>{t.getSource().attachEventOnce("patchCompleted",s=>{if(o){t.getSource().getModel().setIgnoreETag(false)}if(t.getSource().isA("sap.ui.model.odata.v4.ODataListBinding")){I.setActionEnablementAfterPatch(this.getView(),e,this.getView()?.getBindingContext("internal"))}const a=s.getParameter("success");if(a){n()}else{i()}})});this.updateDocument(e,n)}};s.handleCreateSent=function e(t){const n=t.getParameter("context");this.getMessageHandler().removeTransitionMessages(false,false,n.getPath())};s.syncTask=async function t(n){if(n){if(typeof n==="function"){this.syncTasks=this.syncTasks.then(n).catch(function(t){e.debug(t)})}else{this.syncTasks=this.syncTasks.then(async()=>n).catch(function(t){e.debug(t)})}}return this.syncTasks};s.computeModelsForEditMode=async function t(n){const i=this.getProgrammingModel(n);if(i===Je.Draft){if(this.getInternalModel().getProperty("/executeShareActionForCollaboration")){Fe(n);this.getInternalModel().setProperty("/executeShareActionForCollaboration",false)}try{this.setDraftStatus(Xe.Clear);const e=this.getGlobalUIModel();e.setProperty("/isEditablePending",true,undefined,true);const t=this.getView().getModel();const i=h.isCollaborationDraftSupported(t.getMetaModel());let o=false;const s=await n.requestObject("IsActiveEntity");if(i&&s===false){await this.fetchCollaborativeDraftUsersPromise;const t=await n.requestObject("DraftAdministrativeData/DraftAdministrativeUser");const i=Be.getMe(this.getAppComponent()),s=t?.filter(e=>e.UserID===i.id)??[];if(s.length>0){e.setProperty("/hasCollaborationAuthorization",true)}else{o=true;e.setProperty("/hasCollaborationAuthorization",false)}}else{e.setProperty("/hasCollaborationAuthorization",undefined)}this.fetchCollaborativeDraftUsersPromise=undefined;if(s===false&&!o){this.setEditMode(Ye.Editable);const e=await n.requestObject("HasActiveEntity");this.setEditMode(undefined,!e)}else{this.setEditMode(Ye.Display,false)}e.setProperty("/isEditablePending",false,undefined,true)}catch(t){e.error("Error while determining the editMode for draft",t)}}else if(i===Je.Sticky){const e=this.getInternalModel().getProperty("/lastInvokedAction");if(e&&this.isNewActionForSticky(e,n)){this.setEditMode(Ye.Editable,true);if(!this.getAppComponent()._isFclEnabled()){f.setEditStateDirty()}this.handleStickyOn(n);this._setStickySessionInternalProperties(this.getProgrammingModel(n),n.getModel());this.getInternalModel().setProperty("/lastInvokedAction",undefined)}}};s.deleteDocumentTransaction=async function e(t,n){if(n.selectedContexts){n.numberOfSelectedContexts=n.selectedContexts.length}const i=this._getResourceModel();const o=this.getTransactionHelper();if(n.controlId){const e=D.getElementById(n.controlId);if(e&&!e.isA("sap.ui.mdc.MultiValueField")){n.internalModelContext=e.getBindingContext("internal")}}await this.syncTask();await o.deleteDocument(t,n,this.getAppComponent(),i,this.getMessageHandler())};s._getResourceModel=function e(){return _e(this.getView())};s.getTransactionHelper=function e(){return r};s.getMessageHandler=function e(){if(this.base.messageHandler){return this.base.messageHandler}else{throw new Error("Edit Flow works only with a given message handler")}};s.getInternalModel=function e(){return this.getView().getModel("internal")};s.getGlobalUIModel=function e(){return this.getView().getModel("ui")};s.getPageInternalModel=function e(){return this.getView().getModel("pageInternal")};s.setCreationMode=function e(t){const n=this.getView().getBindingContext("pageInternal");this.getPageInternalModel().setProperty(l.CreateMode,t,n,true)};s.getCreationMode=function e(){const t=this.getView().getBindingContext("pageInternal");return!!t.getProperty(l.CreateMode)};s.isDocumentModified=function e(){return!!this.getGlobalUIModel().getProperty(l.DocumentModified)};s.setDocumentModified=function e(t){this.getGlobalUIModel().setProperty(l.DocumentModified,t)};s.setDocumentModifiedOnCreate=function e(t){if(t.isRelative()){this.setDocumentModified(true)}};s.handleCreateEvents=function e(t){this.setDraftStatus(Xe.Clear);const n=this.getProgrammingModel(t);let i;t.attachEvent("createSent",()=>{if(n===Je.Draft){this.setDraftStatus(Xe.Saving)}i=this.getMessageHandler().registerToHoldMessages()});t.attachEvent("createCompleted",e=>{const t=e.getParameter("success");if(n===Je.Draft){this.setDraftStatus(t?Xe.Saved:Xe.Clear)}this.getMessageHandler().showMessageDialog({unHoldKey:i})})};s.setDraftStatus=function e(t){this.getView().getModel("ui").setProperty("/draftStatus",t,undefined,true)};s.getProgrammingModel=function e(t){return this.getTransactionHelper().getProgrammingModel(t)};s.setEditMode=function e(t,n){const i=this.getGlobalUIModel();if(t){i.setProperty("/isEditable",t==="Editable",undefined,true);if(t!=="Editable"){this.forceDraftSaveOrDiscard(false)}}if(n!==undefined){this.setCreationMode(n)}};s.forceDraftSaveOrDiscard=function e(t){this.getGlobalUIModel().setProperty("/forceDraftSaveOrDiscard",t,undefined,true)};s.shallForceDraftSaveOrDiscard=function e(){return this.getGlobalUIModel().getProperty("/forceDraftSaveOrDiscard")===true};s.isNewActionForSticky=function t(n,i){try{const e=i.getModel().getMetaModel();const t=e.getMetaContext(i.getPath());const o=Te(t).startingEntitySet;const s=o.annotations.Session?.StickySessionSupported;if(s?.NewAction===n){return true}if(s?.AdditionalNewActions&&s?.AdditionalNewActions.includes(n)){return true}return false}catch(t){e.info(t);return false}};s.handleStickyOn=async function t(n){const i=this.getAppComponent();try{if(i===undefined){throw new Error("undefined AppComponent for function handleStickyOn")}if(!i.getRouterProxy().hasNavigationGuard()){const e=i.getRouterProxy().getHash();const t=this.getInternalModel();setTimeout(function(){i.getRouterProxy().setNavigationGuard(n.getPath().substring(1))},0);await i.getShellServices().setBackNavigation(this.onBackNavigationInSession.bind(this,n));const o=this.base.getView().getModel("sap.fe.i18n");i.registerStickySessionCallbacks(this.getDirtyStateProvider(i,t,e),this.getSessionTimeoutFunction(n,o),this.getRouteMatchedFunction(n,i))}}catch(t){e.info(t);return false}return true};s.handleStickyOff=function t(){const n=this.getAppComponent();try{if(n===undefined){throw new Error("undefined AppComponent for function handleStickyOff")}if(n.getRouterProxy){n.getRouterProxy().discardNavigationGuard()}if(n.unregisterStickySessionCallbacks){n.unregisterStickySessionCallbacks()}this.setEditMode(Ye.Display,false);if(n.getShellServices){n.getShellServices().setBackNavigation()}}catch(t){e.info(t);return false}return true};s._setStickySessionInternalProperties=function e(t,n){if(t===Je.Sticky){const e=this.getInternalModel();e.setProperty("/sessionOn",true);e.setProperty("/stickySessionToken",n.getHttpHeaders(true)["SAP-ContextId"])}};s.getDirtyStateProvider=function t(n,i,o){return t=>{try{if(t===undefined){throw new Error("Invalid input parameters for DirtyStateProvider function")}const e=t.innerAppRoute;const s=n.getRouterProxy();let a="";let r;const c=i.getProperty("/sessionOn");if(!c){return undefined}if(!s.isNavigationFinalized()){r=false;a=e}else if(o===e){r=true}else if(s.checkHashWithGuard(e)||s.isGuardCrossAllowedByUser()){a=e;r=false}else{r=true}if(r){setTimeout(function(){n.getShellServices().setDirtyFlag(false)},0)}else{o=a}return r}catch(t){e.info(t);return undefined}}};s.getSessionTimeoutFunction=function t(n,i){return()=>{try{if(n===undefined){throw new Error("Context missing for SessionTimeout function")}this.getMessageHandler().removeTransitionMessages();const e=new C({title:"{sap.fe.i18n>C_EDITFLOW_OBJECT_PAGE_SESSION_EXPIRED_DIALOG_TITLE}",state:"Warning",content:new M({text:"{sap.fe.i18n>C_EDITFLOW_OBJECT_PAGE_SESSION_EXPIRED_DIALOG_MESSAGE}"}),beginButton:new m({text:"{sap.fe.i18n>C_COMMON_DIALOG_OK}",type:"Emphasized",press:()=>{this.handleStickyOff();this.getInternalRouting().navigateBackFromContext(n)}}),afterClose:function(){e.destroy()}});e.addStyleClass("sapUiContentPadding");e.setModel(i,"sap.fe.i18n");this.getView().addDependent(e);e.open()}catch(t){e.info(t);return undefined}return true}};s.getRouteMatchedFunction=function e(t,n){return()=>{const e=n.getRouterProxy().getHash();if(!e||!n.getRouterProxy().checkHashWithGuard(e)){this.discardStickySession(t);t.getModel().clearSessionContext()}}};s.discardStickySession=async function e(t){const n=this.getCreationMode();this.handleStickyOff();const i=await d.discardDocument(t);if(i?.hasPendingChanges()){i.getBinding().resetChanges()}if(!n){i?.refresh()}};s.getInternalRouting=function e(){if(this.base._routing){return this.base._routing}else{throw new Error("Edit Flow works only with a given routing listener")}};s._getRootViewController=function e(){return this.getAppComponent().getRootViewController()};s._getSemanticMapping=function e(){return this.getAppComponent().getRoutingService().getLastSemanticMapping()};s.createActionPromise=function e(t,n){let i,o;this.actionPromise=new Promise((e,t)=>{i=e;o=t}).then(e=>Object.assign({controlId:n},this.getActionResponseDataAndKeys(t,e)));return{fResolver:i,fRejector:o}};s.getActionResponseDataAndKeys=function e(t,n){if(n.length>=1){const e=this.base.getView();const i=e.getModel().getMetaModel().getData()??{};const o=i[t];const s=o?.[0].$ReturnType?o?.[0].$ReturnType.$Type:null;const a=s&&i[s]?i[s].$Key:[];return{oData:n[0].value.boundContext.getObject(),keys:a}}return undefined};s.getCurrentActionPromise=async function e(){return this.actionPromise};s.deleteCurrentActionPromise=function e(){this.actionPromise=undefined};s.showConfirmRecommendationsDialog=async function e(t){if(!this.confirmRecommendationsDialog){this.confirmRecommendationsDialog=new Re({view:this.getView()})}return this.confirmRecommendationsDialog?.open(t)};s._scrollAndFocusOnInactiveRow=function e(t){const n=t.getRowBinding();const i=n.getCount()||0;if(t.data("tableType")!=="ResponsiveTable"){if(i>0){t.scrollToIndex(i-1)}t.focusRow(i,true)}else{const e=n.getAllCurrentContexts();if(!e?.length){t.focusRow(i,true);return}let o=i,s=0;for(const t of e){if(t.isInactive()&&s<o){o=s}s++}if(o>0){t.scrollToIndex(o)}t.focusRow(o,true)}};s.createEmptyRowsAndFocus=async function e(t){const n=t.getParent();if(n?.tableDefinition?.control?.inlineCreationRowsHiddenInEditMode&&!t.getBindingContext("pageInternal")?.getProperty("createMode")){await n.setUpEmptyRows(t,true)}this._scrollAndFocusOnInactiveRow(t)};s._sendActivity=function e(t,n,i,o,s){const a=Array.isArray(n)?n.map(e=>e.getPath()):n?.getPath();this.base.collaborativeDraft.send({action:t,content:a,triggeredActionName:i,refreshListBinding:o,actionRequestedProperties:s})};s._triggerConfiguredSurvey=function e(t,n){Ve(this.base.getView(),t,n)};s._submitOpenChanges=async function e(t){const n=t.getModel(),i=this.getGlobalUIModel();try{await n.submitBatch("$auto");await n.oRequestor.waitForRunningChangeRequests("$auto");if(n.hasPendingChanges("$auto")){throw new Error("submit of open changes failed")}}finally{if(o.isLocked(i)){o.unlock(i)}}};s._removeStickySessionInternalProperties=function e(t){if(t===Je.Sticky){const e=this.getInternalModel();e.setProperty("/sessionOn",false);e.setProperty("/stickySessionToken",undefined);this.handleStickyOff()}};s.onBackNavigationInSession=function e(t){const n=this.base.getView();const i=this.getAppComponent().getRouterProxy();if(i.checkIfBackIsOutOfGuard()){d.processDataLossConfirmation(async()=>{await this.discardStickySession(t);this._removeStickySessionInternalProperties(Je.Sticky);history.back()},n,Je.Sticky);return}history.back()};s._handleNewContext=async function e(t,n){if(!this._isFclEnabled()){f.setEditStateDirty()}await this.getInternalRouting().navigateToContext(t,{checkNoHashChange:true,editable:n.editable,persistOPScroll:true,recreateContext:n.recreateContext,reason:T.EditFlowAction,showPlaceholder:false,forceFocus:n.forceFocus??false,keepCurrentLayout:true})};s._getBoundContext=function e(t,n){const i=t.getViewData().viewLevel;const o=i>1||i===1&&n.controlId;return!n.isNavigable||!!o};s._checkForValidationErrors=async function t(){return this.syncTask().then(()=>{const t=this._isFclEnabled()?this._getRootViewController()._getAllVisibleViews().map(e=>e.getId()):[this.getView().getId()];const n=P.getMessageModel().getData();let i;if(!n.length){e.info("No validation errors found");return}for(const e of n){if(e.validation){i=D.getElementById(e.getControlId());while(i){if(t.includes(i.getId())){throw"validation errors exist"}i=i.getParent()}}}return})};s._refreshListIfRequired=async function e(t,n){if(!n||!t||!t.oData||!t.keys){return false}const i=n.getBinding();if(i&&i.isA("sap.ui.model.odata.v4.ODataListBinding")){const e=t.oData;const o=t.keys;const s=n.getObject();let a=true;if(Object.keys(e).length){a=o.every(function(t){return s[t]===e[t]});if(!a){await this.getTransactionHelper().refreshListBinding(i,this.getAppComponent());return true}}}return false};s._fetchSemanticKeyValues=async function e(t){const n=t.getModel().getMetaModel(),i=n.getMetaContext(t.getPath()).getObject("@sapui.name"),o=p.getSemanticKeys(n,i);if(o&&o.length){const e=o.map(e=>e.$PropertyPath);await t.requestProperty(e)}};s._getActionOverloadContextFromMetadataPath=function e(t,n,i){const o=t.getModel();const s=o.getMetaModel();let a=n.getPath().split("/");let r=t;a.pop();if(a.length===0){a=[""]}if(a[0]!==""){a.unshift("")}const c=a.map(e=>{if(e!==""){r=o.bindContext(e,r).getBoundContext()}else{r=t}return r}).reverse();const l=c.find(e=>s.getMetaContext(e.getPath()).getObject("$Type")===i);return l||n.getHeaderContext()};s._createSiblingInfo=function e(t,n){return{targetContext:n,pathMapping:[{oldPath:t.getPath(),newPath:n.getPath()}]}};s._updatePathsInHistory=function e(t){const n=this.getAppComponent();n.getRouterProxy().setPathMapping(t);const i=this._getSemanticMapping();if(t.length&&i?.technicalPath===t[t.length-1].oldPath){i.technicalPath=t[t.length-1].newPath}};s._getNavigationTargetForEdit=function e(t,n,i){let o;i=i??this._createSiblingInfo(t,n);this._updatePathsInHistory(i.pathMapping);if(i.targetContext.getPath()!=n.getPath()){o=t.getPath()===i.targetContext.getPath()?t:i.targetContext}return o};s._computeSiblingInformation=async function t(n,i,o,s,a,r){i=i??n;if(!i.getPath().startsWith(n.getPath())){e.error("Cannot compute rightmost sibling context");throw new Error("Cannot compute rightmost sibling context")}let l=i;if(o===Je.Draft&&this.getProgrammingModel(i)!==Je.Draft){l=n}if(s&&l.getPath()===n.getPath()){return Promise.resolve(undefined)}const d=n.getModel();if(o===Je.Draft){return c.computeSiblingInformation(n,l,a,r)}else{return{targetContext:d.bindContext(i.getPath()).getBoundContext(),pathMapping:[]}}};s._isFclEnabled=function e(){return this.getAppComponent()._isFclEnabled()};s.checkRecommendationOption=async function e(){const t=await this.showConfirmRecommendationsDialog(true);if(t===ke.Continue){return Promise.reject(ke.Continue)}return t};s.createNextDocument=async function e(){const t=this.getView()?.getBindingContext()?.getPath();const n=t?.substring(0,t.lastIndexOf("("));return this.createDocument(n,{creationMode:Ie.NewPage})};return i}(i),ze(Se.prototype,"onInit",[F],Object.getOwnPropertyDescriptor(Se.prototype,"onInit"),Se.prototype),ze(Se.prototype,"editDocument",[B,H],Object.getOwnPropertyDescriptor(Se.prototype,"editDocument"),Se.prototype),ze(Se.prototype,"updateDocument",[V,N],Object.getOwnPropertyDescriptor(Se.prototype,"updateDocument"),Se.prototype),ze(Se.prototype,"createDocument",[j,L],Object.getOwnPropertyDescriptor(Se.prototype,"createDocument"),Se.prototype),ze(Se.prototype,"onBeforeCreate",[U,G],Object.getOwnPropertyDescriptor(Se.prototype,"onBeforeCreate"),Se.prototype),ze(Se.prototype,"onBeforeEdit",[$,q],Object.getOwnPropertyDescriptor(Se.prototype,"onBeforeEdit"),Se.prototype),ze(Se.prototype,"onBeforeSave",[K,W],Object.getOwnPropertyDescriptor(Se.prototype,"onBeforeSave"),Se.prototype),ze(Se.prototype,"onBeforeDiscard",[z,J],Object.getOwnPropertyDescriptor(Se.prototype,"onBeforeDiscard"),Se.prototype),ze(Se.prototype,"onBeforeDelete",[Q,X],Object.getOwnPropertyDescriptor(Se.prototype,"onBeforeDelete"),Se.prototype),ze(Se.prototype,"onBeforeExecuteAction",[Y,Z],Object.getOwnPropertyDescriptor(Se.prototype,"onBeforeExecuteAction"),Se.prototype),ze(Se.prototype,"onAfterSave",[ee,te],Object.getOwnPropertyDescriptor(Se.prototype,"onAfterSave"),Se.prototype),ze(Se.prototype,"onAfterCreate",[ne,ie],Object.getOwnPropertyDescriptor(Se.prototype,"onAfterCreate"),Se.prototype),ze(Se.prototype,"onAfterEdit",[oe,se],Object.getOwnPropertyDescriptor(Se.prototype,"onAfterEdit"),Se.prototype),ze(Se.prototype,"onAfterDiscard",[ae,re],Object.getOwnPropertyDescriptor(Se.prototype,"onAfterDiscard"),Se.prototype),ze(Se.prototype,"onAfterDelete",[ce,le],Object.getOwnPropertyDescriptor(Se.prototype,"onAfterDelete"),Se.prototype),ze(Se.prototype,"saveDocument",[de,ge],Object.getOwnPropertyDescriptor(Se.prototype,"saveDocument"),Se.prototype),ze(Se.prototype,"cancelDocument",[fe,he],Object.getOwnPropertyDescriptor(Se.prototype,"cancelDocument"),Se.prototype),ze(Se.prototype,"deleteDocument",[ue,pe],Object.getOwnPropertyDescriptor(Se.prototype,"deleteDocument"),Se.prototype),ze(Se.prototype,"applyDocument",[ye,me],Object.getOwnPropertyDescriptor(Se.prototype,"applyDocument"),Se.prototype),ze(Se.prototype,"invokeAction",[Ce,we],Object.getOwnPropertyDescriptor(Se.prototype,"invokeAction"),Se.prototype),ze(Se.prototype,"onAfterActionExecution",[Me,De],Object.getOwnPropertyDescriptor(Se.prototype,"onAfterActionExecution"),Se.prototype),ze(Se.prototype,"customMassEditSave",[be,Pe],Object.getOwnPropertyDescriptor(Se.prototype,"customMassEditSave"),Se.prototype),ze(Se.prototype,"securedExecution",[ve,Ee],Object.getOwnPropertyDescriptor(Se.prototype,"securedExecution"),Se.prototype),Se))||Ae);return et},false);
//# sourceMappingURL=EditFlow.js.map