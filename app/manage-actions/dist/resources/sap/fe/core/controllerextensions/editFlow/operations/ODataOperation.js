/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)
 *      (c) Copyright 2009-2025 SAP SE. All rights reserved
 */
sap.ui.define(["sap/base/Log","sap/base/util/deepClone","sap/fe/core/converters/MetaModelConverter","sap/fe/core/library","sap/ui/model/odata/v4/SubmitMode","../../../helpers/ModelHelper","../../../helpers/TypeGuards","./ODataStrictHandling","./actionHelper"],function(t,e,i,s,n,a,r,o,c){"use strict";var h={};var p=r.isAction;var u=i.convertTypes;const d=s.InvocationGrouping;let m=function(){function i(t,e){let i=arguments.length>2&&arguments[2]!==undefined?arguments[2]:{};this.operationContextBindings=[];this.firstIterationOperations=[];this.apiGroupIdsToSubmit=new Set;this.bindingParameters={};this.operationParameters=[];this.neverSubmitted=true;this.failedContexts=[];this.operationPromises=[];this.operation=t;this.parameters=e;this.operationProperties=i;this.actionName=c.getActionName(p(this.operation)?this.operation:this.operation.action);this.sideEffects=this.parameters.appComponent.getSideEffectsService().getODataActionSideEffects(this.actionName,this.parameters.contexts.length?this.parameters.contexts[0]:undefined);if(!this.operation.isFunction&&this.parameters.disableStrictHandling!==true){this.oDataStrictHandling=new o({appComponent:this.parameters.appComponent,contexts:this.parameters.contexts,label:this.parameters.label??this.actionName,invocationGrouping:this.parameters.invocationGrouping,events:{onResponse:this.parameters.events?.onStrictResponse,onValidation:this.onStrictValidation.bind(this),onCancel:this.parameters.events?.onStrictCancel}})}this.defineOperationParameters();this.setBindingParameters()}h=i;var s=i.prototype;s.setBindingParameters=function t(){this.bindingParameters=e(this.operationProperties.bindingParameters??{});const i=[];if(p(this.operation)&&this.parameters.contexts.length&&this.operationProperties.enhance$select===true){const t=this.operation.returnEntityType;const e=this.parameters.model.getMetaModel();const s=a.getMessagesPath(e,this.parameters.contexts[0].getPath());const n=u(e).entitySets.filter(e=>e.entityType===t)?.[0];const r=!this.operation.returnCollection&&!!t&&this.operation.sourceEntityType===t;if(r){if(a.isDraftRoot(n)){i.push("HasActiveEntity")}if(s&&!!t?.entityProperties.find(t=>t.name===s)){i.push(s)}}if(i.length){const t=i.join(",");this.bindingParameters.$select=this.bindingParameters.$select?`${this.bindingParameters.$select},${t}`:t}this.bindingParameters.$$inheritExpandSelect=this.bindingParameters.$$inheritExpandSelect||!!i.length||r}};s.defineOperationParameters=function t(){if(!p(this.operation)){this.operationParameters=this.operation.action.parameters}else{this.operationParameters=c.getActionParameters(this.operation)}};s.clear=function t(){for(const t of this.operationContextBindings){t.destroy()}this.apiGroupIdsToSubmit.clear();this.operationContextBindings=[];this.failedContexts=[];this.operationPromises=[]};s.execute=async function e(){let i;try{if(this.parameters.contexts.length){i=await(this.parameters.invocationGrouping===d.ChangeSet?this.executeChangeset():this.executeSequentially())}else{i=await Promise.allSettled([this.executeImport()])}}catch(e){t.error("Error while executing operation "+this.actionName,e);throw e}finally{this.parameters.events?.onODataResponse?.()}return i};s.executeImport=async function t(){const e=this.parameters.model.bindContext(`/${this.actionName}(...)`);this.operationContextBindings.push(e);this.setParametersValue(e);const i=this.operationProperties.groupId??"actionImport";const s=[this.invoke(e,i)];this.defaultSubmit(i);await Promise.allSettled(this.firstIterationOperations);await this.afterODataOperationExecution();const n=await Promise.all(s);return n[0]};s.executeChangeset=async function t(){this.operationPromises=this.parameters.contexts.map(async t=>this.executeBoundOperation(t,this.operationProperties.groupId));await Promise.allSettled(this.firstIterationOperations);await this.afterODataOperationExecution();return Promise.allSettled(this.operationPromises)};s.afterODataOperationExecution=async function t(){await(this.oDataStrictHandling?.manageStrictHandlingFails());await(this.parameters.events?.onAfterODataOperationExecution?.())};s.executeSequentially=async function t(){await this.parameters.contexts.reduce(async(t,e,i)=>{await t;this.operationPromises.push(this.executeBoundOperation(e,this.operationProperties.groupId??`apiMode${i+1}`));await Promise.allSettled(this.firstIterationOperations)},Promise.resolve());await this.afterODataOperationExecution();return Promise.allSettled(this.operationPromises)};s.executeBoundOperation=async function t(e,i){const s=this.parameters.model.bindContext(`${this.actionName}(...)`,e,this.bindingParameters);this.operationContextBindings.push(s);const n=[];this.setParametersValue(s);const a=i??s.getUpdateGroupId();const r=this.invoke(s,a);n.push(r);this.defaultSubmit(a);Promise.allSettled(n);return r};s.enhanceSideEffects=function t(e,i){if(i&&this.parameters.ghostContextBindingProtection===true){const t=this.parameters.appComponent;const s=e.requestSideEffects.bind(e);e.requestSideEffects=async function(){if(t.getRootViewController().getInstancedViews().find(t=>t.getBindingContext()===i)){return s(...arguments)}return Promise.resolve()}}};s.invoke=async function t(e,i){let s;let n;let a;const r=new Promise(function(t,e){n=t;a=e});this.firstIterationOperations.push(r);if(i&&this.isAPIMode(i)){this.apiGroupIdsToSubmit.add(i)}try{const t=e.getContext()??e.getBoundContext();const a=e.invoke(i,this.operationProperties.ignoreETag,this.oDataStrictHandling?.handleOdataStrictHandling.bind(this.oDataStrictHandling,e,n,()=>{this.requestSideEffects(t,i,[]);this.parameters.model.submitBatch(i)}),this.operationProperties.replaceWithRVC);this.requestSideEffects(t,i,[a]);await Promise.race([a,r]);s=await a;this.enhanceSideEffects(e,s);n()}catch(t){a(t);const i=e.getContext();if(i){this.failedContexts.push(i)}throw t}finally{await(this.parameters.events?.onAfterODataInvoke?.(e,i))}return{returnedContext:s,boundContext:e.getBoundContext()}};s.onStrictValidation=function t(){this.parameters.events?.onStrictValidation?.();this.retriggerFailedContexts()};s.retriggerFailedContexts=async function t(){if(this.parameters.invocationGrouping!==d.ChangeSet){let t=0;for(const e of this.failedContexts){t++;this.operationPromises.push(this.executeBoundOperation(e,`apiRetrigger${t+1}`))}await Promise.allSettled(this.operationPromises)}};s.submit=function t(){if(!this.neverSubmitted||this.apiGroupIdsToSubmit.size===0){return}for(const t of Array.from(this.apiGroupIdsToSubmit.values())){this.submitOnModel(t)}this.parameters.events?.onODataSubmit?.()};s.isStrictCanceled=function t(){return this.oDataStrictHandling?.isCanceled()??false};s.submitOnModel=function t(e){this.parameters.model.submitBatch(e);this.apiGroupIdsToSubmit.delete(e)};s.isAPIMode=function t(e){if(!e){return false}if(e.startsWith("$auto")||e.startsWith("$direct")||e.startsWith("$single")){return false}const i=this.parameters.appComponent.getManifestEntry("sap.ui5")?.models[""]?.settings?.groupProperties?.[e]?.submit;if(i===undefined||[n.Auto,n.Direct].includes(i)){return true}return true};s.defaultSubmit=function t(e){const i=this.neverSubmitted;const s=this.isAPIMode(e);if(!s){this.neverSubmitted=false}else if(this.operationProperties.deferredSubmit!==true&&e){this.neverSubmitted=false;this.submitOnModel(e)}if(i&&!this.neverSubmitted){this.parameters.events?.onODataSubmit?.()}};s.setParametersValue=function t(e){if(this.operationParameters.length){const t=this.parameters.parametersValues??{};for(const i of this.operationParameters){const s=i.name;if(!t[s]){switch(i.type){case"Edm.String":t[s]="";break;case"Edm.Boolean":t[s]=false;break;case"Edm.Byte":case"Edm.Int16":case"Edm.Int32":case"Edm.Int64":t[s]=0;break;default:break}}e.setParameter(s,t[s])}}};s.requestSideEffects=async function e(i,s,n){const a=this.parameters.appComponent.getSideEffectsService();let r=n??[];if(this.sideEffects&&!this.parameters.disableSideEffects===true){r=r.concat((this.sideEffects.triggerActions??[]).map(async t=>a.executeAction(t,i,s)),this.sideEffects.pathExpressions?a.requestSideEffects(this.sideEffects.pathExpressions,i,s):[]);try{await Promise.all(r);if(this.sideEffects.pathExpressions){this.parameters.events?.onRequestSideEffects?.(this.sideEffects,this.operation,r)}}catch(e){t.info("Error while requesting side effects for the operation "+this.actionName,e)}}};return i}();h=m;return h},false);
//# sourceMappingURL=ODataOperation.js.map