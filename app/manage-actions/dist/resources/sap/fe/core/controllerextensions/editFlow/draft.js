/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)
 *      (c) Copyright 2009-2025 SAP SE. All rights reserved
 */
sap.ui.define(["sap/base/Log","sap/fe/core/CommonUtils","sap/fe/core/controllerextensions/editFlow/draftDataLossPopup","sap/fe/core/controllerextensions/messageHandler/messageHandling","sap/fe/core/converters/MetaModelConverter","sap/fe/core/helpers/ResourceModelHelper","sap/fe/core/helpers/TypeGuards","sap/m/Button","sap/m/Dialog","sap/m/MessageBox","sap/m/Text","sap/ui/core/Lib","../../helpers/ModelHelper","./operations/Operation"],function(e,t,n,o,r,a,i,s,c,d,u,g,f,l){"use strict";var h=i.isPathAnnotationExpression;var p=a.getResourceModel;var E=r.getInvolvedDataModelObjects;var P=r.convertTypes;const w={EDIT:"EditAction",ACTIVATION:"ActivationAction",DISCARD:"DiscardAction",PREPARE:"PreparationAction"};function A(e,t){const n=e.getModel(),o=n.getMetaModel(),r=o.getMetaPath(e.getPath());return o.getObject(`${r}@com.sap.vocabularies.Common.v1.DraftRoot/${t}`)}function m(e,t,n){const o=A(e,t);return e.getModel().bindContext(`${o}(...)`,e,n)}function C(e,t){const n=A(e,t);const o=e.getModel().getMetaModel(),r=`${o.getMetaPath(e.getPath())}/${n}`,a=o.createBindingContext(r);return P(o).resolvePath(a.getPath()).target}function D(e,t){const n=e.getModel(),o=n.getMetaModel(),r=o.getMetaPath(e.getPath());return o.getObject(`${r}@com.sap.vocabularies.Common.v1.DraftRoot/${t}/$ReturnType`)}function v(e){return!!A(e,w.PREPARE)}async function x(e,n,o,r,a,i){const s=C(e,w.EDIT);if(s){const c=new l(t.getAppComponent(o),e.getModel(),s,{messageHandler:a,contexts:[e],label:p(o).getText("C_COMMON_OBJECT_PAGE_EDIT"),bindingParameters:{$$inheritExpandSelect:true,$$updateGroupId:"$auto"},skipMessages:true,oDataProperties:{disableSideEffects:true,ignoreETag:e.getObject()===undefined,groupId:r,replaceWithRVC:e.getBinding().isA("sap.ui.model.odata.v4.ODataListBinding"),deferredSubmit:i!==true}});c.setDefaultParametersValues({PreserveChanges:n});const d=await c.execute();if(d[0].status==="rejected"){const e=new Error(d[0].reason);e.status=d[0].reason.status;throw e}else{return d[0].value.returnedContext}}else{throw new Error("The edit action not found")}}async function M(t,n,o){if(f.getMessagesPath(t.getModel().getMetaModel(),t.getPath())&&G.hasPrepareAction(t)){try{if(!o&&!t.isKeepAlive()){await t.getBinding().requestObject("")}const e=G.executeDraftPreparationAction(t,t.getUpdateGroupId(),true,o);if(!D(t,w.PREPARE)){_(t,n.getSideEffectsService())}return await e}catch(t){e.error("Error while requesting messages",t)}}return undefined}async function y(t,n,o,r,a){const i=v(t);const s=i;let c;if(!t.getProperty("IsActiveEntity")){const d=C(t,w.ACTIVATION);if(d){try{c=new l(n,t.getModel(),d,{messageHandler:o,contexts:[t],label:p(n).getText("C_OP_OBJECT_PAGE_SAVE"),bindingParameters:{$$inheritExpandSelect:true},skipMessages:true,oDataProperties:{disableSideEffects:true,groupId:r,ignoreETag:s,replaceWithRVC:t.getBinding().isA("sap.ui.model.odata.v4.ODataListBinding")}});const e=await c.execute();if(e[0].status==="rejected"){throw new Error(e[0].reason)}else if(e[0].value.returnedContext===undefined){throw new Error("No context returned by the action")}return e[0].value.returnedContext}catch(o){if(i){const o=await a;o?.destroy();c?.clear();const r=A(t,w.PREPARE),i=n.getSideEffectsService(),s=i.getODataActionSideEffects(r,t),d=s&&s.pathExpressions;if(d&&d.length>0){try{await i.requestSideEffects(d,t)}catch(t){e.error("Error while requesting side effects",t)}}else{try{await _(t,i,true)}catch(t){e.error("Error while requesting messages",t)}}}throw o}}else{throw new Error("The activation action not found")}}else{throw new Error("The activation action cannot be executed on an active document")}}function b(e){return D(e,w.PREPARE)?T(e):undefined}function T(e){const t=e.getModel().getMetaModel().getMetaContext(e.getPath());const n=E(t);const o=n.targetEntityType.annotations.Common?.Messages;return h(o)?o.path:undefined}async function S(t,n,o,r){if(!t.getProperty("IsActiveEntity")){const a=o?b(t):undefined;const i=m(t,w.PREPARE,a?{$select:a}:undefined);i.setParameter("SideEffectsQualifier","");const s=n||i.getGroupId();return i.invoke(s,r).then(function(){return i}).catch(function(t){e.error("Error while executing the operation",t);return i})}else{throw new Error("The preparation action cannot be executed on an active document")}}async function _(e,t){let n=arguments.length>2&&arguments[2]!==undefined?arguments[2]:false;const r=f.getMessagesPath(e.getModel().getMetaModel(),e.getPath());if(r){await t.requestSideEffects([r],e);if(n){const t=await e.requestObject();if(t[r].length>0){o.removeUnboundTransitionMessages();o.removeBoundTransitionMessages()}}}return}async function O(e,t,n,o){if(!e.getProperty("IsActiveEntity")){const r=C(e,w.DISCARD);if(r){const a=await new l(n,e.getModel(),r,{messageHandler:t,label:p(n)?.getText("C_TRANSACTION_HELPER_DRAFT_DISCARD_BUTTON")||"",contexts:[e],skipMessages:true,oDataProperties:{disableSideEffects:true,disableStrictHandling:!o,ignoreETag:e.getObject()===undefined,groupId:"direct",replaceWithRVC:undefined,deferredSubmit:false}}).execute();if(a[0].status==="rejected"){throw new Error(a[0].reason)}}else{throw new Error("The discard action not found")}}else{throw new Error("The discard action cannot be executed on an active document")}}async function R(t,n,o,r){if(!n.getPath().startsWith(t.getPath())){e.error("Cannot compute rightmost sibling context");throw new Error("Cannot compute rightmost sibling context")}if(n.getProperty("IsActiveEntity")===false&&n.getProperty("HasActiveEntity")===false){return undefined}const a=t.getModel();try{const e=n.getPath().replace(t.getPath(),"");const i=e?e.substring(1).split("/"):[];i.unshift(t.getPath().substring(1));const s=[];const c=[];let d="";const u=[...i];if(o?.rootSiblingPathPromise){u.shift();d="/"+t?.getPath()?.substring(1)}const g=u.map(async e=>{d+=`/${e}`;s.unshift(d);if(d.endsWith(")")){const e=a.bindContext(`${d}/SiblingEntity`,undefined,r?{$$groupId:r}:undefined).getBoundContext();return e.requestCanonicalPath()}else{return Promise.resolve(undefined)}});const f=await Promise.all(g);if(f.some(e=>e&&e.endsWith("/SiblingEntity"))){return undefined}if(o?.rootSiblingPathPromise){const e=(await o.rootSiblingPathPromise)?.getPath();f.unshift(e);s.push(t.getPath())}let l="";f.forEach((e,t)=>{if(t!==0){if(i[t].endsWith(")")){const n=i[t].replace(/\(.*$/,"");const o=e.replace(/.*\(/,"(");l+=`/${n}${o}`}else{l+=`/${i[t]}`}}else{l=e}c.unshift(l)});return{targetContext:a.bindContext(l,undefined,{$select:T(n),$$groupId:"$auto.Heroes"}).getBoundContext(),pathMapping:s.map((e,t)=>({oldPath:e,newPath:c[t]}))}}catch(e){return undefined}}async function I(e,n,r,a,i){const s=r||{},c=typeof s.bPreserveChanges==="undefined"||typeof s.bPreserveChanges==="boolean"&&s.bPreserveChanges;async function u(t){const n=e.getModel();const s=n.bindContext(`${e.getPath()}/DraftAdministrativeData`).getBoundContext();const c=p(r.oView);const u=await s.requestObject();if(u){o.removeUnboundTransitionMessages();let t=u.InProcessByUserDescription||u.InProcessByUser;const n=r.oView.getViewData().entitySet;if(t){const e=c.getText("C_DRAFT_OBJECT_PAGE_DRAFT_LOCKED_BY_USER",t,n);d.error(e);throw new Error(e)}else{t=u.CreatedByUserDescription||u.CreatedByUser;const o=c.getText("C_DRAFT_OBJECT_PAGE_DRAFT_UNSAVED_CHANGES",t,n);await G.showEditConfirmationMessageBox(o,e);return G.executeDraftEditAction(e,false,r.oView,a,i,true)}}else if(t?.message){d.error(t.message)}throw new Error(`Draft creation aborted for document: ${e.getPath()}`)}if(!e){throw new Error("Binding context to active document is required")}let g;try{g=await G.executeDraftEditAction(e,c,r.oView,a,i)}catch(n){if(n.status===409||n.status===423){o.removeBoundTransitionMessages();o.removeUnboundTransitionMessages();const r=await G.computeSiblingInformation(e,e);if(r?.targetContext){await t.waitForContextRequested(r.targetContext);return r.targetContext}else{g=await u(n)}}else if(!(n&&n.canceled)){throw new Error(n)}}if(g){const e=G.getActionName(g,w.EDIT);const t=n.getSideEffectsService().getODataActionSideEffects(e,g);if(t?.triggerActions?.length){await n.getSideEffectsService().requestSideEffectsForODataAction(t,g);return g}else{return g}}else{return undefined}}async function B(e,t,n,o){const r=n||{};if(!e){throw new Error("Binding context to draft document is required")}const a=r.fnBeforeActivateDocument?await r.fnBeforeActivateDocument(e):true;if(!a){throw new Error(`Activation of the document was aborted by extension for document: ${e.getPath()}`)}let i;if(!v(e)){i=await y(e,t,o)}else{const n="$auto";const r=e.getModel().hasPendingChanges("$auto")?true:false;const a=G.executeDraftPreparationAction(e,n,undefined,r);e.getModel().submitBatch(n);const s=G.executeDraftActivationAction(e,t,o,n,a);const c=await Promise.all([a,s]);i=c[1]}return r.fnAfterActivateDocument?r.fnAfterActivateDocument(e,i):i}async function $(e,t){const n=g.getResourceBundleFor("sap.fe.core");return new Promise(function(o,r){const a=new c({title:n.getText("C_MESSAGE_HANDLING_SAPFE_ERROR_MESSAGES_PAGE_TITLE_WARNING"),state:"Warning",content:new u({text:e}),beginButton:new s({text:n.getText("C_COMMON_OBJECT_PAGE_EDIT"),type:"Emphasized",press:function(){a.close();o(true)}}),endButton:new s({text:n.getText("C_COMMON_OBJECT_PAGE_CANCEL"),press:function(){a.close();r(`Draft creation aborted for document: ${t.getPath()}`)}}),afterClose:function(){a.destroy()}});a.addStyleClass("sapUiContentPadding");a.open()})}async function N(e,t,n,o){if(e.isTransient()){return e.delete()}const r=A(e,w.DISCARD);const a=e.getObject().IsActiveEntity;if(a||!a&&!r){if(e.hasPendingChanges()&&!e.isInactive()){await e.getBinding().resetChanges();return e.delete()}else{return!e.getProperty("IsActiveEntity")&&f.isDraftRoot(E(e.getModel().getMetaModel().getMetaContext(e.getPath()))?.targetEntitySet)&&e.getProperty("HasActiveEntity")?e.getModel().delete(e):e.delete()}}else{await O(e,t,n,o)}}const G={createDraftFromActiveDocument:I,activateDocument:B,deleteDraft:N,executeDraftEditAction:x,executeDraftValidation:M,executeDraftPreparationAction:S,executeDraftActivationAction:y,hasPrepareAction:v,computeSiblingInformation:R,processDataLossOrDraftDiscardConfirmation:n.processDataLossOrDraftDiscardConfirmation,silentlyKeepDraftOnForwardNavigation:n.silentlyKeepDraftOnForwardNavigation,createOperation:m,executeDraftDiscardAction:O,NavigationType:n.NavigationType,getActionName:A,showEditConfirmationMessageBox:$};return G},false);
//# sourceMappingURL=draft.js.map