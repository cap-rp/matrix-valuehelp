/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)
 *      (c) Copyright 2009-2025 SAP SE. All rights reserved
 */
sap.ui.define(["sap/base/Log","sap/fe/core/CommonUtils","sap/fe/core/controllerextensions/messageHandler/messageHandling","sap/fe/core/converters/ManifestSettings","sap/fe/core/helpers/PromiseKeeper","sap/fe/core/helpers/StableIdHelper","sap/fe/core/library","sap/m/Button","sap/m/Dialog","sap/m/Label","sap/m/MessageBox","sap/m/MessageStrip","sap/m/MessageToast","sap/ui/core/Fragment","sap/ui/core/Lib","sap/ui/core/util/XMLPreprocessor","sap/ui/layout/form/Form","sap/ui/layout/form/FormContainer","sap/ui/layout/form/FormElement","sap/ui/layout/form/ResponsiveGridLayout","sap/ui/model/json/JSONModel","./MassEditField","./MassEditSideEffects","sap/fe/base/jsx-runtime/jsx","sap/fe/base/jsx-runtime/Fragment","sap/fe/base/jsx-runtime/jsxs"],function(e,t,s,n,i,o,r,a,l,d,c,h,g,u,p,f,m,C,M,E,x,b,S,w,_,y){"use strict";var T={};var P=n.OperationGroupingMode;let O=function(){function n(e){this.requiredDataPromise=new i;this.updatedProperties=new Set;this.dialog=undefined;this.table=e.table;this.contexts=e.contexts;this.isAdaptation=t.getAppComponent(this.table).isAdaptationMode();this.fieldProperties=e.fieldProperties;this.view=t.getTargetView(this.table);this.transientListBinding=this.generateListBinding();this.bindingContext=this.transientListBinding.create({},true);this.resourceBundle=p.getResourceBundleFor("sap.fe.macros");this.contextsOnError=[];this.fieldControls=[]}T=n;var O=n.prototype;O.generateListBinding=function e(){const t=this.table.getRowBinding();const s=this.table.getModel().bindList(t.getPath(),t.getContext(),[],[],{$$updateGroupId:"submitLater"});s.refreshInternal=()=>{};return s};O.create=async function e(){if(!this.dialog){const e=p.getResourceBundleFor("sap.fe.core");const t=this.view.getViewData().converterType==="ListReport"?this.resourceBundle.getText("C_MASS_EDIT_SAVE_BUTTON_TEXT"):e.getText("C_COMMON_DIALOG_OK");const s=await this.createContent();const n=w(l,{"dt:designtime":"sap/fe/macros/table/massEdit/designtime/MassEdit.designtime",id:o.generate([this.table.getId(),"MED_","Dialog"]),contentWidth:"27rem",class:"sapUiContentPadding",horizontalScrolling:"false",title:this.resourceBundle.getText("C_MASS_EDIT_DIALOG_TITLE",[this.contexts.length.toString()]),content:s,escapeHandler:this.onClose.bind(this),beforeOpen:this.beforeOpen.bind(this),beginButton:w(a,{text:t,type:"Emphasized",press:this.onApply.bind(this)}),endButton:w(a,{text:e.getText("C_COMMON_OBJECT_PAGE_CANCEL"),press:this.onClose.bind(this)})});this.dialog=n;n.setModel(new x({isEditable:true}),"ui");n.bindElement({path:"/",model:"ui"});return n}return this.dialog};O.beforeOpen=function e(t){const s=t.getSource();s.setModel(this.table.getModel());s.setBindingContext(this.bindingContext);this.table.addDependent(s)};O.onClose=function e(){this.transientListBinding.destroy();if(this.dialog){this.dialog.close();this.dialog.destroy()}};O.getRequiredDataPromise=function e(){return this.requiredDataPromise};O.manageMessage=async function e(){const n=p.getResourceBundleFor("sap.fe.core");const i=this.view.getController();const o=r.DraftStatus;const a=this.view.getBindingContext("internal");a?.setProperty("getBoundMessagesForMassEdit",true);await i.messageHandler.showMessages({onBeforeShowMessage:(e,n)=>{n.fnGetMessageSubtitle=s.setMessageSubtitle.bind({},this.table,this.contexts);if(!this.contextsOnError.length){if(this.updatedProperties.size>0){i.editFlow.setDraftStatus(o.Saved);if(this.view.getViewData().converterType==="ListReport"){g.show(this.resourceBundle.getText("C_MASS_EDIT_SUCCESS_TOAST"))}else{g.show(this.resourceBundle.getText("C_OBJECT_PAGE_MASS_EDIT_SUCCESS_TOAST"))}}else{g.show(this.resourceBundle.getText("C_MASS_EDIT_NO_CHANGE"))}}else if(this.contextsOnError.length<this.contexts.length){i.editFlow.setDraftStatus(o.Saved)}else if(this.contextsOnError.length===this.contexts.length){i.editFlow.setDraftStatus(o.Clear)}if(t.getIsEditable(i)&&!e.some(e=>!e.getTargets())){n.showMessageBox=false;n.showMessageDialog=false}return n}});if(!!this.contextsOnError.length&&this.contextsOnError.length<this.contexts.length){const e=n.getText("C_COMMON_DIALOG_OK");c.success(this.resourceBundle.getText("C_MASS_EDIT_CHANGES_WITH_ERROR",[this.contexts.length-this.contextsOnError.length,this.contexts.length]),{actions:[e],emphasizedAction:e})}a?.setProperty("getBoundMessagesForMassEdit",false)};O.saveChanges=async function t(s){const n=this.table.getParent().getTableDefinition().control.massEdit;const i=n.operationGroupingMode===P.Isolated;const o="$auto.Isolated";const r=new S(this);const a=[];const l=this.table.getModel();if(i){l.setContinueOnError(o)}this.contexts.forEach(t=>{const n=[];const d=[];for(const{control:r,values:l}of s.fieldControlReference){let s=false;if(!r.isReadOnlyOnContext(t)){const c=i?o:"$auto";for(const i in l){if(t.getProperty(i)!==l[i]){s=true;a.push(t.setProperty(i,l[i],c).then(()=>this.updatedProperties.add(i)).catch(s=>{this.contextsOnError.push(t);e.error("Mass Edit: Something went wrong in updating entries.",s)}));n.push({propertyPath:i,groupId:c})}}if(s){d.push({control:r,groupId:c})}}}a.push(...n.map(async e=>r.executeImmediateSideEffects(t,e.propertyPath,e.groupId)));a.push(...d.map(async e=>r.refreshDescription(e.control,t,e.groupId)));if(i){l.submitBatch(o)}});await Promise.allSettled(a);if(this.updatedProperties.size){r.executeDeferredSideEffects(new Set(["genericField",...Array.from(this.updatedProperties)]))}};O.getFieldValuesInfos=function e(){const t={values:{},fieldControlReference:[]};for(const e of this.fieldControls){const s=e.getFieldValues();t.values={...t.values,...s};t.fieldControlReference.push({control:e,values:s})}return t};O.applyChanges=async function t(){await this.requiredDataPromise.promise;this.view.getBindingContext("internal")?.setProperty("skipPatchHandlers",true);const s=this.getFieldValuesInfos();let n=false;try{n=await this.view.getController().editFlow.customMassEditSave({aContexts:this.contexts,oUpdateData:s.values})}catch(t){e.error("Mass Edit: Something went wrong in updating entries.",t)}if(!n){await this.saveChanges(s)}this.view.getBindingContext("internal")?.setProperty("skipPatchHandlers",false);return n};O.onApply=async function e(){if(this.fieldControls.some(e=>!e.isFieldValid())){return}if(!this.isAdaptation){s.removeBoundTransitionMessages();s.removeUnboundTransitionMessages();const e=await this.applyChanges();if(!e){this.manageMessage()}}this.onClose()};O.createContent=async function e(){const t=await this.createCustomContainer();return y(_,{children:[this.getAdaptationMessage(),w(m,{children:{layout:w(E,{labelSpanM:"12",labelSpanL:"12",labelSpanXL:"12"}),formContainers:y(_,{children:[t,w(C,{children:{formElements:this.createFormElements()}})]})}})]})};O.getAdaptationMessage=function e(){if(this.isAdaptation){return w(h,{text:this.resourceBundle.getText("C_MASS_EDIT_ADAPTATION_MODE")})}return undefined};O.createCustomContainer=async function e(){const t=this.table.getParent().getTableDefinition().control.massEdit;if(t.customFragment){if(t.fromInline===true){if(typeof t.customFragment==="string"){const e=await f.process((new DOMParser).parseFromString(t.customFragment,"text/xml").firstElementChild,{models:{}},this.view.getController().getOwnerComponent().getPreprocessorContext());return await u.load({type:"XML",definition:e,controller:this.view.getController()})}else{return t.customFragment.clone()}}return await this.view.getController().getExtensionAPI().loadFragment({id:"customMassEdit",name:t.customFragment,contextPath:this.transientListBinding.getModel().getMetaModel().getMetaPath(this.transientListBinding.getResolvedPath())})}return undefined};O.createFormElements=function e(){return this.fieldProperties.map(this.createFormElement.bind(this))};O.createFormElement=function e(t){return w(M,{visible:t.visible,children:{label:w(d,{text:t.label,id:o.generate(["MED_",t.propertyInfo.key,"Label"])}),fields:this.createFields(t)}})};O.createFields=function e(t){const s=this.table.getModel().getMetaModel();const n=s.createBindingContext(s.getMetaPath(this.bindingContext.getPath()));const i=new b(t,n);this.fieldControls.push(i);return i.getControls()};return n}();T=O;return T},false);
//# sourceMappingURL=MassEditDialog.js.map