{"version":3,"names":["TableAPIStateHandler","_IViewStateContributo","apply","arguments","_exports","_inheritsLoose","_proto","prototype","retrieveState","tableState","innerTable","getControlState","StateUtil","retrieveExternalState","content","quickFilter","getQuickFilter","quickFilterState","getSelectedKey","selectedKey","variantToRetrieve","getVariant","getId","variantManagementControl","variantManagement","variantId","getCurrentVariantKey","setInitialState","initialControlState","e","Log","error","applyLegacyState","_navParameters","shouldApplyDiffState","table","vm","vmState","controlState","fullState","initialState","toString","Object","keys","length","applyState","initialized","innerTableState","currentVariant","quickFilterKey","undefined","ovM","aVariants","getVariants","sVariantReference","some","oVariant","getKey","getStandardVariantKey","ControlVariantApplyAPI","__ui5_require_async","default","activateVariant","element","variantReference","finalState","supplementaryConfig","diffState","applyExternalState","setSelectedKey","onQuickFilterSelectionChange","initialLoad","filterBar","getFilterBarControl","isA","waitForInitialState","then","rebind","catch","IViewStateContributorMixin"],"sourceRoot":".","sources":["TableAPIStateHandler.ts"],"sourcesContent":["import Log from \"sap/base/Log\";\nimport type { NavigationParameter } from \"sap/fe/core/controllerextensions/ViewState\";\nimport IViewStateContributorMixin from \"sap/fe/core/controllerextensions/viewState/IViewStateContributorMixin\";\nimport type FilterBarAPI from \"sap/fe/macros/filterBar/FilterBarAPI\";\nimport type { ControlState } from \"sap/fe/macros/insights/CommonInsightsHelper\";\nimport type TableAPI from \"sap/fe/macros/table/TableAPI\";\nimport type { TableState } from \"sap/fe/macros/table/TableAPI\";\nimport type ManagedObject from \"sap/ui/base/ManagedObject\";\nimport StateUtil from \"sap/ui/mdc/p13n/StateUtil\";\n\nexport default class TableAPIStateHandler extends IViewStateContributorMixin<TableState> {\n\t/**\n\t * Asynchronously retrieves the state of the table based on the provided viewstate.\n\t * @returns A promise that resolves to the table state or null if not found.\n\t */\n\tasync retrieveState(this: TableAPI): Promise<TableState | null> {\n\t\tconst tableState: TableState = {};\n\t\ttableState.innerTable = this.getControlState(await StateUtil.retrieveExternalState(this.content)) as object;\n\t\tconst quickFilter = this.getQuickFilter();\n\t\tif (quickFilter) {\n\t\t\tconst quickFilterState = quickFilter.getSelectedKey();\n\t\t\tif (!tableState.quickFilter) {\n\t\t\t\ttableState.quickFilter = {};\n\t\t\t}\n\t\t\ttableState.quickFilter.selectedKey = quickFilterState;\n\t\t}\n\t\tconst variantToRetrieve = this.content.getVariant()?.getId();\n\t\tif (variantToRetrieve) {\n\t\t\tconst variantManagementControl = this.content.getVariant();\n\t\t\tif (!tableState.variantManagement) {\n\t\t\t\ttableState.variantManagement = { variantId: variantManagementControl?.getCurrentVariantKey() };\n\t\t\t} else {\n\t\t\t\ttableState.variantManagement.variantId = variantManagementControl?.getCurrentVariantKey();\n\t\t\t}\n\t\t}\n\t\treturn tableState;\n\t}\n\n\t/**\n\t * Sets the initial state of the control by retrieving the external state.\n\t * @returns A promise that resolves when the initial state is set.\n\t */\n\tasync setInitialState(this: TableAPI): Promise<void> {\n\t\ttry {\n\t\t\tconst initialControlState = await StateUtil.retrieveExternalState(this.content);\n\t\t\tthis.initialControlState = initialControlState;\n\t\t} catch (e: unknown) {\n\t\t\tLog.error(e as string);\n\t\t}\n\t}\n\n\t/**\n\t * Applies the legacy state to the table based on the provided control state retrieval function.\n\t * @param getControlState Function to retrieve the control state.\n\t * @param [_navParameters] Optional navigation parameters.\n\t * @param [shouldApplyDiffState] Flag indicating whether to apply the diff state.\n\t * @returns - A promise that resolves when the state has been applied.\n\t */\n\tasync applyLegacyState(\n\t\tthis: TableAPI,\n\t\tgetControlState: (control: ManagedObject) => ControlState,\n\t\t_navParameters?: NavigationParameter,\n\t\tshouldApplyDiffState?: boolean\n\t): Promise<void> {\n\t\tconst table = this.content;\n\t\tconst vm = table.getVariant();\n\t\tconst quickFilter = this.getQuickFilter();\n\n\t\tconst tableState = getControlState(table) as { initialState?: TableState; fullState?: TableState };\n\t\tconst vmState = vm ? getControlState(vm) : null;\n\t\tconst quickFilterState = quickFilter?.content ? getControlState(quickFilter.content) : null;\n\n\t\tconst controlState: TableState = {};\n\n\t\tif (tableState) {\n\t\t\tcontrolState.innerTable = {\n\t\t\t\t...controlState.innerTable,\n\t\t\t\t...tableState,\n\t\t\t\tfullState: {\n\t\t\t\t\t...controlState.innerTable?.fullState,\n\t\t\t\t\t...tableState.fullState\n\t\t\t\t},\n\t\t\t\tinitialState: {\n\t\t\t\t\t...controlState.innerTable?.initialState,\n\t\t\t\t\t...tableState.initialState\n\t\t\t\t}\n\t\t\t};\n\t\t}\n\n\t\tif (vmState?.variantId) {\n\t\t\tcontrolState.variantManagement = {\n\t\t\t\t...controlState.variantManagement,\n\t\t\t\tvariantId: vmState.variantId.toString()\n\t\t\t};\n\t\t}\n\n\t\tif (quickFilterState?.selectedKey) {\n\t\t\tcontrolState.quickFilter = {\n\t\t\t\t...controlState.quickFilter,\n\t\t\t\tselectedKey: quickFilterState.selectedKey.toString()\n\t\t\t};\n\t\t}\n\t\tif (controlState && Object.keys(controlState).length > 0) {\n\t\t\tawait this.applyState(controlState as object, _navParameters, shouldApplyDiffState);\n\t\t}\n\t}\n\n\t/**\n\t * Asynchronously applies the provided control state to the viewstate.\n\t * @param controlState The state to be applied to the control.\n\t * @param [_navParameters] Optional navigation parameters.\n\t * @param [shouldApplyDiffState] Optional flag to skip merging states.\n\t * @returns A promise that resolves when the state has been applied.\n\t */\n\tasync applyState(\n\t\tthis: TableAPI,\n\t\tcontrolState: TableState,\n\t\t_navParameters?: NavigationParameter,\n\t\tshouldApplyDiffState?: boolean\n\t): Promise<void> {\n\t\tif (!controlState) return;\n\n\t\t// Table properties need to be available before calling diffState/retrieveState. However, applyState\n\t\t// gets called too early in the table's lifecycle, so the delegate and properties are not yet available.\n\t\tawait this.content.initialized();\n\n\t\tconst innerTableState = controlState?.innerTable;\n\t\tconst variantId = controlState?.variantManagement?.variantId;\n\t\tconst currentVariant = this.content?.getVariant();\n\t\tconst quickFilterKey = controlState?.quickFilter?.selectedKey;\n\t\tconst quickFilter = this.getQuickFilter();\n\n\t\t// Handle Variant Management\n\t\tif (variantId !== undefined && variantId !== currentVariant.getCurrentVariantKey()) {\n\t\t\tconst ovM = this.content?.getVariant();\n\t\t\tconst aVariants = ovM?.getVariants();\n\t\t\tconst sVariantReference = aVariants?.some((oVariant) => oVariant.getKey() === variantId)\n\t\t\t\t? variantId\n\t\t\t\t: ovM?.getStandardVariantKey;\n\t\t\ttry {\n\t\t\t\tconst ControlVariantApplyAPI = (await import(\"sap/ui/fl/apply/api/ControlVariantApplyAPI\")).default;\n\t\t\t\tawait ControlVariantApplyAPI.activateVariant({\n\t\t\t\t\telement: ovM,\n\t\t\t\t\tvariantReference: sVariantReference as string\n\t\t\t\t});\n\t\t\t\tawait this.setInitialState();\n\t\t\t} catch (error: unknown) {\n\t\t\t\tLog.error(error as string);\n\t\t\t\tawait this.setInitialState();\n\t\t\t}\n\t\t} else {\n\t\t\t// we need to update initial state even if above condition not satiesfied\n\t\t\tawait this.setInitialState();\n\t\t}\n\n\t\t// Handle Inner Table State\n\n\t\tlet finalState;\n\n\t\tif (innerTableState) {\n\t\t\tif (shouldApplyDiffState && innerTableState.initialState) {\n\t\t\t\tif (!innerTableState.initialState.supplementaryConfig) {\n\t\t\t\t\tinnerTableState.initialState.supplementaryConfig = {};\n\t\t\t\t}\n\t\t\t\tfinalState = await StateUtil.diffState(\n\t\t\t\t\tthis.content,\n\t\t\t\t\tinnerTableState.initialState as object,\n\t\t\t\t\tinnerTableState.fullState as object\n\t\t\t\t);\n\t\t\t} else {\n\t\t\t\tif (controlState && !controlState?.supplementaryConfig) {\n\t\t\t\t\tcontrolState.supplementaryConfig = {};\n\t\t\t\t}\n\t\t\t\tfinalState = innerTableState.fullState;\n\t\t\t}\n\t\t\tawait StateUtil.applyExternalState(this.content, finalState);\n\t\t}\n\n\t\t// Handle Quick Filter State\n\t\tif (quickFilterKey && quickFilterKey !== quickFilter?.getSelectedKey()) {\n\t\t\tquickFilter?.setSelectedKey(quickFilterKey);\n\t\t\tthis.onQuickFilterSelectionChange();\n\t\t}\n\t\tif (this.initialLoad && this.filterBar) {\n\t\t\tconst filterBar = this.getFilterBarControl(this.filterBar);\n\t\t\tif (filterBar && filterBar.isA<FilterBarAPI>(\"sap.fe.macros.filterBar.FilterBarAPI\")) {\n\t\t\t\tfilterBar\n\t\t\t\t\t.waitForInitialState()\n\t\t\t\t\t.then((): void => {\n\t\t\t\t\t\tthis.content.rebind();\n\t\t\t\t\t\treturn;\n\t\t\t\t\t})\n\t\t\t\t\t.catch((): void => {\n\t\t\t\t\t\tLog.error(\"Error while waiting for initial state of filter bar\");\n\t\t\t\t\t});\n\t\t\t}\n\t\t}\n\t}\n}\n"],"mappings":"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","ignoreList":[],"file":"TableAPIStateHandler-dbg.js"}