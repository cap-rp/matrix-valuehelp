/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)
 *      (c) Copyright 2009-2025 SAP SE. All rights reserved
 */
sap.ui.define(["sap/base/Log","sap/fe/core/ActionRuntime","sap/fe/core/CommonUtils","sap/fe/core/controllerextensions/BusyLocker","sap/fe/core/converters/MetaModelConverter","sap/fe/core/helpers/DeleteHelper","sap/fe/core/helpers/FPMHelper","sap/fe/core/library","sap/fe/macros/table/Utils","sap/ui/core/Messaging","../field/FieldRuntimeHelper"],function(e,t,n,o,a,i,r,l,s,c,d){"use strict";const g=l.CreationMode;const u={executeConditionalActionShortcut:function(e,t){const o=t.getParent();if(e!==g.CreationRow){const t=o.getActions().reduce(function(e,t){return e.concat(t.getAction())},[]).find(function(t){return t.getId().endsWith(e)});n.fireButtonPress(t)}else{const e=o.getAggregation("creationRow");if(e&&e.getApplyEnabled()&&e.getVisible()){e.fireApply()}}},setContexts:async function(t){const n=t.getSource();const a=n;o.lock(a);try{await u.setContextsAsync(a)}catch(t){e.error(t)}finally{o.unlock(a)}},setContextsAsync:async function(e){const n=e.getModel()?.getMetaModel();const o=e.getParent();if(!o||!n){return}const r=o.tableDefinition;const l=a.convertTypes(n).resolvePath(r.annotation.collection).target;const s=r.annotation.updatablePropertyPath;const c=e.data("actionsMultiselectDisabled")?.split(",")??[];const d=JSON.parse(r.operationAvailableMap||"{}");const g=e.data("navigationAvailableMap");const f=e.getSelectedContexts();const b=[];const p=e.data("displayModePropertyBinding")==="true"&&!!l?.annotations.Common?.DraftRoot;const C=[];const m={};const y={};const h=e.getBindingContext("internal");if(!h){return}i.updateDeleteInfoForSelectedContexts(h,f);const x=f.filter(function(e){return!e.isInactive()});const P=Object.assign(h.getObject()||{},{selectedContexts:x,selectedContextsIncludingInactive:f,numberOfSelectedContexts:x.length,dynamicActions:m,ibn:y,deleteEnabled:true,deletableContexts:b,unSavedContexts:[],lockedContexts:[],draftsWithNonDeletableActive:[],draftsWithDeletableActive:[],controlId:"",updatableContexts:C,pasteAuthorized:true,pasteFromCopyAutorized:true,semanticKeyHasDraftIndicator:h.getProperty("semanticKeyHasDraftIndicator")?h.getProperty("semanticKeyHasDraftIndicator"):undefined});P.nodeUpdatesInfo=P.nodeUpdatesInfo||{};for(const e of x){const t=e.getObject();for(const e in t){if(e.indexOf("#")===0){let t=e;t=t.substring(1,t.length);P.dynamicActions[t]={enabled:true};h.setProperty("",P)}}if(this.isUpdatableContext(s,e,p)){C.push(e)}}if(!e.data("enableAnalytics")){u.setIntentBasedNavigationEnablement(h,g,x)}if(x.length>1){this.disableAction(c,m)}if(P){P["updatableContexts"]=C;P["controlId"]=e.getId();h.setProperty("",P)}if(x.length<=1&&r.control.createEnablement){const t=x.length?x[0]:null;this._updateCreateEnablement(h,r.control.createEnablement,e,t,r.control.nodeType)}this.updateCutCopyPasteEnablement(P,e);this.updateMoveUpDownEnablement(P,e);return t.setActionEnablement(h,d,x,"table")},isUpdatableContext:function(e,t,n){const o=t.getObject();const a=e.length===0||!!t.getProperty(e);const i=!n||o.IsActiveEntity;if(a&&i){return true}return false},checkIfNodeIsMovable:function(t,n){const o=n.getParent().getTableDefinition().control.isNodeMovable;const a=o?r.getCustomFunction(o.moduleName,o.methodName,n):undefined;try{return a===undefined||a(t)}catch(t){e.warning(`Error in custom function for isNodeMovable: ${t}`);return true}},checkIfNodeIsCopyable:function(t,n){const o=n.getParent().getTableDefinition().control.isNodeCopyable;const a=o?r.getCustomFunction(o.moduleName,o.methodName,n):undefined;try{return a===undefined||a(t)}catch(t){e.warning(`Error in custom function for isNodeMovable: ${t}`);return true}},updateCutCopyPasteEnablement:function(e,t){let n=arguments.length>2&&arguments[2]!==undefined?arguments[2]:false;const o=t.getParent().getTableDefinition();if(o.control.type!=="TreeTable"){return}const a=!t.getRowBinding().isRelative();if(n){e.contextmenu.nodeUpdatesInfo={}}const i=e.nodeUpdatesInfo;const l=(!n?e:e.contextmenu).nodeUpdatesInfo;const s=!n?e:e.contextmenu;const c=s.updatableContexts.filter(e=>u.checkIfNodeIsMovable(e,t)&&(!a||e.getProperty("HasDraftEntity")!==true));const d=s.selectedContexts.filter(e=>u.checkIfNodeIsCopyable(e,t));l.cutEnablement=c.length===1;l.copyEnablement=d.length===1;if(i.lastAction&&i.pastableContexts.length>0){let e;const n=i.lastAction==="Cut"?o.control.isMoveToPositionAllowed:o.control.isCopyToPositionAllowed;if(n){e=[...s.selectedContexts].filter(e=>r.getCustomFunction(n.moduleName,n.methodName,t)(i.pastableContexts[0],e))}else{e=[...s.selectedContexts]}l.pasteEnablement=s.selectedContexts.length<=1&&e.length===s.selectedContexts.length}},updateMoveUpDownEnablement:function(e,t){let n=arguments.length>2&&arguments[2]!==undefined?arguments[2]:false;const o=!n?e:e.contextmenu;const a=o.selectedContexts;const i=t.getParent().getTableDefinition();const r=i.annotation.changeSiblingForRootsSupported;if(a.length!==1||i.control.type!=="TreeTable"||t.getBindingContext("internal")?.getProperty("isSorted")===true||a[0].getProperty("@$ui5.node.level")===1&&!r){o.singleContextMovableUp=false;o.singleContextMovableDown=false}else{const e=a[0];const n=t.getRowBinding().isRelative()||e.getProperty("HasDraftEntity")!==true;const i=e.isTransient()!==undefined;const r=u.checkIfNodeIsMovable(e,t);o.singleContextMovableUp=n&&r&&!i&&e.getSibling(-1)!==null;o.singleContextMovableDown=n&&r&&!i&&e.getSibling(1)!==null}},_updateCreateEnablement:function(e,t,n,o,a){let i=arguments.length>5&&arguments[5]!==undefined?arguments[5]:false;let l;if(a!==undefined){l=a.values.map(e=>e.value)}else{l=[undefined]}const s=r.getCustomFunction(t.moduleName,t.methodName,n);if(!s){return}const c=l.map(e=>{let t=false;try{t=!!(s(e,o)??true)}catch(e){t=true}return t});const d={};d["Create"]=c.some(e=>e);c.forEach((e,t)=>{d[`Create_${t}`]=e});const g=i?"contextmenu/":"";e.setProperty(g+"createEnablement",d)},clearSelection:function(e){e.clearSelection();const t=e.getBindingContext("internal");if(t){t.setProperty("deleteEnabled",false);t.setProperty("numberOfSelectedContexts",0);t.setProperty("selectedContexts",[]);t.setProperty("deletableContexts",[])}const n=e.getParent();if(n.tableDefinition.control.createEnablement){this._updateCreateEnablement(t,n.tableDefinition.control.createEnablement,e,null,n.tableDefinition.control.nodeType)}},disableAction:function(e,t){e.forEach(function(e){t[e]={bEnabled:false}})},onFieldChangeInCreationRow:function(e,t){const n=d.getFieldStateOnChange(e),o=n.field,a=o.getId();const i=o.getBindingContext("internal"),r=i.getProperty("creationRowFieldValidity"),l=Object.assign({},r);l[a]=n.state;i.setProperty("creationRowFieldValidity",l);if(t){const e=i.getProperty("creationRowCustomValidity"),t=Object.assign({},e);t[o.getBinding("value").getPath()]={fieldId:o.getId()};i.setProperty("creationRowCustomValidity",t);const n=`${o.getBindingContext()?.getPath()}/${o.getBindingPath("value")}`;c.getMessageModel().getData().forEach(function(e){if(e.getTargets()[0]===n){c.removeMessages(e)}})}},onTreeTableContextChanged:function(e,t){const n=e.getSource();const o=n;const a=o.getParent();const i=o.getRowBinding();if(!i?.getContext()||a.getIgnoreContextChangeEvent()){return}const r=i.getAggregation()??{};const l=s.getAllFilterInfo(o);r.expandTo=l.search?Number.MAX_SAFE_INTEGER:t;i.setAggregation(r)},onCreateMenuItemPress:async function(t,o,a){const i=r.getMdcTable(t.getSource());const l=i?.getParent();if(!l||!i){return}const s=l.tableDefinition.control.nodeType;if(!s){return}const c=n.getTargetView(l);const d={};d[s.propertyName]=s.values[o].value;const u={selectedContexts:a,creationMode:l.tableDefinition.annotation.create.mode,data:d,tableId:i?.getId()};if(u.creationMode===g.CreationDialog){u.creationDialogFields=s.values[o].creationDialogFields;if(!u.creationDialogFields||u.creationDialogFields.length===0){u.creationDialogFields=l.tableDefinition.control.creationDialogFields}if(!i.getRowBinding()){await i.rebind()}}c.getController().editFlow.createDocument(l.getRowBinding(),u).catch(t=>{e.error(`Failed to create new document: ${t}`)})},onCreateButtonPress:async function(t,o){const a=r.getMdcTable(t.getSource());const i=a?.getParent();if(!i||!a){return}const l={creationMode:i.tableDefinition.annotation.create.mode};switch(l.creationMode){case g.External:l.outbound=i.tableDefinition.annotation.create.outbound;break;case g.CreationRow:l.creationRow=t.getSource();l.createAtEnd=i.tableDefinition.control.createAtEnd??false;break;case g.NewPage:case g.Inline:case g.CreationDialog:l.createAtEnd=i.tableDefinition.control.createAtEnd??false;l.tableId=a?.getId();l.selectedContexts=o;break;case g.InlineCreationRows:break;default:return}if(l.creationMode===g.CreationDialog){l.creationDialogFields=i.tableDefinition.control.creationDialogFields;if(!a.getRowBinding()){await a.rebind()}}const s=n.getTargetView(i);if(l.creationMode===g.InlineCreationRows){s.getController().editFlow.createEmptyRowsAndFocus(a).catch(t=>{e.error(`Failed to create new empty row: ${t}`)})}else{s.getController().editFlow.createDocument(i.getRowBinding(),l).catch(t=>{e.error(`Failed to create new document: ${t}`)})}},setIntentBasedNavigationEnablement:function(e,t,n){let o=arguments.length>3&&arguments[3]!==undefined?arguments[3]:false;for(const a in t){if(!o){e.setProperty(`ibn/${a}`,{bEnabled:false,aApplicable:[],aNotApplicable:[]})}else{e.setProperty(`ibn/${a}`,{bEnabled:e.getProperty(`${e.getPath()}/ibn/${a}/bEnabled`),aApplicable:e.getProperty(`${e.getPath()}/ibn/${a}/aApplicable`),aNotApplicable:e.getProperty(`${e.getPath()}/ibn/${a}/aNotApplicable`),bEnabledForContextMenu:false,aApplicableForContextMenu:[],aNotApplicableForContextMenu:[]})}const i=[],r=[];const l=t[a];for(const t of n){if(t.getObject(l)){const n=!o?"bEnabled":"bEnabledForContextMenu";e.getModel().setProperty(`${e.getPath()}/ibn/${a}/${n}`,true);i.push(t)}else{r.push(t)}}const s=!o?"aApplicable":"aApplicableForContextMenu";const c=!o?"aNotApplicable":"aNotApplicableForContextMenu";e.getModel().setProperty(`${e.getPath()}/ibn/${a}/${s}`,i);e.getModel().setProperty(`${e.getPath()}/ibn/${a}/${c}`,r)}},onContextMenuItemSelected:function(e){const t=r.getMdcTable(e.getSource());const n=t?.getParent();n?.setContextMenuActive(true);setTimeout(()=>{n?.setContextMenuActive(false)},0)},dataStateIndicatorFilter:function(e,t){const n=t.getParent();return n.dataStateIndicatorFilter(e,t)}};return u},false);
//# sourceMappingURL=TableRuntime.js.map