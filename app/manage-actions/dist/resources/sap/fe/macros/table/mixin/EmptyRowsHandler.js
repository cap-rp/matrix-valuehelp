/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)
 *      (c) Copyright 2009-2025 SAP SE. All rights reserved
 */
sap.ui.define(["sap/base/Log","sap/fe/core/CommonUtils","sap/fe/core/controllerextensions/collaboration/CollaborationCommon","sap/fe/core/converters/ManifestSettings","sap/fe/core/converters/MetaModelConverter","sap/ui/core/Lib","sap/ui/core/Messaging","sap/ui/core/message/Message","sap/ui/core/message/MessageType"],function(t,e,n,o,s,i,a,r,c){"use strict";var g={};var l=s.getInvolvedDataModelObjects;var d=o.CreationMode;var f=n.Activity;let u=function(){function n(){}g=n;var o=n.prototype;o.setupMixin=function t(e){};o._onFieldLiveChange=function t(e){const n=e.getSource(),o=n.getBindingContext(),s=o.getBinding();if(o.isInactive()){const t=this?.getContent();this?.createEmptyRows(s,t,true)}};o._handleCreateActivate=async function n(o){const s=o.getParameter("context");this.createEmptyRows(o.getSource(),this.getContent(),true);if(!this.validateEmptyRow(s)){o.preventDefault();return}try{const n=s.getPath(),o=e.getTargetView(this),i=o.getController(),a=i.editFlow;try{await(s.created()??Promise.resolve());await a.onAfterCreate({context:s})}catch(e){t.warning(`Failed to activate context ${s.getPath()}`);return}const r=s.getPath();const c=o.getController().collaborativeDraft;c.send({action:f.Create,content:r});c.updateLocksForContextPath(n,s.getPath())}catch(e){t.error("Failed to activate new row -",e)}};o.getDefaultValuesFunction=function t(e){const n=e.getModel();const o=n.getMetaModel();const s=o.getMetaContext(e.getResolvedPath());const i=l(s);const a=i.targetObject.annotations.Common?.DefaultValuesFunction;const r=i.targetEntitySet?.annotations.Common?.DefaultValuesFunction;return a??r};o.setEmptyRowsEnabled=function t(n){this.setProperty("emptyRowsEnabled",n);const o=this.getContent().data().navigationPath,s=e.getAppComponent(this.getContent());if(n){const t=this.getContent().getRowBinding();const e=t?.getResolvedPath()?this.getDefaultValuesFunction(t):undefined;if(e){s.getSideEffectsService().registerTargetCallback(o,this.updateEmptyRows.bind(this))}}else{s.getSideEffectsService().deregisterTargetCallback(o)}this.setUpEmptyRows(this.getContent())};o.updateEmptyRows=async function t(){const e=this.getContent();const n=e.getRowBinding();const o=n.getHeaderContext();if(n&&n.isResolved()&&n.isLengthFinal()&&o){const t=o.getPath();this._deleteEmptyRows(n,t);await this.createEmptyRows(n,e)}return};o.setUpEmptyRows=async function t(n){let o=arguments.length>1&&arguments[1]!==undefined?arguments[1]:false;if(this.getTableDefinition().control?.creationMode!==d.InlineCreationRows){return}const s=n.getModel("ui");if(!s){return}if(s.getProperty("/isEditablePending")){const t=s.bindProperty("/isEditablePending");await new Promise(e=>{const n=()=>{t.detachChange(n);t.destroy();e()};t.attachChange(n)})}const i=n.getRowBinding();const a=i?.getHeaderContext();if(i&&i.isResolved()&&i.isLengthFinal()&&a){const t=a.getPath();if(!this.emptyRowsEnabled){this.removeEmptyRowsMessages();return this._deleteEmptyRows(i,t)}if(!e.getIsEditable(n)){return}if(this.getTableDefinition().control?.inlineCreationRowsHiddenInEditMode&&!n.getBindingContext("pageInternal")?.getProperty("createMode")&&!o){return}const s=i.getAllCurrentContexts().find(function(e){return e.isInactive()&&e.getPath().startsWith(t)});if(!s){this.removeEmptyRowsMessages();await this.createEmptyRows(i,n)}}};o._deleteEmptyRows=function t(e,n){for(const t of e.getAllCurrentContexts()){if(t.isInactive()&&t.getPath().startsWith(n)){t.delete()}}};o.getInactiveContextNumber=function t(e){return e.getAllCurrentContexts().filter(t=>t.isInactive()).length};o.validateEmptyRow=function t(e){const n=this.getTableDefinition().annotation.requiredProperties;if(n?.length){this.removeEmptyRowsMessages(e);const t=n.filter(t=>!e.getObject(t));if(t.length){const n=i.getResourceBundleFor("sap.fe.macros");const o=[];let s;for(const i of t){let t;const a=this.getTableDefinition().columns.find(t=>t.relativePath===i||t.propertyInfos&&t.propertyInfos.includes(i));if(!a){t=n.getText("M_TABLE_EMPTYROW_MANDATORY",[i])}else{s=this.getContent().getColumns().find(t=>t.getPropertyKey()===a.name);t=n.getText(s?"M_TABLE_EMPTYROW_MANDATORY":"M_TABLE_EMPTYROW_MANDATORY_HIDDEN",[s?.getHeader()||a.label])}o.push(new r({message:t,processor:this.getModel(),type:c.Error,technical:false,persistent:true,technicalDetails:{tableId:this.getContent().getId(),emptyRowMessage:true,missingColumn:s?undefined:i},target:`${e?.getPath()}/${i}`}))}a.addMessages(o);return false}}return true};o.removeEmptyRowsMessages=function t(e){a.removeMessages(a.getMessageModel().getData().filter(t=>{const n=t.getTechnicalDetails()||{};const o=Array.isArray(e)?e.some(e=>t.getTargets().some(t=>t.startsWith(e.getPath()))):!e||t.getTargets().some(t=>t.startsWith(e.getPath()));return o&&n.emptyRowMessage&&n.tableId===this.getContent().getId()}))};o.createEmptyRows=async function n(o,s){let i=arguments.length>2&&arguments[2]!==undefined?arguments[2]:false;let a=arguments.length>3?arguments[3]:undefined;let r=arguments.length>4&&arguments[4]!==undefined?arguments[4]:false;const c=a??(this.getTableDefinition().control?.inlineCreationRowCount||1);if(this.creatingEmptyRows||this.getInactiveContextNumber(o)>c){return}const g=Array.from({length:c},()=>({})),l=s.data("tableType")!=="ResponsiveTable",d=true,f=e.getTargetView(s),u=f.getController(),h=u.editFlow,p=e.getAppComponent(s);this.creatingEmptyRows=true;try{const t=i?[{}]:g;const e=await h.createMultipleDocuments(o,t,i||r?true:l,false,u.editFlow.onBeforeCreate,d);p.getSideEffectsService().requestSideEffectsForNavigationProperty(o.getPath(),f.getBindingContext());e?.forEach(async function(t){try{await t.created()}catch(t){if(!t.canceled){throw t}}});return e}catch(e){t.error(e)}finally{this.creatingEmptyRows=false}};return n}();g=u;return g},false);
//# sourceMappingURL=EmptyRowsHandler.js.map