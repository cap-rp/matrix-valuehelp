/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)
 *      (c) Copyright 2009-2025 SAP SE. All rights reserved
 */
sap.ui.define(["sap/base/Log","sap/base/util/deepClone","sap/fe/base/BindingToolkit","sap/fe/core/CommonUtils","sap/fe/core/controls/Any","sap/fe/core/converters/MetaModelConverter","sap/fe/core/converters/annotations/DataField","sap/fe/core/helpers/ModelHelper","sap/fe/core/helpers/TypeGuards","sap/fe/core/templating/DataModelPathHelper","sap/fe/core/templating/DisplayModeFormatter","sap/fe/core/templating/FieldControlHelper","sap/fe/core/templating/PropertyHelper","sap/fe/core/templating/UIFormatters","sap/fe/macros/field/FieldTemplating","sap/m/MessageBox","sap/ui/core/Component","sap/ui/core/Lib","sap/ui/mdc/enums/FieldEditMode","sap/ui/model/BindingMode","./MassEditDialog","./library"],function(e,t,n,i,s,o,a,r,l,d,c,g,p,u,f,h,y,m,x,E,T,C){"use strict";var M={};var b=C.SpecificSelectKeys;var P=f.setEditStyleProperties;var _=f.getTextBinding;var A=u.isVisible;var I=u.isMultiValueField;var D=u.getRequiredExpression;var F=u.getEditMode;var S=p.hasValueHelp;var v=p.getAssociatedUnitPropertyPath;var O=p.getAssociatedUnitProperty;var B=p.getAssociatedTextPropertyPath;var w=p.getAssociatedCurrencyPropertyPath;var R=g.isReadOnlyExpression;var L=c.getDisplayMode;var V=d.getRelativePaths;var N=d.getContextRelativeTargetObjectPath;var k=d.enhanceDataModelPath;var U=l.isProperty;var z=a.isDataFieldTypes;var j=o.getInvolvedDataModelObjects;var G=o.convertMetaModelContext;var H=n.pathInModel;var q=n.getExpressionFromAnnotation;var K=n.formatWithTypeInformation;var $=n.constant;var W=n.compileExpression;let X=function(){function n(e){this.maxAnalyzedRows=30;this.analyzedContexts=[];this.fieldProperties=[];const t=e.table.getParent().getTableDefinition().annotation.collection,n=e.table.getModel().getMetaModel();this.table=e.table;this.manifestSettings=this.table.getParent().getTableDefinition().control.massEdit;this.onContextMenu=e.onContextMenu;this.onDialogClose=e.onClose;this.view=i.getTargetView(this.table);this.contexts=this.fetchContextsForEdit();this.degradedMode=this.contexts.length>this.maxAnalyzedRows;this.analyzedContexts=this.degradedMode?this.contexts.slice(0,this.maxAnalyzedRows):this.contexts;this.isAdaptation=i.getAppComponent(this.table).isAdaptationMode();this.headerInfo=j(n.getContext(t)).targetEntityType.annotations.UI?.HeaderInfo}M=n;var o=n.prototype;o.open=async function t(){try{const t=y.getOwnerComponentFor(this.view);const n=this.table.getBindingContext("internal"),i=!this.onContextMenu?"numberOfSelectedContexts":"contextmenu/numberOfSelectedContexts",s=n.getProperty(i)||0;this.fieldProperties=await this.getFieldsPropertiesFromInfo(this.getFieldsInfo());if(!this.isAdaptation){if(!this.fieldProperties.some(e=>e.visible)){this.noFieldInformation();return}if(this.contexts.length!==s){this.contexts=await this.confirmSelection(this.contexts,s);if(!this.contexts.length){this.onDialogClose?.();return}}}await t.runAsOwner(async()=>{this.massEditDialog=new T({table:this.table,contexts:this.contexts,fieldProperties:this.fieldProperties});const t=await this.massEditDialog.create();t.attachBeforeClose(()=>{this.onDialogClose?.()});t.open();const n=this.massEditDialog.getRequiredDataPromise();try{await this.getDataAfterOpeningDialog(this.fieldProperties);n.resolve()}catch(t){e.error("Mass Edit: Something went wrong in mass edit dialog to get required data.",t);n.reject()}})}catch(t){e.error("Mass Edit: Something went wrong in mass edit dialog creation.",t)}};o.noFieldInformation=function e(){const t=this.table.getParent().getTableDefinition().control.massEdit.visibleFields;const n=m.getResourceBundleFor("sap.fe.macros");let i="",s;if(t.length>0){i=n.getText("C_MASS_EDIT_NO_EDITABLE_FIELDS_WITH_MANIFEST",[this.getResourceText(this.headerInfo?.TypeName)??n.getText("C_MASS_EDIT_DIALOG_DEFAULT_TYPENAME")]);s=`<ul>\n\t\t\t${this.fieldProperties.reduce((e,n)=>{if(t.includes(n.propertyInfo.relativePath)){e.push(`<li>${n.label}</li>`)}return e},[]).join("")} </ul>`}else{i=n.getText("C_MASS_EDIT_NO_EDITABLE_FIELDS_DEFAULT")}h.information(i,{details:s,onClose:()=>{this.onDialogClose?.()}})};o.confirmSelection=async function t(n,i){const s=m.getResourceBundleFor("sap.fe.macros");const o=m.getResourceBundleFor("sap.fe.core");const a=n.length;return new Promise(t=>{try{const e=this.table.getParent();const l=s.getText("C_MASS_EDIT_CONFIRM_BUTTON_TEXT"),d=o.getText("C_COMMON_OBJECT_PAGE_CANCEL"),c=this.table.getModel().getMetaModel(),g=this.getResourceText(this.headerInfo?.TypeName)??s.getText("C_MASS_EDIT_DIALOG_DEFAULT_TYPENAME"),p=this.getResourceText(this.headerInfo?.TypeNamePlural)??s.getText("C_MASS_EDIT_DIALOG_DEFAULT_TYPENAME_PLURAL"),u=r.isDraftSupported(c,this.table.data("targetCollectionPath"))&&e.readOnly?this.getMessageDetailForNonEditable(g,p):"";h.warning(s.getText("C_MASS_EDIT_CONFIRM_MESSAGE",[i-a,i,a,p]),{details:u,actions:[l,d],emphasizedAction:l,onClose:function(e){t(e===l?n:[])}})}catch(t){e.error(t)}})};o.getResourceText=function e(t){if(!t){return undefined}return i.getTranslatedTextFromExpBindingString(W(q(t)),this.view)?.toLocaleLowerCase()};o.getMessageDetailForNonEditable=function e(t,n){const i=m.getResourceBundleFor("sap.fe.macros");return`<p><strong>${i.getText("C_MASS_EDIT_CONFIRM_MESSAGE_DETAIL_HEADER")}</strong></p>\n\n\t\t\t<p>${i.getText("C_MASS_EDIT_CONFIRM_MESSAGE_DETAIL_REASON",[n])}</p>\n\n\t\t\t<ul>\n\t\t\t\t<li>${i.getText("C_MASS_EDIT_CONFIRM_MESSAGE_DETAIL_REASON_DRAFT",[t])}</li>\n\t\t\t\t<li>${i.getText("C_MASS_EDIT_CONFIRM_MESSAGE_DETAIL_REASON_NON_EDITABLE",[t])}</li>\n\t\t\t</ul>`};o.getEntityFieldsInfo=function e(){const t=this.table.getParent();const n=t.getTableDefinition().columns;const i=new Set(n.reduce((e,t)=>{if(t.type==="Annotation"){e.push(t.name)}return e},[]));return this.transformPathsToInfo(i)};o.getFieldsInfo=function e(){const t=this.manifestSettings.visibleFields.length>0?new Set(this.manifestSettings.visibleFields):new Set(this.table.getColumns().map(e=>e.getPropertyKey()));if(this.manifestSettings.ignoredFields.length>0){for(const e of this.manifestSettings.ignoredFields){t.delete(e)}}return this.transformPathsToInfo(t)};o.transformPathsToInfo=function e(t){return Array.from(t).reduce((e,t)=>{const n=this.getFieldInfo(t);if(n){e.push(n)}return e},[])};o.getFieldInfo=function e(t){const n=this.table.getParent().getTableDefinition().columns;const i=this.table.getModel().getMetaModel();const s=i.getMetaPath(this.table.data("metaPath"));const o=j(i.getContext(s));const a=n.find(e=>e.name===t&&e.type==="Annotation");if(a){const e=a.annotationPath;if(e&&t){const n=k(o,t);const s=G(i.getContext(e));const r=this.getCompliantProperty(n,s);if(r&&o.targetEntityType.entityProperties.includes(r))return{key:a.key,propertyDataModel:n,targetProperty:r,label:a.label??a.key,convertedAnnotation:s}}}return undefined};o.getCompliantProperty=function e(t,n){const i=t.targetObject;let s;if(U(i)){s=i;if(i.annotations.UI?.IsImageURL){return}}else if(z(n)&&!n.hasOwnProperty("Action")){s=n.Value.$target}else{return}const o=O(s);if(I(t)||S(s)&&s.annotations?.Common?.ValueListRelevantQualifiers||o&&S(o)&&o.annotations?.Common?.ValueListRelevantQualifiers){return}return s};o.isHiddenForContexts=function e(t){if(t==="true"){return false}else if(t==="false"){return true}const n=new s({anyBoolean:t});n.setModel(this.analyzedContexts[0].getModel());const i=!this.analyzedContexts.find(e=>{n.setBindingContext(e);return n.getBinding("anyBoolean").getExternalValue()});n.destroy();return i};o.fetchContextsForEdit=function e(){const t=this.table.getBindingContext("internal"),n=!this.onContextMenu?"updatableContexts":"contextmenu/updatableContexts";return t?.getProperty(n)??[]};o.getFieldProperties=function e(){return t(this.fieldProperties)};o.getFieldsPropertiesFromInfo=async function e(t){const n=[];for(const e of t){const{targetProperty:t,propertyDataModel:i,convertedAnnotation:s}=e;const o=N(i);if(o){const a=v(t)||w(t);const r=this.getInputType(s,i);if(r&&i.targetObject){const l=V(i);const d={visibilityBindings:{isVisible:W(A(s)),editMode:F(t,i,false,false,s,$(true))},visible:true,label:e.label||t.annotations.Common?.Label||o,isFieldRequired:D(t,s,true,false,{},i),descriptionPath:B(i.targetObject),textBinding:{expression:_(i,{displayMode:L(t,i)}),type:t.type==="Edm.DateTimeOffset"||t?.annotations?.Common?.IsTimezone?"anyText":"any"},readOnlyExpression:R(t,l),inputType:r,propertyInfo:{clearable:this.isPropertyClearable(t),emptyValue:this.getEmptyValueForProperty(t,o),key:e.key,relativePath:o,unitOrCurrencyPropertyPath:a},selectItems:[]};n.push(d)}}}await this.getDataForOpeningDialog(n);await Promise.all(n.map(async e=>{e.visible=this.manifestSettings.visibleFields.length===0?this.isFieldVisible(e):true;const t=!this.isAdaptation?await this.getRuntimeSelection(e):[];e.selectItems=[...this.getDefaultSelectOptions(e),...t]}));return n};o.generateFieldsProperties=async function e(){return this.getFieldsPropertiesFromInfo(this.getFieldsInfo())};o.generateEntityFieldsProperties=async function e(){return this.getFieldsPropertiesFromInfo(this.getEntityFieldsInfo())};o.getDataAfterOpeningDialog=async function e(t){if(this.degradedMode){const e=this.contexts.slice(this.maxAnalyzedRows,this.contexts.length);const n=[].concat(...t.map(t=>[{expression:W(t.readOnlyExpression),contexts:this.contexts},{expression:W(H(t.propertyInfo.relativePath)),contexts:e},{expression:W(H(t.propertyInfo.unitOrCurrencyPropertyPath)),contexts:e}]));await this.getMissingData(n)}};o.getDataForOpeningDialog=async function e(t){const n=[].concat(t.reduce((e,t)=>{e=e.concat([{expression:t.textBinding.expression},{expression:W(H(t.propertyInfo.relativePath)),type:t.textBinding.type},{expression:W(H(t.propertyInfo.unitOrCurrencyPropertyPath))}]);if(!this.manifestSettings.visibleFields.length){e=e.concat([{expression:t.visibilityBindings.isVisible},{expression:t.visibilityBindings.editMode}])}if(!this.degradedMode){e.push({expression:W(t.readOnlyExpression)})}return e},[]));await this.getMissingData(n)};o.getMissingData=async function e(t){if(this.isAdaptation){return}if(this.view.getViewData().converterType==="ObjectPage"){const e=this.table.getColumns().map(e=>e.getPropertyKey());if(this.manifestSettings.visibleFields.every(t=>e.includes(t))){return}}const n=[];const i=[];const o=this.contexts[0].getModel();for(const e of t.filter(e=>e.expression?.startsWith("{"))){const t={};const a=e.contexts??this.analyzedContexts;const r=e.type??"any";t[r]=e.expression;for(const e of a){const a=new s(t);a.setModel(o);a.setBindingContext(e);i.push(a);n.push(async()=>{const e=a.getBinding(r);if(e){e.setBindingMode(E.OneTime);if(e.isA("sap.ui.model.CompositeBinding")){await Promise.all(e.getBindings().map(e=>e.requestValue?.()))}else{await(e.requestValue?.())}}})}}await Promise.all(n.map(async e=>e()));for(const e of i){e.destroy()}};o.getEmptyValueForProperty=function e(t,n){if(t.nullable!==false){return null}else{const e=this.contexts[0];const i=new s({any:W(K(t,H(n)))});i.setModel(e.getModel());i.setBindingContext(e);const o=i.getBindingInfo("any").binding.getType().parseValue("","string");i.destroy();return o}};o.isPropertyClearable=function e(t){if(t.nullable!==false){return true}else{return!["Edm.DateTime","Edm.DateTimeOffset","Edm.TimeOfDay","Edm.Time","Edm.Date","Edm.DateTimeWithTimezone"].includes(t.type)}};o.getRuntimeSelection=async function e(t){const n=new Set;const i=[];if(t.inputType==="CheckBox"){return[]}const o=new s({anyText:t.textBinding.expression});o.setModel(this.contexts[0].getModel());for(const e of this.analyzedContexts){o.setBindingContext(e);const s=o.getBinding("anyText");if(s?.isA("sap.ui.model.CompositeBinding")){s.setBindingMode(E.OneTime);await Promise.all(s.getBindings().map(e=>e.requestValue?.()))}const a=o.getBinding("anyText")?.getExternalValue();if(a&&!n.has(a)){n.add(a);i.push({text:a,key:a,unitOrCurrencyValue:t.propertyInfo.unitOrCurrencyPropertyPath?e.getObject(t.propertyInfo.unitOrCurrencyPropertyPath):"",propertyValue:e.getObject(t.propertyInfo.relativePath)})}}o.destroy();return i};o.getDefaultSelectOptions=function e(t){const n=m.getResourceBundleFor("sap.fe.macros");const i={text:n.getText("C_MASS_EDIT_COMBOBOX_KEEP_VALUES"),key:b.KeepKey};const s=[];s.push(i);if(t.inputType==="CheckBox"){s.push({text:n.getText("yes"),key:"true"},{text:n.getText("no"),key:"false"})}else{s.push({text:n.getText("C_MASS_EDIT_COMBOBOX_REPLACE_VALUES"),key:b.ReplaceKey});if(t.isFieldRequired!=="true"&&t.propertyInfo.clearable){s.push({text:n.getText("C_MASS_EDIT_COMBOBOX_CLEAR_VALUES"),key:b.ClearFieldValueKey})}}return s};o.getFieldEditable=function e(t){if(t===x.Editable){return true}else if(Object.keys(x).includes(t)){return false}else if(t){const e=new s({any:t});const n=this.analyzedContexts[0].getModel();e.setModel(n);const i=this.analyzedContexts.some(t=>{e.setBindingContext(t);return e.getBinding("any").getExternalValue()===x.Editable});e.destroy();return i}else{return true}};o.getInputType=function e(t,n){const i={};P(i,t,n,true);return i?.editStyle};o.isFieldVisible=function e(t){if(this.isAdaptation||this.manifestSettings.visibleFields.length&&this.degradedMode){const e=Object.keys(x).includes(t.visibilityBindings.editMode);const n=!e||e&&t.visibilityBindings.editMode===x.Editable;return n&&t.visibilityBindings.isVisible!=="false"}return this.getFieldEditable(t.visibilityBindings.editMode)&&!this.isHiddenForContexts(t.visibilityBindings.isVisible)};return n}();M=X;return M},false);
//# sourceMappingURL=MassEditDialogHelper.js.map