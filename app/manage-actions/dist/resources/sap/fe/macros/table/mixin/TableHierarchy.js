/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)
 *      (c) Copyright 2009-2025 SAP SE. All rights reserved
 */
sap.ui.define(["sap/base/Log","sap/fe/core/CommonUtils","sap/fe/core/controllerextensions/BusyLocker","sap/fe/core/converters/MetaModelConverter","sap/fe/core/helpers/FPMHelper","sap/fe/core/helpers/ResourceModelHelper","sap/m/MessageToast","../TableRuntime"],function(e,t,n,o,r,i,s,a){"use strict";var l={};var c=function(e){e["On"]="On";e["Between"]="Between";e["OnOrBetween"]="OnOrBetween";return e}(c||{});let f=function(){function f(){}l=f;var u=f.prototype;u.setupMixin=function e(t){};u._onCopyCut=function t(n,o,r){let l;if(!o){l=n.getSource().getParent()}else{const e=n.getSource().getParent();l=e.getParent()?.getParent()}const c=l.getBindingContext("internal");const f=this.getSelectedContexts();if(f.length>1){e.error(`Multi ${r==="Cut"?"cutting":"copying"} is not supported`);return}c.setProperty("nodeUpdatesInfo/pastableContexts",f);c.setProperty("nodeUpdatesInfo/lastAction",r);s.show(i.getResourceModel(l).getText("M_CUTCOPY_READY"));if(!o||c.getProperty("numberOfSelectedContexts")>0){a.clearSelection(l);l.fireSelectionChange()}c.setProperty("nodeUpdatesInfo/cutEnablement",false);c.setProperty("contextmenu/nodeUpdatesInfo/cutEnablement",false);c.setProperty("nodeUpdatesInfo/copyEnablement",false);c.setProperty("contextmenu/nodeUpdatesInfo/copyEnablement",false)};u._onDragEnterDocument=function e(t){const n=t.getParameter("dragSource");if(this.getContent().getRowBinding()!==n.getBinding()){t.preventDefault();return}const o=t.getParameter("bindingContext");if(n.isAncestorOf(o)){t.preventDefault();return}let i=false;let s=false;const a=this.getTableDefinition();const l=a.control.isMoveToPositionAllowed;const f=l?r.getCustomFunction(l.moduleName,l.methodName,t.getSource().getParent()):undefined;if(o===this.getContent().getBindingContext()){s=!this.safeIsMoveAllowed(f,n,null);i=true}else{s=!this.safeIsMoveAllowed(f,n,o);i=a.annotation.allowDropBetweenNodes!==true;if(Math.abs(o.getIndex()-n.getIndex())===1&&!(o.getIndex()===0&&t.getParameter("dropPosition")==="Before")&&!(o.getIndex()===this.getContent().getRowBinding().getLength()-1&&t.getParameter("dropPosition")==="After")){i=true}if(!i&&!a.annotation.changeSiblingForRootsSupported&&o.getProperty("@$ui5.node.level")===1){i=true}if(f&&!i){i=!this.isDropBetweenAllowedForDrag(f,n,o)}}let u=c.OnOrBetween;if(i&&s){t.preventDefault();return}if(i){u=c.On}else if(s){u=c.Between}t.getSource().setDropPosition(u)};u._onDragStartDocument=function e(t){const n=t.getParameter("bindingContext");const o=this.getTableDefinition().annotation.updatablePropertyPath;let i=!!o&&!n.getProperty(o);if(!i&&!n.getBinding().isRelative()){i=n.getProperty("HasDraftEntity")===true}const s=this.getTableDefinition().control.isNodeMovable;try{if(s&&!i){i=r.getCustomFunction(s.moduleName,s.methodName,t.getSource())(n)===false}}catch(e){i=false}if(i){t.preventDefault()}};u._onDropDocument=async function e(t){n.lock(this.getContent());try{const e=t.getParameter("bindingContext");let n;if(e===this.getContent().getBindingContext()){n={position:c.On,parentContext:null}}else if(t.getParameter("dropPosition")===c.On){n={position:c.On,parentContext:e}}else{let o;let r;if(t.getParameter("dropPosition")==="After"){o=e;r=this.getContextAfter(e)}else{o=this.getContextBefore(e);r=e}n={position:c.Between,contextAfter:r,contextBefore:o}}const o=t.getParameter("dragSource");await Promise.all([this.dropContext(o,n),this.requestSideEffectsForChangeNextSiblingAction(o)])}catch(e){s.show(this.getTranslatedText("M_TABLEDROP_FAILED",[e.message??""]))}finally{n.unlock(this.getContent())}};u._onCollapseExpandNode=async function e(t,n){const o=this.getSelectedContexts();if(n){const e=o.map(async e=>{if(e.isExpanded()!==undefined){if(e.isExpanded()===true){await e.collapse()}return e.expand(Number.MAX_SAFE_INTEGER)}});await Promise.all(e)}else{await Promise.all(o.map(async e=>{if(e.isExpanded()===true){return e.collapse(true)}}))}};u._onMoveUpDown=async function e(t,n){let o=arguments.length>2&&arguments[2]!==undefined?arguments[2]:false;const r=this.getSelectedContexts();if(r.length!==1){return}const i=r[0];const s=await i.requestParent();let a=false;let l=null;if(n){const e=await i.requestSibling(-1);if(e){l=i.move({nextSibling:e,parent:s});a=true}}else{const e=await i.requestSibling(1);if(e){l=e.move({nextSibling:i,parent:s});a=true}}await Promise.all([l,this.requestSideEffectsForChangeNextSiblingAction(i)]);const c=i.getIndex();if(a&&c!==undefined&&c>=0){const e=this.getContent();if(!o){e.scrollToIndex(c)}else{e.focusRow(c)}}};u.requestSideEffectsForChangeNextSiblingAction=async function e(t){return this._requestSideEffectsForHierarchyActions(t,"ChangeNextSiblingAction")};u.requestSideEffectsForCopyAction=async function e(t){return this._requestSideEffectsForHierarchyActions(t,"CopyAction")};u._requestSideEffectsForHierarchyActions=async function e(n,r){const i=this.getContent().data("metaPath");const s=n.getModel().getMetaModel();const a=s.getContext(i);const l=o.convertMetaModelContext(a);const c=l.targetType??l.entityType;const f=c.annotations.Hierarchy?.[`RecursiveHierarchyActions#${this.getTableDefinition().control.hierarchyQualifier??""}`]?.[r];if(f){const e=t.getAppComponent(this.getContent());const o=e.getSideEffectsService();const r=o.getODataActionSideEffects(f,n);if(r){await o.requestSideEffectsForODataAction(r,n)}}};u.safeIsMoveAllowed=function t(n,o,r){if(!n){return true}let i=true;try{i=n(o,r)===true}catch(t){e.error("Cannot execute function related to isMoveToPositionAllowed",t);i=true}return i};u.isDropBetweenAllowedForDrag=function e(t,n,o){let r=true;const i=this.getContextBefore(o);const s=i===null?null:i.getParent();const a=this.getDropBetweenParameters(i,s,o,o.getParent());const l=this.getContextAfter(o);const c=l===null?null:l.getParent();const f=this.getDropBetweenParameters(o,o.getParent(),l,c);if(a!==undefined&&f!==undefined){if(a.parent===f.parent){r=this.safeIsMoveAllowed(t,n,a.parent)}else{r=this.safeIsMoveAllowed(t,n,a.parent)||this.safeIsMoveAllowed(t,n,f.parent)}}return r};u.getContextBefore=function e(t){const n=t.getIndex();if(n===undefined){throw new Error("Unexpected error")}const o=t.getBinding();return n===0?null:o.getAllCurrentContexts().find(e=>e.getIndex()===n-1)??null};u.getContextAfter=function e(t){const n=t.getIndex();if(n===undefined){throw new Error("Unexpected error")}const o=t.getBinding();return o.getAllCurrentContexts().find(e=>e.getIndex()===n+1)??null};u.getDropBetweenParameters=function e(t,n,o,r){if(t===null){return{parent:null,nextSibling:o}}else if(o===null){return n!==undefined?{parent:n,nextSibling:null}:undefined}else if(r===t){return{parent:t,nextSibling:o}}else if(n===undefined||r===undefined){return undefined}else if(n===r){return{parent:n,nextSibling:o}}else{return{parent:n,nextSibling:null}}};u.dropContext=async function e(t,n){const o=this.getTableDefinition().control.isMoveToPositionAllowed;const i=o?r.getCustomFunction(o.moduleName,o.methodName,this.getContent()):undefined;const a=this.getContent().getBindingContext("internal");const l=a.getProperty("isSorted")===true;const f=async(e,n)=>{if(this.safeIsMoveAllowed(i,t,e)){return t.move({parent:e,nextSibling:l?undefined:n})}else{s.show(this.getTranslatedText("M_TABLE_DROP_NOT_ALLOWED"))}};if(n.position===c.On){return f(n.parentContext)}else{const[e,t]=await Promise.all([n.contextBefore?.requestParent()??null,n.contextAfter?.requestParent()??null]);const o=this.getDropBetweenParameters(n.contextBefore,e,n.contextAfter,t);return f(o.parent,o.nextSibling)}};return f}();l=f;return l},false);
//# sourceMappingURL=TableHierarchy.js.map