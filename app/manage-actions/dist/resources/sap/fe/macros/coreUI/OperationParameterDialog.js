/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)
 *      (c) Copyright 2009-2025 SAP SE. All rights reserved
 */
sap.ui.define(["sap/base/Log","sap/fe/base/BindingToolkit","sap/fe/core/ActionRuntime","sap/fe/core/CommonUtils","sap/fe/core/controllerextensions/BusyLocker","sap/fe/core/controllerextensions/editFlow/editFlowConstants","sap/fe/core/controllerextensions/editFlow/operations/actionHelper","sap/fe/core/controllerextensions/editFlow/operations/facade","sap/fe/core/converters/MetaModelConverter","sap/fe/core/converters/annotations/DataField","sap/fe/core/helpers/FPMHelper","sap/fe/core/helpers/ResourceModelHelper","sap/fe/core/helpers/StableIdHelper","sap/fe/core/helpers/TypeGuards","sap/fe/core/library","sap/fe/core/templating/DataModelPathHelper","sap/fe/core/templating/FieldControlHelper","sap/fe/core/templating/PropertyHelper","sap/fe/macros/field/FieldHelper","sap/fe/macros/internal/valuehelp/ValueHelpTemplating","sap/m/Button","sap/m/Dialog","sap/m/Label","sap/m/MessageBox","sap/m/MessageStrip","sap/ui/core/Messaging","sap/ui/core/Title","sap/ui/core/message/MessageType","sap/ui/layout/form/SimpleForm","sap/ui/mdc/Field","sap/ui/mdc/MultiValueField","sap/ui/mdc/ValueHelp","sap/ui/mdc/enums/FieldEditMode","sap/ui/mdc/field/MultiValueFieldItem","sap/ui/mdc/valuehelp/Dialog","sap/ui/mdc/valuehelp/Popover","sap/ui/mdc/valuehelp/content/MTable","sap/ui/model/json/JSONModel","sap/ui/model/odata/v4/AnnotationHelper","sap/ui/unified/FileUploader","sap/ui/unified/FileUploaderHttpRequestMethod","../internal/helpers/Upload","sap/fe/base/jsx-runtime/jsx","sap/fe/base/jsx-runtime/Fragment","sap/fe/base/jsx-runtime/jsxs"],function(e,t,a,s,i,n,r,o,l,c,u,m,p,d,h,f,g,P,y,M,v,E,x,F,T,C,O,b,A,D,I,V,w,_,S,N,R,L,$,B,H,U,j,k,q){"use strict";var G={};var K=U.showTypeMismatchDialog;var z=U.showFileSizeExceedDialog;var W=U.displayMessageForFailedUpload;var X=M.useCaseSensitiveFilterRequests;var J=M.requiresValidation;var Q=P.isMultiLineText;var Y=P.hasValueHelp;var Z=g.isReadOnlyExpression;var ee=g.isDisabledExpression;var te=g.isActionParameterRequiredExpression;var ae=f.getTargetNavigationPath;var se=d.isPathAnnotationExpression;var ie=p.generate;var ne=m.getResourceModel;var re=c.hasFieldGroupTarget;var oe=l.getInvolvedDataModelObjects;var le=l.convertTypes;var ce=t.not;var ue=t.ifElse;var me=t.getExpressionFromAnnotation;var pe=t.equal;var de=t.constant;var he=t.compileExpression;let fe=function(){function t(e,t,a,s,i){this.isDialogOpen=false;this.buttonLock=false;this.actionParameterInfos=[];this.parameterModel=new L({$displayMode:{}});this.action=e;this.parameters=t;this.parameterValues=a;this.entitySetName=s;this.messageHandler=i;this.actionName=r.getActionName(this.action);this.metaModel=this.parameters.model.getMetaModel();this.resourceModel=this.parameters.view?ne(this.parameters.view):ne(this.parameters.appComponent);this.parametersValuesPromise=new Promise((e,t)=>{this.parametersValuesResolve=e;this.parametersValuesReject=t})}G=t;var l=t.prototype;l.getParameterEditMode=function e(t){const a=t.annotations,s=a.Common?.FieldControl,i=a.Core?.Immutable?.valueOf(),n=a.Core?.Computed?.valueOf();if(i||n){return de(w.ReadOnly)}else if(s){return ue(Z(t),w.ReadOnly,ue(ee(t),w.Disabled,w.Editable))}return de(w.Editable)};l.createFormElement=async function e(t){const a=this.action.isBound?`${this.metaModel.getMetaPath(this.parameters.contexts[0].getPath())}/${le(this.metaModel).namespace}.${this.action.name}`:`/${this.action.name}`;const s=this.metaModel.createBindingContext(`${a}/${t.name}`);let i;let n=t.annotations.Common?.Label?this.resourceModel.getText(t.annotations.Common.Label.toString()):t.name;let r;if(t.isCollection){i=await this.createMultiField(t,s)}else if(!t.type.startsWith("Edm.")&&this.getStreamProperty(t)){r=this.getStreamProperty(t);n=r?.annotations.Common?.Label?this.resourceModel.getText(r.annotations.Common.Label.toString()):r?.name;i=this.createFileUploader(t)}else{i=await this.createField(t,s)}return q(k,{children:[j(x,{id:ie(["APD_",t.name,r?.name,"Label"]),text:n}),i]})};l.createMultiField=async function t(a,s){let i="Value";try{i=await y.getAPDialogDisplayFormat(s.getObject(),{context:s})}catch(t){e.warning(`Parameter dialog multifield: display format couldn't be calculated for parameter '${a.name}': ${t}`)}return j(I,{id:ie(["APD_",a.name]),placeholder:a.annotations.UI?.Placeholder,items:{path:`mvfview>/${a.name}`},delegate:{name:"sap/fe/core/controls/MultiValueParameterDelegate"},display:i,editMode:this.getParameterEditMode(a),width:"100%",multipleLines:a.annotations.UI?.MultiLineText?.valueOf()===true,required:he(te(a,this.action,le(this.metaModel))),valueHelp:Y(a)?ie([this.actionName,a.name]):undefined,change:async e=>this.handleFieldChange(e,a),visible:he(ce(pe(me(a.annotations?.UI?.Hidden),true))),ariaLabelledBy:[ie(["APD_",a.name,"Label"])],dependents:this.createParameterDialogValueHelp(a,s),children:j(_,{description:"{mvfview>Desc}"},"{path: 'mvfview>Key', type:'sap.ui.model.type.String'}")})};l.createFileUploader=function e(t){let a;if(this.getStreamProperty(t)?.annotations.Core?.AcceptableMediaTypes){const e=Array.from(this.getStreamProperty(t)?.annotations.Core?.AcceptableMediaTypes).map(e=>`'${e}'`);a=`{=odata.collection([${e.join(",")}])}`}const s=function(e){const t=e.getSource();const a=e.getParameter("mimeType");const s=t.getMimeType();if(a){K(t,a,s)}};const i=y.calculateMBfromByte(this.getStreamProperty(t)?.maxLength);const n=function(e){const t=e?.getSource();z(t,t.getMaximumFileSize().toFixed(3))};const r=function(e){if(e.getParameter("status")===0||e.getParameter("status")>=400){W(e.getSource(),e.getParameter("responseRaw")||e.getParameter("response"))}};return j(B,{name:"FEV4FileUpload",buttonOnly:"false",iconOnly:"true",multiple:"false",tooltip:"{sap.fe.i18n>M_FIELD_FILEUPLOADER_UPLOAD_BUTTON_TOOLTIP}",icon:"sap-icon://upload",style:"Transparent",sendXHR:"true",useMultipart:"false",sameFilenameAllowed:"true",uploadOnChange:"false",mimeType:a,typeMissmatch:s,maximumFileSize:i,fileSizeExceed:n,httpRequestMethod:H.Put,uploadComplete:r,change:async e=>this.handleFileUploaderChange(e,t)})};l.createField=async function t(a,s){let i="Value";try{i=await y.getAPDialogDisplayFormat(s.getObject(),{context:s})}catch(t){e.warning(`Parameter dialog field: display format couldn't be calculated for parameter '${a.name}': ${t}`)}return j(D,{delegate:{name:"sap/fe/macros/field/FieldBaseDelegate",payload:{retrieveTextFromValueList:true}},id:ie(["APD_",a.name]),value:$.format(s.getObject(),{context:s}),placeholder:a.annotations.UI?.Placeholder,display:i,editMode:this.getParameterEditMode(a),width:"100%",multipleLines:Q(a),required:he(te(a,this.action,le(this.metaModel))),change:async e=>this.handleFieldChange(e,a),valueHelp:Y(a)?ie([this.actionName,a.name]):undefined,dependents:this.createParameterDialogValueHelp(a,s),visible:he(ue(a.name==="ResultIsActiveEntity",false,ce(pe(me(a.annotations?.UI?.Hidden),true)))),ariaLabelledBy:[ie(["APD_",a.name,"Label"])]})};l.createParameterDialogValueHelp=function e(t,a){if(!Y(t)){return undefined}return j(V,{id:ie([this.actionName,t.name]),delegate:{name:"sap/fe/macros/valuehelp/ValueHelpDelegate",payload:{propertyPath:this.action.isBound?`${ae(oe(a))}/${this.actionName}/${t.name}`:`/${this.action.name.substring(this.action.name.lastIndexOf(".")+1)}/${t.name}`,qualifiers:{},valueHelpQualifier:""}},validateInput:J(t),typeahead:j(N,{children:j(R,{id:ie([this.actionName,t.name,"Popover","qualifier"]),caseSensitive:this.action.isBound?X(oe(a),le(this.metaModel).entityContainer.annotations.Capabilities?.FilterFunctions??[]):false,useAsValueHelp:!!t.annotations.Common?.ValueListWithFixedValues})}),dialog:this.createFieldVHDialog(t)})};l.createFieldVHDialog=function e(t){if(t.annotations.Common?.ValueListWithFixedValues?.valueOf()!==true){return j(S,{})}else{return undefined}};l.handleFieldChange=async function e(t,s){const i=t.getParameter("promise");const n=t.getSource();const r=this.actionParameterInfos.find(e=>e.field===n);if(!r){return}r.validationPromise=i;this.removeMessagesForParameter(s);try{r.value=await i;this.parameters.parametersValues[r.parameter.name]=r.value;r.hasError=false}catch(e){delete r.value;r.hasError=true;a._addMessageForActionParameter([{actionParameterInfo:r,message:e.message}])}};l.handleFileUploaderChange=async function e(t,a){const s=t.getParameter("files");const i=t.getSource();const n=this.actionParameterInfos.find(e=>e.field===i);if(!n||!s){return}this.removeMessagesForParameter(a);n.value={};if(this.getStreamProperty(a)){n.value[this.getStreamProperty(a)?.name]=await this.getBase64File(s);n.value[this.getMimeTypePath(a).path]=s[0].type||"application/octet-stream";n.value[this.getFileNamePath(a)]=s[0].name;n.hasError=false;this.parameters.parametersValues[n.parameter.name]=n.value}};l.getFileNamePath=function e(t){return(this.getStreamProperty(t)?.annotations.Core?.ContentDisposition?.Filename).path};l.getMimeTypePath=function e(t){return me(this.getStreamProperty(t)?.annotations.Core?.MediaType)};l.getStreamProperty=function e(t){return t.typeReference.properties?.find(e=>e.type==="Edm.Stream")};l.getBase64File=async function e(t){return new Promise(e=>{const a=new FileReader;a.onload=()=>{if(!a.result){return}e(a.result.split(",")[1])};a.readAsDataURL(t.item(0))})};l.removeMessagesForParameter=function e(t){const a=C.getMessageModel().getData();const s=ie(["APD_",t.name]);const i=a.filter(e=>e.getControlIds().some(e=>s.split("-").includes(e)));C.removeMessages(i)};l.getFormElements=async function e(t){const a=await this.createFormElement(t);return{formElements:a,parameter:t}};l.getDialog=function e(){return this.dialog};l.createDialog=async function e(){let t=[];let a=[];const s=this.action.isBound?this.action.parameters.slice(1):this.action.parameters;if(this.action.annotations?.UI?.OperationParameterFacets){const e=[];this.action.annotations.UI?.OperationParameterFacets?.forEach(function(t){let a;if(t.$Type==="com.sap.vocabularies.UI.v1.ReferenceFacet"){a=t.Label}if(re(t)){const s=t?.Target?.$target;const i=[];s.Data.forEach(function(e){i.push(e.Value.$target)});e.push({facetTitle:a,data:i})}});const s=async e=>{const t=await Promise.all(e.data.map(this.getFormElements.bind(this)));return{facetTitle:e.facetTitle,data:t}};const i=e.map(async e=>s(e));const n=await Promise.all(i);n.forEach(e=>{t.push(j(O,{text:e.facetTitle}));return e.data.map(e=>t.push(e.formElements))});n.forEach(function(e){e.data.forEach(function(e){a.push(e)})})}else{a=await Promise.all(s.map(this.getFormElements.bind(this)));t=a.map(e=>e.formElements)}this.registerActionParameterInfo(a);const i=this.getCustomActionMessageStripText();const n=j(v,{id:ie(["fe","APD_",this.actionName,"Action","Cancel"]),text:this.resourceModel.getText("C_COMMON_ACTION_PARAMETER_DIALOG_CANCEL"),press:()=>{this.onCancel.bind(this)()}});const r=j(E,{title:this.getTitleText(this.parameters.label),id:ie(["fe","APD_",this.actionName]),escapeHandler:this.onCancel.bind(this),draggable:true,resizable:true,afterClose:this.afterClose.bind(this),beforeOpen:this.beforeOpen.bind(this),afterOpen:()=>{this.afterOpen()},initialFocus:n,children:{beginButton:j(v,{id:ie(["fe","APD_",this.actionName,"Action","Ok"]),text:this.parameters.isCreateAction===true?this.resourceModel.getText("C_TRANSACTION_HELPER_SAPFE_ACTION_CREATE_BUTTON_CONTINUE"):this.getBeginButtonLabel(this.parameters.label),press:()=>{this.onApply.bind(this)()},type:"Emphasized"}),endButton:n,content:q(k,{children:[i&&j(T,{showIcon:"true",text:i}),j(A,{columnsM:"2",editable:"true",labelSpanL:"12",labelSpanM:"12",binding:"$Parameter",children:{content:t}})]})}});this.dialog=r;return r};l.getBeginButtonLabel=function e(t){const a="ACTION_PARAMETER_DIALOG_ACTION_NAME";const s="C_COMMON_DIALOG_OK";return this.getOverriddenText(a,s,t)};l.getTitleText=function e(t){const a="ACTION_PARAMETER_DIALOG_ACTION_TITLE";const s="C_OPERATIONS_ACTION_PARAMETER_DIALOG_TITLE";return this.getOverriddenText(a,s,t)};l.getCustomActionMessageStripText=function e(){const t="ACTION_PARAMETER_DIALOG_MESSAGE_TEXT";let a=this.actionName;a=a.split(".").pop()??a;const s=a&&this.entitySetName?`${this.entitySetName}|${a}`:"";if(this.resourceModel.checkIfResourceKeyExists(`${t}|${s}`)){return this.resourceModel.getText(t,undefined,s)}else if(this.resourceModel.checkIfResourceKeyExists(`${t}|${this.entitySetName}`)){return this.resourceModel.getText(t,undefined,`${this.entitySetName}`)}else if(this.resourceModel.checkIfResourceKeyExists(`${t}`)){return this.resourceModel.getText(t)}return undefined};l.getOverriddenText=function e(t,a,s){let i=this.actionName;i=i.split(".").pop()??i;const n=i&&this.entitySetName?`${this.entitySetName}|${i}`:"";if(s){if(this.resourceModel.checkIfResourceKeyExists(`${t}|${n}`)){return this.resourceModel.getText(t,undefined,n)}else if(this.resourceModel.checkIfResourceKeyExists(`${t}|${this.entitySetName}`)){return this.resourceModel.getText(t,undefined,`${this.entitySetName}`)}else if(this.resourceModel.checkIfResourceKeyExists(`${t}`)){return this.resourceModel.getText(t)}else{return s}}else{return this.resourceModel.getText(a)}};l.onApply=async function e(){if(this.buttonLock||!this.dialog){return}const t=this.dialog;const s=t.getObjectBinding()?.getParameterContext();this.buttonLock=true;i.lock(t);if(!await a.validateProperties(this.actionParameterInfos,this.resourceModel)){i.unlock(t);this.buttonLock=false;return}const r=Object.assign({},...this.actionParameterInfos.map(e=>{const a=e.parameter;let i;if(a.isCollection){i=Object.values(t.getModel("mvfview").getProperty(`/${a.name}`)??{}).map(e=>e?.Key)}else if(!a.type.startsWith("Edm.")&&this.getStreamProperty(a)){i=e.value}else{i=s?.getProperty(a.name)}return{[a.name]:i}}));const o=Object.values(r).some(e=>!!e);this.parametersValuesResolve(r);this.parameters.appComponent.getModel("ui").setProperty(n.DocumentModified,o);this.messageHandler.removeTransitionMessages()};l.resetState=function e(){this.unlockDialog();this.buttonLock=false;this.updateDialogBindingContextForError();this.parametersValuesPromise=new Promise((e,t)=>{this.parametersValuesResolve=e;this.parametersValuesReject=t})};l.updateDialogBindingContextForError=function e(){if(this.parameters.contexts.length<2){return}let t,a;const s=this.parameters.contexts.find(e=>{const s=e.getMessages();return s.some(s=>{t=!t&&s.getType()===b.Warning?e:undefined;a=!a&&s.getType()===b.Information?e:undefined;return s.getType()===b.Error})});const i=s??t??a;if(i){this.dialog?.setBindingContext(i)}};l.unlockDialog=function e(){if(this.dialog&&i.isLocked(this.dialog)){i.unlock(this.dialog)}};l.onCancel=function e(){this.parametersValuesReject(h.Constants.CancelActionDialog);this.closeDialog()};l.closeDialog=function e(){if(this.dialog){this.parameters.events?.onParameterDialogClosed?.();this.dialog.close()}this.isDialogOpen=false};l.openDialog=async function e(){if(!this.dialog){throw new Error("Error on opening the dialog")}await s.setUserDefaults(this.parameters.appComponent,this.actionParameterInfos.map(e=>e.parameter),this.parameterModel,true);this.setModels(this.dialog);this.parameters.view?.addDependent(this.dialog);await this.setOperationDefaultValues(this.dialog);this.dialog.open();this.isDialogOpen=true};l.setModels=function e(t){t.setModel(this.parameterModel,"paramsModel");t.bindElement({path:"/",model:"paramsModel"});t.setModel(this.parameters.model);t.bindElement({path:`${this.parameters.contexts.length?"":"/"}${this.actionName}(...)`});if(this.parameters.contexts.length){t.setBindingContext(this.parameters.contexts[0])}t.setModel(new L({}),"mvfview")};l.beforeOpen=function e(t){this.messageHandler.removeTransitionMessages()};l.waitForParametersValues=async function e(){return this.parametersValuesPromise};l.isOpen=function e(){return this.isDialogOpen};l.getParameterDefaultValue=async function t(a,i,n){const r=n.getObjectBinding();const o=this.parameterModel.getData();const l=a.name;const c=a.annotations.UI?.ParameterDefaultValue;if(c){if(this.parameters.contexts.length>0&&se(c)){try{const e=i&&c.path.startsWith(`${i}/`)?c.path.replace(`${i}/`,""):c.path;let t=await s.requestSingletonProperty(c.path,r.getModel());if(t===null){t=await r.getParameterContext().requestProperty(c.path)}if(this.parameters.contexts.length>1){if(this.parameters.contexts.some(a=>a.getProperty(e)!==t)){return{paramName:l,value:undefined,noPossibleValue:true}}}return{paramName:l,value:t}}catch(t){e.error("Error while reading default action parameter",l,this.action.name);return{paramName:l,value:undefined,latePropertyError:true}}}else{return{paramName:l,value:c.valueOf()}}}return{paramName:l,value:o[l]}};l.getManifestFunctionValues=async function e(){const t=this.dialog?.getBindingContext();if(!this.parameters.view||!this.parameters.defaultValuesExtensionFunction||!t){return{}}return u.loadModuleAndCallMethod(this.parameters.defaultValuesExtensionFunction.substring(0,this.parameters.defaultValuesExtensionFunction.lastIndexOf(".")||-1).replace(/\./gi,"/"),this.parameters.defaultValuesExtensionFunction.substring(this.parameters.defaultValuesExtensionFunction.lastIndexOf(".")+1,this.parameters.defaultValuesExtensionFunction.length),this.parameters.view,t,this.parameters.contexts)};l.getPreDefinedValues=async function t(a,s){const i=this.action.annotations.Common?.DefaultValuesFunction?.valueOf();let n=Promise.resolve({});let r=[];if(this.action.isBound){if(typeof i==="string"){r=this.parameters.contexts.map(async e=>o.callBoundFunction(i,e,e.getModel()))}if(this.parameters.contexts.length>0){n=this.parameters.contexts[0].requestObject()}}try{const e=await n;const t=await Promise.all([Promise.all(this.actionParameterInfos.map(async e=>this.getParameterDefaultValue(e.parameter,a,s))),Promise.all(r),this.getManifestFunctionValues()]);return{contextValues:e,defaultValues:t[0],functionValues:t[1],manifestFunctionValues:t[2]}}catch(t){e.error("Error while retrieving the parameter",t);this.messageHandler.removeTransitionMessages();return{contextValues:{},defaultValues:[],functionValues:[],manifestFunctionValues:{}}}};l.afterOpen=function e(){const t=this.actionParameterInfos.find(e=>e.field.getVisible());if(t){const e=t?.field;const a=e?.getFocusInfo();a.targetInfo={silent:true};e?.focus(a)}this.parameters.events?.onParameterDialogOpened?.()};l.registerActionParameterInfo=function e(t){t.forEach(e=>{const t=e?.parameter;const a=e?.formElements?.[1];this.actionParameterInfos.push({parameter:t,field:a,isMultiValue:t.isCollection,hasError:false})})};l.setOperationDefaultValues=async function e(t){const a=this.action.isBound?this.action.parameters[0].name:"";const{contextValues:s,defaultValues:i,functionValues:n,manifestFunctionValues:r}=await this.getPreDefinedValues(a,t);const o=t.getObjectBinding();if(a){o.setParameter(a,s)}for(const e in this.actionParameterInfos){if(this.actionParameterInfos[e].parameter.name!=="ResultIsActiveEntity"){const t=this.actionParameterInfos[e].parameter.name;const a=this.parameterValues?.find(e=>e.name===t)?.value;if(a){o.setParameter(t,a)}else if(r.hasOwnProperty(t)){o.setParameter(t,r[t])}else if(i[e]&&i[e].value!==undefined){o.setParameter(t,i[e].value)}else if(this.action.annotations.Common?.DefaultValuesFunction&&!i[e].noPossibleValue){const e=new Set(this.parameters.contexts.map((e,a)=>n[a].getObject(t)));if(e.size===1&&e.values().next().value!==undefined){o.setParameter(t,Array.from(e)[0])}}}}if(i.some(e=>e.latePropertyError)){const e=this.resourceModel.getText("C_COMMON_SAPFE_REFRESH");F.warning(ne(this.parameters.appComponent).getText("C_APP_COMPONENT_SAPFE_ETAG_LATE_PROPERTY"),{actions:[e,F.Action.OK],emphasizedAction:e,onClose:t=>{if(t===e){const e=this.parameters.view?.getController().getExtensionAPI();e.refresh()}},contentWidth:"25em"})}};l.afterClose=function e(){for(const e in this.actionParameterInfos){this.removeMessagesForParameter(this.actionParameterInfos[e].parameter)}this.dialog?.destroy();this.buttonLock=false};return t}();G=fe;return G},false);
//# sourceMappingURL=OperationParameterDialog.js.map