/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)
 *      (c) Copyright 2009-2025 SAP SE. All rights reserved
 */
sap.ui.define(["sap/base/Log","sap/fe/base/ClassSupport","sap/fe/controls/easyFilter/EasyFilterBarContainer","sap/fe/core/buildingBlocks/BuildingBlock","sap/fe/core/controllerextensions/BusyLocker","sap/fe/core/helpers/ModelHelper","sap/fe/core/helpers/TypeGuards","sap/fe/core/templating/PropertyHelper","sap/fe/macros/ai/EasyFilterDataFetcher","sap/fe/macros/filter/FilterUtils","sap/fe/macros/filterBar/DraftEditState","sap/fe/macros/internal/valuehelp/ValueListHelper","sap/ui/core/Element","sap/ui/model/FilterOperator","sap/ui/model/json/JSONModel","sap/ui/model/odata/type/Date","sap/ui/model/odata/type/DateTimeOffset","sap/ui/model/odata/type/TimeOfDay","sap/fe/base/jsx-runtime/jsx"],function(e,t,a,r,i,n,o,s,l,c,u,p,d,f,h,m,y,g,b){"use strict";var w,F,v,V,P,C,B,S,E,T,_,k,M,L,O;var D={};var I=l.unresolvedResult;var x=l.resolveTokenValue;var A=l.mapValueListToCodeList;var z=l.generateSelectParameter;var Q=s.hasValueHelpWithFixedValues;var j=o.isPathAnnotationExpression;var H=t.property;var $=t.implementInterface;var q=t.defineUI5Class;var N=t.association;var W=t.aggregation;function K(e,t,a,r){a&&Object.defineProperty(e,t,{enumerable:a.enumerable,configurable:a.configurable,writable:a.writable,value:a.initializer?a.initializer.call(r):void 0})}function R(e,t){e.prototype=Object.create(t.prototype),e.prototype.constructor=e,U(e,t)}function U(e,t){return U=Object.setPrototypeOf?Object.setPrototypeOf.bind():function(e,t){return e.__proto__=t,e},U(e,t)}function G(e,t,a,r,i){var n={};return Object.keys(r).forEach(function(e){n[e]=r[e]}),n.enumerable=!!n.enumerable,n.configurable=!!n.configurable,("value"in n||n.initializer)&&(n.writable=!0),n=a.slice().reverse().reduce(function(a,r){return r(e,t,a)||a},n),i&&void 0!==n.initializer&&(n.value=n.initializer?n.initializer.call(i):void 0,n.initializer=void 0),void 0===n.initializer?(Object.defineProperty(e,t,n),null):n}function J(e,t){throw Error("Decorating class property failed. Please ensure that transform-class-properties is enabled and runs after the decorators transform.")}let X=(w=q("sap.fe.macros.EasyFilterBar"),F=$("sap.fe.core.controllerextensions.viewState.IViewStateContributor"),v=N({type:"sap.fe.macros.filterBar.FilterBarAPI"}),V=N({type:"sap.fe.macros.contentSwitcher.ContentSwitcher"}),P=H({type:"string"}),C=H({type:"string"}),B=W({type:"sap.fe.controls.easyFilter.EasyFilterBarContainer"}),w(S=(E=function(t){function r(a,r){var i;i=t.call(this,a,r)||this;K(i,"__implements__sap_fe_core_controllerextensions_viewState_IViewStateContributor",T,i);K(i,"filterBar",_,i);K(i,"contentSwitcher",k,i);K(i,"contentSwitcherKey",M,i);K(i,"contextPath",L,i);K(i,"content",O,i);i.getAppComponent()?.getEnvironmentCapabilities().prepareFeature("MagicFiltering").then(()=>{i.easyFilterPath="ux/eng/fioriai/reuse/easyfilter/EasyFilter";i.content?.setEasyFilterLib(i.easyFilterPath);return}).catch(t=>{e.debug("Error while loading EasyFilter",t);return undefined});return i}D=r;R(r,t);var o=r.prototype;o.applyLegacyState=async function e(t,a,r,i){if(a?.selectionVariant){const e=a.selectionVariant.getSelectOptionsPropertyNames();this.filterBarMetadata.forEach(t=>{if(e.includes(t.name)){t.defaultValue=a.selectionVariant.getSelectOption(t.name)?.map(e=>{if(e.Sign==="I"){if(e.Option==="BT"){return{operator:f.BT,selectedValues:[{value1:e.Low,value2:e.High}]}}else{return{operator:e.Option,selectedValues:[e.Low]}}}else{return{operator:f.NE,selectedValues:[e.Low]}}})}});this.content?.resetState(false)}return Promise.resolve(undefined)};o.applyState=function e(t,a){return undefined};o.retrieveState=function e(){return{}};o.getApplicationId=function e(){return this.getAppComponent()?.getManifestEntry("sap.app").id??"<unknownID>"};o.onMetadataAvailable=function e(){this._fetchedCodeList??={};this.filterBarMetadata=this.prepareFilterBarMetadata();this.recommendedQueries=this.getAppComponent()?.getManifestEntry("sap.fe")?.macros?.easyFilter?.recommendedQueries??[];this.content=this.createContent();this.content.filterBarMetadata=this.filterBarMetadata};o.prepareFilterBarMetadata=function e(){const t=this._getOwner();const a=t.preprocessorContext?.getDefinitionForPage();let r;if(a){r=a.getFilterBarDefinition({});const e=t.preprocessorContext?.models.metaModel;const i=(e,t)=>{if(t){return"MenuWithCheckBox"}switch(e){case"Edm.Date":return"Calendar";case"Edm.TimeOfDay":return"Time";default:return"ValueHelp"}};const o=t.getAppComponent().getComponentData()?.startupParameters??{};const s=r.getFilterFields();const l=s.map(e=>{const t=e.getTarget();let a;const r=Q(t);if(r){a=this._fetchedCodeList[e.name];if(!a){a=async()=>this.getCodeListForProperty(e.name,e.annotationPath)}}const n=t.annotations.Measures?.ISOCurrency??t.annotations.Measures?.Unit;const l=j(n)?n.$target:undefined;const c=l?s.find(e=>e.getTarget()===l)?.name:undefined;let u;if(o.hasOwnProperty(e.name)){u=[{operator:f.EQ,selectedValues:o[e.name]}]}else if(e.isParameter&&o.hasOwnProperty(e.name.substring(2))){u=[{operator:f.EQ,selectedValues:o[e.name.substring(2)]}]}return{name:e.name,path:e.annotationPath,label:e.label,dataType:t.type,required:e.required??false,defaultValue:u,filterable:true,sortable:!e.isParameter,codeList:a,type:i(t.type,a),unit:c}});if(n.isMetaPathDraftSupported(a.getMetaPath())){const t=new h({isDraftCollaborative:n.isCollaborationDraftSupported(e)}).createBindingContext("/");const a=u.getEditStatesContext(t).getObject("/").map(e=>({value:e.id,description:e.display}));l.push({name:"$editState",label:this.getTranslatedText("FILTERBAR_EDITING_STATUS"),dataType:"Edm.String",required:false,filterable:true,sortable:false,codeList:a,type:"MenuWithCheckBox"})}return l}return[]};o.getCodeListForProperty=async function e(t,a){const r=await this.getValueList(a);if(!r){return[]}const i=r.valueListInfo;const n=i.$model.bindList(`/${i.CollectionPath}`,undefined,undefined,undefined,{$select:z(r)});const o=await n.requestContexts();const s=o.map(A(r));this._fetchedCodeList[t]=s;const l=this.filterBarMetadata.find(e=>e.name===t);if(l){l.codeList=s}return s};o.resolveTokenValuesForField=async function e(t,a){const r=this.filterBarMetadata.find(e=>{let{name:a}=e;return a===t});if(r?.path){const e=await this.getValueList(r.path);if(e&&p.isValueListSearchable(r.path,e)){const t=await Promise.all(a.map(async t=>x(e,t)));return t.flat()}}return I(a)};o.getValueList=async function e(t){const a=this.getMetaModel();const r=await p.getValueListInfo(undefined,t,undefined,a);return r[0]};o.onTokensChanged=async function e(t){const a=d.getElementById(this.filterBar);const r=a.getParent();const i=t.getParameter("tokens");const n=i.some(e=>e.key==="$editState");await r._clearFilterValuesWithOptions(a,{clearEditFilter:n});this.formateDataTypes(i);for(const e of i){if(e.key==="$editState"){for(const t of e.keySpecificSelectedValues){await c.addFilterValues(r.content,e.key,"DRAFT_EDIT_STATE",t.selectedValues)}}else{for(const t of e.keySpecificSelectedValues){const{operator:a,selectedValues:i}=t;await c.addFilterValues(r.content,e.key,a,i)}}}await r.triggerSearch()};o.formateDataTypes=function e(t){const a=new m,r=new y(undefined,{V4:true}),i=new g;t.forEach(e=>{const t=this.filterBarMetadata.find(t=>t.name===e.key)?.dataType;e.keySpecificSelectedValues.forEach(e=>{let n;switch(t){case"Edm.Date":n=a;break;case"Edm.TimeOfDay":n=i;break;case"Edm.DateTimeOffset":n=r;break;default:return}e.selectedValues.forEach((t,a)=>{e.selectedValues[a]=n.parseValue(t,"object")})})})};o.showValueHelpForKey=async function e(t,a,r){const i=d.getElementById(this.filterBar);const n=i.getParent();await n.showFilterField(t);n.openValueHelpForFilterField(t,undefined,r)};o.onBeforeQueryProcessing=function e(){const t=this.getModel("ui");i.lock(t)};o.onAfterQueryProcessing=function e(){const t=this.getModel("ui");i.unlock(t)};o.onClearFilters=async function e(){const t=d.getElementById(this.filterBar);const a=t.getParent();await a._clearFilterValuesWithOptions(t);await a.triggerSearch()};o.onQueryChanged=function e(){const t=d.getElementById(this.filterBar);t.fireFiltersChanged({conditionsBased:true})};o.createContent=function e(){return b(a,{contextPath:this.getOwnerContextPath(),appId:this.getApplicationId(),filterBarMetadata:this.filterBarMetadata,easyFilterLib:this.easyFilterPath,showValueHelp:e=>{this.showValueHelpForKey(e.getParameter("key"),e.getParameter("values"),t=>{const a=t.map(e=>{if(e.operator===f.BT||e.operator===f.NB){return{operator:e.operator,selectedValues:e.values}}else{return{operator:e.operator,selectedValues:e.values}}});e.getParameter("resolve")(a)})},dataFetcher:this.resolveTokenValuesForField.bind(this),recommendedValues:this.recommendedQueries,queryChanged:this.onQueryChanged.bind(this),tokensChanged:this.onTokensChanged.bind(this),beforeQueryProcessing:this.onBeforeQueryProcessing.bind(this),afterQueryProcessing:this.onAfterQueryProcessing.bind(this),clearFilters:this.onClearFilters.bind(this)})};return r}(r),T=G(E.prototype,"__implements__sap_fe_core_controllerextensions_viewState_IViewStateContributor",[F],{configurable:true,enumerable:true,writable:true,initializer:null}),_=G(E.prototype,"filterBar",[v],{configurable:true,enumerable:true,writable:true,initializer:null}),k=G(E.prototype,"contentSwitcher",[V],{configurable:true,enumerable:true,writable:true,initializer:null}),M=G(E.prototype,"contentSwitcherKey",[P],{configurable:true,enumerable:true,writable:true,initializer:null}),L=G(E.prototype,"contextPath",[C],{configurable:true,enumerable:true,writable:true,initializer:null}),O=G(E.prototype,"content",[B],{configurable:true,enumerable:true,writable:true,initializer:null}),E))||S);D=X;return D},false);
//# sourceMappingURL=EasyFilterBar.js.map