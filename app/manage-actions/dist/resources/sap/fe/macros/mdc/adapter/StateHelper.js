/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)
 *      (c) Copyright 2009-2025 SAP SE. All rights reserved
 */
sap.ui.define(["sap/base/Log","sap/base/util/deepClone","sap/fe/core/templating/PropertyHelper","sap/fe/macros/filterBar/DraftEditState","sap/fe/macros/mdc/adapter/SelectionVariantToStateFilters","sap/fe/macros/mdc/adapter/StateFilterToSelectionVariant","sap/fe/navigation/SelectionVariant","sap/ui/mdc/p13n/StateUtil"],function(e,t,a,r,i,n,o,s){"use strict";const l={async getSelectionVariant(t){try{const e=await s.retrieveExternalState(t);const a=e.filter;let r=[];if(t?.getParent()?.isA("sap.fe.macros.filterBar.FilterBarAPI")&&t.getParent().getParameters!==undefined){r=t.getParent().getParameters()}const i=n.getSelectionVariantFromConditions(a,t.getPropertyHelper(),r);if(t?.isA("sap.ui.mdc.Chart")){const e=new o;const t=i._getSelectOptions();for(const a in t){e.massAddSelectOption(a.split("_fe_groupable_")[1],t[a])}return e}else{return i}}catch(a){const r=t?.getId();const i=a instanceof Error?a.message:String(a);e.error(`Building Block (${r}) - get selection variant failed : ${i}`);throw Error(i)}},async convertSelectionVariantToStateFilters(e,t,a,r){const n=await this._getSupportedFilterFields(e);if(!n.length){throw new Error("No valid metadata properties present for filter bar")}const o=this._getControlInfoForConversion(e);const s=r?.getMetaModel();const l=JSON.parse(JSON.stringify(n));const c=this._updatePropertyInfoToSupportSV(e,l);const p=i.getStateFiltersFromSV(t,o,c??l,a,s);return p},_getControlInfoForConversion(e){const t=e.getModel()?.getMetaModel(),a=e.data("entityType");if(e.isA("sap.fe.macros.controls.FilterBar")){const r=e.data("useSemanticDateRange")==="true"||e.data("useSemanticDateRange")===true,i=e.getModel("viewData"),n=i.getData(),o=n?.controlConfiguration,s=o?.["@com.sap.vocabularies.UI.v1.SelectionFields"],l=s?.filterFields;return{metaModel:t,contextPath:a,useSemanticDateRange:r,filterFieldsConfig:l,selectionFieldsConfigs:s}}else{return{metaModel:t,contextPath:a}}},async _getSupportedFilterFields(e){if(e.isA("sap.ui.mdc.Filterbar")){await e.waitForInitialization();return e.getControlDelegate().fetchFilterProperties(e)}else if(e.isA("sap.fe.macros.controls.FilterBar")){return e.getControlDelegate().fetchFilterProperties(e)}else{await e.awaitControlDelegate()}return e.getControlDelegate().fetchProperties(e)},async clearFilterValues(e){await this._clearFilterValuesWithOptions(e.content);e.fireEvent("afterClear")},async _clearFilterValuesWithOptions(e,a){if(!e){return}const i=await s.retrieveExternalState(e);let n="",o,l,c,p;if(e.isA("sap.ui.mdc.FilterBar")){n="$editState";l=r.ALL.id;o=t(i.filter[n]?.[0]);c=o?.values[0]===l;p=a&&Object.keys(a).length>0&&a.clearEditFilter}for(const e of Object.keys(i.filter)){if(!p&&e===n&&c){continue}for(const t of i.filter[e]){t.filtered=false}}await s.applyExternalState(e,{filter:i.filter});if(e.isA("sap.ui.mdc.FilterBar")){if(!p&&o&&!c){o.values=[l];await s.applyExternalState(e,{filter:{[n]:[o]}})}e.cleanUpAllFilterFieldsInErrorState()}},_updatePropertyInfoToSupportSV(e,t){if(e.isA("sap.ui.mdc.FilterBar")){return t}t.forEach(t=>{if(e.isA("sap.ui.mdc.Table")){t["conditionPath"]=t.name;t["annotationPath"]=t.metadataPath?t.metadataPath:"";t["hasValueHelp"]=a.hasValueHelp(e.getPropertyHelper().getProperty(t.name));t["dataType"]=t?.typeConfig?.className}else if(e.isA("sap.ui.mdc.Chart")){if(t.path){t["name"]=t.path;t["conditionPath"]=t.path;const r=e.getParent()?.getPropertyDataModel(t.path)?.targetObject;t["hasValueHelp"]=r?a.hasValueHelp(r):false;t["dataType"]=t?.typeConfig?.className||t.dataType}}});return t},async setSelectionVariantToMdcControl(t,a){let r=arguments.length>2&&arguments[2]!==undefined?arguments[2]:false;try{const n=await s.retrieveExternalState(t);if(!n.filter){e.error(`FE : setSelectionVariant API cannot be applied on : ${t?.getId()}`);return}const o=await this.convertSelectionVariantToStateFilters(t,a,r,t?.getModel());await this.clearFilterValues(t?.getParent());const l=await this._getSupportedFilterFields(t);const c=i.getStateToApply(l,o);if(t?.isA("sap.ui.mdc.Chart")){this.convertConditionsForChart(c)}return await s.applyExternalState(t,c)}catch(a){const r=t?.getId();const i=a instanceof Error?a.message:String(a);e.error(`FE : BuildingBlock (${r}) - set selection variant failed  : ${i}`);throw Error(i)}},convertConditionsForChart(e){for(const t in e.filter){delete Object.assign(e.filter,{["_fe_groupable_"+t]:e.filter[t]})[t]}e.items.forEach(e=>{e.name="_fe_groupable_"+e.name})}};return l},false);
//# sourceMappingURL=StateHelper.js.map