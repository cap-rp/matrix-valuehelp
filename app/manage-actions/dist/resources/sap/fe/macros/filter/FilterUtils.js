/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)
 *      (c) Copyright 2009-2025 SAP SE. All rights reserved
 */
sap.ui.define(["sap/base/Log","sap/base/util/merge","sap/fe/core/CommonUtils","sap/fe/core/converters/ConverterContext","sap/fe/core/converters/ManifestWrapper","sap/fe/core/converters/MetaModelConverter","sap/fe/core/converters/controls/ListReport/FilterBar","sap/fe/core/helpers/MetaModelFunction","sap/fe/core/helpers/ModelHelper","sap/fe/core/templating/DisplayModeFormatter","sap/fe/macros/CommonHelper","sap/fe/macros/DelegateUtil","sap/fe/macros/filterBar/SemanticDateOperators","sap/ui/core/Element","sap/ui/mdc/condition/Condition","sap/ui/mdc/condition/ConditionConverter","sap/ui/mdc/enums/ConditionValidated","sap/ui/mdc/odata/v4/TypeMap","sap/ui/mdc/p13n/StateUtil","sap/ui/mdc/util/FilterUtil","sap/ui/model/Filter","sap/ui/model/FilterOperator","sap/ui/model/odata/v4/ODataUtils","../filterBar/DraftEditState"],function(e,t,n,i,r,a,o,s,l,c,f,d,u,p,g,y,h,m,F,C,P,S,b,v){"use strict";var T=c.ODATA_TYPE_MAPPING;var I=s.getAllCustomAggregates;var E=function(e){e["hiddenFilter"]="hiddenFilter";e["required"]="required";e["path"]="path";e["tooltip"]="tooltip";e["visible"]="visible";e["maxConditions"]="maxConditions";e["formatOptions"]="formatOptions";e["constraints"]="constraints";e["group"]="group";e["groupLabel"]="groupLabel";e["caseSensitive"]="caseSensitive";return e}(E||{});const M={getFilter:function(e){const t=M.getFilterInfo(e).filters;return t?.length?new P(t,false):undefined},getFilterField:function(e,t,n){return o.getFilterField(e,t,n)},buildProperyInfo:function(e,t){let n;const i={};const r=t.getConverterContextFor(e.annotationPath);const a=r.getDataModelObjectPath().targetObject;const s=o.fetchTypeConfig(a);n=o.fetchPropertyInfo(t,e,s);i[e.key]=s;n=o.assignDataTypeToPropertyInfo(n,t,[],i);return n},createConverterContext:function(e,o,s,l){const c=d.getCustomData(e,"entityType"),f=o||c;const u=e.isA?n.getTargetView(e):null;const p=s||e.getModel().getMetaModel();const g=l||u&&n.getAppComponent(u);const y=a.getInvolvedDataModelObjects(p.createBindingContext(f));let h;if(e.isA&&!e.isA("sap.ui.mdc.valuehelp.FilterBar")){h=u&&u.getViewData()||{}}return i.createConverterContextForMacro(y.startingEntitySet.name,p,g?.getDiagnostics(),t,y.contextLocation,new r(h??{}))},getConvertedFilterFields:function(e,t,n,i,r,a,o){const s=this._getFilterMetaModel(e,i);const l=d.getCustomData(e,"entityType");const c=d.getCustomData(e,"annotationPath"),f=t||l;const u=this._getFieldsForTable(e,t);const p=this.createConverterContext(e,t,i,r);return this._getSelectionFields(e,t,l,f,u,s,p,n,a,o,c)},getBindingPathForParameters:function(e,n,i,r){const a=[];i=M.setTypeConfigToProperties(i);for(const o of r){if(n[o]&&n[o].length>0){const r=t({},n[o][0]);const s=C.getPropertyByKey(i,o);const l=s.typeConfig||m.getTypeConfig(s.dataType,s.formatOptions,s.constraints);const c=y.toType(r,l,e.getTypeMap());const f=T[l.className];a.push(`${o}=${encodeURIComponent(b.formatLiteral(c.values[0],f))}`)}}const o=e.data("entityType");const s=o.substring(0,o.length-1);const l=s.slice(0,s.lastIndexOf("/"));const c=s.substring(s.lastIndexOf("/")+1);return`${l}(${a.toString()})/${c}`},getEditStateIsHideDraft:function(e){let t=false;if(e&&e.$editState){const n=e.$editState.find(function(e){return e.operator==="DRAFT_EDIT_STATE"});if(n&&(n.values.includes("ALL_HIDING_DRAFTS")||n.values.includes("SAVED_ONLY"))){t=true}}return t},getFilterInfo:function(e,t,n){let i=t&&t.ignoredProperties||[];const r=t&&t.targetControl,a=r?r.data("entityType"):undefined;const o={};let s=e,l,c=[],f,d=t&&t.propertiesMetadata;if(typeof e==="string"){s=p.getElementById(e)}if(s){l=this._getSearchField(s,i);const e=this._getFilterConditions(t,n,s);let r;if(s.isA("sap.ui.mdc.FilterBar")){r=this.getFilterPropertyInfo(s)}else{r=s.getPropertyInfoSet?s.getPropertyInfoSet():null}r=this._getFilterPropertiesMetadata(r,s);if(t&&t.targetControl&&t.targetControl.isA("sap.ui.mdc.Chart")){Object.keys(e).forEach(function(t){if(t==="$editState"){delete e["$editState"]}})}let u=s.data("parameters")||[];u=typeof u==="string"?JSON.parse(u):u;if(u&&u.length>0){f=M.getBindingPathForParameters(s,e,r,u);if(Object.keys(e).length){Object.keys(e).forEach(t=>{u.forEach(n=>{if(t===n){const i=e[t][0].values;o[n]=i[0]}})})}}if(e){if(a&&s.data("entityType")&&s.data("entityType")!==a){const e=s.getModel().getMetaModel();const t=s.getControlDelegate?.().fetchPropertiesForEntity(a,e,s);d=t;const n=this._getIgnoredProperties(r,t);if(n.length>0){i=i.concat(n)}}else if(!d&&r){d=r}c=this.getEditStateAndFilter({oIFilter:s,mConditions:e,aPropertiesMetadata:d,aIgnoreProperties:i,aParameters:u})}}return{parameters:o,filters:c,search:l||undefined,bindingPath:f}},getEditStateAndFilter:function(e){let{oIFilter:t,mConditions:n,aPropertiesMetadata:i,aIgnoreProperties:r,aParameters:a}=e;const o=C.getFilterInfo(t,n,M.setTypeConfigToProperties(i),r.concat(a)).filters;const s=t?.getCurrentState?.();const l=s?.items?.some(e=>e?.key==="$editState");const c=Array.isArray(i)&&i?.some(e=>e?.key==="$editState");let f;if(!r.includes("$editState")&&l===true&&c){if(n.hasOwnProperty("$editState")){const e=n["$editState"];f=v.getFilterForEditState(e?.[0]?.values?.[0])}else{f=v.getFilterForEditState("")}}let d=o?[o]:[];if(f){const e=this.hasEditStateFilterRecursively(d);if(e){d=this.exchangeEditStateFilterRecursively(f,d)}else{d.push(f)}}return d},hasEditStateFilterRecursively:function(e){return e.some(e=>{if(e.getPath()==="$editState"){return true}else if(e.getFilters()!==undefined){return this.hasEditStateFilterRecursively(e.getFilters())}else{return false}})},exchangeEditStateFilterRecursively:function(e,t){return t.map(t=>{if(t.getPath()==="$editState"){return e}else if(t.getFilters()!==undefined){t=new P({filters:this.exchangeEditStateFilterRecursively(e,t.getFilters()),and:t.isAnd()});return t}return t})},setTypeConfigToProperties:function(e){if(e&&e.length){e.forEach(function(e){if(e.typeConfig&&e.typeConfig.typeInstance&&e.typeConfig.typeInstance.getConstraints instanceof Function){return}if(e.path==="$editState"){e.typeConfig=m.getTypeConfig("sap.ui.model.odata.type.String",{},{})}else if(e.path==="$search"){e.typeConfig=m.getTypeConfig("sap.ui.model.odata.type.String",{},{})}else if(e.dataType||e.typeConfig&&e.typeConfig.className){e.typeConfig=m.getTypeConfig(e.dataType||e.typeConfig?.className,e.formatOptions,e.constraints)}})}return e},getNotApplicableFilters:function(e,t){const n=t.data("entityType"),i=e.data("entityType"),r=e.getModel().getMetaModel(),a=r.getObject(i),o=[],s=e.getConditions(),l=n===i,c=t.isA("sap.ui.mdc.Chart"),u=!c&&t.getParent().getTableDefinition().enableAnalytics,p=!c&&t.getParent().getTableDefinition().control.type==="TreeTable",g=c?f.parseCustomData(d.getCustomData(t,"applySupported")).enableSearch:!(u||p)||t.getParent().getTableDefinition().enableBasicSearch;if(s&&(!l||u||c||p)){const i=l?[]:e.getControlDelegate().fetchPropertiesForEntity(n,r,e),f=i.reduce(function(e,t){e[t.name]=t;return e},{}),d={};const g=t.getModel().getMetaModel().getObject(t.data("targetCollectionPath")+"/");if(t.isA("sap.ui.mdc.Chart")){const e=t.getModel().getMetaModel().getObject(`${t.data("targetCollectionPath")}@`),n=I(e);Object.keys(n).forEach(function(e){if(!d[e]){const t=n[e];d[e]=t}})}for(const e in s){const t=s[e];let n=true;if(g[e]&&a[e]){n=g[e]["$Type"]===a[e]["$Type"]}if(Array.isArray(t)&&t.length>0&&((!f[e]||f[e].isCustomFilter&&f[e].annotationPath==undefined||f[e]&&!n)&&(!l||e==="$editState"&&(c||p||u))||d[e])){o.push(e.replace(/[+|*]/g,""))}}}if(!g&&e.getSearch()){o.push("$search")}return o},async _getValueListInfo(e,t){const n=e.getModel()?.getMetaModel();if(!n){return undefined}const i=e.data("entityType")??"";const r=await n.requestValueListInfo(i+t,true).catch(()=>null);return r?.[""]},getFilterPropertyInfo(e){let t=e.data("feFilterInfo");if(typeof t==="string"){t=JSON.parse(t)}return t||[]},_getConditionValidated:async function(t,n,i){if(!t){return h.NotValidated}try{const e=t.Parameters.filter(e=>["com.sap.vocabularies.Common.v1.ValueListParameterInOut".valueOf(),"com.sap.vocabularies.Common.v1.ValueListParameterOut".valueOf()].includes(e.$Type)).filter(e=>e.LocalDataProperty?.$PropertyPath===n).map(e=>e.ValueListProperty);const r=e[0]??n;const a=new P({path:r,operator:S.EQ,value1:i});const o=t.$model.bindList(`/${t.CollectionPath}`,undefined,undefined,a,{$select:r});const s=(await o.requestContexts()).length>0;if(s){return h.Validated}else{return h.NotValidated}}catch(t){e.error("FilterUtils: Error while retrieving ConditionValidated",t);return h.NotValidated}},async _clearFilterValue(e,t){const n=await F.retrieveExternalState(e);if(n.filter[t]){n.filter[t].forEach(e=>{e.filtered=false});await F.applyExternalState(e,{filter:{[t]:n.filter[t]}})}},setFilterValues:async function(e,t){for(var n=arguments.length,i=new Array(n>2?n-2:0),r=2;r<n;r++){i[r-2]=arguments[r]}await this._setFilterValues(e,false,t,...i)},addFilterValues:async function(e,t){for(var n=arguments.length,i=new Array(n>2?n-2:0),r=2;r<n;r++){i[r-2]=arguments[r]}await this._setFilterValues(e,true,t,...i)},_setFilterValues:async function(t,n,i){for(var r=arguments.length,a=new Array(r>3?r-3:0),o=3;o<r;o++){a[o-3]=arguments[o]}let s=a?.[0];let l=a?.[1];if(!t){return}if(a.length===2&&(l===undefined||l===null||l==="")&&s&&Object.keys(S).includes(s)){e.warning(`An empty filter value cannot be applied with the ${s} operator`);return}if(l===undefined&&!u.getSemanticDateOperations().includes(s||"")){l=s??[];s=undefined}if(!s){s=S.EQ}const c=["string","number","boolean"];if(l!==undefined&&(!Array.isArray(l)&&!c.includes(typeof l)||Array.isArray(l)&&l.length>0&&!c.includes(typeof l[0]))){throw new Error("FilterUtils.js#_setFilterValues: Filter value not supported; only primitive values or an array thereof can be used.")}let f;if(l!==undefined){f=Array.isArray(l)?l:[l]}const d=await this._getValueListInfo(t,i);const p={};if(i){if(f&&f.length){if(s===S.BT){p[i]=[g.createCondition(s,f,null,null,h.NotValidated)]}else{p[i]=await Promise.all(f.map(async e=>{const t=s===S.EQ?await this._getConditionValidated(d,i,e):h.NotValidated;return g.createCondition(s,[e],null,null,t)}))}}else if(u.getSemanticDateOperations().includes(s||"")){p[i]=[g.createCondition(s,[],null,null,h.NotValidated)]}}if(!n){await this._clearFilterValue(t,i)}if(p[i]){await F.applyExternalState(t,{filter:p})}},conditionToModelPath:function(e){return e.replace(/\//g,"\\")},_getFilterMetaModel:function(e,t){return t||e.getModel().getMetaModel()},_getEntitySetPath:function(e){return e&&l.getEntitySetPath(e)},_getFieldsForTable:function(e,t){const i=[];if(t){const t=n.getTargetView(e);const r=t&&t.getController()&&t.getController()._getControls&&t.getController()._getControls("table");if(r){r.forEach(function(e){i.push(e.getParent().getTableDefinition())})}return i}return[]},_getSelectionFields:function(e,t,n,i,r,s,l,c,f,d,u){const p=o.getSelectionFields(l,r,u,c,d);let g=p.selectionFields;const y=e.data?this.getFilterPropertyInfo(e):JSON.parse(p.sPropertyInfo.replace(/\\\{/g,"{").replace(/\\\}/g,"}"));if((f?f.getControlType(e)==="sap.ui.mdc.FilterBar":e.isA("sap.ui.mdc.FilterBar"))&&t!==n){const e=a.getInvolvedDataModelObjects(s.createBindingContext(i));const t=l.getConverterContextFor(n);const r=t.getEntityTypeAnnotation("@com.sap.vocabularies.UI.v1.SelectionFields").annotation||[];const c={};g.forEach(function(e){c[e.conditionPath]=true});r.forEach(function(t){const n=t.value;if(!c[n]){const t=o.getFilterField(n,l,e.startingEntitySet.entityType);if(t){g.push(t)}}})}if(g){const e=[];g.forEach(function(t){e.push(t.key)});g=this._getSelectionFieldsFromPropertyInfos(e,g,y)}return g},_getSelectionFieldsFromPropertyInfos:function(e,t,n){n.forEach(function(n){if(n.name==="$search"||n.name==="$editState"||n.key===undefined){return}const i=t[e.indexOf(n.key)];if(e.includes(n.key)&&i.annotationPath){n.group=i.group;n.groupLabel=i.groupLabel;n.settings=i.settings;n.visualFilter=i.visualFilter;n.label=n.label?n.label:i.label;n.annotationPath=n.annotationPath??i.annotationPath;t[e.indexOf(n.key)]=n}if(!e.includes(n.key)&&!n.annotationPath){t.push(n)}});return t},_getSearchField:function(e,t){return e.getSearch&&!t.includes("search")?e.getSearch():null},_getFilterConditions:function(e,t,n){const i=t||n.getConditions();if(e&&e.targetControl&&e.targetControl.isA("sap.ui.mdc.Chart")){Object.keys(i).forEach(function(e){if(e==="$editState"){delete i["$editState"]}})}return i},_getFilterPropertiesMetadata:function(e,t){if(!(e&&e.length)){if(t.getPropertyInfo){e=t.getPropertyInfo()}else{e=null}}return e},_getIgnoredProperties:function(e,t){const n=[];e.forEach(function(e){const i=e.name;const r=t.find(e=>e.name===i);if(r&&(!e.isCustomFilter&&e.dataType!==r.dataType||e.isCustomFilter&&r.annotationPath===undefined)){n.push(i)}});return n},getFilters:function(e){if(!e||typeof e.isInitialized!=="function"||!e.isInitialized()){return}const{parameters:t,filters:n,search:i}=this.getFilterInfo(e);return{parameters:t,filters:n,search:i}},formatPropertyInfo:function(e){if(typeof e==="string"){let t=e.replace(/\\\{/g,"{");t=t.replace(/\\\}/g,"}");let n=JSON.parse(t);n=this._formatPropertyInfo(n);let i=JSON.stringify(n);i=i.replace(/\{/g,"\\{");i=i.replace(/\}/g,"\\}");return i}else{return this._formatPropertyInfo(e)}},_formatPropertyInfo:function(e){return e.map(e=>{const t={key:e.key||e.name,dataType:"",label:""};for(const n in E){if(e.hasOwnProperty(n)){switch(n){case"hiddenFilter":t.hiddenFilter=e.hiddenFilter;break;case"required":t.required=e.required;break;case"path":t.path=e.path;break;case"tooltip":t.tooltip=e.tooltip;break;case"visible":t.visible=e.visible;break;case"maxConditions":t.maxConditions=e.maxConditions;break;case"formatOptions":t.formatOptions=e.formatOptions;break;case"constraints":t.constraints=e.constraints;break;case"group":t.group=e.group;break;case"groupLabel":t.groupLabel=e.groupLabel;break;case"caseSensitive":t.caseSensitive=e.caseSensitive}}}if(e.dataType){t.dataType=e.dataType}else{throw new Error(`Missing mandatory property dataType for filter-bar filter field: ${e}`)}if(e.label){t.label=e.label}return t})}};return M},false);
//# sourceMappingURL=FilterUtils.js.map