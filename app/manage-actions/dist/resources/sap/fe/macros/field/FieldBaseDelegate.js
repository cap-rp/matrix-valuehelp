/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)
 *      (c) Copyright 2009-2025 SAP SE. All rights reserved
 */
sap.ui.define(["sap/base/Log","sap/fe/core/CommonUtils","sap/fe/core/converters/MetaModelConverter","sap/ui/core/Element","sap/ui/mdc/field/FieldBaseDelegate","sap/ui/mdc/odata/v4/TypeMap","sap/ui/mdc/p13n/StateUtil","sap/ui/model/Filter","../CommonHelper"],function(e,t,n,r,a,o,i,s,l){"use strict";var u=n.getInvolvedDataModelObjects;return Object.assign({},a,{apiVersion:2,initializeTypeFromBinding:function(e,t,n){const r={};if(t&&t.isA(["sap.ui.model.odata.type.Unit","sap.ui.model.odata.type.Currency"])&&Array.isArray(n)&&n.length>2&&n[2]!==undefined){t.formatValue(n,"string");r.bTypeInitialized=true;r.mCustomUnits=n[2]}return r},initializeInternalUnitType:function(e,t,n){if(n?.mCustomUnits!==undefined){t.formatValue([null,null,n.mCustomUnits],"string")}},enhanceValueForUnit:function(e,t,n){if(n?.bTypeInitialized===true&&t.length===2){t.push(n.mCustomUnits);return t}return undefined},getDefaultValueHelpDelegate:function(e){return{name:"sap/ui/mdc/odata/v4/ValueHelpDelegate",payload:{}}},getTypeMap:function(e){return o},_getValueListParameter:function(e,t){return e.Parameters.filter(function(e){if(e.LocalDataProperty){return e.LocalDataProperty.$PropertyPath===t}else{return false}})},_getFilter:function(e,t,n,a,o,i,l,u){let c=[];const p=e.Parameters.filter(function(e){return e.$Type==="com.sap.vocabularies.Common.v1.ValueListParameterIn"||e.$Type==="com.sap.vocabularies.Common.v1.ValueListParameterInOut"||e.LocalDataProperty?.$PropertyPath===t&&e.ValueListProperty===n});for(const e of p){let n;if(e.LocalDataProperty?.$PropertyPath===t){n=a}else if(o?.isActionParameterDialog===true){const t=`APD_::${e.LocalDataProperty?.$PropertyPath}`;const a=r.getElementById(t);n=a?.getValue()}else if(i!==undefined){const t=e.ValueListProperty;const r=i?.[0];n=t&&r?.[t]}else if(l){const t=e.LocalDataProperty?.$PropertyPath;n=l.getObject(t)}if(!n&&u){const t=u?.[e.ValueListProperty];if(t?.length===1&&t[0]?.operator==="EQ"){n=t[0]?.values[0]}}if(n!==null&&n!==undefined){c.push(new s({path:e.ValueListProperty,operator:"EQ",value1:n}))}}if(i?.[0]){c=c.concat(this._getRemainingKeyValueFilters(i[0],e))}return c},_getRemainingKeyValueFilters(e,t){const{$model:n,CollectionPath:r,Parameters:a}=t;const o=n.getMetaModel().getMetaContext(`/${r}`);const i=u(o).targetEntityType;const c=a.reduce((e,t)=>{if(t.LocalDataProperty?.$PropertyPath){e.push(t.LocalDataProperty.$PropertyPath)}return e},[]);const p=i.keys.reduce((t,n)=>{let{name:r}=n;if(!c.includes(r)&&e.hasOwnProperty(r)){t.push(r)}return t},[]);if(p.length>0){return p.reduce((t,a)=>{const o=n.getMetaModel().getMetaContext(`/${r}/${a}`);if(l.isPropertyFilterable(o,undefined,true)){t.push(new s({path:a,operator:"EQ",value1:e[a]}))}return t},[])}return[]},getItemForValue:function(e,t,n){if(n.value===""){return}if(n.checkDescription){const e=t.getPayload();const r=e.valueHelpDescriptionPath;const a=e?.maxLength;const o=n.value!==null&&n.value!==undefined?n.value.toString().length:0;if(r===""){n.checkDescription=false}else if(a!==undefined&&o>a){return}}return a.getItemForValue(e,t,n)},_getFilterBar:function(e){let t;if(e?.isA("sap.ui.mdc.FilterField")){while(e){if(e?.isA("sap.fe.macros.filterBar.FilterBarAPI")){t=e;break}e=e?.getParent()}if(t?.getContent()?.isA("sap.fe.macros.controls.FilterBar")){return t.getContent()}}return undefined},getDescription:async function(n,r,a,o,l,u,c,p,f,d,g){let m=n?.getPayload();if(!m&&d?.getDisplay().includes("Description")){m={retrieveTextFromValueList:true}}if(m?.retrieveTextFromValueList===true||m?.isFilterField===true){const o=r.getModel();const l=o?o.getMetaModel():t.getAppComponent(r).getModel().getMetaModel();const c=r.getPayload();const p=f?.[c.valueHelpQualifier];const d=c.propertyPath;const g=c?.propertyDescriptionPath;let m;try{const o=await l.requestValueListInfo(d,true,u);const f=this._getFilterBar(n);let P;if(f){const e=await i.retrieveExternalState(f);P=e.filter}const h=l.getObject(`${d}@sapui.name`);const y=o[Object.keys(o)[0]];const $=this._getValueListParameter(y,h);const v=$?.[0]?.ValueListProperty;if(!v){throw Error(`Inconsistent value help annotation for ${h}`)}const C=y.$model;const b=C.getMetaModel().getObject(`/${y.CollectionPath}/${v}@com.sap.vocabularies.Common.v1.Text`);if(b&&b.$Path){m=b.$Path;const e=this._getFilter(y,h,v,a,c,p,u,P);const t=C.bindList(`/${y.CollectionPath}`,undefined,undefined,e,{$select:m});const n=await t.requestContexts(0,2);return n.length?n[0].getObject(m):undefined}else if(u!==undefined&&g){const n=g.lastIndexOf("/");const a=n>0?g.substring(0,n):g;const o=t.getAppComponent(r).getSideEffectsService();await o.requestSideEffects([a],u);e.warning(`RequestSideEffects is triggered because the text annotation for ${v} is not defined at the CollectionPath of the value help`);return undefined}else{const t=l?.getObject(`${c.propertyPath}@com.sap.vocabularies.Common.v1.ExternalID`)?.$Path;if(t){const e=c.propertyPath.replace(h,t);const n=l.getObject(`${e}@sapui.name`);const r=l?.getObject(`${e}@com.sap.vocabularies.Common.v1.Text`)?.$Path;const o=[];o.push(new s({path:n,operator:"EQ",value1:a}));const i=C.bindList(`/${y.CollectionPath}`,undefined,undefined,o,{$select:`${n},${r}`});const u=await i.requestContexts(0,2);if(u.length){return u[0].getObject(r)}}e.error(`Text Annotation for ${v} is not defined`);return undefined}}catch(t){const n=t?t.status:undefined;const r=t instanceof Error?t.message:String(t);const a=n===404?`Metadata not found (${n}) for value help of property ${d}`:r;e.error(a)}}return undefined}})},false);
//# sourceMappingURL=FieldBaseDelegate.js.map