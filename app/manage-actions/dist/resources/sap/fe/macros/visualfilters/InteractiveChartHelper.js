/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)
 *      (c) Copyright 2009-2025 SAP SE. All rights reserved
 */
sap.ui.define(["sap/base/util/JSTokenizer","sap/fe/core/CommonUtils","sap/fe/core/helpers/StableIdHelper","sap/fe/core/helpers/TypeGuards","sap/fe/core/templating/CriticalityFormatters","sap/fe/macros/CommonHelper","sap/fe/macros/controls/filterbar/utils/VisualFilterUtils","sap/fe/macros/filter/FilterFieldHelper","sap/fe/macros/filterBar/FilterHelper","sap/m/library","sap/ui/core/Lib","sap/ui/core/format/NumberFormat","sap/ui/mdc/condition/ConditionConverter","sap/ui/mdc/odata/v4/TypeMap","sap/ui/model/Filter","sap/ui/model/odata/v4/ODataUtils","../field/FieldTemplating"],function(e,t,a,r,n,i,o,s,l,u,c,g,f,p,m,d,h){"use strict";var y=h.getTextBinding;var C=l.getFiltersConditionsFromSelectionVariant;var M=s.formatOptions;var T=s.constraints;var v=n.buildExpressionForCriticalityColorMicroChart;var P=r.isSingleton;var $=r.isPathAnnotationExpression;var b=r.isNavigationProperty;var F=r.isEntitySet;var E=a.generate;const D={getChartDisplayedValue:function(e,t,a){const r=E([a]);return"{parts:[{path:'"+e+"',type:'sap.ui.model.odata.type.Decimal', constraints:{'nullable':false}}"+(t&&t.ScaleFactor?",{value:'"+t.ScaleFactor.valueOf()+"'}":",{path:'internal>scalefactorNumber/"+r+"'}")+(t&&t.NumberOfFractionalDigits?",{value:'"+t.NumberOfFractionalDigits+"'}":",{value:'0'}")+",{path:'internal>currency/"+r+"'}"+",{path:'"+e+"',type:'sap.ui.model.odata.type.String', constraints:{'nullable':false}}"+"], formatter:'sap.fe.macros.visualfilters.VisualFilterRuntime.scaleVisualFilterValue'}"},getChartValue:function(e){return"{path:'"+e+"',type:'sap.ui.model.odata.type.Decimal', constraints:{'nullable':false}}"},_getCollectionName:function(e,t,a){const r=e?.targetObject;if(b(r)){return a?t:r.name}else if(F(r)){return"/"+r.name}else{return r.name}},_getBindingPathForParameters:function(a,r,n,i,s){const l=[];const u=o.convertFilterCondions(a);const c=t.getParameterInfo(r,n).parameterProperties;if(c){for(const t in i){const a=i[t];const n=c[a];const o=s.split("/")[1];const g=r?.createBindingContext(`/${o}/${a}`);let m;if(g){m=p.getTypeConfig(n.$Type,e.parseJS(M(n,{context:g})||"{}"),e.parseJS(T(n,{context:g})||"{}"))}const h=u[a];const y=h?h[0]:undefined;if(y){const e=f.toType(y,m,p);const t=n.$Type;let r=encodeURIComponent(d.formatLiteral(e.values[0],t));l.push(`${a}=${r}`)}}}const g=n.slice(0,n.lastIndexOf("/"));const m=n.substring(n.lastIndexOf("/")+1);return`${g}(${l.toString()})/${m}`},_getUOMAggregationExpression:function(e,t,a,r){let n,i;const o=a&&$(a)&&a.path;if(e){if(t){n=o?{unit:o}:{};i={}}else{n={};i=o?{[o]:{}}:{}}}else if(r&&r.AggregatableProperty&&r.AggregatableProperty.value&&r.AggregationMethod){n={name:r.AggregatableProperty.value,with:r.AggregationMethod};i=o?{[o]:{}}:{}}return{aggregationExpression:n,UOMExpression:i}},getAggregationBinding:function(e,t,a,r,n,i,s,l,u,c,g,f,p,d,h){const y=s;const M=f;const T=a;const v=e.Dimensions[0].value;const P=[];let $;let b=this._getCollectionName(t,a,g);const F=D.getUoM(e,t,undefined,l,u);if(p){P.push(new m({operator:"EQ",value1:"true",value2:null,path:"IsActiveEntity"}))}if(y){$=C(T,h,y,o.getCustomConditions.bind(o));for(const e in $){const t=$[e];t.forEach(function(e){if(!e.isParameter){P.push(new m({operator:e.operator,value1:e.value1,value2:e.value2,path:e.path}))}})}}if(M!==`${b}/`&&g&&g.length&&$){const e=this._getBindingPathForParameters($,h,b,g,T);b=e}const E=this._getUOMAggregationExpression(l,c,F,u);const I=E.aggregationExpression;const O=E.UOMExpression;const V=r?{additionally:[r.path]}:{};const A={...this.getSortOrder(e,n,i,d),$$aggregation:{aggregate:{[d]:I},group:{[v]:{...V},...O}}};return{path:b,templateShareable:true,suspended:true,filters:P,parameters:A,...D.getMaxItems(e)}},_getOrderExpressionFromMeasure:function(e,t){let a;if(e&&e.length){if(e[0].DynamicProperty){a=e[0].DynamicProperty.$target?.Name}else{a=e[0].Property?.value}if(a===t){return{$orderby:t+(e[0].Descending?" desc":"")}}return{$orderby:t+" desc"}}return{$orderby:t+" desc"}},getSortOrder:function(e,t,a,r){if(e.ChartType==="UI.ChartType/Donut"||e.ChartType==="UI.ChartType/Bar"){return this._getOrderExpressionFromMeasure(a,r)}else if(t==="Edm.Date"||t==="Edm.Time"||t==="Edm.DateTimeOffset"){return{$orderby:e.Dimensions[0].value}}else if(a&&a.length&&a[0].Property?.$target?.path===e.Dimensions[0].value){return{$orderby:a[0].Property?.$target?.name+(a[0].Descending?"desc'":"'")}}else{return{$orderby:e.Dimensions[0].$target?.name}}},getMaxItems:function(e){if(e.ChartType==="UI.ChartType/Bar"){return{startIndex:0,length:3}}else if(e.ChartType==="UI.ChartType/Line"){return{startIndex:0,length:6}}else{return""}},getColorBinding:function(e,t){const a=t?.$target?.annotations?.UI?.ValueCriticality;if(e?.Criticality){return v(e)}else if(e?.CriticalityCalculation){const t=e.CriticalityCalculation.ImprovementDirection;const a=e.Value;const r=e.CriticalityCalculation.DeviationRangeLowValue.valueOf();const n=e.CriticalityCalculation.ToleranceRangeLowValue.valueOf();const o=e.CriticalityCalculation.AcceptanceRangeLowValue.valueOf();const s=e.CriticalityCalculation.AcceptanceRangeHighValue.valueOf();const l=e.CriticalityCalculation.ToleranceRangeHighValue.valueOf();const u=e.CriticalityCalculation.DeviationRangeHighValue.valueOf();return i.getCriticalityCalculationBinding(t,a,r,n,o,s,l,u)}else if(a&&a.length){return D.getValueCriticality(t.value,a)}else{return undefined}},getValueCriticality:function(e,t){let a;const r=[];if(t&&t.length>0){t.forEach(function(t){if(t.Value&&t.Criticality){const a="${"+e+"} === '"+t.Value+"' ? '"+D._getCriticalityFromEnum(t.Criticality)+"'";r.push(a)}});a=r.length>0&&r.join(" : ")+" : undefined"}return a?"{= "+a+" }":undefined},_getCriticalityFromEnum:function(e){const t=u.ValueColor;let a;if(e==="UI.CriticalityType/Negative"){a=t.Error}else if(e==="UI.CriticalityType/Positive"){a=t.Good}else if(e==="UI.CriticalityType/Critical"){a=t.Critical}else{a=t.Neutral}return a},getScaleUoMTitle:function(e,t,a,r,n,i,o){const s=e?.MeasureAttributes?e.MeasureAttributes[0]?.DataPoint?.$target?.ValueFormat?.ScaleFactor?.valueOf():undefined;const l=E([a]);const u=g.getIntegerInstance({style:"short",showScale:false,shortRefNumber:s});let c=u.getScale();let f=D.getUoM(e,t,undefined,r,n);f=f&&(f.path?"${internal>uom/"+l+"}":"'"+f+"'");c=c?"'"+c+"'":"${internal>scalefactor/"+l+"}";if(!i){i="|"}i="' "+i+" ' + ";const p=c&&f?i+c+" + ' ' + "+f:i+(c||f);return o?p:"{= "+p+"}"},getMeasureDimensionTitle:function(e,t,a){let r;let n;if(t){n=e?.Measures[0]?.$target?.name}if(e?.DynamicMeasures&&e.DynamicMeasures.length>0){n=e.DynamicMeasures[0]?.$target?.AggregatableProperty?.value}else if(!t&&e?.Measures&&e?.Measures.length>0){n=e.Measures[0]?.$target?.name}const i=e?.Dimensions[0]?.value;let o=e?.Dimensions[0]?.$target?.annotations?.Common?.Label;if(!t&&a){r=a.annotations&&a.annotations.Common&&a.annotations.Common.Label;if(r===undefined){r=e?.Measures?.[0]?.$target?.annotations?.Common?.Label}}else{r=e?.Measures?.[0]?.$target?.annotations?.Common?.Label}if(r===undefined){r=n}if(o===undefined){o=i}return c.getResourceBundleFor("sap.fe.macros").getText("M_INTERACTIVE_CHART_HELPER_VISUALFILTER_MEASURE_DIMENSION_TITLE",[r,o])},getToolTip:function(e,t,a,r,n,o){const s=e&&e["ChartType"];let l=D.getMeasureDimensionTitle(e,r,n);l=i.escapeSingleQuotes(l);if(o===false&&s==="UI.ChartType/Line"){return`{= '${l}'}`}const u=c.getResourceBundleFor("sap.fe.macros")?.getText("M_INTERACTIVE_CHART_HELPER_VISUALFILTER_TOOLTIP_SEPERATOR");const g=E([a]);const f=D.getScaleUoMTitle(e,t,g,r,n,u,true);return"{= '"+l+(f?"' + "+f:"'")+"}"},_getUOM:function(e,t,a,r,n){const i={};const o=a?.targetObject;if(e&&t&&$(e)){i[t]={$Path:e.path};return r&&e.path?i:e}else if(n){const a=F(o)||P(o)?o.entityType.entityProperties:o?.targetType?.entityProperties;const s=a?.find(e=>e.name==n);if(s?.annotations?.Measures&&t){e=s?.annotations?.Measures[t];i[t]={$Path:e?.path}}return e&&r&&$(e)&&e.path?i:e}},getUoM:function(e,t,a,r,n){let i={};if(r){i=e?.Measures[0]}if(e?.DynamicMeasures&&e.DynamicMeasures.length>0){i=e.DynamicMeasures[0]?.$target?.AggregatableProperty?.$target?.annotations?.Measures}else if(!r&&e?.Measures&&e.Measures.length>0){i=e.Measures[0]}const o=i?.ISOCurrency;const s=i?.Unit;let l;if(!r&&n){l=n.AggregatableProperty&&n.AggregatableProperty.value}else{l=i?.value}return this._getUOM(o,"ISOCurrency",t,a,l)||this._getUOM(s,"Unit",t,a,l)},getScaleFactor:function(e){if(e&&e.ScaleFactor){return e.ScaleFactor.valueOf()}return undefined},getUoMVisiblity:function(e,t){const a=e&&e["ChartType"];if(t){return false}else if(!(a==="UI.ChartType/Bar"||a==="UI.ChartType/Line")){return false}else{return true}},getInParameterFiltersBinding:function(e){if(e.length>0){const t=[];let a="";e.forEach(function(e){if(e.localDataProperty){t.push(`{path:'$filters>/conditions/${e.localDataProperty}'}`)}});if(t.length>0){a=t.join();return`{parts:[${a}], formatter:'sap.fe.macros.visualfilters.VisualFilterRuntime.getFiltersFromConditions'}`}else{return undefined}}else{return undefined}},getfilterCountBinding:function(e){const t=e?.Dimensions[0]?.$target?.name;return"{path:'$filters>/conditions/"+t+"', formatter:'sap.fe.macros.visualfilters.VisualFilterRuntime.getFilterCounts'}"},getInteractiveChartProperties:function(e){const t=e.chartAnnotation;const a={};if(e.chartMeasure&&t?.Dimensions&&t.Dimensions[0]){const r=E([e.metaPath]);a.showErrorExpression="{= ${internal>"+r+"/showError}}";a.errorMessageExpression="{= ${internal>"+r+"/errorMessage}}";a.errorMessageTitleExpression="{= ${internal>"+r+"/errorMessageTitle}}";let n;if(t?.MeasureAttributes&&t?.MeasureAttributes[0]){n=t?.MeasureAttributes[0]?.DataPoint?t?.MeasureAttributes[0].DataPoint.$target:t?.MeasureAttributes[0]}const o=t?.Dimensions[0];const s=i.getParameters(e.contextPath,e.getMetaModel());const l=o?.$target?.annotations?.Common?.Text;a.aggregationBinding=D.getAggregationBinding(t,e.collection,e.contextPath,l,o.$target?.type,e?.sortOrder,e.selectionVariant,e.customAggregate,e.aggregateProperties,e.UoMHasCustomAggregate,s,e.filterBarEntityType,e.draftSupported,e.chartMeasure,e.getMetaModel());a.scalefactor=D.getScaleFactor(n?.ValueFormat);a.uom=D.getUoM(t,e.collection,true,e.customAggregate,e.aggregateProperties);a.inParameters=e.inParameters;const u=i.parseCustomData(e.inParameters);a.inParameterFilters=e.inParameters?D.getInParameterFiltersBinding(u):undefined;a.selectionVariant=e.selectionVariant?e.selectionVariant:undefined;a.stringifiedParameters=s;const c=e.getMetaModel()?.createBindingContext(e.contextPath+"/@"+o.fullyQualifiedName.split("@")[1]);if(c){const t=e.getDataModelObjectForMetaPath(c.getPath(),e.contextPath);a.chartLabel=y(t,{})}a.measure=D.getChartValue(e.chartMeasure);a.displayedValue=D.getChartDisplayedValue(e.chartMeasure,n?.ValueFormat,e.metaPath);a.color=D.getColorBinding(n,o)}return a}};return D},false);
//# sourceMappingURL=InteractiveChartHelper.js.map