/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)
 *      (c) Copyright 2009-2025 SAP SE. All rights reserved
 */
sap.ui.define(["sap/fe/base/BindingToolkit","sap/fe/base/ClassSupport","sap/fe/core/helpers/BindingHelper","sap/fe/core/helpers/StableIdHelper","sap/fe/core/helpers/TypeGuards","sap/fe/core/templating/DataModelPathHelper","sap/fe/core/templating/UIFormatters","sap/fe/macros/field/FieldHelper","sap/fe/macros/field/FieldTemplating","sap/ui/core/CustomData","sap/ui/mdc/MultiValueField","sap/ui/mdc/field/MultiValueFieldItem","sap/fe/core/buildingBlocks/BuildingBlock","sap/fe/core/controllerextensions/collaboration/CollaborationCommon","sap/fe/core/controls/FormElementWrapper","sap/fe/core/formatters/CollaborationFormatter","sap/fe/core/helpers/ModelHelper","sap/fe/macros/field/FieldRuntime","sap/fe/macros/multivaluefield/FormatOptions","sap/fe/macros/multivaluefield/MultiValueFieldRuntime","sap/m/Avatar","sap/m/HBox","sap/ui/base/Event","sap/ui/core/Element","./ValueHelp","./field/FieldRuntimeHelper","sap/fe/base/jsx-runtime/jsx"],function(t,e,i,a,o,n,r,l,s,d,c,u,h,p,f,b,g,m,y,v,P,M,x,C,E,I,O){"use strict";var D,F,_,w,z,B,j,S,V,A,L,T,G,H,$,R,k,U,N,Q,q,W,J;var K={};var X=p.CollaborationFieldGroupPrefix;var Y=s.getVisibleExpression;var Z=s.getValueBinding;var tt=r.getDisplayMode;var et=r.getCollaborationExpression;var it=n.isPathInsertable;var at=n.isPathDeletable;var ot=n.getTargetObjectPath;var nt=n.getRelativePaths;var rt=n.getContextRelativeTargetObjectPath;var lt=n.enhanceDataModelPath;var st=o.isPropertyPathExpression;var dt=o.isProperty;var ct=o.isPathAnnotationExpression;var ut=o.isMultipleNavigationProperty;var ht=i.UI;var pt=e.property;var ft=e.implementInterface;var bt=e.defineUI5Class;var gt=e.association;var mt=e.aggregation;var yt=t.or;var vt=t.not;var Pt=t.isConstant;var Mt=t.ifElse;var xt=t.getExpressionFromAnnotation;var Ct=t.constant;var Et=t.compileExpression;var It=t.and;function Ot(t,e,i,a){i&&Object.defineProperty(t,e,{enumerable:i.enumerable,configurable:i.configurable,writable:i.writable,value:i.initializer?i.initializer.call(a):void 0})}function Dt(t,e){t.prototype=Object.create(e.prototype),t.prototype.constructor=t,Ft(t,e)}function Ft(t,e){return Ft=Object.setPrototypeOf?Object.setPrototypeOf.bind():function(t,e){return t.__proto__=e,t},Ft(t,e)}function _t(t,e,i,a,o){var n={};return Object.keys(a).forEach(function(t){n[t]=a[t]}),n.enumerable=!!n.enumerable,n.configurable=!!n.configurable,("value"in n||n.initializer)&&(n.writable=!0),n=i.slice().reverse().reduce(function(i,a){return a(t,e,i)||i},n),o&&void 0!==n.initializer&&(n.value=n.initializer?n.initializer.call(o):void 0,n.initializer=void 0),void 0===n.initializer?(Object.defineProperty(t,e,n),null):n}function wt(t,e){throw Error("Decorating class property failed. Please ensure that transform-class-properties is enabled and runs after the decorators transform.")}let zt=(D=bt("sap.fe.macros.MultiValueField"),F=ft("sap.ui.core.IFormContent"),_=pt({type:"string"}),w=gt({type:"string"}),z=gt({type:"string"}),B=pt({type:"string",required:true}),j=pt({type:"boolean",required:false}),S=pt({type:"string"}),V=pt({type:"any",isBindingInfo:true}),A=mt({type:"sap.fe.macros.multivaluefield.FormatOptions",multiple:false,defaultClass:y}),L=pt({type:"boolean"}),D(T=(G=function(t){function e(e,i){var a;if(typeof e!=="string"){e._isInEditMode=Et(ht.IsEditable)}a=t.call(this,e,i)||this;Ot(a,"__implements__sap_ui_core_IFormContent",H,a);Ot(a,"id",$,a);Ot(a,"idPrefix",R,a);Ot(a,"vhIdPrefix",k,a);Ot(a,"metaPath",U,a);Ot(a,"readOnly",N,a);Ot(a,"contextPath",Q,a);Ot(a,"items",q,a);Ot(a,"formatOptions",W,a);Ot(a,"_isInEditMode",J,a);return a}K=e;Dt(e,t);var i=e.prototype;i._overrideValue=function t(e,i,a,o){if(this.items){const t=this.items.model??this.items.modelName;e={path:`${t}>${this.items.path}`};const n=i.targetObject;const r=`{${t}>${n.name}}`;if(ct(n.annotations.Common?.Text)){a=`{${t}>${n.annotations.Common?.Text?.path}}`}else{a=r}o=r}return{description:a,collectionBinding:e,key:o}};i._getMultiInputSettings=function t(i,a){const{collectionPath:o,itemDataModelObjectPath:n}=e._getPathStructure(i);const r={path:o,parameters:{$$ownRequest:true},templateShareable:false};const l=i.targetObject;const s=st(l)?l.$target:l;const d=s?.annotations.Common?.Text;const c=nt(i);const u=d?Et(xt(d,c)):Z(n,a??{},true);const h=Z(n,a??{},true);let p=false;if(nt(n).length>0){p=true}return{displayOnly:p,...this._overrideValue(r,n,u,h)}};e._getPathStructure=function t(e){let i="";const a=e.contextLocation?.targetEntitySet?e.contextLocation.targetEntitySet:e.startingEntitySet;const o=[];const n=e.contextLocation?.navigationProperties||[];for(const t of e.navigationProperties){if(e.contextLocation===undefined||!e.contextLocation.navigationProperties.some(e=>e.fullyQualifiedName===t.fullyQualifiedName)){o.push(t.name);n.push(t);if(a.navigationPropertyBinding.hasOwnProperty(t.name)){if(ut(t)){break}}}}i=`${o.join("/")}`;const r=Object.assign({},e);if(r.contextLocation){r.contextLocation.navigationProperties=n}return{collectionPath:i,itemDataModelObjectPath:r}};i.computeFieldGroupIds=function t(e){if(!e){return""}const i=e.getSideEffectsService();const a=i.computeFieldGroupIds(this.dataModelPath.targetEntityType.fullyQualifiedName,this.dataModelPath.targetObject.fullyQualifiedName);if(this.collaborationEnabled){const t=`${X}${this.dataSourcePath}`;a.push(t)}this.fieldGroupIds=a.length?a.join(","):undefined;const o=a.join(",");return o===""?undefined:o};i.initialize=function t(e){const i=this._getOwner();this.contextPath=this.contextPath??i?.preprocessorContext?.fullContextPath;const a=i?.getMetaModel();const o=a?.createBindingContext(e.getPath());const n=e?.getTarget();if(dt(n)&&n.annotations.UI?.DataFieldDefault!==undefined){this.enhancedMetaPath=a?.createBindingContext(`@${"com.sap.vocabularies.UI.v1.DataFieldDefault"}`,o)}else{this.enhancedMetaPath=o}const r=this.getDataModelObjectForMetaPath(this.enhancedMetaPath.getPath(),this.contextPath);this.convertedDataField=r.targetObject;this.dataModelPath=lt(r,this.convertedDataField.Value.path);this.dataSourcePath=ot(this.dataModelPath);this.property=this.dataModelPath.targetObject;let l=it(this.dataModelPath);const s=at(this.dataModelPath,{ignoreTargetCollection:true,authorizeUnresolvable:true});const d=at(this.dataModelPath);let c=Mt(s._type==="Unresolvable",yt(vt(Pt(d)),d),d);if(this.items){l=c=Ct(!this.readOnly)}else{this.visible=Y(this.dataModelPath,this.formatOptions)}this.insertableAndDeletable=It(l,c);this.collaborationExpression=Ct(false);this.computeCollaborationProperties();if(this.formatOptions?.displayOnly===true||this.readOnly===true){this.editMode="Display"}else if(this.readOnly===false){this.editMode=Et(Mt(It(l,c),Mt(this.collaborationExpression,Ct("ReadOnly"),Ct("Editable")),Ct("Display")))}else{this.editMode=Et(Mt(It(l,c,ht.IsEditable),Mt(this.collaborationExpression,Ct("ReadOnly"),Ct("Editable")),Ct("Display")))}this.displayMode=tt(this.dataModelPath);const u=lt(this.getDataModelObjectForMetaPath(this.enhancedMetaPath.getPath(),this.contextPath),this.convertedDataField.Value.path);this.item=this._getMultiInputSettings(u,this.formatOptions);if(this.item.displayOnly){this.editMode="Display"}this.collection=this.item.collectionBinding;const h=this.getAppComponent();this.fieldGroupIds=this.computeFieldGroupIds(h)};i.onMetadataAvailable=function t(){if(!this.content){this.content=this.createContent()}};i.isCollaborationDraftSupported=function t(){const e=this._getOwner();const i=e?.getMetaModel();return g.isCollaborationDraftSupported(i)};i.computeCollaborationProperties=function t(){if(this.isCollaborationDraftSupported()&&this.editMode!=="Display"){this.collaborationEnabled=true;this.collaborationExpression=r.getCollaborationExpression(this.dataModelPath,b.hasCollaborationActivity);this.collaborationInitialsExpression=Et(et(this.dataModelPath,b.getCollaborationActivityInitials));this.collaborationColorExpression=Et(et(this.dataModelPath,b.getCollaborationActivityColor))}};i.createContent=function t(){const e=this.getMetaPathObject(this.metaPath,this.contextPath);if(e){this.initialize(e);if(this.id){this.vhIdPrefix=a.generate([this.getId(),this.vhIdPrefix??"FieldValueHelp"])}else if(!this.vhIdPrefix){this.vhIdPrefix=this.createId("FieldValueHelp")}const t=this._getOwner()?.getRootController();const i=t.getView();const o=this._getOwner()?.getMetaModel();const n=o?.createBindingContext(e.getPath());const r=o?.createBindingContext(e.getContextPath());if(!n||!r){return}const s=this.collection;const h=this.getAppComponent()?.getManifestEntry("sap.fe")?.macros?.multiValueField?.itemsSizeLimit;if(h!==undefined){s.length=h}const p=l.computeLabelText(this.convertedDataField.Value,{context:n});const b=E.getValueHelpForMetaPath(this.getPageController(),rt(this.dataModelPath),this.contextPath??this.getOwnerContextPath(),this._getOwner()?.getMetaModel());let g;if(b&&b.getContent()){g=b.getContent().getId()}const y=O(c,{id:this.createId("_mvf"),delegate:{name:"sap/fe/macros/multivaluefield/MultiValueFieldDelegate"},items:s,display:this.displayMode,width:"100%",editMode:this.editMode,valueHelp:g,ariaLabelledBy:this.ariaLabelledBy?this.ariaLabelledBy:[],showEmptyIndicator:this.formatOptions?.showEmptyIndicator,label:p,change:v.handleChange.bind(v,t),fieldGroupIds:this.fieldGroupIds,validateFieldGroup:m.onValidateFieldGroup,children:{items:O(u,{description:this.item.description},this.item.key),customData:O(d,{value:this.insertableAndDeletable},"insertableAndDeletable")}});let D=null;if(this.collaborationEnabled){const e=O(P,{visible:this.collaborationExpression,initials:this.collaborationInitialsExpression,displaySize:"Custom",customDisplaySize:"1.5rem",customFontSize:"0.8rem",backgroundColor:this.collaborationColorExpression,press:()=>{I.showCollaborationEditUser(e,i)}});D=O(f,{children:O(M,{width:"100%",renderType:"Bare",alignItems:"End",children:{items:[y,e]}})});y?.addEventDelegate({onfocusin:e=>{const i=e.srcControl.getParent();t.collaborativeDraft?.handleContentFocusIn(i);if(a?.getDomRef()){a.attachEventOnce("closed",()=>{i?.focus()})}},onfocusout:e=>{let i=e.srcControl.getParent();if(i?.isA("sap.m.Tokenizer")){i=i.getParent()?.getParent()}const a=new x("",i,{fieldGroupIds:i.getFieldGroupIds()});t.collaborativeDraft.handleContentFocusOut(a)}},this);const a=C.getElementById(y.getValueHelp());a?.attachOpened(e=>{const i=e.getSource().getControl();t.collaborativeDraft.handleContentFocusIn(i)})}y.addCustomData(new d({key:"forwardedItemsBinding",value:this.items}));return this.collaborationEnabled?D:y}};i.setReadOnly=function e(i){t.prototype.setProperty.call(this,"readOnly",i);this.updateEditMode()};i.set_isInEditMode=function e(i){t.prototype.setProperty.call(this,"_isInEditMode",i);this.updateEditMode()};i.getMultiValueField=function t(){if(this.isCollaborationDraftSupported()){return this.content.content.getItems()[0]}else{return this.content}};i.updateEditMode=function t(){if(!this.content){return}const e=this.getMultiValueField();const i=e.data("insertableAndDeletable");if(this.readOnly===true){this.editMode="Display";e.setEditMode("Display")}else if(this.readOnly===false&&i){if(this._isInEditMode){this.editMode="Editable";e.setEditMode("Editable")}else{this.editMode="Display";e.setEditMode("Display")}}};i.onBeforeRendering=function t(){if(this.content){const t=this.getMultiValueField();const e=this.getAriaLabelledBy();for(const i of e){const e=t.getAriaLabelledBy();if(!e.includes(i)){t.addAriaLabelledBy(i)}}}};return e}(h),H=_t(G.prototype,"__implements__sap_ui_core_IFormContent",[F],{configurable:true,enumerable:true,writable:true,initializer:function(){return true}}),$=_t(G.prototype,"id",[_],{configurable:true,enumerable:true,writable:true,initializer:null}),R=_t(G.prototype,"idPrefix",[w],{configurable:true,enumerable:true,writable:true,initializer:null}),k=_t(G.prototype,"vhIdPrefix",[z],{configurable:true,enumerable:true,writable:true,initializer:null}),U=_t(G.prototype,"metaPath",[B],{configurable:true,enumerable:true,writable:true,initializer:null}),N=_t(G.prototype,"readOnly",[j],{configurable:true,enumerable:true,writable:true,initializer:null}),Q=_t(G.prototype,"contextPath",[S],{configurable:true,enumerable:true,writable:true,initializer:null}),q=_t(G.prototype,"items",[V],{configurable:true,enumerable:true,writable:true,initializer:null}),W=_t(G.prototype,"formatOptions",[A],{configurable:true,enumerable:true,writable:true,initializer:null}),J=_t(G.prototype,"_isInEditMode",[L],{configurable:true,enumerable:true,writable:true,initializer:function(){return false}}),G))||T);K=zt;return K},false);
//# sourceMappingURL=MultiValueField.js.map