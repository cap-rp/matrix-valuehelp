/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)
 *      (c) Copyright 2009-2025 SAP SE. All rights reserved
 */
sap.ui.define(["sap/base/Log","sap/base/util/deepEqual","sap/fe/core/CommonUtils","sap/fe/core/converters/MetaModelConverter","sap/fe/core/converters/controls/ListReport/FilterBar","sap/fe/core/helpers/MetaModelFunction","sap/fe/core/helpers/ModelHelper","sap/fe/core/templating/DataModelPathHelper","sap/fe/core/templating/DisplayModeFormatter","sap/fe/core/templating/PropertyHelper","sap/fe/core/type/EDM","sap/fe/macros/DelegateUtil","sap/fe/macros/internal/valuehelp/TableDelegateHelper","sap/ui/core/Element","sap/ui/mdc/odata/v4/TableDelegate","sap/ui/mdc/odata/v4/TypeMap","sap/ui/mdc/odata/v4/util/DelegateUtil","sap/ui/mdc/util/FilterUtil","sap/ui/model/Filter","sap/ui/model/FilterOperator","sap/ui/model/Sorter"],function(e,t,a,n,r,o,i,s,c,p,l,g,f,d,u,y,h,m,b,P,v){"use strict";var C=f.isSortableProperty;var I=f.isFilterableProperty;var M=f.getPath;var $=l.isTypeFilterable;var T=p.getLabel;var O=p.getAssociatedUnitPropertyPath;var D=p.getAssociatedTimezonePropertyPath;var F=p.getAssociatedTextPropertyPath;var S=p.getAssociatedCurrencyPropertyPath;var E=c.getDisplayMode;var x=s.getTargetObjectPath;var B=s.enhanceDataModelPath;var j=o.isMultiValueFilterExpression;var w=o.getSortRestrictionsInfo;var A=o.getFilterRestrictionsInfo;var N=r.fetchTypeConfig;var _=n.getInvolvedDataModelObjects;const k=Object.assign({},u);k.fetchProperties=async function(e){const t=await this._getModel(e);const a=await this._createPropertyInfos(e,t);k.createInternalBindingContext(e);g.setCachedProperties(e,a);e.getBindingContext("internal").setProperty("tablePropertiesAvailable",true);return a};k.createInternalBindingContext=function(e){let t=e;while(t&&!t.isA("sap.ui.mdc.valuehelp.Dialog")){t=t.getParent()}const a=e.getModel("internal");if(t&&a){const n=t.getBindingContext("internal");let r;if(n){r=n.getPath()+`::VHDialog::${t.getId()}::table`}else{r=`/buildingblocks/${e.getId()}`;a.setProperty("/buildingblocks",{...a.getProperty("/buildingblocks")})}const o=a.bindContext(r).getBoundContext();e.setBindingContext(o,"internal")}};function R(e){const t=V(e);const a={};if(t?.targetObject){const n=t.targetObject;const r=x(t,true);const o=e.targetObject;const i=x(e,true);const s=o.annotations?.Common?.Text,c=s?.annotations?.UI?.TextArrangement?.toString(),p=s&&c&&E(o);if(p==="Description"){a[r]=n}else if(p&&p!=="Value"||!s){a[i]=o;a[r]=n}}return a}k._createPropertyInfos=async function(e,t){const a=e.getDelegate().payload;const n=[];const r=`/${a.collectionName}`;const o=t.getMetaModel();return o.requestObject(`${r}@`).then(function(t){const a=w(t);const s=t["@Org.OData.Capabilities.V1.FilterRestrictions"];const c=A(s);const p=t["@Org.OData.Capabilities.V1.FilterFunctions"];const l=i.isFilteringCaseSensitive(o,p);const f=g.getCustomData(e,"columns");const d={};const u=_(e.getModel().getMetaModel().getContext(r));f.customData.forEach(function(t){let r=$(t.$Type)?e.getTypeMap().getTypeConfig(t.$Type):y.getTypeConfig("sap.ui.model.odata.type.String");const o={key:t.path,label:t.label};const i=B(u,t.path);const s=i.targetObject;if(s){const e=x(i,true);if($(s.type)){const e=N(s);r=y.getTypeConfig(e.type??"sap.ui.model.odata.type.String",e.formatOptions,e.constraints)??r}const n=R(i);const p=Object.keys(n);if(p.length){o.propertyInfos=p;p.forEach(e=>{d[e]=n[e]});if(!p.find(e=>n[e]===s)){d[e]=s}}else{o.path=t.path;o.dataType=r.className;o.constraints=r.typeInstance?.oConstraints;o.formatOptions=r.typeInstance?.oFormatOptions;o.sortable=C(a,t);o.filterable=I(c,t);o.maxConditions=H(c,t);o.caseSensitive=l}}else{o.path=t.path;o.caseSensitive=l;o.dataType=r.className}n.push(o)});const h=U(d,n,a,c,l);return n.concat(h)})};k.updateBindingInfo=function(e,t){u.updateBindingInfo.apply(this,[e,t]);const n=e.getDelegate().payload;if(n){t.path=t?.path||n.collectionPath||`/${n.collectionName}`}t.parameters=t.parameters||{};const r=d.getElementById(e.getFilter()),o=e.isFilteringEnabled();let s;let c,p;const l=[];const f=g.getCachedProperties(e);if(o){s=e.getConditions();c=m.getFilterInfo(e,s,f,[]);if(c.filters){l.push(c.filters)}}const y=!!n?.hierarchyQualifier;if(y){t.parameters.$$aggregation={hierarchyQualifier:n.hierarchyQualifier,expandTo:n.initialExpansionLevel}}if(r){s=r.getConditions();if(s){const a=h.getParameterNames(r);k._updatePropertyInfo(f,e,s,n);p=m.getFilterInfo(r,s,f,a);if(p.filters){l.push(p.filters)}const o=h.getParametersInfo(r,s);if(o){t.path=o}}if(!y){t.parameters.$search=a.normalizeSearchTerm(r.getSearch())||undefined}else if(r.getSearch()){if(!t.parameters.$$aggregation){t.parameters.$$aggregation={}}t.parameters.$$aggregation.search=a.normalizeSearchTerm(r.getSearch());t.parameters.$$aggregation.expandTo=Number.MAX_SAFE_INTEGER}}t.parameters.$$sharedRequest=false;this._applyDefaultSorting(t,e.getDelegate().payload);t.parameters.$select=f?.reduce(function(e,t){if(t.path&&!t.path.includes("/")){e=e?`${e},${t.path}`:t.path}return e},"");t.parameters.$count=true;if(t.path&&i.isDraftSupported(e.getModel()?.getMetaModel(),t.path)){l.push(new b("IsActiveEntity",P.EQ,true))}t.filters=new b(l,true)};k.getTypeMap=function(){return y};k._getModel=async function(e){const t=e.getDelegate().payload;let a=e.getModel(t.model);if(!a){await new Promise(t=>{e.attachEventOnce("modelContextChange",t)});a=e.getModel(t.model)}return a};k._applyDefaultSorting=function(e,t){if(e.parameters&&e.parameters.$search==undefined&&e.parameters.$$aggregation?.search==undefined&&e.sorter&&e.sorter.length==0){const a=t?t.defaultSortPropertyName:undefined;if(a){e.sorter.push(new v(a,false))}}};k._updatePropertyInfo=function(e,t,a,n){const r=Object.keys(a),o=t.getModel().getMetaModel();r.forEach(function(a){const r=o.getObject(`/${n.collectionName}/${a}`)?.$Type??"Edm.String";const i=t.getTypeMap().getTypeConfig(r);e.forEach((t,n)=>{if(t.path===a){e[n].typeConfig=i}});if(e.findIndex(function(e){return e.path===a})===-1){const t={key:a,label:a,path:a,dataType:i.typeInstance.baseType,formatOptions:i.typeInstance?.oFormatOptions,constraints:i.typeInstance?.oConstraints};e.push(t)}})};k.updateBinding=function(a,n,r){let o=false;const i=a.getBindingContext("internal");const s="pendingManualBindingUpdate";const c="lastSearch";const p="lastFilter";const l=i?.getProperty(s);const g=i?.getProperty(c);const f=i?.getProperty(p);let d=a.getRowBinding();u.updateBinding.apply(k,[a,n,r]);if(!d){d=a.getRowBinding()}if(d){o=i?t(n.filters,f)&&n.parameters?.$search===g&&!l:true}i?.setProperty(c,n.parameters?.$search);i?.setProperty(p,n.filters);if(o&&a.getFilter()){i?.setProperty(s,true);d.requestRefresh(d.getGroupId()).finally(function(){i?.setProperty(s,false)}).catch(function(t){e.error("Error while refreshing a filterBar VH table",t)})}a.fireEvent("bindingUpdated")};function U(e,t,a,n,r){const o={},i=[];Object.keys(e).forEach(s=>{const c=e[s],p=t.find(e=>e.path===s);if(!p){const e=`Property::${s}`;o[s]=e;const t=N(c);const p=y.getTypeConfig(t.type??"sap.ui.model.odata.type.String",t.formatOptions,t.constraints);const l={key:e,label:T(c),path:s,sortable:C(a,c),filterable:I(n,c),dataType:p.className,formatOptions:$(c.type)?p.typeInstance?.oFormatOptions:undefined,constraints:$(c.type)?p.typeInstance?.oConstraints:undefined,caseSensitive:r};l.maxConditions=H(n,l);i.push(l)}});t.forEach(e=>{if(e.propertyInfos){e.propertyInfos=e.propertyInfos?.map(e=>o[e]??e)}});return i}function H(e,t){const a=M(t);return a&&e.propertyInfo?.hasOwnProperty(a)&&j(e.propertyInfo[a])?-1:1}function V(e){const t=e.targetObject;const a=t&&(F(t)||S(t)||O(t)||D(t));if(!a){return undefined}const n=B(e,a);const r=n.targetObject;if(!r){return undefined}return n}return k},false);
//# sourceMappingURL=TableDelegate.js.map