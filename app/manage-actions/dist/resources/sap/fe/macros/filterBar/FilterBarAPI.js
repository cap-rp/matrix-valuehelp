/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)
 *      (c) Copyright 2009-2025 SAP SE. All rights reserved
 */
sap.ui.define(["sap/base/Log","sap/base/util/merge","sap/fe/base/ClassSupport","sap/fe/core/CommonUtils","sap/fe/core/converters/MetaModelConverter","sap/fe/core/helpers/PromiseKeeper","sap/fe/core/library","sap/fe/macros/MacroAPI","sap/fe/macros/filter/FilterUtils","sap/fe/macros/filterBar/SemanticDateOperators","sap/fe/macros/mdc/adapter/StateHelper","sap/fe/navigation/SelectionVariant","sap/fe/navigation/library","sap/ui/core/Element","sap/ui/fl/apply/api/ControlVariantApplyAPI","sap/ui/mdc/enums/FieldEditMode","sap/ui/mdc/p13n/StateUtil","./mixin/FilterBarAPIStateHandler","sap/ui/thirdparty/jquery"],function(t,e,n,r,a,i,o,l,s,c,u,f,g,d,p,h,y,m,jQuery){"use strict";var V,b,S,F,C,v,P,w,I,_,E,A,M,B,O,D,T,x,z,k,K,j,N,R,H,L,$,U,q,J,W,G;var Q=g.NavType;var X=o.InitialLoadMode;var Y=a.getInvolvedDataModelObjects;var Z=n.xmlEventHandler;var tt=n.property;var et=n.mixin;var nt=n.event;var rt=n.defineUI5Class;var at=n.aggregation;function it(t,e,n,r){n&&Object.defineProperty(t,e,{enumerable:n.enumerable,configurable:n.configurable,writable:n.writable,value:n.initializer?n.initializer.call(r):void 0})}function ot(t,e){t.prototype=Object.create(e.prototype),t.prototype.constructor=t,lt(t,e)}function lt(t,e){return lt=Object.setPrototypeOf?Object.setPrototypeOf.bind():function(t,e){return t.__proto__=e,t},lt(t,e)}function st(t,e,n,r,a){var i={};return Object.keys(r).forEach(function(t){i[t]=r[t]}),i.enumerable=!!i.enumerable,i.configurable=!!i.configurable,("value"in i||i.initializer)&&(i.writable=!0),i=n.slice().reverse().reduce(function(n,r){return r(t,e,n)||n},i),a&&void 0!==i.initializer&&(i.value=i.initializer?i.initializer.call(a):void 0,i.initializer=void 0),void 0===i.initializer?(Object.defineProperty(t,e,i),null):i}function ct(t,e){throw Error("Decorating class property failed. Please ensure that transform-class-properties is enabled and runs after the decorators transform.")}let ut=function(){function t(t){this.countFilterActions=0;this.countVariantFilters=0;this.filterBarAPI=t}var e=t.prototype;e.onFiltersChanged=function t(e){if(e==="Variant"){this.countVariantFilters++}else{this.countFilterActions++}};e.onSearch=function t(e,n){const r=this.getFilterNamesFromConditions(n);this.filterBarAPI.getPageController()?.telemetry.storeAction({type:"FE.FilterBarSearch",parameters:{countFilterActions:this.countFilterActions,countFilters:Object.keys(n).length,countVariantFilters:this.countVariantFilters,variantLayer:this.filterBarAPI.getVariant()?.layer??"None",autoLoad:e.reason==="Variant",searchUsed:n.$search?!!Object.keys(n.$search).length:false,filterNames:r}});this.countFilterActions=0;this.countVariantFilters=0};e.getFilterNamesFromConditions=function t(e){let n="";Object.keys(e).forEach(t=>{if(t!="$search"){n+=t+";"}});return n};return t}();var ft=function(t){t["Control"]="Control";t["Page"]="Page";t["None"]="None";return t}(ft||{});const gt="DisplayCurrency";const dt="P_DisplayCurrency";let pt=(V=rt("sap.fe.macros.filterBar.FilterBarAPI",{returnTypes:["sap.ui.core.Control"]}),b=et(m),S=tt({type:"string"}),F=tt({type:"string",expectedAnnotations:["com.sap.vocabularies.UI.v1.SelectionFields"],expectedTypes:["EntitySet","EntityType"]}),C=tt({type:"string",expectedTypes:["EntitySet","EntityType","NavigationProperty"]}),v=tt({type:"boolean",defaultValue:false}),P=tt({type:"boolean",defaultValue:true}),w=tt({type:"boolean",defaultValue:true}),I=tt({type:"boolean",defaultValue:false}),_=at({type:"sap.fe.macros.filterBar.FilterField",multiple:true}),E=nt(),A=nt(),M=nt(),B=nt(),O=nt(),D=Z(),T=Z(),V(x=b(x=(z=function(n){function a(t,e){var r;r=n.call(this,t,e)||this;r.initialControlState={};r._initialStatePromise=new i;r._bSearchTriggered=false;it(r,"id",k,r);it(r,"metaPath",K,r);it(r,"contextPath",j,r);it(r,"liveMode",N,r);it(r,"visible",R,r);it(r,"showMessages",H,r);it(r,"showClearButton",L,r);it(r,"filterFields",$,r);it(r,"search",U,r);it(r,"internalSearch",q,r);it(r,"filterChanged",J,r);it(r,"afterClear",W,r);it(r,"internalFilterChanged",G,r);r.telemetry=new ut(r);r.attachStateChangeHandler();return r}ot(a,n);var o=a.prototype;o.waitForInitialState=async function t(){return this._initialStatePromise.promise};o.getControlState=function t(e){const n=this.initialControlState;if(e){return{fullState:e,initialState:n}}return e};o.isSearchTriggeredByInitialLoad=function t(e){const n=this.getPageController(),r=n.getView(),a=r.getViewData();let t=false,i;if(a.variantManagement===ft.Control){i=n._getFilterBarVariantControl()}else{i=r.byId("fe::PageVariantManagement")}const o=i?.getCurrentVariantKey();if(e===Q.xAppState){return true}else if(i&&a.initialLoad!==X.Enabled){if(n._shouldAutoTriggerSearch(this._getFilterBarVM(r))){t=true}}else if(i&&a.initialLoad===X.Enabled&&n._getApplyAutomaticallyOnVariant(i,o)){t=true}return t};o._applySelectionVariant=async function t(e,n,r){const a=this.getContent();const{selectionVariant:i,selectionVariantDefaults:o,requiresStandardVariant:l=false}=n;if(!a||!i){return Promise.resolve()}const s=this._getFilterBarVM(e);const c=await this._activateVariantAndDetermineApplyAppState(s,l,r);if(c){this._addDefaultDisplayCurrencyToSV(e,i,o);const t=o?o.getSelectOptionsPropertyNames().length>0:false;const n=s&&s.getDefaultVariantKey()===s.getStandardVariantKey();const l=t&&(n||!s);const c=a.getParent();let u=i;if(r||l){u=await this._getAdjustedSV(i,l)}return c.setSelectionVariant(u,true)}};o._enableFilterBar=function t(e,n){const r=e.getParent();const a=()=>{this._bSearchTriggered=!n};if(e.getSuspendSelection()){r.attachEventOnce("search",a);e.setSuspendSelection(false)}else{a()}};o._getAdjustedSV=async function t(e,n){let r=new f(e.toJSONObject());const a=await this.getSelectionVariant();const i=a?.getSelectOptionsPropertyNames()||[];if(i.length>0){r=i.reduce((t,e)=>{const r=t.getSelectOption(e);if(n&&!r?.length||!n){const n=a.getSelectOption(e);t.massAddSelectOption(e,n||[])}return t},r)}return r};o._preventInitialSearch=function t(e){if(!e){return true}const n=e.getVariants();const r=n.find(function(t){return t.getKey()===e.getCurrentVariantKey()});return!r.executeOnSelect};o._addDefaultDisplayCurrencyToSV=function t(e,n,r){if(!r||r?.isEmpty()){return}const a=e.getViewData(),i=e.getModel()?.getMetaModel(),o=a.contextPath||`/${a.entitySet}`,l=i.getMetaContext(o),s=Y(l);const c=this.getDisplayCurrencyPropertyName(s);const u=this._checkIfDisplayCurrencyIsRequired(s);if(!u){return}const f=n.getSelectOption(c)||[],g=r.getSelectOption(c)||[],d=g.length>0,p=f.length===0;if(p&&d){const t=g[0],e=t["Sign"],r=t["Option"],a=t["Low"],i=t["High"];n.addSelectOption(c,e,r,a,i)}};o.isParameterized=function t(e){return!!e.startingEntitySet.entityType?.annotations?.Common?.ResultContext};o.getDisplayCurrencyPropertyName=function t(e){return this.isParameterized(e)?dt:gt};o._checkIfDisplayCurrencyIsRequired=function t(e){let n=false;if(this.isParameterized(e)){n=e.startingEntitySet.entityType.entityProperties.some(t=>t.name===dt)}else{const t=e.startingEntitySet._type==="EntitySet"?e.startingEntitySet:undefined,r=t?.annotations.Capabilities?.FilterRestrictions?.RequiredProperties??[];n=r.some(t=>t.value===gt)}return n};o._activateVariantAndDetermineApplyAppState=async function t(e,n,r){if(e&&!r){let t=n?e.getStandardVariantKey():e.getDefaultVariantKey();if(t===null){t=e.getId()}await p.activateVariant({element:e,variantReference:t});return n||e.getDefaultVariantKey()===e.getStandardVariantKey()}return true};o._getFilterBarVM=function t(e){let n;const r=e.getViewData();switch(r.variantManagement){case ft.Page:n=e.byId("fe::PageVariantManagement");break;case ft.Control:n=e.getController()._getFilterBarVariantControl();break;case ft.None:default:break}return n};o.handleVariantIdPassedViaURLParams=async function t(e){const n=e["sap-ui-fe-variant-id"],r=e["sap-ui-fe-filterbar-variant-id"],a=e["sap-ui-fe-table-variant-id"],i=e["sap-ui-fe-chart-variant-id"];let o;if(n||r||a||i){o={sPageVariantId:n&&n[0],sFilterBarVariantId:r&&r[0],sTableVariantId:a&&a[0],sChartVariantId:i&&i[0]}}return this._handleControlVariantId(o)};o._handleControlVariantId=async function t(e){let n;const r=this.getPageController()?.getView(),a=[];const i=r.getViewData().variantManagement;if(e&&e.sPageVariantId&&i==="Page"){n=r.byId("fe::PageVariantManagement");this._handlePageVariantId(e,n,a)}else if(e&&i==="Control"){if(e.sFilterBarVariantId){n=r.getController()._getFilterBarVariantControl();this._handleFilterBarVariantControlId(e,n,a)}}return Promise.all(a)};o._handlePageVariantId=function t(e,n,r){n.getVariants()?.forEach(t=>{this._findAndPushVariantToPromise(t,e.sPageVariantId,n,r,true)})};o._handleFilterBarVariantControlId=function t(e,n,r){if(n){n.getVariants().forEach(t=>{this._findAndPushVariantToPromise(t,e.sFilterBarVariantId,n,r,true)})}};o._findAndPushVariantToPromise=function t(e,n,r,a,i){if(e.key===n){a.push(this._applyControlVariant(r,n,i))}};o._applyControlVariant=async function t(e,n){let r=arguments.length>2&&arguments[2]!==undefined?arguments[2]:false;const a=this._checkIfVariantIdIsAvailable(e,n)?n:e.getStandardVariantKey();const i=p.activateVariant({element:e,variantReference:a});return i.then(function(){return r})};o._checkIfVariantIdIsAvailable=function t(e,n){const r=e.getVariants();let a=false;r.forEach(function(t){if(t.getKey()===n){a=true}});return a};o.attachStateChangeHandler=function t(){y.detachStateChange(this.stateChangeHandler);y.attachStateChange(this.stateChangeHandler)};o.stateChangeHandler=function t(e){const n=e.getParameter("control");if(n.isA("sap.ui.mdc.FilterBar")){const t=n.getParent();if(t?.handleStateChange){t.handleStateChange()}}};o.handleSearch=function t(n){const r=n.getSource();const a=n.getParameters();if(r){const t=r.getFilterConditions()??{};const n=this._prepareEventParameters(r);this.telemetry?.onSearch(a,t);this.fireEvent("internalSearch",e({conditions:t},a));this.fireEvent("search",e({reason:a.reason},n))}};o.handleFilterChanged=function t(n){const r=n.getSource();const a=n.getParameters();if(r){const t=r.getFilterConditions();const n=this._prepareEventParameters(r);this.telemetry?.onFiltersChanged(this._getFilterBarReason(r));this.fireEvent("internalFilterChanged",e({conditions:t},a));this.fireEvent("filterChanged",n)}};o._getFilterBarReason=function t(e){return e?._sReason??""};o._prepareEventParameters=function t(e){const{parameters:n,filters:r,search:a}=s.getFilters(e)||{};return{parameters:n,filters:r,search:a}};o.setFilterValues=async function t(e,n,r){if(arguments.length===2){r=n;return s.setFilterValues(this.content,e,r)}return s.setFilterValues(this.content,e,n,r)};o.getActiveFiltersText=function t(){return this.content?.getAssignedFiltersText()?.filtersText||""};o.getFilters=function t(){return s.getFilters(this.content)||{}};o.triggerSearch=async function e(){const n=this.content;try{if(n){await n.waitForInitialization();return await n.triggerSearch()}}catch(e){const n=e instanceof Error?e.message:String(e);t.error(`FE : Buildingblock : FilterBar : ${n}`);throw Error(n)}};o.isSemanticDateFilterApplied=function t(){return c.hasSemanticDateOperations(this.content.getConditions(),false)};o.getSelectionVariant=async function t(){const e=await u.getSelectionVariant(this.getContent());const n=this.getPageController();if(n!==undefined){const t=n?.getView(),a=r.getAppComponent(t),i=a?.getNavigationService(),o=this.getDataModelObjectForMetaPath(this.metaPath);if(o?.targetEntitySet?.name){const n=o?.targetEntitySet?.name&&i?.constructContextUrl(o?.targetEntitySet?.name,t.getModel());e.setFilterContextUrl(n)}}return e};o.getMandatoryFilterPropertyNames=function t(){return this.content.getPropertyInfoSet().filter(function(t){return t.required}).map(function(t){return t.conditionPath})};o.getParameters=function t(){const e=this.content;const n=e.data("parameters");if(n){return Array.isArray(n)?n:JSON.parse(n)}return[]};o.getVariant=function e(){let n;try{const t=this.getModel("$FlexVariants");const e=this.content.getVariantBackreference();if(t&&e){n=t.getVariant(t.getCurrentVariantReference(e))}}catch(e){t.debug("Couldn't fetch variant ",e)}return n};o.setFilterFieldVisible=async function t(e,n){await y.applyExternalState(this.content,{items:[{name:e,visible:n}]})};o.getFilterFieldVisible=async function t(e){const n=await y.retrieveExternalState(this.content);return!!n.items.find(t=>t.name===e)};o.getVariantManagement=function t(){const e=this.content.getVariantBackreference();if(e){return d.getElementById(e)}else{throw new Error(`Variant back reference not defined on the filter bar ${this.id}`)}};o.setVariantBackReference=function t(e){const n=this.getContent();const r=n?.getLiveMode?.();if(!r){this.content.setVariantBackreference(e)}};o.getCurrentVariantKey=function t(){return this.getVariantManagement().getCurrentVariantKey()};o.setCurrentVariantKey=function t(e){const n=this.getVariantManagement();n.setCurrentVariantKey(e)};o.setFilterFieldEnabled=function t(e,n){this.getModel("internal").setData({[this.content.data("localId")]:{filterFields:{[e]:{editMode:n?h.Editable:h.Disabled}}}},true)};o.getFilterFieldEnabled=function t(e){return this.getModel("internal").getProperty(`/${this.content.data("localId")}/filterFields/${e}/editMode`)===h.Disabled?false:true};o.convertSelectionVariantToStateFilters=async function t(e,n){return u.convertSelectionVariantToStateFilters(this.content,e,n,this.content?.getModel())};o._clearFilterValuesWithOptions=async function t(e,n){await u._clearFilterValuesWithOptions(e,n)};o.setSelectionVariant=async function e(n){let r=arguments.length>1&&arguments[1]!==undefined?arguments[1]:false;const a=this.getContent();const i=a&&a?.getLiveMode?.();if(i){a.setSuspendSelection(true)}let o;try{o=await u.setSelectionVariantToMdcControl(this.getContent(),n,r);return o}catch(e){const n=e instanceof Error?e.message:String(e);t.error(`FE : Buildingblock : FilterBar : ${n}`);throw Error(n)}finally{if(i){a.setSuspendSelection(false)}}};o.handleStateChange=function t(){this.getPageController()?.getExtensionAPI().updateAppState()};o.showFilterField=async function t(e){const n=await y.retrieveExternalState(this.content);const r=!!n.items.find(t=>t.name===e);if(!r){n.items.push({name:e})}await y.applyExternalState(this.content,n)};o.openValueHelpForFilterField=function t(e,n,r){const a=this.content.getFilterItems().find(t=>t.getPropertyKey()===e);if(a){const t=d.getElementById(a.getValueHelp());if(t){let e=[];const n=t=>{e=t.getParameter("conditions")};t.attachClosed(()=>{t.detachSelect(n,this);r?.(e)});t.attachSelect(n,this)}a._oFocusInfo={targetInfo:{silent:true}};a.onfocusin?.(new jQuery.Event("focusin"));setTimeout(()=>{a.getAggregation("_content")[0].fireValueHelpRequest({fromKeyboard:true,_userInputValue:n})},200)}};o.getCollapsedFiltersText=function t(){return this.content?.getAssignedFiltersText()?.filtersText};return a}(l),k=st(z.prototype,"id",[S],{configurable:true,enumerable:true,writable:true,initializer:null}),K=st(z.prototype,"metaPath",[F],{configurable:true,enumerable:true,writable:true,initializer:null}),j=st(z.prototype,"contextPath",[C],{configurable:true,enumerable:true,writable:true,initializer:null}),N=st(z.prototype,"liveMode",[v],{configurable:true,enumerable:true,writable:true,initializer:null}),R=st(z.prototype,"visible",[P],{configurable:true,enumerable:true,writable:true,initializer:null}),H=st(z.prototype,"showMessages",[w],{configurable:true,enumerable:true,writable:true,initializer:null}),L=st(z.prototype,"showClearButton",[I],{configurable:true,enumerable:true,writable:true,initializer:null}),$=st(z.prototype,"filterFields",[_],{configurable:true,enumerable:true,writable:true,initializer:null}),U=st(z.prototype,"search",[E],{configurable:true,enumerable:true,writable:true,initializer:null}),q=st(z.prototype,"internalSearch",[A],{configurable:true,enumerable:true,writable:true,initializer:null}),J=st(z.prototype,"filterChanged",[M],{configurable:true,enumerable:true,writable:true,initializer:null}),W=st(z.prototype,"afterClear",[B],{configurable:true,enumerable:true,writable:true,initializer:null}),G=st(z.prototype,"internalFilterChanged",[O],{configurable:true,enumerable:true,writable:true,initializer:null}),st(z.prototype,"handleSearch",[D],Object.getOwnPropertyDescriptor(z.prototype,"handleSearch"),z.prototype),st(z.prototype,"handleFilterChanged",[T],Object.getOwnPropertyDescriptor(z.prototype,"handleFilterChanged"),z.prototype),z))||x)||x);return pt},false);
//# sourceMappingURL=FilterBarAPI.js.map